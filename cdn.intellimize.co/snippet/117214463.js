var cPubgJNt = '{"campaigns":{"217069952":{"name":"Intellimize Launch A/A Test | Round 2","metrics":[{"id":"197960786","name":"Demo Form Submission - Step 1","eventIds":["157022139"],"scope":"user","type":"conversion","countingMethod":"unique","isGoal":false},{"id":"197960787","name":"Demo Form Submission - Step 2","eventIds":["157022140"],"scope":"user","type":"conversion","countingMethod":"unique","isGoal":false},{"id":"197960788","name":"HRIS Demo Form Submission - Step 1","eventIds":["157022141"],"scope":"user","type":"conversion","countingMethod":"unique","isGoal":false},{"id":"197960793","name":"HRIS Demo Form Submission - Step 2","eventIds":["157022142"],"scope":"user","type":"conversion","countingMethod":"unique","isGoal":false},{"id":"197960792","name":"Demo Video Form Submission","eventIds":["157022143"],"scope":"user","type":"conversion","countingMethod":"unique","isGoal":false},{"id":"197960789","name":"Product Tour Form Submission","eventIds":["157022144"],"scope":"user","type":"conversion","countingMethod":"unique","isGoal":false},{"id":"197960790","name":"Content Form Submission","eventIds":["157022145"],"scope":"user","type":"value","countingMethod":"cumulative","isGoal":false,"valueType":"dynamic"},{"id":"197960791","name":"Content Demo Form Submission","eventIds":["157022146"],"scope":"user","type":"value","countingMethod":"cumulative","isGoal":false,"valueType":"dynamic"},{"id":"197960794","name":"All Pageviews (Excluding Library)","eventIds":["157022148"],"scope":"session","type":"conversion","countingMethod":"unique","isGoal":false}],"experiences":{"417220799":{"name":"Intellimize Launch A/A Test | Round 2","type":"ab","pageIds":["137706711"],"state":"live","ignore":0,"variations":{"617087431":{"name":"No Change","state":"live","preconditions":[]},"617087432":{"name":"AA","state":"live","preconditions":[],"changes":[{"type":"ATTRIBUTE","selector":".footer-smallprints > div","attributes":{"html":"¬© Copyright <span id=\\"copyright\\">2024</span>. All Rights Reserved. "}}]}},"trafficAllocation":{"617087431":{"lowerEndpoint":0,"upperEndpoint":500},"617087432":{"lowerEndpoint":500,"upperEndpoint":1000}},"preconditions":[],"boundingSelectors":[]}}},"217070001":{"name":"Thank You Page | Product Tour (1)","metrics":[{"id":"197960872","name":"AutoGoal: On-page engagement","eventIds":["157022347"],"scope":"session","type":"conversion","countingMethod":"unique","isGoal":true}],"experiences":{"417220848":{"name":"Thank You Page | Product Tour copy","type":"ab","pageIds":["137706842"],"state":"live","ignore":0,"variations":{"617087569":{"name":"No Change","state":"live","preconditions":[]},"617087570":{"name":"Product Tour","state":"live","preconditions":[],"changes":[{"type":"INSERT_ELEMENT","elementType":"html-block","targetPosition":{"selector":".hero","insertPosition":"afterend"},"idAttribute":"insert-1fa90e77-08bb-461b-bb7a-c484e02cce47"},{"type":"ATTRIBUTE","selector":"#insert-1fa90e77-08bb-461b-bb7a-c484e02cce47","attributes":{"css":{},"html":"<section class=\\"section is-tour\\" style=\\"margin-top:0px;\\">\\n  <div class=\\"tour-wrapper\\">\\n    <div class=\\"tour-embed w-embed w-iframe\\"><iframe class=\\"tour-iframe\\" src=\\"https://capture.navattic.com/clts1vsob00dt0gl8dxaa2imw\\" id=\\"navattic-embed\\" style=\\"border:none;width:100%;height:100%;\\" allow=\\"fullscreen\\"></iframe></div>\\n  </div>\\n</section>"}},{"type":"ATTRIBUTE","selector":".cms-list","attributes":{"css":{"display":"none"}}},{"type":"ATTRIBUTE","selector":".is-large > p","attributes":{"css":{},"html":"We\'ll be in touch shortly, but if you have a question, please feel free to email <a href=\\"mailto:hello@lattice.com\\">hello@lattice.com</a>.<br>\\n‚Äç<br>\\nIn the meantime, get a sneak peek of our people platform through our self-guided tour:"}},{"type":"ATTRIBUTE","selector":".is-logobar > .w-container","attributes":{"css":{"display":"none"}}},{"type":"ATTRIBUTE","selector":".hero","attributes":{"css":{"top":""}}},{"type":"ATTRIBUTE","selector":"#navattic-embed","attributes":{"css":{"marginTop":""}}},{"type":"ATTRIBUTE","selector":".is-tour","attributes":{"css":{},"style":"margin-top: -60px;"}}]}},"trafficAllocation":{"617087569":{"lowerEndpoint":0,"upperEndpoint":500},"617087570":{"lowerEndpoint":500,"upperEndpoint":1000}},"preconditions":[],"boundingSelectors":[]}}},"217070093":{"name":"Product Tour on Homepage","metrics":[{"id":"197960986","name":"Homepage - Nav Click - Request a Demo","eventIds":["157022431"],"scope":"session","type":"conversion","countingMethod":"unique","isGoal":false},{"id":"197960987","name":"Homepage - Hero Click - Request a Demo","eventIds":["157022432"],"scope":"session","type":"conversion","countingMethod":"unique","isGoal":false},{"id":"197960988","name":"Homepage - Hero Click - Tour Button","eventIds":["157022433"],"scope":"session","type":"conversion","countingMethod":"unique","isGoal":false},{"id":"197960989","name":"Demo Form Submission","eventIds":["157022140"],"scope":"user","type":"conversion","countingMethod":"unique","isGoal":false},{"id":"197960990","name":"Product Tour Form Submission","eventIds":["157022144"],"scope":"user","type":"conversion","countingMethod":"unique","isGoal":false}],"experiences":{"417220940":{"name":"Product Tour on Homepage","type":"cc","pageIds":["137706177"],"state":"live","ignore":0,"variations":{"617087743":{"name":"No Change","state":"live","preconditions":[]},"617087744":{"name":"Product Tour Button in Hero","state":"live","preconditions":[],"changes":[{"type":"ATTRIBUTE","selector":".hero .title-wrapper","attributes":{"css":{},"html":"<p characters=\\"46\\" class=\\"quadro-paragraph\\">More than 5,000 strategic HR teams <span id=\\"keyword-1\\" class=\\"quadro-keyword\\">run performance reviews</span>, <span id=\\"keyword-2\\" class=\\"quadro-keyword\\">manage employee information</span>, <span id=\\"keyword-3\\" class=\\"quadro-keyword\\">capture team sentiment</span>, and <span id=\\"keyword-4\\" class=\\"quadro-keyword\\">align company priorities</span> with Lattice</p><div class=\\"buttons\\"><a href=\\"/demo\\" class=\\"button w-button\\" style=\\"\\">Request a demo</a><a href=\\"/tour\\" class=\\"button is-secondary w-button\\">Take a product tour</a></div><div class=\\"raters\\"><div class=\\"rater\\"><div class=\\"rater-star\\">‚≠êÔ∏è</div><div class=\\"rater-text is-rating\\">4.7</div><div class=\\"rater-text\\">&nbsp;on G2.com</div><div class=\\"rater-logo w-embed\\"><svg width=\\"100%\\" viewBox=\\"0 0 32 32\\" fill=\\"none\\" xmlns=\\"http://www.w3.org/2000/svg\\">\\n<path fill-rule=\\"evenodd\\" clip-rule=\\"evenodd\\" d=\\"M10.942 16a5.233 5.233 0 0 0 5.226 5.225 5.2 5.2 0 0 0 3.405-1.267l1.977 3.43a9.1 9.1 0 0 1-5.382 1.754A9.14 9.14 0 0 1 7.025 16a9.142 9.142 0 0 1 10.932-8.967l-1.79 3.741A5.233 5.233 0 0 0 10.943 16m11.987-3.743h-2.733c.073-.43.339-.67.877-.941l.502-.256c.9-.461 1.38-.983 1.38-1.834 0-.534-.209-.957-.622-1.26q-.616-.456-1.468-.455a2.27 2.27 0 0 0-1.245.355q-.564.344-.826.9l.79.793c.308-.62.753-.925 1.338-.925.496 0 .8.256.8.611 0 .298-.147.544-.717.832l-.323.157q-1.048.532-1.469 1.223-.42.69-.419 1.74v.192h4.135zm-.366 2.438h-4.525l-2.263 3.917H20.3l2.263 3.92 2.262-3.92z\\" fill=\\"currentcolor\\"></path>\\n</svg></div></div><div class=\\"rater\\"><div class=\\"rater-star\\">‚≠êÔ∏è</div><div class=\\"rater-text is-rating\\">4.5</div><div class=\\"rater-text\\">&nbsp;on Capterra</div><div class=\\"rater-logo w-embed\\"><svg width=\\"100%\\" viewBox=\\"0 0 32 32\\" fill=\\"none\\" xmlns=\\"http://www.w3.org/2000/svg\\">\\n<path d=\\"m22.965 8.164-5.6 17.778-3.33-8.356L5.512 14.7z\\" fill=\\"currentcolor\\"></path>\\n</svg></div></div></div>"}}]}},"preconditions":[],"boundingSelectors":[]}}}},"events":{"157021295":{"name":"On-page engagement (Homepage)","type":"click","pageIds":["137706177"],"selector":"a:not([href^=\\"(http:|https:)?//\\"],[href^=\\"#\\"])"},"157021297":{"name":"On-page engagement (Pricing Page)","type":"click","pageIds":["137706199"],"selector":"a:not([href^=\\"(http:|https:)?//\\"],[href^=\\"#\\"])"},"157022139":{"name":"Demo Form Submission - Step 1","type":"custom","apiName":"demoformsubmission1"},"157022140":{"name":"Demo Form Submission - Step 2","type":"custom","apiName":"demoformsubmission2"},"157022141":{"name":"HRIS Demo Form Submission - Step 1","type":"custom","apiName":"hrisdemoformsubmission1"},"157022142":{"name":"HRIS Demo Form Submission - Step 2","type":"custom","apiName":"hrisdemoformsubmission2"},"157022143":{"name":"Demo Video Form Submission","type":"custom","apiName":"demovideoformsubmission"},"157022144":{"name":"Product Tour Form Submission","type":"custom","apiName":"producttourformsubmission"},"157022145":{"name":"Content Form Submission","type":"custom","apiName":"contentformsubmission"},"157022146":{"name":"Content Demo Form Submission","type":"custom","apiName":"contentdemoformsubmission"},"157022147":{"name":"On-page engagement (All Pages (Excluding Library))","type":"click","pageIds":["137706711"],"selector":"a:not([href^=\\"(http:|https:)?//\\"],[href^=\\"#\\"])"},"157022148":{"name":"View pages: \\"All Pages (Excluding Library)\\"","type":"view","pageIds":["137706711"]},"157022317":{"name":"Click - Demo Navigation Button on TYP","type":"click","pageIds":["137706799"],"selector":".button.is-nav"},"157022327":{"name":"On-page engagement (Demo TYP Page)","type":"click","pageIds":["137706799"],"selector":"a:not([href^=\\"(http:|https:)?//\\"],[href^=\\"#\\"])"},"157022347":{"name":"On-page engagement (Demo TYP Page) (1)","type":"click","pageIds":["137706842"],"selector":"a:not([href^=\\"(http:|https:)?//\\"],[href^=\\"#\\"])"},"157022431":{"name":"Click on .button.is-nav (Homepage)","type":"click","pageIds":["137706177"],"selector":".button.is-nav"},"157022432":{"name":"Click on .hero a:nth-of-type(1) (Homepage)","type":"click","pageIds":["137706177"],"selector":".hero a:nth-of-type(1)"},"157022433":{"name":"Click on body > main > header > div > div.title-wrapper > div.buttons > a.button.is-secondary.w-button (Homepage)","type":"click","pageIds":["137706177"],"selector":"body > main > header > div > div.title-wrapper > div.buttons > a.button.is-secondary.w-button"},"157023093":{"name":"On-page engagement (Summer QPR Page)","type":"click","pageIds":["137707283"],"selector":"a:not([href^=\\"(http:|https:)?//\\"],[href^=\\"#\\"])"}},"pages":{"137706177":{"name":"Homepage","urls":[{"match":"regex","value":"^(https?:\\\\/\\\\/)?(www\\\\.)?lattice\\\\.com\\\\/?([?#].*?)?$"}]},"137706199":{"name":"Pricing","type":"matching","urls":[{"match":"simple","value":"https://lattice.com/pricing"}]},"137706711":{"name":"All Pages (Excluding Library)","type":"matching","urls":[{"match":"regex","value":"^((?!library).)*$"}]},"137706799":{"name":"Demo TYP","type":"matching","urls":[{"match":"simple","value":"https://lattice.com/thank-you/no-meeting"},{"match":"simple","value":"https://lattice.com/thank-you/soon"}]},"137706842":{"name":"Thank You - No Meeting","type":"matching","urls":[{"match":"simple","value":"https://lattice.com/thank-you/no-meeting"}]},"137707283":{"name":"Summer QPR","type":"matching","urls":[{"match":"simple","value":"https://lattice.com/product-updates/summer-2024"}]}},"audiences":{"187598730":{"name":"Banking customers","condition":{"type":"comparison-array-enum","operator":"includesAny","value":["Financial Services: Banking"],"attrDefId":{"name":"industry","namespace":"firmographic"}}},"187598731":{"name":"Engaged with pricing on a mobile device","condition":{"type":"logic-or","conditions":[{"type":"activity","filter":{"filters":[{"fieldName":"time","operation":{"argument":"P30D","operator":"withinPastDuration"},"type":"comparison-unix-time"},{"fieldName":"eventType","operation":{"argument":"c","operator":"eq"},"type":"comparison-enum"},{"fieldName":"eventId","operation":{"argument":"157021297","operator":"eq"},"type":"comparison-enum"}],"type":"logic-and"},"aggregation":{"type":"count"},"operation":{"argument":1,"operator":">="}},{"type":"comparison-enum","operator":"eq","value":"P","attrDefId":{"name":"device_type","namespace":"standard"}}]}},"187599046":{"name":"Financial Services","condition":{"type":"comparison-array-enum","operator":"includesAny","value":["Financial Services: Insurance","Financial Services: Banking","Financial Services: Investments","Financial Services: Payments","Financial Services: Other"],"attrDefId":{"name":"industry","namespace":"firmographic"}}},"187599047":{"name":"Lattice Employees","condition":{"type":"comparison-string","operator":"eq","value":"Lattice","attrDefId":{"name":"companyName","namespace":"firmographic"}}}},"model":{},"id":"117214463","name":"Lattice","encrypt":false,"iint":{"ga4":{"enabled":true,"autoConfig":true,"measurementIds":[]},"sixsense":{"enabled":false,"oemEnabled":true},"demandbase":{"enabled":true},"firmographic":{"enabled":true}},"ictp":0.2,"ipcc":false,"plugins":[],"schemaVersion":"2","origins":[{"domain":"lattice.com","includeSubdomains":true}],"classicAccess":false}';
var iOverride = {};
(function(){"use strict";try{if(typeof document!="undefined"){var e=document.createElement("style");e.appendChild(document.createTextNode("")),document.head.appendChild(e)}}catch(t){console.error("vite-plugin-css-injected-by-js",t)}})();
var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__pow=Math.pow,__defNormalProp=(e,t,i)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__spreadValues=(e,t)=>{for(var i in t||(t={}))__hasOwnProp.call(t,i)&&__defNormalProp(e,i,t[i]);if(__getOwnPropSymbols)for(var i of __getOwnPropSymbols(t))__propIsEnum.call(t,i)&&__defNormalProp(e,i,t[i]);return e},__spreadProps=(e,t)=>__defProps(e,__getOwnPropDescs(t)),__objRest=(e,t)=>{var i={};for(var s in e)__hasOwnProp.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&__getOwnPropSymbols)for(var s of __getOwnPropSymbols(e))t.indexOf(s)<0&&__propIsEnum.call(e,s)&&(i[s]=e[s]);return i},__publicField=(e,t,i)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,i),i),__async=(e,t,i)=>new Promise(((s,n)=>{var r=e=>{try{a(i.next(e))}catch(t){n(t)}},o=e=>{try{a(i.throw(e))}catch(t){n(t)}},a=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,o);a((i=i.apply(e,t)).next())}));!function(){"use strict";const e=e=>"[object Array]"===Object.prototype.toString.call(e),t=e=>"boolean"==typeof e,i=e=>"number"==typeof e,s=e=>"[object Object]"===Object.prototype.toString.call(e),n=e=>"[object String]"===Object.prototype.toString.call(e),r=e=>n(e)&&e.length>0,o=e=>void 0===e,a=e=>n(e)&&/^[\da-f]{8}-[\da-f]{4}-4[\da-f]{3}-[89ab][\da-f]{3}-[\da-f]{12}$/.test(e),l=e=>{try{return r(e)&&/^[\u0020-\u007E]+$/.test(e)}catch(t){return!1}},c=(e,t)=>!!s(e)&&Object.keys(e).every((e=>t.includes(e))),u="imize-extension",d="imize-field-name";var h=(e=>(e.backgroundColor="backgroundColor",e.backgroundImage="backgroundImage",e.backgroundPosition="backgroundPosition",e.backgroundRepeat="backgroundRepeat",e.backgroundSize="backgroundSize",e.borderColor="borderColor",e.borderStyle="borderStyle",e.borderWidth="borderWidth",e.borderRadius="borderRadius",e.bottom="bottom",e.boxShadow="boxShadow",e.clear="clear",e.color="color",e.cursor="cursor",e.direction="direction",e.float="float",e.fontFamily="fontFamily",e.fontSize="fontSize",e.fontWeight="fontWeight",e.left="left",e.letterSpacing="letterSpacing",e.lineHeight="lineHeight",e.listStyleType="listStyleType",e.listStylePosition="listStylePosition",e.height="height",e.minHeight="minHeight",e.maxHeight="maxHeight",e.width="width",e.minWidth="minWidth",e.maxWidth="maxWidth",e.visibility="visibility",e.display="display",e.position="position",e.margin="margin",e.marginLeft="marginLeft",e.marginRight="marginRight",e.marginTop="marginTop",e.marginBottom="marginBottom",e.opacity="opacity",e.overflow="overflow",e.padding="padding",e.paddingLeft="paddingLeft",e.paddingRight="paddingRight",e.paddingTop="paddingTop",e.paddingBottom="paddingBottom",e.right="right",e.textAlign="textAlign",e.textShadow="textShadow",e.textTransform="textTransform",e.top="top",e.wordSpacing="wordSpacing",e.zIndex="zIndex",e))(h||{});const g=new Set(["beforebegin","afterbegin","beforeend","afterend"]),p=e=>n(e)&&g.has(e),m=e=>s(e)&&p(e.insertPosition)&&v(e.selector)&&c(e,["insertPosition","selector"]),v=l;var b=(e=>(e.UNAPPLIED="UNAPPLIED",e.APPLIED="APPLIED",e.ERROR="ERROR",e))(b||{});const f=e=>!!s(e)&&Object.keys(e).every((t=>t in h&&"string"==typeof e[t])),E=new Set(["rich-text","html-block","video","image","heading"]),_=e=>n(e)&&E.has(e);let y=class extends Error{constructor(e){super(e),this.name="UnexpectedNullException"}};function S(e,t){if(null==e||"string"==typeof e&&0===e.length)throw new y(t);return e}class I extends Error{constructor(e){super(e),this.name="IllegalArgumentException"}}function w(e,t){if(S(e),!e)throw new I(t)}let C=class extends Error{constructor(e){super(e),this.name="IllegalStateException"}};function T(e,t){if(S(e),!e)throw new C(t)}let x=class extends Error{constructor(e){super(e),this.name="NoSuchElementException"}};var A=Object.defineProperty,k=(e,t,i)=>t in e?A(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,P=(e,t,i)=>(k(e,"symbol"!=typeof t?t+"":t,i),i);class D{static empty(){return N.INSTANCE}static of(e){return new F(S(e))}static ofNullable(e){return null==e||"string"==typeof e&&0===e.length?N.INSTANCE:new F(e)}}class F extends D{constructor(e){super(),P(this,"value"),this.value=e}isPresent(){return!0}ifPresent(e){return e(this.value),this}ifAbsent(e){return this}get(){return this.value}orElse(e){return this.value}orElseRun(e){return this.value}toArray(){return[this.value]}map(e){return D.ofNullable(e(this.value))}flatMap(e){return e(this.value)}toString(){return`Optional[${this.value.toString()}]`}}const M=class extends D{isPresent(){return!1}ifPresent(e){return this}ifAbsent(e){return e(),this}get(){throw new x("No value present")}orElse(e){return e}orElseRun(e){return e()}toArray(){return[]}map(e){return D.empty()}flatMap(e){return D.empty()}toString(){return"Optional.empty"}};let N=M;P(N,"INSTANCE",new M);var O,R,L={},$={},U={};Object.defineProperty(U,"__esModule",{value:!0}),U.LogLevel=void 0,(R=O||(U.LogLevel=O={}))[R.OFF=5]="OFF",R[R.ERROR=4]="ERROR",R[R.WARN=3]="WARN",R[R.INFO=2]="INFO",R[R.DEBUG=1]="DEBUG",R[R.TRACE=0]="TRACE",Object.defineProperty($,"__esModule",{value:!0}),$.BasicConsoleLogger=void 0;var V=U,W=function(){function e(e,t){this.prefix="",this.theConsole=e,this.minimumLogLevel=t}return e.prototype.getLevel=function(){return this.minimumLogLevel},e.prototype.error=function(e,t){this.minimumLogLevel<=V.LogLevel.ERROR&&this.theConsole.error("[".concat(t,"] ").concat(this.format(e)))},e.prototype.warn=function(e,t){this.minimumLogLevel<=V.LogLevel.WARN&&this.theConsole.warn("[".concat(t,"] ").concat(this.format(e)))},e.prototype.info=function(e,t){if(this.minimumLogLevel<=V.LogLevel.INFO){var i=void 0!==t?"[".concat(t,"] "):"";this.theConsole.info("".concat(i).concat(this.format(e)))}},e.prototype.debug=function(e,t){if(this.minimumLogLevel<=V.LogLevel.DEBUG){var i=void 0!==t?"[".concat(t,"] "):"";(this.theConsole.debug?this.theConsole.debug:this.theConsole.log)("".concat(i).concat(this.format(e)))}},e.prototype.group=function(e){this.minimumLogLevel<=V.LogLevel.DEBUG&&(this.prefix+="‚é¢ ",this.theConsole.log("[1m"+this.format(e)+"[22m"))},e.prototype.groupEnd=function(){this.minimumLogLevel<=V.LogLevel.DEBUG&&(this.prefix=this.prefix.slice(0,-2))},e.prototype.time=function(e){this.minimumLogLevel<=V.LogLevel.DEBUG&&this.theConsole.time(this.format(e))},e.prototype.timeEnd=function(e){this.minimumLogLevel<=V.LogLevel.DEBUG&&this.theConsole.timeEnd(this.format(e))},e.prototype.format=function(e){return e.toString().replace(/^/gm,this.prefix)},e}();$.BasicConsoleLogger=W;var z={};Object.defineProperty(z,"__esModule",{value:!0}),z.NO_OP_LOGGER=void 0;var j=U;z.NO_OP_LOGGER=function(){return{getLevel:function(){return j.LogLevel.OFF},error:function(){},warn:function(){},info:function(){},debug:function(){},group:function(){},groupEnd:function(){},time:function(){},timeEnd:function(){}}}();var G={};Object.defineProperty(G,"__esModule",{value:!0}),G.GroupConsoleLogger=void 0;var B=U,H=function(){function e(e,t){this.theConsole=e,this.minimumLogLevel=t}return e.prototype.getLevel=function(){return this.minimumLogLevel},e.prototype.error=function(e,t){this.minimumLogLevel<=B.LogLevel.ERROR&&this.theConsole.error("[".concat(t,"] ").concat(e))},e.prototype.warn=function(e,t){this.minimumLogLevel<=B.LogLevel.WARN&&this.theConsole.warn("[".concat(t,"] ").concat(e))},e.prototype.info=function(e,t){if(this.minimumLogLevel<=B.LogLevel.INFO){var i=void 0!==t?"[".concat(t,"] "):"";this.theConsole.info("".concat(i).concat(e))}},e.prototype.debug=function(e,t){if(this.minimumLogLevel<=B.LogLevel.DEBUG){var i=void 0!==t?"[".concat(t,"] "):"";(this.theConsole.debug?this.theConsole.debug:this.theConsole.log)("".concat(i).concat(e))}},e.prototype.group=function(e){this.minimumLogLevel<=B.LogLevel.DEBUG&&this.theConsole.group(e)},e.prototype.groupEnd=function(){this.minimumLogLevel<=B.LogLevel.DEBUG&&this.theConsole.groupEnd()},e.prototype.time=function(e){this.minimumLogLevel<=B.LogLevel.DEBUG&&this.theConsole.time(e)},e.prototype.timeEnd=function(e){this.minimumLogLevel<=B.LogLevel.DEBUG&&this.theConsole.timeEnd(e)},e}();G.GroupConsoleLogger=H,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.GroupConsoleLogger=e.NO_OP_LOGGER=e.LogLevel=e.BasicConsoleLogger=void 0;var t=$;Object.defineProperty(e,"BasicConsoleLogger",{enumerable:!0,get:function(){return t.BasicConsoleLogger}});var i=U;Object.defineProperty(e,"LogLevel",{enumerable:!0,get:function(){return i.LogLevel}});var s=z;Object.defineProperty(e,"NO_OP_LOGGER",{enumerable:!0,get:function(){return s.NO_OP_LOGGER}});var n=G;Object.defineProperty(e,"GroupConsoleLogger",{enumerable:!0,get:function(){return n.GroupConsoleLogger}})}(L);var Q=Object.defineProperty,q=(e,t,i)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,K=(e,t,i)=>(q(e,"symbol"!=typeof t?t+"":t,i),i);class Y{constructor({name:e,namespace:t}){K(this,"name"),K(this,"namespace"),this.name=e,this.namespace=t}getId(){return{name:this.name,namespace:this.namespace}}getName(){return this.name}getNamespace(){return this.namespace}getValue(e){return e.getAttributeValue(this)}}const J=["standard","custom","url_param","marketo","salesforce","firmographic","6sense","googleAds","demandbase","hubspot"];class X{constructor(e){K(this,"audience"),this.audience=e}getId(){return this.audience.getId()}getName(){return this.audience.getName()}getState(){return this.audience.getState()}getCondition(){return this.audience.getCondition()}addExperience(e){this.audience.addExperience(e)}addVariation(e){this.audience.addVariation(e)}getCode(){return this.audience.getCode()}getExperiences(){return this.audience.getExperiences()}getVariations(){return this.audience.getVariations()}isInclude(){return!1}}class Z{constructor(e,t,i,s,n){K(this,"logger"),K(this,"json"),K(this,"filter"),K(this,"newAggregator"),K(this,"operation"),this.json=e,this.filter=t,this.newAggregator=i,this.logger=n,this.operation=s}evaluate(e){this.logger.group("ActivityCondition.evaluate()"),this.logger.debug(`activity condition config: ${JSON.stringify(this.json)}`);const t=e.getActivities();this.logger.debug(`activities: ${JSON.stringify(t)}`),this.logger.info(`activity count: ${t.length}`);const i=t.filter((e=>this.filter.evaluate(e)));this.logger.debug(`filtered activities: ${JSON.stringify(i)}`),this.logger.info(`filtered activities count: ${i.length}`);const s=this.newAggregator();i.forEach((e=>{s.accept(e)}));const n=s.result();this.logger.info(`aggregator result: ${n}`);const r=this.operation(D.of(n));return this.logger.info(`condition result: ${r}`),this.logger.groupEnd(),r}toJSON(){return JSON.parse(JSON.stringify(this.json))}}class ee{constructor(e,t){K(this,"conditions"),this.conditions=e.conditions.map((e=>t.buildCondition(e)))}getConditions(){return this.conditions}evaluate(e){return this.conditions.every((t=>t.evaluate(e)))}toJSON(){return{conditions:this.conditions.map((e=>e.toJSON())),type:"logic-and"}}}class te{constructor(e,t,i){K(this,"audience");const s=t.getAudience(e.audienceId);this.audience=!0===i?new X(s):s}getAudience(){return this.audience}evaluate(e){return this.audience.getCondition().evaluate(e)}toJSON(){return{audienceId:this.audience.getId(),type:"audience"}}}class ie{constructor(e){K(this,"code"),this.code=e.code}getCode(){return this.code}evaluate(e){return e.evalBoolean(this.code)}toJSON(){return{code:this.code,type:"code"}}}class se{constructor(e,t,i){K(this,"json"),K(this,"attributeDefinition"),K(this,"operation"),this.json=e,this.attributeDefinition=t,this.operation=i}getAttributeDefinition(){return this.attributeDefinition}getComparisonOperation(){return this.operation}evaluate(e){return this.operation(this.attributeDefinition.getValue(e))}toJSON(){return JSON.parse(JSON.stringify(this.json))}}class ne{constructor(e,t){K(this,"condition");const i="audience"===e.condition.type;this.condition=t.buildCondition(e.condition,i)}getCondition(){return this.condition}evaluate(e){return!this.condition.evaluate(e)}toJSON(){return{condition:this.condition.toJSON(),type:"logic-not"}}}class re{constructor(e,t){K(this,"conditions"),this.conditions=e.conditions.map((e=>t.buildCondition(e)))}getConditions(){return this.conditions}evaluate(e){return this.conditions.some((t=>t.evaluate(e)))}toJSON(){return{conditions:this.conditions.map((e=>e.toJSON())),type:"logic-or"}}}class oe{constructor(e,t,i){var s;if(K(this,"id"),K(this,"name"),K(this,"state"),K(this,"condition"),K(this,"experiences",[]),K(this,"variations",[]),this.id=e,this.name=t.name,this.state=null!=(s=t.state)?s:"live",void 0!==t.code&&void 0!==t.condition)this.condition=i.buildCondition({conditions:[{code:t.code,type:"code"},t.condition],type:"logic-and"});else if(void 0!==t.code)this.condition=i.buildCondition({code:t.code,type:"code"});else{if(void 0===t.condition)throw new y('Unable to build condition for audience. No "code" or "condition" property.');this.condition=i.buildCondition(t.condition)}}getId(){return this.id}getName(){return this.name}getState(){return this.state}getCondition(){return this.condition}addExperience(e){this.experiences.push(e)}addVariation(e){this.variations.push(e)}getCode(){return this.condition instanceof ie?D.of(this.condition.getCode()):D.empty()}getExperiences(){return[...this.experiences]}getVariations(){return[...this.variations]}isInclude(){return!0}}class ae{constructor(){K(this,"count",0)}accept(e){this.count++}result(){return this.count}}class le{constructor(e){K(this,"activityFieldFunction"),K(this,"set",new Set),this.activityFieldFunction=e}accept(e){const t=this.activityFieldFunction(e);t.isPresent()&&this.set.add(t.get())}result(){return this.set.size}}class ce{constructor(e){K(this,"activityFieldFunction"),K(this,"sum",0),K(this,"count",0),this.activityFieldFunction=e}accept(e){const t=this.activityFieldFunction(e);t.isPresent()&&(this.count++,this.sum+=t.get())}result(){return this.count>0?this.sum/this.count:0}}class ue{constructor(e){K(this,"activityFieldFunction"),K(this,"sum",0),this.activityFieldFunction=e}accept(e){const t=this.activityFieldFunction(e);this.sum+=t.orElse(0)}result(){return this.sum}}class de{constructor(e,t){K(this,"filters"),this.filters=e.filters.map((e=>t.buildActivityFilter(e)))}evaluate(e){return this.filters.every((t=>t.evaluate(e)))}}class he{constructor(e,t){K(this,"activityFieldFunction"),K(this,"operation"),this.activityFieldFunction=e,this.operation=t}evaluate(e){return this.operation(this.activityFieldFunction(e))}}class ge{constructor(e,t){K(this,"filter"),this.filter=t.buildActivityFilter(e.filter)}evaluate(e){return!this.filter.evaluate(e)}}class pe{constructor(e,t){K(this,"filters"),this.filters=e.filters.map((e=>t.buildActivityFilter(e)))}evaluate(e){return this.filters.some((t=>t.evaluate(e)))}}class me{constructor(e,t,i,s){K(this,"id"),K(this,"name"),K(this,"controlTrafficPercentage"),K(this,"code"),K(this,"css"),K(this,"metrics"),K(this,"experiences"),K(this,"customer"),K(this,"intervals"),K(this,"intervalModifications"),K(this,"important"),K(this,"primaryMetrics"),this.id=e,this.customer=s,this.name=t.name,this.intervals=[],this.intervalModifications=[],void 0!==t.ictp&&(this.controlTrafficPercentage=t.ictp),void 0!==t.code&&(this.code=t.code),void 0!==t.css&&(this.css=t.css);const n=[];for(const[r,o]of Object.entries(t.experiences)){const e=i.buildExperience(r,o,this);n.push(e)}this.experiences=n,this.important=Boolean(t.important),void 0!==t.modifiedIntervals&&(this.intervals=t.modifiedIntervals),void 0!==t.intervalModifications&&(this.intervalModifications=t.intervalModifications),this.metrics=t.metrics.map((e=>i.buildMetric(e,this))),this.primaryMetrics=t.primaryMetrics}getId(){return this.id}getName(){return this.name}getControlTrafficPercentage(){return D.ofNullable(this.controlTrafficPercentage)}getCode(){return D.ofNullable(this.code)}getCss(){return D.ofNullable(this.css)}getExperiences(){return this.experiences}getMetrics(){return this.metrics}getMetric(e){const t=this.metrics.filter((t=>t.getId()===e));return 0===t.length?D.empty():D.ofNullable(t[0])}getCustomer(){return this.customer}getExperience(e){const t=this.experiences.filter((t=>t.getId()===e));return 0===t.length?D.empty():D.ofNullable(t[0])}getIntervals(){return this.intervals}getIntervalModifications(){return this.intervalModifications}isImportant(){return this.important}getPrimaryMetrics(){const{primaryMetrics:e}=this,t="customer"===e.level?this.customer.getMetrics():this.metrics;return 0===e.metricIds.length?t:t.filter((t=>e.metricIds.includes(t.getId())))}getPrimaryMetricLevel(){return this.primaryMetrics.level}}class ve{constructor(e){K(this,"username"),K(this,"role"),this.username=e.username,this.role=e.role}getUsername(){return this.username}getRole(){return this.role}}let be=class{constructor(e){var t,i;K(this,"enabled"),K(this,"originWhitelist"),K(this,"originBlacklist"),void 0===e?(this.enabled=!1,this.originWhitelist=[],this.originBlacklist=[]):(this.enabled=e.enabled||!1,this.originWhitelist=null!=(t=e.originWhitelist)?t:[],this.originBlacklist=null!=(i=e.originBlacklist)?i:[])}static isMatchingOrigin(e,t){return new RegExp(`^${e}$`).test(t)}isEnabled(){return this.enabled}getOriginWhitelist(){return this.originWhitelist}getOriginBlacklist(){return this.originBlacklist}isOriginAllowed(e){let t=!1;for(const i of this.originWhitelist)if(be.isMatchingOrigin(i,e)){t=!0;break}if(t)for(const i of this.originBlacklist)if(be.isMatchingOrigin(i,e)){t=!1;break}return t}};function fe(e){return e instanceof Error?e:new Error(e)}class Ee extends Error{constructor(e,t){super(e),K(this,"cause"),this.name="ProxyError",this.cause=fe(t),this.message=this.getAggregateMessage(),void 0!==this.cause.stack&&(this.stack=this.cause.stack)}getCause(){return this.cause instanceof Ee?this.cause.getCause():this.cause}getAggregateMessage(){let e=`${this.message}. `;return e+=this.cause instanceof Ee?this.cause.getAggregateMessage():`${this.cause.name}: ${this.cause.message}`,e}}class _e{constructor(e,t,i){var s;K(this,"logger"),K(this,"id"),K(this,"name"),K(this,"type"),K(this,"state"),K(this,"metrics",[]),this.logger=i.getLogger(),this.id=e,this.name=t.name,this.type=t.type,w(void 0!==this.type,"invalid event type: "+t.type),this.state=null!=(s=t.state)?s:"live"}addMetric(e){this.metrics.push(e)}getId(){return this.id}getName(){return this.name}getType(){return this.type}getState(){return this.state}getMetrics(){const e=[];return this.metrics.forEach((t=>{e.push(t)})),e}}class ye extends _e{}class Se extends ye{constructor(e,t,i){super(e,t,i),K(this,"pages"),K(this,"code"),K(this,"selector"),this.pages=t.pageIds.flatMap((e=>i.getPage(e).toArray())),this.pages.forEach((e=>{e.addEvent(this)})),void 0!==t.code&&(this.code=t.code),this.selector=t.selector}static filterEvents(e){return e.filter((e=>"click"===e.getType()))}getPages(){return this.pages}getCode(){return D.ofNullable(this.code)}getSelector(){return this.selector}executeCode(e){this.logger.debug("executeCode() if present");let t=!0;if(this.getCode().isPresent()){const s=this.getCode().get();try{this.logger.info(`Event ${this.id} code running`),t=e(s),this.logger.info(`Event ${this.id} code result => ${t}`)}catch(i){const e=new Ee(`Click event (${this.id}) code execution failed `,i);t=!1,this.logger.error(e,1007,{eventId:this.id})}}return t}}class Ie extends _e{constructor(e,t,i){super(e,t,i),K(this,"apiName"),this.apiName=t.apiName}static filterEvents(e){return e.filter((e=>"custom"===e.getType()))}getApiName(){return this.apiName}}class we extends _e{constructor(e,t,i){super(e,t,i),K(this,"formId"),this.formId=t.formId}static filterEvents(e){return e.filter((e=>"hubspot"===e.getType()))}getFormId(){return this.formId}}class Ce extends _e{constructor(e,t,i){super(e,t,i),K(this,"formId"),this.formId=t.formId}static filterEvents(e){return e.filter((e=>"marketo"===e.getType()))}getFormId(){return this.formId}}class Te extends _e{constructor(e,t,i){super(e,t,i),K(this,"customerEventName"),this.customerEventName=t.customerEventName}static filterEvents(e){return e.filter((e=>"shopify"===e.getType()))}getCustomerEventName(){return this.customerEventName}}class xe extends _e{constructor(e,t,i){super(e,t,i)}}class Ae extends _e{constructor(e,t,i){super(e,t,i),K(this,"pages"),K(this,"code"),this.pages=t.pageIds.flatMap((e=>i.getPage(e).toArray())),this.pages.forEach((e=>{e.addEvent(this)})),void 0!==t.code&&(this.code=t.code)}static filterEvents(e){return e.filter((e=>"view"===e.getType()))}getPages(){return this.pages}getCode(){return D.ofNullable(this.code)}executeCode(e){this.logger.debug("executeCode() if present");let t=!0;if(this.getCode().isPresent()){const s=this.getCode().get();try{this.logger.info(`Event ${this.id} code running`),t=e(s),this.logger.info(`Event ${this.id} code result => ${t}`)}catch(i){const e=new Ee(`View event (${this.id}) code execution failed `,i);t=!1,this.logger.error(e,1011,{eventId:this.id})}}return t}}class ke extends ye{static filterEvents(e){return e.filter((e=>"wf_engagement_click"===e.getType()))}constructor(e,t,i){super(e,t,i)}getSelector(){return"[data-wf-native-id-path]"}}class Pe{constructor(e,t){var i,s,n,r,o,a,l;K(this,"data"),K(this,"active"),K(this,"encrypt"),K(this,"schemaVersion"),K(this,"id"),K(this,"version"),K(this,"name"),K(this,"controlStickyConfig"),K(this,"campaignControl"),K(this,"controlTrafficPercentage"),K(this,"collaborators"),K(this,"excludeIps"),K(this,"plugins"),K(this,"metrics"),K(this,"campaigns"),K(this,"pages"),K(this,"audiences"),K(this,"experiences"),K(this,"iEvents"),K(this,"code"),K(this,"css"),K(this,"snippetDomain"),K(this,"urlParamFilters"),K(this,"customAttributeFilters"),K(this,"googleUniversalAnalyticsIntegration"),K(this,"googleAnalytics4Integration"),K(this,"segmentAnalyticsIntegration"),K(this,"mixpanelIntegration"),K(this,"marketoIntegration"),K(this,"salesforceIntegration"),K(this,"shopifyIntegration"),K(this,"firmographicIntegration"),K(this,"sixsenseIntegration"),K(this,"googleAdsIntegration"),K(this,"demandbaseIntegration"),K(this,"hubspotIntegration"),K(this,"mfa"),K(this,"changelogInternal"),K(this,"changelogExternal"),K(this,"crossOrigin"),K(this,"origins"),K(this,"vertical"),K(this,"currentContract"),K(this,"timeZone"),K(this,"classicAccess"),K(this,"salesforceAccountId"),K(this,"autoUpdateOrigins"),K(this,"roiScenario"),K(this,"webflowSiteId"),this.data=e,this.active=e.active,this.encrypt=e.encrypt,this.schemaVersion=null!=(i=e.schemaVersion)?i:"1",this.id=e.id,this.version=e.__v,this.name=e.name,this.controlStickyConfig=t.buildControlStickyConfig(e.scon),this.campaignControl=e.ipcc,!this.campaignControl&&void 0!==e.ictp&&(this.controlTrafficPercentage=e.ictp),void 0!==e.code&&(this.code=e.code),void 0!==e.css&&(this.css=e.css),void 0!==e.snippetDomain&&(this.snippetDomain=e.snippetDomain);const c=[];void 0!==e.collaborators&&e.collaborators.forEach((e=>{c.push(t.buildCollaborator(e))})),this.collaborators=c,this.excludeIps=null!=(s=e.excludeIps)?s:[],this.plugins=null!=(n=e.plugins)?n:[],this.urlParamFilters=null!=(r=e.urlParamFilters)?r:[],this.customAttributeFilters=null!=(o=e.customAttributeFilters)?o:[],this.changelogInternal=null!=(a=e.changelogInternal)?a:[],this.changelogExternal=null!=(l=e.changelogExternal)?l:[],this.crossOrigin=t.buildCrossOrigin(e.crossOrigin),this.origins=void 0!==e.origins&&e.origins.length>0?e.origins.map((e=>t.buildOrigin(e))):[];const u=[];for(const[v,b]of Object.entries(e.audiences)){const e=t.buildAudience(v,b);u.push(e)}this.audiences=u;const d=[];for(const[v,b]of Object.entries(e.pages)){const e=t.buildPage(v,b);d.push(e)}this.pages=d;const h=[];for(const[v,b]of Object.entries(e.events)){const e=t.buildEvent(v,b);h.push(e)}this.iEvents=h;for(const[v,b]of Object.entries(e.pages))"metrics"in b&&b.metrics.forEach((e=>{t.getPage(v).ifPresent((i=>{i.addMetric(t.buildMetric(e,void 0,i))}))}));let g=[];void 0!==e.metrics&&(g=e.metrics.map((e=>t.buildMetric(e,void 0,void 0,this)))),this.metrics=g;const p=[];for(const[v,b]of Object.entries(e.campaigns)){const e=t.buildCampaign(v,b,this);p.push(e)}this.campaigns=p;const m=new Map;this.campaigns.forEach((e=>{e.getExperiences().forEach((e=>{m.set(e.getId(),e)}))})),this.experiences=m,void 0!==e.iint&&(void 0!==e.iint.gua&&(this.googleUniversalAnalyticsIntegration=t.buildGoogleUniversalAnalyticsIntegration(e.iint.gua)),void 0!==e.iint.ga4&&(this.googleAnalytics4Integration=t.buildGoogleAnalytics4Integration(e.iint.ga4)),void 0!==e.iint.sg&&(this.segmentAnalyticsIntegration=t.buildSegmentIntegration(e.iint.sg)),void 0!==e.iint.mp&&(this.mixpanelIntegration=t.buildMixpanelIntegration(e.iint.mp)),void 0!==e.iint.marketo&&(this.marketoIntegration=t.buildMarketoIntegration(e.iint.marketo)),void 0!==e.iint.salesforce&&(this.salesforceIntegration=t.buildSalesforceIntegration(e.iint.salesforce)),void 0!==e.iint.shopify&&(this.shopifyIntegration=t.buildShopifyIntegration(e.iint.shopify,this.metrics,this.pages,this.iEvents)),void 0!==e.iint.firmographic&&(this.firmographicIntegration=t.buildFirmographicIntegration(e.iint.firmographic)),void 0!==e.iint.sixsense&&(this.sixsenseIntegration=t.buildSixsenseIntegration(e.iint.sixsense)),void 0!==e.iint.googleAds&&(this.googleAdsIntegration=t.buildGoogleAdsIntegration(e.iint.googleAds)),void 0!==e.iint.demandbase&&(this.demandbaseIntegration=t.buildDemandbaseIntegration(e.iint.demandbase)),void 0!==e.iint.hubspot&&(this.hubspotIntegration=t.buildHubspotIntegration(e.iint.hubspot))),this.mfa=Boolean(e.mfa),void 0!==e.vertical&&(this.vertical=e.vertical),void 0!==e.currentContract&&(this.currentContract=e.currentContract),void 0!==e.timeZone&&(this.timeZone=e.timeZone),void 0!==e.classicAccess&&(this.classicAccess=e.classicAccess),void 0!==e.salesforceAccountId&&(this.salesforceAccountId=e.salesforceAccountId),this.autoUpdateOrigins=e.autoUpdateOrigins,void 0!==e.roiScenario&&(this.roiScenario=e.roiScenario),this.webflowSiteId=e.webflowSiteId}getData(){return this.data}isActive(){return this.active}shouldEncrypt(){return this.encrypt}getSchemaVersion(){return this.schemaVersion}getId(){return this.id}getVersion(){return this.version}getName(){return this.name}getCollaborators(){return this.collaborators}getExcludeIps(){return this.excludeIps}getPlugins(){return this.plugins}getMetrics(){return this.metrics}getControlStickyConfig(){return this.controlStickyConfig}isCampaignControl(){return this.campaignControl}getControlTrafficPercentage(){return D.ofNullable(this.controlTrafficPercentage)}getCode(){return D.ofNullable(this.code)}getCss(){return D.ofNullable(this.css)}getSnippetDomain(){return D.ofNullable(this.snippetDomain)}getCampaigns(){return this.campaigns}getPages(){return this.pages}getAudiences(){return this.audiences}getEvents(){return this.iEvents}getCampaign(e){const t=this.campaigns.filter((t=>t.getId()===e));return 0===t.length?D.empty():D.ofNullable(t[0])}getExperience(e){return D.ofNullable(this.experiences.get(e))}getPage(e){const t=this.pages.filter((t=>t.getId()===e));return 0===t.length?D.empty():D.ofNullable(t[0])}getEvent(e){const t=this.iEvents.filter((t=>t.getId()===e));return 0===t.length?D.empty():D.ofNullable(t[0])}getCustomEvent(e){const t=this.iEvents.filter((t=>t instanceof Ie&&t.getApiName()===e));return 0===t.length?D.empty():D.ofNullable(t[0])}getShopifyEvent(e){const t=this.iEvents.filter((t=>t instanceof Te&&t.getCustomerEventName()===e));return 0===t.length?D.empty():D.ofNullable(t[0])}getShopifyServerSideEvent(){return D.ofNullable(this.iEvents.find((e=>e instanceof xe)))}getAudience(e){const t=this.audiences.filter((t=>t.getId()===e));return 0===t.length?D.empty():D.ofNullable(t[0])}getIntegrationGoogleUniversalAnalytics(){return D.ofNullable(this.googleUniversalAnalyticsIntegration)}getIntegrationGoogle4Analytics(){return D.ofNullable(this.googleAnalytics4Integration)}getIntegrationSegmentAnalytics(){return D.ofNullable(this.segmentAnalyticsIntegration)}getIntegrationMixpanel(){return D.ofNullable(this.mixpanelIntegration)}getIntegrationMarketo(){return D.ofNullable(this.marketoIntegration)}getIntegrationSalesforce(){return D.ofNullable(this.salesforceIntegration)}getIntegrationShopify(){return D.ofNullable(this.shopifyIntegration)}getIntegrationFirmographic(){return D.ofNullable(this.firmographicIntegration)}getIntegrationSixsense(){return D.ofNullable(this.sixsenseIntegration)}getIntegrationGoogleAds(){return D.ofNullable(this.googleAdsIntegration)}getIntegrationDemandbase(){return D.ofNullable(this.demandbaseIntegration)}getIntegrationHubspot(){return D.ofNullable(this.hubspotIntegration)}getUrlParamFilters(){return this.urlParamFilters}getCustomAttributeFilters(){return this.customAttributeFilters}getChangelogInternal(){return this.changelogInternal}getChangelogExternal(){return this.changelogExternal}getCrossOrigin(){return this.crossOrigin}getOrigins(){return this.origins}isMfa(){return this.mfa}getVertical(){return D.ofNullable(this.vertical)}getCurrentContract(){return D.ofNullable(this.currentContract)}getTimeZone(){return D.ofNullable(this.timeZone)}hasClassicAccess(){return D.ofNullable(this.classicAccess).orElse(!1)}getSalesforceAccountId(){return D.ofNullable(this.salesforceAccountId)}shouldAutoUpdateOrigins(){return D.ofNullable(this.autoUpdateOrigins).orElse(!1)}getRoiScenario(){return D.ofNullable(this.roiScenario)}getWebflowSiteId(){return D.ofNullable(this.webflowSiteId)}}class De{constructor(e){K(this,"type"),K(this,"id"),this.type=e.type,this.id=e.id}getType(){return this.type}getId(){return D.ofNullable(this.id)}}class Fe extends De{constructor(e){super(e),K(this,"attributes");const t=__spreadValues({},e.attributes.css);this.attributes=__spreadProps(__spreadValues({},e.attributes),{css:t})}getAttributes(){return this.attributes}isReadyToApply(e){return this.getSelectorElements(e).length>0}getSelectorElements(e){return e.querySelectorAll(this.getSelector())}}class Me extends Fe{constructor(e){super(e),K(this,"selector"),this.selector=e.selector}getSelector(){return this.selector}}class Ne extends De{constructor(e){super(e),K(this,"code"),K(this,"css"),w(Boolean(e.code)||Boolean(e.css),'Either "code" or "css" must be specified'),this.code=e.code,this.css=e.css}getCode(){return D.ofNullable(this.code)}getCss(){return D.ofNullable(this.css)}isReadyToApply(e){return!0}}class Oe extends Fe{constructor(e){super(e),K(this,"refId"),K(this,"extensionName"),K(this,"fieldName"),this.refId=e.refId,this.fieldName=e.fieldName,this.extensionName=e.extensionName}getSelector(){const e=`[data-${u}="${this.refId}"]`,t=`[data-${d}="${this.fieldName}"]`;return`${e}${t}, ${e} ${t}`}getRefId(){return this.refId}getExtensionName(){return this.extensionName}getFieldName(){return this.fieldName}}class Re extends De{constructor(e){super(e),K(this,"name"),K(this,"executorJson"),this.name=e.name,this.executorJson=e.executorJson}getName(){return this.name}getExecutorJson(){return this.executorJson}}function Le(e){return e.replace(/['\\]/g,(e=>"\\"+e))}function $e(e,t=!0){return`document.querySelectorAll('${Le(e)}').length ${t?"> 0":"=== 1"}`}function Ue(e,t){const i=e.querySelectorAll(t),s=null==i?void 0:i[0];return 1===i.length&&void 0!==s?D.of(s):D.empty()}class Ve extends De{constructor(e){super(e),K(this,"elementType"),K(this,"targetPosition"),K(this,"idAttribute"),this.targetPosition=e.targetPosition,this.elementType=e.elementType,this.idAttribute=e.idAttribute}getElementType(){return this.elementType}getTargetPosition(){return this.targetPosition}getIdAttribute(){return this.idAttribute}getTargetElement(e){return Ue(e,this.targetPosition.selector)}isReadyToApply(e){return this.getTargetElement(e).isPresent()}}class We extends Ve{constructor(e){super(e),K(this,"size"),this.size=e.size}getSize(){return this.size}}class ze extends De{constructor(e){super(e),K(this,"targetPosition"),K(this,"selector"),K(this,"moveId"),this.targetPosition=e.targetPosition,this.selector=e.selector,this.moveId=e.moveId}getTargetPosition(){return this.targetPosition}getSelector(){return this.selector}getMoveId(){return this.moveId}getSelectorElement(e){return Ue(e,this.selector)}getTargetElement(e){return Ue(e,this.targetPosition.selector)}isReadyToApply(e){return this.getTargetElement(e).isPresent()&&this.getSelectorElement(e).isPresent()}}var je=(e=>(e.ATTRIBUTE="ATTRIBUTE",e.CUSTOM_CODE="CUSTOM_CODE",e.INSERT_ELEMENT="INSERT_ELEMENT",e.EXTENSION="EXTENSION",e.EXTENSION_ATTRIBUTE="EXTENSION_ATTRIBUTE",e.MOVE_ELEMENT="MOVE_ELEMENT",e.WEBFLOW="WEBFLOW",e))(je||{});class Ge extends De{constructor(e){super(e)}}const Be=e=>{if(!dt(e))return!1;const t=e;return"ATTRIBUTE"===t.type&&v(t.selector)&&wt(t.attributes)},He=e=>Be(e)&&c(e,["type","selector","attributes","id"]),Qe=new Set(["1","2","3","4","5","6"]),qe=e=>Qe.has(e),Ke=e=>{if(!dt(e))return!1;const t=e;return"INSERT_ELEMENT"===t.type&&_(t.elementType)&&m(t.targetPosition)&&r(t.idAttribute)},Ye=e=>!!Ke(e)&&("heading"!==e.elementType||qe(e.size)),Je=["id","type","targetPosition","elementType","size","idAttribute"],Xe=e=>Ye(e)&&c(e,Je),Ze=e=>s(e)&&Object.values(e).every((e=>n(e)||i(e)||t(e)||o(e))),et=e=>s(e)&&(o(e.targetPosition)||m(e.targetPosition))&&Ze(e.fieldData)&&c(e,["targetPosition","fieldData"]),tt=["id","type","name","executorJson"],it=e=>{if(!dt(e))return!1;const t=e;return t.type===je.EXTENSION&&r(t.name)&&et(t.executorJson)},st=e=>it(e)&&c(e,tt),nt=e=>{if(!dt(e))return!1;const t=e;return"EXTENSION_ATTRIBUTE"===t.type&&a(t.refId)&&r(t.extensionName)&&r(t.fieldName)&&wt(t.attributes)},rt=e=>nt(e)&&c(e,["type","attributes","id","refId","extensionName","fieldName"]),ot=e=>s(e)&&e.type===je.MOVE_ELEMENT&&a(e.moveId)&&v(e.selector)&&m(e.targetPosition),at=["id","type","targetPosition","selector","moveId"],lt=e=>ot(e)&&c(e,at),ct=e=>ut(e)&&c(e,["type"]),ut=e=>s(e)&&e.type===je.WEBFLOW,dt=e=>s(e)&&mt(e.type)&&(o(e.id)||r(e.id)),ht=e=>{if(!dt(e))return!1;const t=e,{code:i,css:s}=t;return"CUSTOM_CODE"===t.type&&(void 0!==i||void 0!==s)&&(o(i)||r(i))&&(o(s)||r(s))},gt=e=>ht(e)&&c(e,["type","id","code","css"]),pt=(()=>new Set([je.ATTRIBUTE,je.CUSTOM_CODE,je.INSERT_ELEMENT,je.MOVE_ELEMENT,je.EXTENSION,je.EXTENSION_ATTRIBUTE,je.WEBFLOW]))(),mt=e=>pt.has(e),vt=new Set(J),bt=e=>n(e)&&vt.has(e),ft=e=>s(e)&&r(e.name)&&bt(e.namespace)&&c(e,["name","namespace"]),Et=e=>s(e)&&ft(e.attrDefId)&&n(e.defaultString)&&c(e,["defaultString","attrDefId"]),_t=e=>s(e)&&"attribute"===e.type&&Et(e.value)&&c(e,["type","value"]),yt=e=>s(e)&&"string"===e.type&&r(e.value)&&c(e,["type","value"]),St=e=>yt(e)||_t(e),It=t=>n(t)||e(t)&&t.every((e=>St(e))),wt=e=>!(!s(e)||!o(e.html)&&!It(e.html)||!o(e.style)&&!n(e.style)||!o(e.className)&&!n(e.className)||!o(e.src)&&!n(e.src)||!o(e.alt)&&!n(e.alt)||!o(e.srcset)&&!n(e.srcset)||!o(e.sizes)&&!n(e.sizes)||!o(e.href)&&!n(e.href)||!o(e.value)&&!n(e.value)||!o(e.placeholder)&&!n(e.placeholder)||!o(e.maxlength)&&!i(e.maxlength)||!o(e.required)&&!t(e.required)||!o(e.poster)&&!n(e.poster)||!o(e.loop)&&!t(e.loop)||!o(e.autoplay)&&!t(e.autoplay)||!o(e.muted)&&!t(e.muted)||!o(e.controls)&&!t(e.controls)||!o(e.css)&&!f(e.css))&&c(e,["html","style","className","src","alt","srcset","sizes","href","css","value","placeholder","maxlength","required","poster","loop","autoplay","muted","controls"]);function Ct(e){if(He(e))return new Me(e);if(gt(e))return new Ne(e);if(lt(e))return new ze(e);if(Xe(e)){if("heading"===e.elementType)return new We(e);return new Ve(e)}if(st(e))return new Re(e);if(rt(e))return new Oe(e);if(ct(e))return new Ge(e);throw new y(`Invalid dom change type ${e.type}`)}class Tt{constructor(e,t,i,s){var n,r,o,a;K(this,"allVariationsMap",{}),K(this,"id"),K(this,"name"),K(this,"type"),K(this,"state"),K(this,"pages"),K(this,"condition"),K(this,"audiences"),K(this,"realPreconditions"),K(this,"preconditions"),K(this,"dependsOnExperienceIds"),K(this,"dependsOnExperiences",[]),K(this,"realVariations"),K(this,"campaign"),K(this,"ignore"),K(this,"inclusionStickyConfig"),K(this,"variationStickyConfig"),K(this,"boundingSelectors"),K(this,"playbookId"),K(this,"note"),this.id=e,this.name=t.name,this.type=null!=(n=t.type)?n:"cc",this.state=t.state,this.inclusionStickyConfig=i.buildExperienceIncludeStickyConfig(t.sinc),this.variationStickyConfig=i.buildVariationStickyConfig(t.svar),this.ignore=t.ignore,this.playbookId=t.playbookId,this.note=t.note,this.pages=t.pageIds.flatMap((e=>i.getPage(e).toArray())),this.pages.forEach((e=>{e.addExperience(this)})),this.condition=i.buildConditionFromVariationOrExperience(t),this.audiences=gi.addExperienceToAudiences(this),this.dependsOnExperienceIds=null!=(r=t.dependsOnExperienceIds)?r:[],this.dependsOnExperiences=[];const l=[];for(const[c,u]of Object.entries(t.variations)){const e=i.buildVariation(c,u,this);l.push(e),this.allVariationsMap[c]=e}this.realVariations=l,this.boundingSelectors=null!=(o=t.boundingSelectors)?o:[],this.realPreconditions=null!=(a=t.preconditions)?a:[],this.preconditions=[...this.realPreconditions,...this.generatePreconditionsForBoundingSelectors()],this.campaign=s}inflateDependsOnExperiences(e){this.dependsOnExperienceIds.forEach((t=>{const i=e[t];void 0!==i&&this.dependsOnExperiences.push(i)}))}getId(){return this.id}getName(){return this.name}getType(){return this.type}isEnabled(){return"live"===this.state}getState(){return this.state}getPages(){return this.pages}getCondition(){return D.ofNullable(this.condition)}getAudiences(){return this.audiences}getPreconditions(){return this.preconditions}getBoundingSelectors(){return this.boundingSelectors}getRealPreconditions(){return this.realPreconditions}getDependsOnExperiences(){return this.dependsOnExperiences}getRealVariations(){return this.realVariations}getVariation(e){return D.ofNullable(this.allVariationsMap[e])}getCampaign(){return this.campaign}getInclusionStickyConfig(){return this.inclusionStickyConfig}getVariationStickyConfig(){return this.variationStickyConfig}getIgnore(){return this.ignore}getPlaybookId(){return D.ofNullable(this.playbookId)}getNote(){return D.ofNullable(this.note)}generatePreconditionsForBoundingSelectors(){const e=[];return this.boundingSelectors.forEach((t=>{e.push($e(t))})),e}}class xt extends Tt{constructor(e,t,i,s){super(e,t,i,s),K(this,"logger"),K(this,"trafficAllocation"),this.logger=i.getLogger(),this.trafficAllocation=t.trafficAllocation}static filterExperiences(e){return e.filter((e=>"ab"===e.getType()))}selectVariation(e){let t;for(const[i,s]of Object.entries(this.trafficAllocation))if(e>=s.lowerEndpoint&&e<s.upperEndpoint){t=i;break}return void 0!==t?this.getVariation(t):(this.logger.error(`Could not determine A/B variation for ${e}`,1012,{experienceId:this.getId()}),D.empty())}getTrafficAllocation(){const e={};for(const[t,i]of Object.entries(this.trafficAllocation))e[t]=__spreadValues({},i);return e}}class At extends Tt{constructor(e,t,i,s){super(e,t,i,s),K(this,"controlVariation");const n=i.buildControlVariation(this);this.controlVariation=n,this.allVariationsMap[n.getId()]=n}static filterExperiences(e){return e.filter((e=>"cc"===e.getType()))}getControlVariation(){return this.controlVariation}}class kt extends Tt{constructor(e,t,i,s){super(e,t,i,s),K(this,"logger"),K(this,"variationPriority"),this.logger=i.getLogger(),this.variationPriority=t.variationPriority}static filterExperiences(e){return e.filter((e=>"rbp"===e.getType()))}getPrioritizedVariations(){const e=[];if(void 0!==this.variationPriority)for(const t of this.variationPriority)this.getVariation(t).ifPresent((t=>{e.push(t)})).ifAbsent((()=>{this.logger.debug("Could not find prioritized variation for RBP",1013,{experienceId:this.getId(),variationId:t})}));return e}}class Pt{constructor(e){K(this,"enabled"),this.enabled=e.enabled}isEnabled(){return this.enabled}}class Dt{constructor(e){K(this,"enabled"),this.enabled=e.enabled}isEnabled(){return this.enabled}}class Ft{constructor(e){K(this,"enabled"),K(this,"managedAccounts"),this.enabled=e.enabled,this.managedAccounts=e.managedAccounts}isEnabled(){return this.enabled}getManagedAccounts(){return this.managedAccounts}}class Mt{constructor(e){K(this,"enabled"),K(this,"autoConfig"),K(this,"measurementIds"),this.enabled=e.enabled,this.autoConfig=e.autoConfig,this.measurementIds=e.measurementIds}isEnabled(){return this.enabled}isAutoConfig(){return this.autoConfig}getMeasurementIds(){return this.measurementIds}}class Nt{constructor(e){K(this,"enabled"),K(this,"autoConfig"),K(this,"trackingIds"),K(this,"dimensionName"),this.enabled=e.enabled,this.autoConfig=e.autoConfig,this.trackingIds=e.trackingIds,this.dimensionName=e.dimensionName}isEnabled(){return this.enabled}isAutoConfig(){return this.autoConfig}getTrackingIds(){return this.trackingIds}getDimensionName(){return D.ofNullable(this.dimensionName)}}class Ot{constructor(e){K(this,"enabled"),K(this,"hubId"),K(this,"objectsToIngest"),this.enabled=e.enabled,this.hubId=e.hubId,this.objectsToIngest=e.objectsToIngest}isEnabled(){return this.enabled}getHubId(){return this.hubId}getObjectsToIngest(){return this.objectsToIngest}}class Rt{constructor(e){K(this,"enabled"),K(this,"munchkinId"),K(this,"fieldsToIngest"),K(this,"listsToIngest"),this.enabled=e.enabled,this.munchkinId=e.munchkinId,this.fieldsToIngest=e.fieldsToIngest,this.listsToIngest=e.listsToIngest}isEnabled(){return this.enabled}getMunchkinId(){return this.munchkinId}getFieldsToIngest(){return this.fieldsToIngest}getListsToIngest(){return this.listsToIngest}}class Lt{constructor(e){K(this,"enabled"),this.enabled=e.enabled}isEnabled(){return this.enabled}}class $t{constructor(e){K(this,"enabled"),K(this,"objectsToIngest"),K(this,"outboundReport"),this.enabled=e.enabled,this.objectsToIngest=e.objectsToIngest,this.outboundReport=e.outboundReport}isEnabled(){return this.enabled}getObjectsToIngest(){return this.objectsToIngest}getOutboundReport(){return D.ofNullable(this.outboundReport)}}class Ut{constructor(e){K(this,"enabled"),K(this,"eventName"),this.enabled=e.enabled,this.eventName=e.dim}isEnabled(){return this.enabled}getEventName(){return this.eventName}}class Vt{constructor(e,t,i){var s,n;K(this,"logger"),K(this,"id"),K(this,"name"),K(this,"type"),K(this,"state"),K(this,"iEvents",[]),K(this,"experiences",[]),K(this,"metrics",[]),K(this,"code"),K(this,"timeBudget"),K(this,"changes"),this.logger=i.getLogger(),this.id=e,this.name=t.name,this.type=null!=(s=t.type)?s:"matching",void 0!==t.code&&(this.code=t.code),void 0!==t.timeBudget&&(this.timeBudget=t.timeBudget);const r=[];void 0!==t.changes&&t.changes.forEach((e=>{r.push(i.buildDomChange(e))})),this.changes=r,this.state=null!=(n=t.state)?n:"live"}addEvent(e){this.iEvents.push(e)}addMetric(e){this.metrics.push(e)}addExperience(e){this.experiences.push(e)}getId(){return this.id}getName(){return this.name}getType(){return this.type}getState(){return this.state}getCode(){return D.ofNullable(this.code)}getChanges(){return[...this.changes]}getExperiences(){return[...this.experiences]}getEvents(){return[...this.iEvents]}getTimeBudgetMs(){return D.ofNullable(this.timeBudget)}getMetrics(){return[...this.metrics]}getMetric(e){const t=this.metrics.filter((t=>t.getId()===e));return 0===t.length?D.empty():D.ofNullable(t[0])}executeCode(e){this.logger.debug("executeCode() if present");let t=!0;if(this.getCode().isPresent()){const s=this.getCode().get();try{this.logger.info(`Page ${this.id} code running`),t=e(s),this.logger.info(`Page ${this.id} code result => ${t}`)}catch(i){const e=new Ee(`Page (${this.id}) code execution failed`,i);t=!1,this.logger.error(e,1009,{pageId:this.id})}}return t}}class Wt extends Vt{constructor(e,t,i){var s,n;super(e,t,i),K(this,"templateUrl"),K(this,"paramName"),K(this,"paramValue"),this.templateUrl=t.templateUrl,this.paramName=null!=(s=t.paramName)?s:Wt.defaultParamName,this.paramValue=null!=(n=t.paramValue)?n:Wt.landingPageNameToParamValue(t.name)}static filterPages(e){return e.filter((e=>"landing"===e.getType()))}static removeWWW(e){return e.replace(/^www\./i,"")}static get defaultParamName(){return"page"}static landingPageNameToParamValue(e){return e.trim().replace(/[^\w\-._~!'()*]+/g,"-")}getTemplateUrl(){return this.templateUrl}getParamName(){return this.paramName}getParamValue(){return this.paramValue}getPreviewUrl(){const{name:e,value:t}=this.determineLandingParam(),i=`${encodeURIComponent(e)}=${encodeURIComponent(t)}`,s=this.templateUrl.indexOf("?");if(-1!==s)return this.templateUrl.slice(0,s+1)+i+"&"+this.templateUrl.slice(s+1);const n=this.templateUrl.indexOf("#");return-1!==n?this.templateUrl.slice(0,n)+"?"+i+this.templateUrl.slice(n):this.templateUrl+"?"+i}matches(e,t){this.logger.group("check page matches");try{const i=new URL(e),s=new URL(this.templateUrl);let n=!0;s.searchParams.forEach(((e,t)=>{i.searchParams.getAll(t).includes(e)||(n=!1)}));const r=D.ofNullable(s.hash).map((e=>e===i.hash)).orElse(!0),{name:o,value:a}=this.determineLandingParam(),l=i.searchParams.getAll(o).includes(a),c=Wt.removeWWW(i.host)===Wt.removeWWW(s.host),u=i.protocol===s.protocol&&i.port===s.port&&i.pathname===s.pathname&&c&&n&&l&&r,d=this.executeCode(t);return this.logger.debug(`didMatch: ${u.toString()}, didPassCode: ${d.toString()}`),this.logger.groupEnd(),u&&d}catch(i){const e=new Ee("Could not parse URL",i);return this.logger.warn(e,1018,{pageId:this.getId()}),!1}}determineLandingParam(){return{name:this.getParamName(),value:this.getParamValue()}}}const zt=(e,t,i,s)=>{e.group("check page matches");const n=i.some((i=>{e.group("check url");const s=i.matches(t);return e.groupEnd(),s})),r=s();return e.debug(`didMatch: ${n.toString()}, didPassCode: ${r.toString()}`),e.groupEnd(),n&&r};class jt extends Vt{constructor(e,t,i){super(e,t,i),K(this,"urls"),K(this,"previewUrl");const s=[];t.urls.forEach((e=>{s.push(i.buildUrl(e))})),this.urls=s,this.previewUrl=t.previewUrl}static filterPages(e){return e.filter((e=>"matching"===e.getType()))}getPreviewUrl(){return this.previewUrl}getUrls(){return this.urls}matches(e,t){return zt(this.logger,e,this.urls,(()=>this.executeCode(t)))}}class Gt extends Vt{constructor(e,t,i){super(e,t,i),K(this,"urls"),K(this,"previewUrl");const s=[];t.urls.forEach((e=>{s.push(i.buildUrl(e))})),this.urls=s,this.previewUrl=t.previewUrl}static filterPages(e){return e.filter((e=>"shopify"===e.getType()))}getPreviewUrl(){return this.previewUrl}getUrls(){return this.urls}matches(e,t){return zt(this.logger,e,this.urls,(()=>this.executeCode(t)))}}class Bt{constructor(e,t,i,s){let n;if(K(this,"legacy"),K(this,"shopifyMetric"),K(this,"shopifyPages"),K(this,"shopifyEvents"),K(this,"shopifyCheckoutCompletedEvent"),K(this,"shop"),K(this,"snippet"),K(this,"plus"),Bt.isLegacyShopifyIntegrationJson(e)){this.legacy=!0;const t=e;n={shop:`${t.shop}.myshopify.com`,snippet:t.theme,plus:!0};const s=[];i.forEach((e=>{t.pages.includes(e.getId())&&s.push(e)})),this.shopifyPages=s}else this.legacy=!1,n=e,this.shopifyPages=Gt.filterPages(i);this.shop=n.shop,this.snippet=n.snippet,this.plus=n.plus,this.shopifyEvents=Te.filterEvents(s);const r=this.shopifyEvents.find((e=>"checkout_completed"===e.getCustomerEventName()));S(r,'The shopify "checkout_completed" event must be present'),this.shopifyCheckoutCompletedEvent=r,this.shopifyMetric=t.find((e=>e.getIEvents().find((e=>e.getId()===this.shopifyCheckoutCompletedEvent.getId()))))}static isLegacyShopifyIntegrationJson(e){return void 0!==e.pixel}isPixelEnabled(){return!0}isLegacy(){return this.legacy}getShop(){return this.shop}getMetric(){return D.ofNullable(this.shopifyMetric)}getPages(){return this.shopifyPages}getEvents(){return this.shopifyEvents}getCheckoutCompletedEvent(){return this.shopifyCheckoutCompletedEvent}doesInjectSnippet(){return this.snippet}isShopifyPlus(){return this.plus}}class Ht{constructor(e){K(this,"enabled"),K(this,"oemEnabled"),this.enabled=e.enabled,this.oemEnabled=e.oemEnabled}isEnabled(){return this.enabled}isOemEnabled(){return this.oemEnabled}}class Qt{constructor(e,t,i,s,n){K(this,"id"),K(this,"name"),K(this,"iEvents"),K(this,"scope"),K(this,"type"),K(this,"countingMethod"),K(this,"goal"),K(this,"page"),K(this,"campaign"),K(this,"customer"),w(void 0===i||void 0===n),this.id=e.id,this.name=e.name,this.scope=e.scope,this.type=e.type,this.countingMethod=e.countingMethod,this.goal=e.isGoal,this.iEvents=e.eventIds.flatMap((e=>t.getEvent(e).toArray())),this.iEvents.forEach((e=>{e.addMetric(this)})),this.campaign=i,this.page=s,this.customer=n}getId(){return this.id}getName(){return this.name}getIEvents(){return this.iEvents}getScope(){return this.scope}getType(){return this.type}getCountingMethod(){return this.countingMethod}isGoal(){return this.goal}getCampaign(){return D.ofNullable(this.campaign)}getPage(){return D.ofNullable(this.page)}getCustomer(){return D.ofNullable(this.customer)}}class qt extends Qt{constructor(e,t,i,s,n){super(e,t,i,s,n),K(this,"valueType"),this.valueType=e.valueType}getValueType(){return this.valueType}}class Kt extends qt{constructor(e,t,i,s,n){super(e,t,i,s,n),K(this,"value"),this.value=e.value}getValue(){return this.value}}const Yt="exists",Jt="notExists";function Xt(e,t=!1){return i=>i.map((t=>e(t))).orElse(t)}function Zt(e){switch(e.operator){case"includesAny":return Xt((t=>t.some((t=>e.argument.includes(t)))));case"excludesAll":return Xt((t=>!t.some((t=>e.argument.includes(t)))),!0);case Yt:return e=>e.isPresent();case Jt:return e=>!e.isPresent();default:throw new Error(`Unknown array enum operator: ${e.operator}`)}}function ei(e){switch(e.operator){case"includesAny":return Xt((t=>t.some((t=>e.argument.includes(t)))));case Yt:return e=>e.isPresent();case Jt:return e=>!e.isPresent();default:throw new Error(`Unknown array string operator: ${e.operator}`)}}function ti(e){switch(e.operator){case"isTrue":return Xt((e=>e));case"isFalse":return Xt((e=>!e),!0);case Yt:return e=>e.isPresent();case Jt:return e=>!e.isPresent();default:throw new Error(`Unknown boolean operator: ${e.operator}`)}}function ii(e){switch(e.operator){case"eq":return Xt((t=>t===e.argument));case"ne":return Xt((t=>t!==e.argument),!0);case Yt:return e=>e.isPresent();case Jt:return e=>!e.isPresent();default:throw new Error(`Unknown enum operator: ${e.operator}`)}}function si(e){switch(e.operator){case"==":return Xt((t=>t===e.argument));case"!=":return Xt((t=>t!==e.argument),!0);case">":return Xt((t=>t>e.argument));case"<":return Xt((t=>t<e.argument));case">=":return Xt((t=>t>=e.argument));case"<=":return Xt((t=>t<=e.argument));case Yt:return e=>e.isPresent();case Jt:return e=>!e.isPresent();default:throw new Error(`Unknown number operator: ${e.operator}`)}}function ni(e){switch(e.operator){case"eq":return Xt((t=>t===e.argument));case"ne":return Xt((t=>t!==e.argument),!0);case"substr":return Xt((t=>t.includes(e.argument)));case"startsWith":return Xt((t=>t.startsWith(e.argument)));case"endsWith":return Xt((t=>t.endsWith(e.argument)));case"regex":return Xt((t=>new RegExp(e.argument).test(t)));case Yt:return e=>e.isPresent();case Jt:return e=>!e.isPresent();default:throw new Error(`Unknown string operator: ${e.operator}`)}}function ri(e){switch(e.operator){case"withinPastDuration":return Xt((t=>{const i=/^P(\d+)D$/.exec(e.argument);if(void 0===(null==i?void 0:i[1]))throw new Error(`Invalid unix time operator duration: ${e.argument}`);const s=24*Number(i[1])*60*60*1e3;return t>=Date.now()-s}));case"inBetween":return Xt((t=>{const[i,s]=e.argument;return t>=i&&t<s}));case Yt:return e=>e.isPresent();case Jt:return e=>!e.isPresent();default:throw new Error(`Unknown unix time operator: ${e.operator}`)}}const oi=e=>{const t=/[|\\{}()[\]^$+*?.-]/g;return e.replace(t,"\\$&")};class ai{constructor(e){K(this,"includeSubdomains"),K(this,"domain"),K(this,"port"),this.includeSubdomains=e.includeSubdomains,this.domain=e.domain,this.port=e.port}static isMatchingAllowedDomain(e,t){return new RegExp(`^${e}$`).test(t)}getIncludeSubdomains(){return this.includeSubdomains}getDomain(){return this.domain}getPort(){return D.ofNullable(this.port)}getDomainAndPort(){return void 0===this.port?this.domain:`${this.domain}:${this.port}`}isOriginAllowed(e){const t=this.getDomainAndPort();let i="https?://";return i+=this.includeSubdomains?"([^.]+\\.)?":"(www\\.)?",i+=oi(t),ai.isMatchingAllowedDomain(i,e)}}class li{constructor(e,t,i){this.sticky=e,this.relativeExpirationTimeSec=t,this.absoluteExpirationTimeSec=i}isSticky(){return this.sticky}getRelativeExpirationTimeSec(){return D.ofNullable(this.relativeExpirationTimeSec)}getAbsoluteExpirationTimeSec(){return D.ofNullable(this.absoluteExpirationTimeSec)}isExpired(e,t){return void 0!==this.absoluteExpirationTimeSec&&t<this.absoluteExpirationTimeSec||void 0!==this.relativeExpirationTimeSec&&t+this.relativeExpirationTimeSec<e}}const ci="118",ui=["checkout_completed","checkout_started","collection_viewed","product_added_to_cart","product_viewed","search_submitted"];class di{constructor(e,t){K(this,"logger"),K(this,"value"),K(this,"match"),this.logger=t.getLogger(),this.value=e.value,this.match=e.match,w(void 0!==this.match,"invalid match type: "+e.match)}static simplifyUrl(e){let t=e;const i=t.indexOf("?");i>0&&(t=t.slice(0,Math.max(0,i)));const s=t.indexOf("#");s>0&&(t=t.slice(0,Math.max(0,s))),t.endsWith("/")&&(t=t.slice(0,Math.max(0,t.length-1)));const n=/^(?:https?:\/\/)?(?:www\.)?(.+)$/.exec(t);return void 0!==(null==n?void 0:n[1])&&(t=n[1]),t}getMatch(){return this.match}getValue(){return this.value}matches(e){let t=!1;switch(this.logger.debug("checking match: "+this.match+", value: "+this.value),this.match){case"simple":t=di.simplifyUrl(this.value)===di.simplifyUrl(e);break;case"regex":{const i=new RegExp(this.value);t=Boolean(i.test(e));break}case"exact":t=e===this.value;break;case"substring":t=e.includes(this.value);break;default:this.logger.error(`Unknown url match type: ${this.match}`,1010)}return this.logger.debug(t.toString()),t}}class hi{constructor(e,t,i,s){K(this,"id"),K(this,"name"),K(this,"state"),K(this,"condition"),K(this,"audiences"),K(this,"preconditions"),K(this,"code"),K(this,"redirect"),K(this,"css"),K(this,"changes"),K(this,"experience"),K(this,"playbookTemplateId"),this.id=e,this.name=t.name,this.state=t.state,this.preconditions=t.preconditions,void 0!==t.code&&(this.code=t.code),void 0!==t.redirect&&(this.redirect=t.redirect),void 0!==t.css&&(this.css=t.css),this.condition=i.buildConditionFromVariationOrExperience(t),this.audiences=gi.addVariationToAudiences(this);const n=[];void 0!==t.changes&&t.changes.forEach((e=>{n.push(i.buildDomChange(e))})),this.changes=n,this.experience=s,this.playbookTemplateId=t.playbookTemplateId}getId(){return this.id}getName(){return this.name}isEnabled(){return"live"===this.state}getState(){return this.state}getCode(){return D.ofNullable(this.code)}getCss(){return D.ofNullable(this.css)}getRedirect(){return D.ofNullable(this.redirect)}getPreconditions(){return this.preconditions}getCondition(){return D.ofNullable(this.condition)}getAudiences(){return this.audiences}getChanges(){return this.changes}isTypeChange(){return this.getChanges().length>0}isRedirect(){return this.getRedirect().isPresent()}getExperience(){return this.experience}getTrafficAllocation(){if(this.experience instanceof xt){const e=this.experience.getTrafficAllocation()[this.id];if(void 0!==e)return D.of(__spreadValues({},e))}return D.empty()}getPlaybookTemplateId(){return D.ofNullable(this.playbookTemplateId)}}class gi{constructor(e){K(this,"logger"),K(this,"experienceMap",{}),K(this,"pageMap",{}),K(this,"audienceMap",{}),K(this,"eventMap",{}),this.logger=e}static buildStickyConfiguration(e,t){let i,s,n;return void 0!==e&&(void 0!==e.s&&(i=e.s),void 0!==e.r&&(s=e.r),void 0!==e.a&&(n=e.a)),void 0===i&&(i=t.s),void 0===s&&void 0!==t.r&&(s=t.r),void 0===n&&void 0!==t.a&&(n=t.a),new li(i,s,n)}static addExperienceToAudiences(e){const t=[];return e.getCondition().ifPresent((i=>{if(i instanceof te)t.push(gi.addExperienceToAudience(e,i));else if(i instanceof ee||i instanceof re)i.getConditions().forEach((i=>{if(i instanceof te)t.push(gi.addExperienceToAudience(e,i));else if(i instanceof ne){const s=i.getCondition();s instanceof te&&(s.getAudience().addExperience(e),t.push(s.getAudience()))}}));else if(i instanceof ne){const s=i.getCondition();s instanceof te&&(s.getAudience().addExperience(e),t.push(s.getAudience()))}})),t}static addVariationToAudiences(e){const t=[];return e.getCondition().ifPresent((i=>{if(i instanceof te)t.push(gi.addVariationToAudience(e,i));else if(i instanceof ee||i instanceof re)i.getConditions().forEach((i=>{if(i instanceof te)t.push(gi.addVariationToAudience(e,i));else if(i instanceof ne){const s=i.getCondition();s instanceof te&&(s.getAudience().addVariation(e),t.push(s.getAudience()))}}));else if(i instanceof ne){const s=i.getCondition();s instanceof te&&(s.getAudience().addVariation(e),t.push(s.getAudience()))}})),t}static addExperienceToAudience(e,t){const i=t.getAudience();return t.getAudience().addExperience(e),i}static addVariationToAudience(e,t){const i=t.getAudience();return t.getAudience().addVariation(e),i}static audienceIdToConditionJson(e){let t=!1,i=e;e.startsWith("!")&&(t=!0,i=e.slice(1));const s={audienceId:i,type:"audience"};let n=s;return t&&(n={type:"logic-not",condition:s}),n}getLogger(){return this.logger}buildCustomer(e){const t=new Pe(e,this);return t.getCampaigns().forEach((e=>{e.getExperiences().forEach((e=>{e.inflateDependsOnExperiences(this.experienceMap)}))})),t}buildCollaborator(e){return new ve(e)}buildCrossOrigin(e){return new be(e)}buildOrigin(e){return new ai(e)}buildPage(e,t){const i=this.pageMap[e];if(void 0!==i)return this.logger.warn(`Trying to build page twice ${e}`,1e3,{pageId:e}),i;const s=this.buildTypedPage(e,t);return this.pageMap[e]=s,s}buildTypedPage(e,t){return"matching"===t.type?new jt(e,t,this):"landing"===t.type?new Wt(e,t,this):"shopify"===t.type?new Gt(e,t,this):new jt(e,t,this)}getPage(e){return D.ofNullable(this.pageMap[e]).ifAbsent((()=>{this.logger.error(`Could not find page in builder map ${e}`,1001,{pageId:e})}))}buildAudience(e,t){const i=this.audienceMap[e];if(void 0!==i)return this.logger.warn(`Trying to build audience twice ${e}`,1002,{audienceId:e}),i;const s=new oe(e,t,this);return this.audienceMap[e]=s,s}buildConditionFromVariationOrExperience({audienceIds:e,condition:t}){const i=[];if(void 0!==e&&e.length>0&&e.forEach((e=>{i.push(gi.audienceIdToConditionJson(e))})),void 0!==t&&("logic-and"===t.type?i.push(...t.conditions):i.push(t)),0===i.length)return;const[s]=i;return 1===i.length&&void 0!==s?this.buildCondition(s):this.buildCondition({conditions:i,type:"logic-and"})}buildCondition(e,t){switch(e.type){case"logic-not":return new ne(e,this);case"logic-and":return new ee(e,this);case"logic-or":return new re(e,this);case"comparison-number":return new se(e,new Y(e.attrDefId),si({operator:e.operator,argument:e.value}));case"comparison-string":return new se(e,new Y(e.attrDefId),ni({operator:e.operator,argument:e.value}));case"comparison-enum":return new se(e,new Y(e.attrDefId),ii({operator:e.operator,argument:e.value}));case"comparison-boolean":return new se(e,new Y(e.attrDefId),ti({operator:e.operator,argument:void 0}));case"comparison-array-string":return new se(e,new Y(e.attrDefId),ei({operator:e.operator,argument:e.value}));case"comparison-array-enum":return new se(e,new Y(e.attrDefId),Zt({operator:e.operator,argument:e.value}));case"audience":return new te(e,this,t);case"code":return new ie(e);case"activity":return new Z(e,this.buildActivityFilter(e.filter),(()=>this.buildAggregator(e.aggregation)),si(e.operation),this.getLogger());default:throw new Error(`Unknown ConditionType: ${e.type}`)}}buildActivityFilter(e){switch(e.type){case"logic-not":return new ge(e,this);case"logic-and":return new de(e,this);case"logic-or":return new pe(e,this);case"comparison-number":return new he(this.getActivityPathValue(e.fieldName,["number"]),si(e.operation));case"comparison-string":return new he(this.getActivityPathValue(e.fieldName,["string"]),ni(e.operation));case"comparison-enum":return new he(this.getActivityPathValue(e.fieldName,["string"]),ii(e.operation));case"comparison-array-enum":return new he(this.getActivityPathValue(e.fieldName,["array-enum"]),Zt(e.operation));case"comparison-unix-time":return new he(this.getActivityPathValue(e.fieldName,["number"]),ri(e.operation));default:throw new Error(`Unknown activity filter type: ${e.type}`)}}buildAggregator(e){switch(e.type){case"count":return new ae;case"sum":return new ue(this.getActivityPathValue(e.fieldName,["number"]));case"mean":return new ce(this.getActivityPathValue(e.fieldName,["number"]));case"countDistinct":return new le(this.getActivityPathValue(e.fieldName,["string","number"]));default:throw new Error(`Unknown aggregator type: ${e.type}`)}}getAudience(e){return D.ofNullable(this.audienceMap[e]).orElseRun((()=>(this.logger.error(`Could not find audience in builder map ${e}`,1003,{audienceId:e}),new oe(e,{name:`Missing Audience ${e}`,code:'throw new Error("Missing audience");'},this))))}buildEvent(e,t){const i=this.eventMap[e];if(void 0!==i)return this.logger.warn(`Trying to build event twice ${e}`,1004,{eventId:e}),i;const s=this.buildTypedEvent(e,t);return this.eventMap[e]=s,s}buildTypedEvent(e,t){if("click"===t.type)return new Se(e,t,this);if("view"===t.type)return new Ae(e,t,this);if("custom"===t.type)return new Ie(e,t,this);if("shopify"===t.type)return new Te(e,t,this);if("shopify_server_side"===t.type)return new xe(e,t,this);if("marketo"===t.type)return new Ce(e,t,this);if("hubspot"===t.type)return new we(e,t,this);if("wf_engagement_click"===t.type)return new ke(e,t,this);throw new y(`Invalid event type ${t.type}`)}getEvent(e){return D.ofNullable(this.eventMap[e]).ifAbsent((()=>{this.logger.error(`Could not find event in builder map ${e}`,1005,{eventId:e})}))}buildCampaign(e,t,i){return new me(e,t,this,i)}buildExperience(e,t,i){const s=this.experienceMap[e];if(void 0!==s)return this.logger.warn(`Trying to build experience twice ${e}`,1006,{experienceId:e}),s;const n=this.buildTypedExperience(e,t,i);return this.experienceMap[e]=n,n}buildTypedExperience(e,t,i){return"ab"===t.type?new xt(e,t,this,i):"rbp"===t.type?new kt(e,t,this,i):new At(e,t,this,i)}buildMetric(e,t,i,s){return w(Boolean(t)&&void 0===s&&void 0===i||Boolean(s)&&void 0===t&&void 0===i||Boolean(i)&&void 0===s&&void 0===t),"value"===e.type?"static"===e.valueType?new Kt(e,this,t,i,s):new qt(e,this,t,i,s):new Qt(e,this,t,i,s)}buildUrl(e){return new di(e,this)}buildVariation(e,t,i){return new hi(e,t,this,i)}buildControlVariation(e){const t={name:"Intellimize Control",state:"live",preconditions:[]};return this.buildVariation(ci,t,e)}buildControlStickyConfig(e){return gi.buildStickyConfiguration(e,{s:!0})}buildExperienceIncludeStickyConfig(e){return gi.buildStickyConfiguration(e,{s:!0})}buildVariationStickyConfig(e){return gi.buildStickyConfiguration(e,{s:!0,r:302400})}buildGoogleUniversalAnalyticsIntegration(e){return new Nt(e)}buildGoogleAnalytics4Integration(e){return new Mt(e)}buildSegmentIntegration(e){return new Ut(e)}buildMixpanelIntegration(e){return new Lt(e)}buildMarketoIntegration(e){return new Rt(e)}buildSalesforceIntegration(e){return new $t(e)}buildShopifyIntegration(e,t,i,s){return new Bt(e,t,i,s)}buildFirmographicIntegration(e){return new Dt(e)}buildSixsenseIntegration(e){return new Ht(e)}buildGoogleAdsIntegration(e){return new Ft(e)}buildDemandbaseIntegration(e){return new Pt(e)}buildHubspotIntegration(e){return new Ot(e)}buildDomChange(e){return Ct(e)}getActivityPathValue(t,i){return s=>{let n=t,r=s;for(;void 0!==r&&void 0!==n;){const s=n.split(".");if(!(s.length>1&&void 0!==s[0])){const s=r[n];let o=typeof s;return e(s)&&s.every((e=>"string"==typeof e))&&(o="array-enum"),i.includes(o)?D.ofNullable(s):(void 0!==s&&this.logger.warn(`Field "${t}" is not an allowed type (wanted ${i.join(", ")}; found ${o})`,1017),D.empty())}r=r[s[0]],n=s.slice(1).join(".")}return D.empty()}}}const pi="imize-move-id",mi=D.ofNullable("v5.fe4b1dde").orElse("NA"),vi=1e3,bi=50,NO_PROGRESS_TOLERANCE_TIME_MS=48e4,fi=1800,Ei=86400,_i=3600,yi=500,Si=1e3,Ii=1,wi="api.intellimize.co",Ci="log.intellimize.co",Ti="intellimize_api_",xi="intellimize_attributes_",Ai="intellimize_integrations_",ki="intellimize_",Pi="intellimize_policy_",Di="intellimize_server_context_",Fi="intellimize_activity_",Mi="intellimize_user_",Ni="intellimize_opt_out_",Oi="intellimize_shopify_",Ri="intellimize_status_module_",Li="_mkto_trk",$i="hubspotutk",Ui="wf",Vi=L.LogLevel.WARN,Wi=L.LogLevel.OFF,zi=["utt","utm","uts","utcn","utcm"],ji="mkt_tok",Gi="_hsenc";function Bi(e,t,i){try{return Hi(e,t,i)}catch(s){return"CAN_NOT_SERIALIZE"}}function Hi(e,t,i){let s;if(void 0!==Array.prototype.toJSON&&"[3]"!==JSON.stringify([3])){const n=Array.prototype.toJSON;delete Array.prototype.toJSON,s=JSON.stringify(e,t,i),Array.prototype.toJSON=n}else s=JSON.stringify(e,t,i);return s}function Qi(e){return JSON.parse(e)}function qi(e){const t={type:e.type,target:Yi(e.target)};return e.addedNodes&&e.addedNodes.length>0&&(t.addedNodes=Array.prototype.map.call(e.addedNodes,Yi)),e.removedNodes&&e.removedNodes.length>0&&(t.removedNodes=Array.prototype.map.call(e.removedNodes,Yi)),e.attributeName&&(t.attributeName=e.attributeName),e.oldValue&&(t.oldValue=e.oldValue),Hi(t)}function Ki(e){return Hi(Yi(e))}function Yi(e){const t={nodeName:e.nodeName};return null!==e.textContent&&e.textContent.length<500&&(t.textContent=e.textContent),e instanceof Element&&(e.id&&(t.id=e.id),e.classList&&e.classList.length>0&&(t.classList=e.classList),e.attributes&&e.attributes.length>0&&(t.attributes=Ji(e.attributes))),t}function Ji(e){const t=e.length,i=[];for(let s=0;s<t;s+=1){const t=e.item(s);null!==t&&i.push({name:t.name,value:t.value})}return i}function Xi(e,t){const i=e.getWindow().atob(t),s=es(e,i);return decodeURIComponent(s)}function Zi(e,t){return Qi(Xi(e,t))}function es(e,t){const i=[...e.getWindow().atob("YmdKTnQ=")],s=[];for(let n=0;n<t.length;n++){const e=t.codePointAt(n)^i[n%i.length].codePointAt(0);s.push(String.fromCodePoint(e))}return s.join("")}function ts(e){return e.getWindow().atob("Y1B1YmdKTnQ=")}function is(e){let t;if(void 0!==e)t=e;else{if("undefined"==typeof window)return L.NO_OP_LOGGER;t=window}const i=os(t);return i===L.LogLevel.OFF?L.NO_OP_LOGGER:"group"in t.console?new ss(t,i):new ns(t,i)}class ss extends L.GroupConsoleLogger{constructor(e,t){super(e.console,t),__publicField(this,"idebFilters"),this.idebFilters=us(e)}debug(e,t,i,s){rs(this.idebFilters,s)&&super.debug(e,t,i)}info(e,t,i,s){rs(this.idebFilters,s)&&super.info(e,t,i)}warn(e,t,i,s){rs(this.idebFilters,s)&&super.warn(e,t,i)}error(e,t,i,s){rs(this.idebFilters,s)&&super.error(e,t,i)}group(e,t){rs(this.idebFilters,t)&&super.group(e)}groupEnd(e){rs(this.idebFilters,e)&&super.groupEnd()}time(e,t){rs(this.idebFilters,t)&&super.time(e)}timeEnd(e,t){rs(this.idebFilters,t)&&super.timeEnd(e)}}class ns extends L.BasicConsoleLogger{constructor(e,t){super(e.console,t),__publicField(this,"idebFilters"),this.idebFilters=us(e)}debug(e,t,i,s){rs(this.idebFilters,s)&&super.debug(e,t,i)}info(e,t,i,s){rs(this.idebFilters,s)&&super.info(e,t,i)}warn(e,t,i,s){rs(this.idebFilters,s)&&super.warn(e,t,i)}error(e,t,i,s){rs(this.idebFilters,s)&&super.error(e,t,i)}group(e,t){rs(this.idebFilters,t)&&super.group(e)}groupEnd(e){rs(this.idebFilters,e)&&super.groupEnd()}time(e,t){rs(this.idebFilters,t)&&super.time(e)}timeEnd(e,t){rs(this.idebFilters,t)&&super.timeEnd(e)}}function rs(e,t){const i=[],s=[];for(const n of e)n.startsWith("!")?s.push(n.slice(1)):i.push(n);return void 0===t&&0===i.length||(!0===(null==t?void 0:t.some((e=>i.includes(e))))||!0!==(null==t?void 0:t.some((e=>s.includes(e))))&&(!(i.length>0)||void 0!==t&&!t.every((e=>!i.includes(e)))))}function os(e){let t=as(e);return t.isPresent()?t.get():(t=ls(e),t.isPresent()?t.get():(t=cs(e),t.isPresent()?t.get():Wi))}function as(e){var t,i;return D.ofNullable(null==(i=null==(t=null==e?void 0:e.location)?void 0:t.search)?void 0:i.slice(1)).flatMap((e=>D.ofNullable(/(?:^|\?|&)ideb=([0-5])(?:$|&|#)/.exec(e)).map((e=>Number.parseInt(e[1],10)))))}function ls(e){var t;return D.ofNullable(null==(t=null==e?void 0:e.localStorage)?void 0:t.getItem("ideb")).flatMap((e=>D.ofNullable(/^([0-5])$/.exec(e)).map((e=>Number.parseInt(e[1],10)))))}function cs(e){var t;return D.ofNullable(null==(t=null==e?void 0:e.iOverride)?void 0:t.logLevel)}function us(e){var t;return D.ofNullable(null==(t=null==e?void 0:e.localStorage)?void 0:t.getItem("ideb_filters")).map((e=>e.split(","))).orElse([])}function ds(e,t){const i=e.getReferrerUrl();if(!i.isPresent())return D.of(!1);const s=i.get(),n=e.getHostingPageUrl();return s.getOrigin()===n.getOrigin()?D.of(!0):hs(t,s.getOrigin())}function hs(e,t){const i=e.getCrossOrigin().isEnabled(),s=e.getOrigins().length>0;if(!i&&!s)return D.empty();const n=e.getCrossOrigin().isOriginAllowed(t),r=e.getOrigins().some((e=>e.isOriginAllowed(t)));return i&&s&&n!==r&&_s.error(`Customer crossOrigin ${n} does not match origins ${r} for origin ${t}`,251),D.of(n||r)}function gs(e,t){return new URL(`https://${e}${t}`)}function ps(e){return new fs(e)}const ms={[L.LogLevel.OFF]:"o",[L.LogLevel.ERROR]:"e",[L.LogLevel.WARN]:"w",[L.LogLevel.INFO]:"i",[L.LogLevel.DEBUG]:"d",[L.LogLevel.TRACE]:"t"},vs=["audienceId","campaignId","experienceId","variationId","eventId","pageId","changeId"],bs={audienceId:"aid",campaignId:"cmid",experienceId:"eid",variationId:"vid",eventId:"ei",pageId:"pid",changeId:"chid"};class fs{constructor(e){__publicField(this,"minimumLogLevel"),__publicField(this,"customer"),__publicField(this,"environment"),__publicField(this,"serverContext"),__publicField(this,"user"),this.minimumLogLevel=e}static get LOGGING_APP_STRING(){return"client"}static get PATH(){return"/clientlogger"}configureCustomer(e){this.customer=e}configureEnvironment(e){this.environment=e}configureServerContext(e){this.serverContext=e}configureUser(e){this.user=e}getLevel(){return this.minimumLogLevel}error(e,t,i){this.log(L.LogLevel.ERROR,e,t,i)}warn(e,t,i){this.log(L.LogLevel.WARN,e,t,i)}info(e,t,i){this.log(L.LogLevel.INFO,e,t,i)}debug(e,t,i){this.log(L.LogLevel.DEBUG,e,t,i)}group(e){}groupEnd(){}time(e){}timeEnd(e){}log(e,t,i,s){this.minimumLogLevel<=e&&this.send(__spreadProps(__spreadValues(__spreadValues(__spreadValues({},this.buildCommonPayload()),this.entityIdsToPayload(s)),this.messageToPayload(t)),{app:fs.LOGGING_APP_STRING,mc:i,ll:ms[e]}))}buildCommonPayload(){const e={v:mi};return void 0!==this.customer&&(e.cid=this.customer.getId()),void 0!==this.serverContext&&(e.rid=this.serverContext.requestId),void 0!==this.environment&&(e.pvid=this.environment.getPageviewId(),e.hpurl=this.environment.getHostingPageUrl().getRawUrl(),e.lut=this.environment.getNowUnixTimeMs(),e.ltz=this.environment.getTimeZone()),void 0!==this.user&&(e.uid=this.user.getId()),e}messageToPayload(e){return e instanceof Ee?{m:e.message,en:e.getCause().name,es:e.getCause().stack}:e instanceof Error?{m:e.message,en:e.name,es:e.stack}:{m:e}}entityIdsToPayload(e){const t={};return void 0!==e&&vs.forEach((i=>{void 0!==e[i]&&(t[bs[i]]=e[i])})),t}convertToStringValues(e){return Object.assign({},...Object.entries(e).map((([e,t])=>({[e]:String(t)}))))}send(e){const t=gs(Ci,fs.PATH),i=Hi(this.convertToStringValues(e));void 0===this.environment?navigator.sendBeacon(t,i):this.environment.sendBeacon(t,i)}}class Es{constructor(){__publicField(this,"consoleLogger"),__publicField(this,"serverLogger"),__publicField(this,"isLogging",!1),this.consoleLogger=is(),this.serverLogger=ps(Vi)}configureCustomer(e){this.serverLogger.configureCustomer(e)}configureEnvironment(e){this.serverLogger.configureEnvironment(e)}configureServerContext(e){this.serverLogger.configureServerContext(e)}configureUser(e){this.serverLogger.configureUser(e)}getLevel(){return this.consoleLogger.getLevel()}error(e,t,i,s){this.isLogging||(this.isLogging=!0,this.consoleLogger.error(e,t,i,s),this.serverLogger.error(e,t,i),this.isLogging=!1)}warn(e,t,i,s){this.isLogging||(this.isLogging=!0,this.consoleLogger.warn(e,t,i,s),this.serverLogger.warn(e,t,i),this.isLogging=!1)}info(e,t,i,s){this.isLogging||(this.isLogging=!0,this.consoleLogger.info(e,t,i,s),this.serverLogger.info(e,t,i),this.isLogging=!1)}debug(e,t,i,s){this.isLogging||(this.isLogging=!0,this.consoleLogger.debug(e,t,i,s),this.serverLogger.debug(e,t,i),this.isLogging=!1)}group(e,t){this.isLogging||(this.isLogging=!0,this.consoleLogger.group(e,t),this.isLogging=!1)}groupEnd(e){this.isLogging||(this.isLogging=!0,this.consoleLogger.groupEnd(e),this.isLogging=!1)}time(e,t){this.isLogging||(this.isLogging=!0,this.consoleLogger.time(e,t),this.isLogging=!1)}timeEnd(e,t){this.isLogging||(this.isLogging=!0,this.consoleLogger.timeEnd(e,t),this.isLogging=!1)}}const _s=new Es,ys="Other";class Ss{constructor(e,t,i,s,n,r,o){__publicField(this,"environment"),__publicField(this,"serverContext"),__publicField(this,"attributeStorage"),__publicField(this,"override"),__publicField(this,"customerStorage"),__publicField(this,"integrationDataStorage"),__publicField(this,"user"),__publicField(this,"data"),this.environment=e,this.serverContext=t,this.attributeStorage=i,this.override=s,this.customerStorage=n,this.integrationDataStorage=r,this.user=o,this.reinitialize()}reinitialize(){this.data=this.withAttributeDataOverrides({location:this.initializeLocationData(),utmParams:this.initializeUtmParamData(),userAgent:this.initializeUserAgentData(),dayPart:this.environment.getDayPart(),weekPart:this.environment.getWeekPart(),trafficSource:this.initializeTrafficSourceData(),custom:this.initializeCustomData(),urlParam:this.initializeUrlParamData(),userVisitStatus:this.initializeUserVisitStatusData(),userBucket:this.initializeUserBucketData(),marketo:this.initializeMarketoData(),salesforce:this.initializeSalesforceData(),firmographic:this.initializeFirmographicData(),"6sense":this.initializeSixsenseData(),googleAds:this.initializeGoogleAdsData(),demandbase:this.initializeDemandbaseData(),hubspot:this.initializeHubspotData()}),_s.debug(`[AttributeData] Initialized: ${Bi(this.data)}`)}getLocationData(){return this.data.location}getUtmParamsData(){return this.data.utmParams}getUserAgentData(){return this.data.userAgent}getDayPartData(){return this.data.dayPart}getWeekPartData(){return this.data.weekPart}getTrafficSourceData(){return this.data.trafficSource}getCustomData(){return this.data.custom}getUrlParamData(){return this.data.urlParam}getUserVisitStatusData(){return this.data.userVisitStatus}getUserBucketData(){return this.data.userBucket}getMarketoData(){return this.data.marketo}getSalesforceData(){return this.data.salesforce}getFirmographicData(){return this.data.firmographic}getSixsenseData(){return this.data["6sense"]}getGoogleAdsData(){return this.data.googleAds}getDemandbaseData(){return this.data.demandbase}getHubspotData(){return this.data.hubspot}getAttributeValue(e){switch(e.getNamespace()){case"standard":switch(e.getName()){case"utm_source":return D.ofNullable(this.getUtmParamsData().utmSource);case"utm_medium":return D.ofNullable(this.getUtmParamsData().utmMedium);case"utm_campaign":return D.ofNullable(this.getUtmParamsData().utmCampaign);case"utm_content":return D.ofNullable(this.getUtmParamsData().utmContent);case"utm_term":return D.ofNullable(this.getUtmParamsData().utmTerm);case"country":return D.ofNullable(this.getLocationData().country);case"state":return D.ofNullable(this.getLocationData().state);case"subdivision":return D.ofNullable(this.getLocationData().subdivision);case"city":return D.ofNullable(this.getLocationData().city);case"postal":return D.ofNullable(this.getLocationData().postal);case"dma":return D.ofNullable(this.getLocationData().dma);case"timezone":return D.ofNullable(this.getLocationData().tz);case"device_type":return D.ofNullable(this.getUserAgentData().deviceType);case"day_part":return D.ofNullable(this.getDayPartData());case"week_part":return D.ofNullable(this.getWeekPartData());case"traffic_source":return D.ofNullable(this.getTrafficSourceData());case"user_visit_status":return D.ofNullable(this.getUserVisitStatusData());case"user_bucket":return D.ofNullable(this.getUserBucketData());default:return _s.error(`Standard attribute name (${e.getName()}) not supported`,214),D.empty()}case"url_param":return D.ofNullable(this.getUrlParamData()[e.getName()]);case"custom":return D.ofNullable(this.getCustomData()[e.getName()]);case"marketo":return D.ofNullable(this.getMarketoData()[e.getName()]);case"salesforce":return D.ofNullable(this.getSalesforceData()[e.getName()]);case"firmographic":return D.ofNullable(this.getFirmographicData()[e.getName()]);case"6sense":return D.ofNullable(this.getSixsenseData()[e.getName()]);case"googleAds":return D.ofNullable(this.getGoogleAdsData()[e.getName()]);case"demandbase":return D.ofNullable(this.getDemandbaseData()[e.getName()]);case"hubspot":return D.ofNullable(this.getHubspotData()[e.getName()]);default:return _s.error(`Attribute namespace (${e.getNamespace()}) not supported`,215),D.empty()}}initializeCustomData(){return this.attributeStorage.getFlattenedCustomAttributes()}initializeUrlParamData(){return this.environment.getHostingPageUrl().getAllQueryParamsUnsafe()}initializeUserVisitStatusData(){return this.customerStorage.getUserVisitStatus(this.user)}initializeUserBucketData(){return this.user.getUserBucket()}initializeLocationData(){var e,t,i,s,n;const r=null!=(e=this.serverContext.location)?e:{},o=null!=(i=null!=(t=r.subdivision2Iso)?t:r.subdivision1Iso)?i:ys,a=[];void 0!==r.countryIso&&(void 0!==r.subdivision1Iso&&a.push(`${r.countryIso}-${r.subdivision1Iso}`),void 0!==r.subdivision2Iso&&a.push(`${r.countryIso}-${r.subdivision2Iso}`));let l=ys;return void 0!==r.countryIso&&void 0!==r.postalCode&&(l=`${r.countryIso}-${r.postalCode}`),{country:null!=(s=r.countryIso)?s:ys,state:o,subdivision:a,city:null!=(n=r.geonameId)?n:ys,dma:void 0===r.dmaCode?ys:r.dmaCode.toString(),postal:l,tz:this.environment.getTimeZone()}}initializeUserAgentData(){var e,t,i,s,n,r,o,a,l,c;const u=null!=(e=this.serverContext.userAgent)?e:{};let d,h,g;switch(u.deviceClass){case"Desktop":case"Set-top box":case"TV":case"Game Console":default:d="D";break;case"Mobile":case"Phone":case"Handheld Game Console":d="P";break;case"Tablet":case"eReader":d="T"}switch(u.agentName){case"Firefox":case"Gecko":case"Camino":case"SeaMonkey":h="Firefox";break;case"Chrome":case"Chrome Webview":case"Chromium":case"Epiphany":h="Chrome";break;case"Edge":case"Edge Webview":h="Edge";break;case"Safari":case"Mobile Safari":h="Safari";break;case"Internet Explorer":case"IE Mobile":case"Internet Explorer Webview":h="IE";break;default:h=ys}switch(u.osName){case"Mac OS X":g="Macintosh";break;case"Windows Phone":g="WindowsPhone";break;case"Windows NT":case"Windows 9x":case"Windows CE":g="Windows";break;case"Android":g="Android";break;case"Linux":case"Fedora":g="Linux";break;case"iOS":g="iOS";break;default:g=ys}return{deviceType:d,browser:h,os:g,deviceClass:null!=(t=u.deviceClass)?t:ys,deviceName:null!=(i=u.deviceName)?i:ys,deviceBrand:null!=(s=u.deviceBrand)?s:ys,osClass:null!=(n=u.osClass)?n:ys,osName:null!=(r=u.osName)?r:ys,osVersion:null!=(o=u.osVersion)?o:ys,agentClass:null!=(a=u.agentClass)?a:ys,agentName:null!=(l=u.agentName)?l:ys,agentVersionMajor:null!=(c=u.agentVersionMajor)?c:ys}}initializeUtmParamData(){const e=this.attributeStorage.getInternalAttributes("user",zi);return{utmSource:e.uts,utmMedium:e.utm,utmCampaign:e.utcm,utmContent:e.utcn,utmTerm:e.utt}}initializeTrafficSourceData(){const{ts:e}=this.attributeStorage.getInternalAttributes("user",["ts"]);return null!=e?e:"OT"}initializeMarketoData(){return this.integrationDataStorage.getData("marketo").map((e=>null!=e?e:{})).orElse({})}initializeSalesforceData(){return this.integrationDataStorage.getData("salesforce").map((e=>{const t={};return void 0!==e&&Object.entries(e).forEach((([e,i])=>{Object.entries(i).forEach((([i,s])=>{t[`${e}.${i}`]=s}))})),t})).orElse({})}initializeFirmographicData(){return this.integrationDataStorage.getData("firmographic").map((e=>null!=e?e:{})).orElse({})}initializeSixsenseData(){return this.integrationDataStorage.getData("6sense").map((e=>null!=e?e:{})).orElse({})}initializeGoogleAdsData(){return this.integrationDataStorage.getData("googleAds").map((e=>null!=e?e:{})).orElse({})}initializeDemandbaseData(){return this.integrationDataStorage.getData("demandbase").map((e=>{const t={};return void 0!==e&&Object.entries(e).forEach((([e,i])=>{"custom"===e?Object.entries(i).forEach((([e,i])=>{t[`custom.${e}`]=i})):t[e]=i})),t})).map((e=>null!=e?e:{})).orElse({})}initializeHubspotData(){return this.integrationDataStorage.getData("hubspot").map((e=>{const t={};return void 0!==e&&Object.entries(e).forEach((([e,i])=>{Object.entries(i).forEach((([i,s])=>{t[`${e}.${i}`]=s}))})),t})).orElse({})}withAttributeDataOverrides(e){const t=this.override.getAttributeDataOverrides();return this.overrideObject(e.location,t.location),this.overrideObject(e.utmParams,t.utmParams),this.overrideObject(e.userAgent,t.userAgent),void 0!==t.dayPart&&(e.dayPart=t.dayPart),void 0!==t.weekPart&&(e.weekPart=t.weekPart),void 0!==t.trafficSource&&(e.trafficSource=t.trafficSource),this.overrideObject(e.custom,t.custom),this.overrideObject(e.urlParam,t.urlParam),void 0!==t.userVisitStatus&&(e.userVisitStatus=t.userVisitStatus),void 0!==t.userBucket&&(e.userBucket=t.userBucket),e}overrideObject(e,t){Object.entries(t).forEach((([t,i])=>{void 0!==i&&(e[t]=i)}))}}class Is{constructor(e){__publicField(this,"timestamp"),this.timestamp=e.getNowUnixTime()}get id(){return"missing-policy"}getId(){return this.id}getTimestamp(){return this.timestamp}toJson(){return Hi({id:this.id,timestamp:this.timestamp})}}function ws(e){const t=[...e];let i,s=t.length;for(;s>0;)i=Math.floor(Math.random()*s),s--,[t[s],t[i]]=[t[i],t[s]];return t}class Cs{constructor(e){__publicField(this,"id"),__publicField(this,"timestamp"),__publicField(this,"experiences",{}),this.id=S(e.id),this.timestamp=S(e.timestamp),S(e.experiences),Object.keys(e.experiences).forEach((t=>{this.experiences[t]={modelVersion:S(e.experiences[t].modelVersion),variationId:S(e.experiences[t].variationId)}}))}static buildDefaultPolicy(e,t){const i={};return Object.keys(t.candidates).forEach((e=>{const s=t.candidates[e];void 0!==s&&ws(s).forEach((t=>{(t.isSticky||void 0===i[e])&&(i[e]={modelVersion:"default-model-version",variationId:t.variationId})}))})),new Cs({id:"default-policy",timestamp:e.getNowUnixTime(),experiences:i})}static buildControlPolicy(e){return new Ts(e)}getId(){return this.id}getTimestamp(){return this.timestamp}getExperienceModelVersion(e){return void 0===this.experiences[e]?(_s.info(`PolicyV5 could not find experience ${e}`),"NA"):this.experiences[e].modelVersion}getExperienceVariationId(e){return void 0===this.experiences[e]?(_s.info(`PolicyV5 could not find experience ${e}`),"NA"):this.experiences[e].variationId}toJson(){return Hi({id:this.id,timestamp:this.timestamp,experiences:this.experiences})}}class Ts extends Cs{constructor(e){super({id:"control-policy",timestamp:e.getNowUnixTime(),experiences:{}})}getExperienceModelVersion(e){return"control-experience"}getExperienceVariationId(e){return ci}}var xs=function e(t){return Object.freeze(t),Object.getOwnPropertyNames(t).forEach((function(i){!t.hasOwnProperty(i)||null===t[i]||"object"!=typeof t[i]&&"function"!=typeof t[i]||Object.isFrozen(t[i])||e(t[i])})),t};class As{constructor(e){__publicField(this,"optionalUrl"),__publicField(this,"optionalOrigin"),__publicField(this,"urlParamsUnsafe"),this.optionalUrl=As.sanitizeUrl(e);const t=!0===(null==e?void 0:e.includes("?"))?e.slice(e.indexOf("?")):void 0;if(this.urlParamsUnsafe=xs(As.parseQueryStringUnsafe(t)),this.optionalOrigin=D.empty(),this.optionalUrl.isPresent()){const e=this.optionalUrl.get();try{const{origin:t}=new URL(e);this.optionalOrigin=D.ofNullable(t)}catch(i){const e=new Ee("Could not construct URL to determine origin",i);_s.warn(e,135)}}else _s.debug("cannot determine url origin")}static parseQueryStringUnsafe(e){const t={};return void 0!==e&&e.length>0&&e.slice(1).split("&").forEach((e=>{try{if(void 0!==e&&e.length>0){const i=e.split("=",2),s=decodeURIComponent(i[0]);if(!Object.prototype.hasOwnProperty.call(t,s)){let e="";void 0!==i[1]&&(e=decodeURIComponent(i[1].replace(/\+/g," "))),t[s]=e}}}catch(i){const e=fe(i);_s.warn(e,29)}})),t}static sanitizeUrl(e){try{if(void 0!==e)return D.ofNullable(decodeURI(e))}catch(t){_s.error(`Url could not be decoded: '${e}'`,44)}return D.ofNullable(e)}getAllUrlParamsUnsafe(){return this.urlParamsUnsafe}getUrl(){return this.optionalUrl}getOrigin(){return this.optionalOrigin}}const ks=`${Ui}NativeIdPath`;class Ps{constructor(e,t,i,s,n,r,o,a,l){__publicField(this,"customer"),__publicField(this,"environment"),__publicField(this,"user"),__publicField(this,"attributeStorage"),__publicField(this,"pageContext"),__publicField(this,"serverContext"),__publicField(this,"customerStorage"),__publicField(this,"policy"),__publicField(this,"override"),this.customer=S(e),this.environment=S(t),this.user=S(i),this.attributeStorage=S(s),this.pageContext=S(n),this.serverContext=S(r),this.customerStorage=S(o),this.policy=null!=a?a:new Is(t),this.override=S(l)}setPolicy(e){this.policy=e}sendPageview(){return __async(this,null,(function*(){_s.debug("sendPageview()");const e=this.buildPageviewEvent();return this.send(e,!0)}))}sendContext(e){return __async(this,null,(function*(){_s.debug("sendContext()");const t=this.buildContextEvent(e);return this.send(t,!0)}))}sendConversion(e){return __async(this,null,(function*(){_s.debug("sendConversion()");const t=this.buildConversionEvent(e);return this.send(t,!0)}))}sendView(e,t){return __async(this,null,(function*(){_s.debug("sendView()");const i=this.buildViewEvent(e,t);return this.send(i,!0)}))}sendGoal(e,t,i,s){return __async(this,null,(function*(){_s.debug("sendGoal()");const n=this.buildGoalEvent(e,t,i);return this.send(n,s)}))}static get PATH(){return"/logger"}buildPageviewEvent(){_s.debug("buildPageviewEvent()");const e={eventType:"pv"};return this.buildCommonEvent(e),e.pageviewId=this.environment.getPageviewId(),e.sessionId=this.customerStorage.updateAndGetSessionId(),e.policyId=this.policy.getId(),e.policyTimestamp=this.policy.getTimestamp(),this.customerStorage.getCustomerControlStatus(this.customer).ifPresent((t=>{e.controlStatus=t})),e}buildContextEvent(e){_s.debug("buildContextEvent()");const t={eventType:"ctx",pageviewId:this.environment.getPageviewId(),customerId:this.customer.getId(),userId:this.user.getId()},i=e.getAllData();return Object.keys(i).length>0&&(t.integrationData=i),t}buildConversionEvent(e){_s.debug("buildConversionEvent()");const t={eventType:"c"};return this.buildCommonEvent(t),this.populateConversionInfo(t,e),t.pageviewId=this.environment.getPageviewId(),t.sessionId=this.customerStorage.updateAndGetSessionId(),t.policyId=this.policy.getId(),t.policyTimestamp=this.policy.getTimestamp(),this.customerStorage.getCustomerControlStatus(this.customer).ifPresent((e=>{t.controlStatus=e})),t}buildViewEvent(e,t){_s.debug("buildViewEvent()");const i={eventType:"v"};this.buildBaseEvent(i,e);const s=e.getExperience(),n=s.getCampaign(),r=n.getCustomer();return t.isStickyVariation(e)?this.customerStorage.getVariationPredictionModelVersion(e).ifPresent((e=>{i.modelVersion=e})):i.modelVersion=t.getModelVersion(s.getId()),i.isPrediction=!t.isStickyVariation(e)&&e.getId()!==ci,i.isVariationSticky=t.isStickyVariation(e),i.isCampaignFirstTime=this.customerStorage.updateAndGetIsCampaignFirstTimeView(n,this.environment.getInitializeUnixTime()),i.isVariationFirstTime=this.customerStorage.updateAndGetIsVariationFirstTimeView(e,this.environment.getInitializeUnixTime()),i.pageviewId=this.environment.getPageviewId(),i.sessionId=this.customerStorage.updateAndGetSessionId(),i.policyId=this.policy.getId(),i.policyTimestamp=this.policy.getTimestamp(),this.customerStorage.getCustomerControlStatus(r).ifPresent((e=>{i.controlStatus=e})),i}buildGoalEvent(e,t,i){_s.debug("buildGoalEvent()");const s={eventType:"ocg"};this.buildBaseEvent(s,e);const n=e.getExperience().getCampaign();return s.isCampaignFirstTime=this.customerStorage.updateAndGetIsCampaignFirstTimeGoal(n,t,this.environment.getInitializeUnixTime()),s.isVariationFirstTime=this.customerStorage.updateAndGetIsVariationFirstTimeGoal(e,t,this.environment.getInitializeUnixTime()),this.customerStorage.getVariationPredictionModelVersion(e).ifPresent((e=>{s.modelVersion=e})),s.metricId=t.getId(),s.isGoal=t.isGoal(),s.goalPageviewId=this.environment.getPageviewId(),s.goalSessionId=this.customerStorage.updateAndGetSessionId(),this.populateConversionInfo(s,i),this.customerStorage.getVariationPredictionPageviewId(e).ifPresent((e=>{s.pageviewId=e})),this.customerStorage.getVariationPredictionSessionId(e).ifPresent((e=>{s.sessionId=e})),s.policyId=this.policy.getId(),s.policyTimestamp=this.policy.getTimestamp(),this.customerStorage.getCustomerControlStatus(n.getCustomer()).ifPresent((e=>{s.controlStatus=e})),s}populateConversionInfo(e,t){e.actionId=t.getActionId();const i=t.getEvent();i instanceof ye&&t.getNativeMouseEvent().ifPresent((t=>{this.getAnchorHref(t).ifPresent((t=>{e.clickTargetUrl=t})),this.getWebflowNativeIdPath(i,t).ifPresent((t=>{e.webflowNativeIdPath=t}))})),e.eventId=t.getEventId(),e.eventInstanceId=t.getEventInstanceId(),t.getEventValue().ifPresent((t=>{e.eventValue=t}))}getAnchorHref(e){var t,i;let s,n=e.target;for(;void 0!==n;){if(n instanceof HTMLAnchorElement){s=null!=(t=n.getAttribute("href"))?t:void 0;break}n=null!=(i=n.parentNode)?i:void 0}return D.ofNullable(s)}getWebflowNativeIdPath(e,t){let i=t.target.dataset[ks];if(void 0===i){const s=t.target.closest(e.getSelector());s instanceof HTMLElement&&(i=s.dataset[ks])}return D.ofNullable(i)}buildBaseEvent(e,t){const i=t.getExperience(),s=i.getCampaign();this.buildCommonEvent(e),e.campaignId=s.getId(),e.experienceId=i.getId(),e.variationId=t.getId()}buildCommonEvent(e){e.userId=this.user.getId(),e.isFirstTimeUser=this.user.isNewVisitor(),e.userVisitStatus=this.customerStorage.getUserVisitStatus(this.user),e.userBucket=this.user.getUserBucket(),e.intellimizeClientIp=this.serverContext.clientIp,e.customerId=this.customer.getId(),this.environment.getNowVisibilityState().ifPresent((t=>{e.visibilityState=t})),e.clientVersion=mi,e.requestId=this.serverContext.requestId,this.environment.getReferrerUrl().ifPresent((t=>{As.sanitizeUrl(t.getRawUrl()).ifPresent((t=>{e.referrerUrl=t})),e.referrerUrlEnc=t.getRawUrl()})),As.sanitizeUrl(this.environment.getHostingPageUrl().getRawUrl()).ifPresent((t=>{e.hostingPageUrl=t})),e.hostingPageUrlEnc=this.environment.getHostingPageUrl().getRawUrl(),e.intellimizeUserAgentDigest=this.serverContext.userAgentDigest,e.time=this.environment.getNowUnixTimeMs(),e.timeZone=this.environment.getTimeZone(),this.environment.getWidowWidth().ifPresent((t=>{e.windowWidth=t})),this.environment.getWidowHeight().ifPresent((t=>{e.windowHeight=t})),this.environment.getScreenOrientation().ifPresent((t=>{e.screenOrientation=t}));const t=this.attributeStorage.getFlattenedInternalAttributes();Object.keys(t).length>0&&(e.internalAttributes=t);const i=this.attributeStorage.getFlattenedCustomAttributes();Object.keys(i).length>0&&(e.customAttributes=i);const s=this.pageContext.getPages().map((e=>e.getId()));s.length>0&&(e.pageIds=s);const n=this.pageContext.getAudiences().map((e=>e.getId()));n.length>0&&(e.audienceIds=n);const r=this.environment.getWebflowPageMetadata();void 0!==r.domain&&(e.webflowDomain=r.domain),void 0!==r.siteId&&(e.webflowSiteId=r.siteId),void 0!==r.pageId&&(e.webflowPageId=r.pageId),void 0!==r.collectionId&&(e.webflowCollectionId=r.collectionId),void 0!==r.itemSlug&&(e.webflowItemSlug=r.itemSlug)}send(e,t){return __async(this,null,(function*(){const i=Date.now();_s.debug(`send(async: ${t}) ${i}`);if(("pv"===e.eventType?this.override.sendPageviewBrowserEvents():this.override.sendNonPageviewBrowserEvents()).orElse(!0)){if(t){const t=gs(Ci,Ps.PATH),i=Hi(e);yield this.sendBeacon(t,i)}else yield this.environment.legacySynchronousXhr(Ci,Ps.PATH,{method:"POST",body:Hi(e)});_s.debug("BrowserEvent sent")}else _s.debug("BrowserEvent send skipped")}))}sendBeacon(e,t){return __async(this,null,(function*(){return new Promise(((i,s)=>{this.environment.sendBeacon(e,t)?i():s()}))}))}}class Ds{constructor(){__publicField(this,"onVariationRecordedCallbackTuples",[])}getVariationRecordedCallbackTuples(){return this.onVariationRecordedCallbackTuples}addVariationRecordedCallbackTuple(e){this.onVariationRecordedCallbackTuples.push(e)}}class Fs{static evalBoolean(e){const t=Fs.eval(e);if("boolean"==typeof t)return t;throw new TypeError("Expected boolean response, but got "+typeof t+": "+t)}static evalString(e){const t=Fs.eval(e);if("string"==typeof t)return t;throw new TypeError("Expected string response, but got "+typeof t+": "+t)}static eval(e){return _s.info(`eval code: ${e}`),(0,eval)('"use strict";\n'+Fs.reformatJqueryCode(e))}static injectCss(e,t,i){_s.info(`inject css: ${e}`);const s=`intellimize-${t}`,n=i.querySelectorAll(`head #${s}`),[r]=n;if(void 0===r){const t=i.createElement("style");t.id=s,t.className="iStyleBlock",t.append(e),i.head.append(t)}else r.innerHTML=e}static removeCss(e,t){var i;_s.info(`Remove css: ${e}`);const s=`intellimize-${e}`;null==(i=t.querySelector(`head #${s}`))||i.remove()}static executeFunction(e,t){try{e.call(void 0)}catch(i){const e=new Ee("Caught exception in function callback",i);_s.error(e,t)}}static reformatJqueryCode(e){return`var $ = (window.intellimize && window.intellimize.plugins && window.intellimize.plugins.jquery) ? window.intellimize.plugins.jquery : window.$;\n${e}`}}class Ms{constructor(e,t){__publicField(this,"attributeData"),__publicField(this,"activityStorage"),this.attributeData=e,this.activityStorage=t}evalBoolean(e){_s.info(`ConditionEvaluationRuntime.evalBoolean(${e.slice(0,10)})`);const t=Fs.evalBoolean(e);return _s.info(`ConditionEvaluationRuntime.evalBoolean() => ${t}`),t}getAttributeValue(e){return this.attributeData.getAttributeValue(e)}getActivities(){return this.activityStorage.getAll()}}const Ns=["mutations"],Os={debug(e,t,i){_s.debug(e,t,i,Ns)},group(e){_s.group(e,Ns)},groupEnd(){_s.groupEnd(Ns)},time(e){_s.time(e,Ns)},timeEnd(e){_s.timeEnd(e,Ns)}};class Rs{attachObserver(){}detachObserver(){}registerSelectorAndExecute(e,t,i,s){const n=document.querySelectorAll(e);Os.debug(`Found ${n.length} matching elements`),n.length>0?n.forEach((e=>{Os.debug(`Processing element: ${Ki(e)}`),t(e)})):Os.debug(`No matching elements for selector: ${e}`)}reset(){}}function Ls(e){return"[object Array]"===Object.prototype.toString.call(e)}function $s(e){return"[object Arguments]"===Object.prototype.toString.call(e)}function Us(e){return"[object Object]"===Object.prototype.toString.call(e)}function Vs(e){return"[object Function]"===Object.prototype.toString.call(e)}function Ws(e){return"[object HTMLImageElement]"===Object.prototype.toString.call(e)}function zs(e,t){const i=[];for(const s of e)t.includes(s)||i.push(s);for(const s of t)e.includes(s)||i.push(s);return i}function js(e){return e.replace(/([a-z\d])([A-Z])/g,"$1-$2").toLowerCase()}function Gs(e,t){const i=e.indexOf(t);i>-1&&e.splice(i,1)}function Bs(e){return Object.fromEntries(Object.entries(e).map((([e,t])=>[t,e])))}const Hs={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},Qs=e=>String(e).replace(/[&<>"'`=/]/g,(e=>{var t;return null!=(t=Hs[e])?t:e})),qs=(e,t,i=!0)=>{let s="";return t.forEach((t=>{s+=Ks(e,t,i)})),s},Ks=(e,t,i=!0)=>{switch(t.type){case"string":return t.value;case"attribute":return Ys(e,t.value,i);default:throw new Error(`Unsupported TemplateFragment type: ${t.type}`)}},Ys=(e,{attrDefId:t,defaultString:i},s)=>{const n=new Y(t);let r=e.getAttributeValue(n).orElse(i);return Ls(r)&&(r=Js(e,n,i)),s?Qs(String(r)):String(r)},Js=(e,t,i)=>e.getAttributeValue(t).flatMap((([e])=>D.ofNullable(e))).orElse(i);class Xs{constructor(e,t,i,s){__publicField(this,"attributeData"),__publicField(this,"environment"),__publicField(this,"localDocument"),__publicField(this,"parent"),__publicField(this,"changeIndex"),this.parent=e,this.changeIndex=t,this.attributeData=i,this.environment=s,this.localDocument=s.getWindow().document}getGuid(){return`${this.parent.getGuid()}-c${this.changeIndex}}`}getEntityIds(){return __spreadProps(__spreadValues({},this.parent.getEntityIds()),{changeId:String(this.changeIndex)})}}const Zs="data-imize";function en(e,t,i){var n;const r=e;r.imizeChangeData=null!=(n=r.imizeChangeData)?n:{},s(r.imizeChangeData)?r.imizeChangeData[t]=i:_s.error("Invalid imizeChangeData value: must be an object",118)}function tn(e,t){return D.ofNullable(cn(e)[t])}function sn(e,t){delete cn(e)[t],0===Object.keys(cn(e)).length&&un(e)}function nn(e){const t=e;return void 0!==t.imizeChangeData&&Object.keys(t.imizeChangeData).length>0}function rn(e){return`${Zs}-${e}`}function on(e){return document.querySelectorAll(`[${rn(e)}]`)}function an(e,t){e.setAttribute(rn(t),t)}function ln(e,t){e.removeAttribute(rn(t))}function cn(e){var t;const i=e;return s(i.imizeChangeData)||o(i.imizeChangeData)?null!=(t=i.imizeChangeData)?t:{}:(_s.error("Invalid imizeChangeData value: must be undefined or an object",119),{})}function un(e){delete e.imizeChangeData}function dn(e,t){const i={};for(const[s,n]of Object.entries(cn(e)))n.type===t&&(i[s]=n.value);return i}function hn(e){return{getGuid:()=>`e${e.getExperience().getId()}-v${e.getId()}`,getEntityIds:()=>({variationId:e.getId(),experienceId:e.getExperience().getId()})}}function gn(e){return{getGuid:()=>`p${e.getId()}`,getEntityIds:()=>({pageId:e.getId()})}}function pn(e){return{getGuid:()=>`ve${e.id}`,getEntityIds:()=>({})}}const mn=class extends Xs{constructor(e,t,i,s,n){super(t,i,s,n),__publicField(this,"attributeChange"),this.attributeChange=e}static getIsValidAttribute(e,t){const i=e.tagName.toLowerCase();return mn.VALID_TAGS_BY_NON_STANDARD_ATTRIBUTE[t].includes(i)}isReadyToApply(){return this.attributeChange.isReadyToApply(this.localDocument)}apply(e,t){_s.group("EnhancedAttributeChange.apply()"),_s.debug(`Applying change: ${Bi(this.attributeChange)}`),t.registerSelectorAndExecute(this.attributeChange.getSelector(),(t=>{this.applyChanges(t,e)}),{shouldReapply:e=>this.shouldReapply(e)},this.getEntityIds()),_s.groupEnd()}undo(){_s.debug(`[EnhancedAttributeChange]: Undoing change: ${Bi(this.attributeChange)}`),this.attributeChange.getId().ifPresent((e=>{const t=on(e);Array.prototype.forEach.call(t,(t=>{if(t instanceof HTMLElement){const i=tn(t,e);if(i.isPresent()){const e=i.get().value;Object.keys(this.attributeChange.getAttributes()).forEach((i=>{switch(i){case"html":void 0!==e.html&&(t.innerHTML=this.renderContent(e.html));break;case"className":void 0!==e.className&&(t.className=e.className);break;case"alt":case"src":case"srcset":case"sizes":case"href":{const s=e[i];void 0===s?t.removeAttribute(i):t.setAttribute(i,s);break}case"css":case"style":void 0!==e.style&&(t.style.cssText=e.style);break;default:_s.error(`[EnhancedAttributeChange]: Cannot undo unknown attribute: ${i}`,121,this.getEntityIds())}}))}else _s.error(`[EnhancedAttributeChange]: Expected change data, but there was none: ${Bi(this.attributeChange)}`,122,this.getEntityIds())}else _s.error(new Error("[EnhancedAttributeChange]: Found matching element that is not an HTMLElement"),123,this.getEntityIds());ln(t,e),sn(t,e)}))}))}getSelector(){return D.of(this.attributeChange.getSelector())}applyChanges(e,t){let i=!1;_s.group(`EnhancedAttributeChange.applyChanges(${Bi(this.attributeChange)})`),this.attributeChange.getId().ifPresent((t=>{an(e,t)}));const s={};Object.keys(this.attributeChange.getAttributes()).forEach((n=>{switch(n){case"html":{const{html:t}=this.attributeChange.getAttributes();void 0!==t&&(s.html=e.innerHTML,e.innerHTML=this.renderContent(t)),_s.debug("Applied html");break}case"css":case"style":break;case"className":{const{className:t}=this.attributeChange.getAttributes();void 0!==t&&(s.className=e.className,e.className=t),_s.debug("Applied className");break}case"src":this.applyNonStandardAttribute(n,e,s),Ws(e)&&!e.complete&&(_s.debug("attaching listener for img src loading"),i=!0,e.addEventListener("load",(()=>{try{_s.debug("EnhancedAttributeChange() image loaded! calling onReadyToRender()"),t()}catch(e){const t=new Ee("Exception in image onload handler",e);_s.error(t,236,this.getEntityIds())}}),{once:!0}));break;case"alt":case"srcset":case"sizes":case"href":this.applyNonStandardAttribute(n,e,s);break;default:_s.error(`[EnhancedAttributeChange]: Cannot apply unknown attribute: ${n}`,120,this.getEntityIds())}}));const n=this.createCssText(e);void 0!==n&&(s.style=e.style.cssText,e.style.cssText=n,_s.debug("Applied css")),this.attributeChange.getId().ifPresent((t=>{en(e,t,{value:s,type:je.ATTRIBUTE})})),i||(_s.debug("EnhancedAttributeChange() not waiting; calling onReadyToRender()"),t()),_s.debug("DOM modifications successfully applied for this change."),_s.groupEnd()}applyNonStandardAttribute(e,t,i){const s=mn.getIsValidAttribute(t,e),n=this.attributeChange.getAttributes()[e];if(s&&void 0!==n){const s=t.getAttribute(e);null!==s&&(i[e]=s),t.setAttribute(e,n)}else _s.error(`This ${t.tagName} does not support this attribute: ${e}`,131,this.getEntityIds());_s.debug(`Applied ${n}`)}createCssText(e){const{css:t,style:i}=this.attributeChange.getAttributes();if(o(t))return i;const s=null!=i?i:"";let n="";return Object.entries(t).forEach((([e,t])=>{const i=js(e);if(!new RegExp(i+"\\s*:").test(s)){const i=t.includes("!important")?t:`${t} !important`;n+=`${js(e)}:${i};`}})),o(i)?e.style.cssText+n:n+s}shouldReapply(e){for(const t in this.attributeChange.getAttributes())if(Object.prototype.hasOwnProperty.call(this.attributeChange.getAttributes(),t))switch(_s.debug(`shouldReapply(): CHECKING "${t}"`),t){case"css":case"className":case"style":case"alt":_s.debug(`shouldReapply(): SKIP (attribute "${t}" not checked)`);break;case"src":case"srcset":case"sizes":case"href":{const i=this.attributeChange.getAttributes()[t];if(void 0!==i){const s=e.getAttribute(t);if(""===i&&null===s){_s.debug(`shouldReapply(): SKIP (value of "${t}" is null; configured value is empty string)`);break}if(i!==s)return _s.debug(`shouldReapply(): YES (value of "${t}" changed from "${i}" to "${s}")`),!0;_s.debug(`shouldReapply(): SKIP (value of "${t}" did not change)`);break}_s.debug(`shouldReapply(): SKIP (configured value of "${t}" is undefined)`);break}case"html":{const i=this.attributeChange.getAttributes()[t],s=document.createElement("div");if(void 0!==i&&(s.innerHTML=this.renderContent(i)),e.textContent!==s.textContent)return _s.debug(`shouldReapply(): YES (The visible text of the element has changed from "${s.textContent}" to "${e.textContent}")`),!0;_s.debug(`shouldReapply(): SKIP (The text of the element has not changed; comparing configured "${s.textContent}" to current "${e.textContent}")`);break}default:_s.error(`[EnhancedAttributeChange]: shouldReapply() found unknown attribute: ${t}`,201,this.getEntityIds())}return _s.debug("shouldReapply(): NO (all attributes skipped)"),!1}renderContent(e){return"string"==typeof e?e:qs(this.attributeData,e,!0)}};let vn=mn;function bn(){return _n("xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx")}function fn(){return _n("xxxx-yxxx-xxxxxxxxxxxx")}function En(){return _n("xxxxxxxxxx")}function _n(e){let t=Date.now();return e.replace(/[xy]/g,(e=>{const i=Math.trunc((t+16*Math.random())%16);return t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)}))}__publicField(vn,"VALID_TAGS_BY_NON_STANDARD_ATTRIBUTE",{alt:["img"],src:["img"],srcset:["img"],sizes:["img"],href:["a"]});class yn extends Xs{constructor(e,t,i,s,n){super(t,i,s,n),__publicField(this,"customCodeChange"),this.customCodeChange=e}isReadyToApply(){return this.customCodeChange.isReadyToApply(this.localDocument)}apply(e,t){_s.group("EnhancedCustomCodeChange.apply()"),_s.debug(`Applying change: ${Bi(this.customCodeChange)}`);try{this.customCodeChange.getCss().ifPresent((e=>{this.injectCss(e)})),t.detachObserver(),this.customCodeChange.getCode().ifPresent((e=>{this.runCode(e)}))}finally{t.attachObserver(),e(),_s.groupEnd()}}undo(){}getSelector(){return D.empty()}runCode(e){try{_s.info("Running code for CUSTOM_CODE change"),Fs.eval(e)}catch(t){throw new Ee("Code execution failed",t)}}injectCss(e){try{const t=this.customCodeChange.getId().orElseRun(bn);_s.info("Injecting css for CUSTOM_CODE change"),Fs.injectCss(e,`dom-change-${t}`,document)}catch(t){throw new Ee("Css injection failed",t)}}}var Sn={};!function(e){var t=Object.defineProperty,i=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,r=(e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s,o=(e,t,i)=>(r(e,"symbol"!=typeof t?t+"":t,i),i);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"});let a=class extends Error{constructor(e){super(e),this.name="UnexpectedNullException"}};function l(e,t){if(null==e||"string"==typeof e&&0===e.length)throw new a(t);return e}class c extends Error{constructor(e){super(e),this.name="IllegalArgumentException"}}let u=class extends Error{constructor(e){super(e),this.name="NoSuchElementException"}};var d=Object.defineProperty,h=(e,t,i)=>{return r=i,(n="symbol"!=typeof t?t+"":t)in(s=e)?d(s,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[n]=r,i;var s,n,r};class g{static empty(){return v.INSTANCE}static of(e){return new p(l(e))}static ofNullable(e){return null==e||"string"==typeof e&&0===e.length?v.INSTANCE:new p(e)}}class p extends g{constructor(e){super(),h(this,"value"),this.value=e}isPresent(){return!0}ifPresent(e){return e(this.value),this}ifAbsent(e){return this}get(){return this.value}orElse(e){return this.value}orElseRun(e){return this.value}toArray(){return[this.value]}map(e){return g.ofNullable(e(this.value))}flatMap(e){return e(this.value)}toString(){return`Optional[${this.value.toString()}]`}}const m=class extends g{isPresent(){return!1}ifPresent(e){return this}ifAbsent(e){return e(),this}get(){throw new u("No value present")}orElse(e){return e}orElseRun(e){return e()}toArray(){return[]}map(e){return g.empty()}flatMap(e){return g.empty()}toString(){return"Optional.empty"}};let v=m;h(v,"INSTANCE",new m);const b="imize-extension";var f=Object.prototype.toString,E=Array.isArray||function(e){return"[object Array]"===f.call(e)};function _(e){return"function"==typeof e}function y(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function S(e,t){return null!=e&&"object"==typeof e&&t in e}var I=RegExp.prototype.test,w=/\S/;function C(e){return t=w,i=e,!I.call(t,i);var t,i}var T={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},x=/\s*/,A=/\s+/,k=/\s*=/,P=/\s*\}/,D=/#|\^|\/|>|\{|&|=|!/;function F(e){this.string=e,this.tail=e,this.pos=0}function M(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function N(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}F.prototype.eos=function(){return""===this.tail},F.prototype.scan=function(e){var t=this.tail.match(e);if(!t||0!==t.index)return"";var i=t[0];return this.tail=this.tail.substring(i.length),this.pos+=i.length,i},F.prototype.scanUntil=function(e){var t,i=this.tail.search(e);switch(i){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,i),this.tail=this.tail.substring(i)}return this.pos+=t.length,t},M.prototype.push=function(e){return new M(e,this)},M.prototype.lookup=function(e){var t,i,s,n=this.cache;if(n.hasOwnProperty(e))t=n[e];else{for(var r,o,a,l=this,c=!1;l;){if(e.indexOf(".")>0)for(r=l.view,o=e.split("."),a=0;null!=r&&a<o.length;)a===o.length-1&&(c=S(r,o[a])||(i=r,s=o[a],null!=i&&"object"!=typeof i&&i.hasOwnProperty&&i.hasOwnProperty(s))),r=r[o[a++]];else r=l.view[e],c=S(l.view,e);if(c){t=r;break}l=l.parent}n[e]=t}return _(t)&&(t=t.call(this.view)),t},N.prototype.clearCache=function(){void 0!==this.templateCache&&this.templateCache.clear()},N.prototype.parse=function(e,t){var i=this.templateCache,s=e+":"+(t||O.tags).join(":"),n=void 0!==i,r=n?i.get(s):void 0;return null==r&&(r=function(e,t){if(!e)return[];var i,s,n,r=!1,o=[],a=[],l=[],c=!1,u=!1,d="",h=0;function g(){if(c&&!u)for(;l.length;)delete a[l.pop()];else l=[];c=!1,u=!1}function p(e){if("string"==typeof e&&(e=e.split(A,2)),!E(e)||2!==e.length)throw new Error("Invalid tags: "+e);i=new RegExp(y(e[0])+"\\s*"),s=new RegExp("\\s*"+y(e[1])),n=new RegExp("\\s*"+y("}"+e[1]))}p(t||O.tags);for(var m,v,b,f,_,S,I=new F(e);!I.eos();){if(m=I.pos,b=I.scanUntil(i))for(var w=0,T=b.length;w<T;++w)C(f=b.charAt(w))?(l.push(a.length),d+=f):(u=!0,r=!0,d+=" "),a.push(["text",f,m,m+1]),m+=1,"\n"===f&&(g(),d="",h=0,r=!1);if(!I.scan(i))break;if(c=!0,v=I.scan(D)||"name",I.scan(x),"="===v?(b=I.scanUntil(k),I.scan(k),I.scanUntil(s)):"{"===v?(b=I.scanUntil(n),I.scan(P),I.scanUntil(s),v="&"):b=I.scanUntil(s),!I.scan(s))throw new Error("Unclosed tag at "+I.pos);if(_=">"==v?[v,b,m,I.pos,d,h,r]:[v,b,m,I.pos],h++,a.push(_),"#"===v||"^"===v)o.push(_);else if("/"===v){if(!(S=o.pop()))throw new Error('Unopened section "'+b+'" at '+m);if(S[1]!==b)throw new Error('Unclosed section "'+S[1]+'" at '+m)}else"name"===v||"{"===v||"&"===v?u=!0:"="===v&&p(b)}if(g(),S=o.pop())throw new Error('Unclosed section "'+S[1]+'" at '+I.pos);return function(e){for(var t,i=[],s=i,n=[],r=0,o=e.length;r<o;++r)switch((t=e[r])[0]){case"#":case"^":s.push(t),n.push(t),s=t[4]=[];break;case"/":n.pop()[5]=t[2],s=n.length>0?n[n.length-1][4]:i;break;default:s.push(t)}return i}(function(e){for(var t,i,s=[],n=0,r=e.length;n<r;++n)(t=e[n])&&("text"===t[0]&&i&&"text"===i[0]?(i[1]+=t[1],i[3]=t[3]):(s.push(t),i=t));return s}(a))}(e,t),n&&i.set(s,r)),r},N.prototype.render=function(e,t,i,s){var n=this.getConfigTags(s),r=this.parse(e,n),o=t instanceof M?t:new M(t,void 0);return this.renderTokens(r,o,i,e,s)},N.prototype.renderTokens=function(e,t,i,s,n){for(var r,o,a,l="",c=0,u=e.length;c<u;++c)a=void 0,"#"===(o=(r=e[c])[0])?a=this.renderSection(r,t,i,s,n):"^"===o?a=this.renderInverted(r,t,i,s,n):">"===o?a=this.renderPartial(r,t,i,n):"&"===o?a=this.unescapedValue(r,t):"name"===o?a=this.escapedValue(r,t,n):"text"===o&&(a=this.rawValue(r)),void 0!==a&&(l+=a);return l},N.prototype.renderSection=function(e,t,i,s,n){var r=this,o="",a=t.lookup(e[1]);if(a){if(E(a))for(var l=0,c=a.length;l<c;++l)o+=this.renderTokens(e[4],t.push(a[l]),i,s,n);else if("object"==typeof a||"string"==typeof a||"number"==typeof a)o+=this.renderTokens(e[4],t.push(a),i,s,n);else if(_(a)){if("string"!=typeof s)throw new Error("Cannot use higher-order sections without the original template");null!=(a=a.call(t.view,s.slice(e[3],e[5]),(function(e){return r.render(e,t,i,n)})))&&(o+=a)}else o+=this.renderTokens(e[4],t,i,s,n);return o}},N.prototype.renderInverted=function(e,t,i,s,n){var r=t.lookup(e[1]);if(!r||E(r)&&0===r.length)return this.renderTokens(e[4],t,i,s,n)},N.prototype.indentPartial=function(e,t,i){for(var s=t.replace(/[^ \t]/g,""),n=e.split("\n"),r=0;r<n.length;r++)n[r].length&&(r>0||!i)&&(n[r]=s+n[r]);return n.join("\n")},N.prototype.renderPartial=function(e,t,i,s){if(i){var n=this.getConfigTags(s),r=_(i)?i(e[1]):i[e[1]];if(null!=r){var o=e[6],a=e[5],l=e[4],c=r;0==a&&l&&(c=this.indentPartial(r,l,o));var u=this.parse(c,n);return this.renderTokens(u,t,i,c,s)}}},N.prototype.unescapedValue=function(e,t){var i=t.lookup(e[1]);if(null!=i)return i},N.prototype.escapedValue=function(e,t,i){var s=this.getConfigEscape(i)||O.escape,n=t.lookup(e[1]);if(null!=n)return"number"==typeof n&&s===O.escape?String(n):s(n)},N.prototype.rawValue=function(e){return e[1]},N.prototype.getConfigTags=function(e){return E(e)?e:e&&"object"==typeof e?e.tags:void 0},N.prototype.getConfigEscape=function(e){return e&&"object"==typeof e&&!E(e)?e.escape:void 0};var O={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){R.templateCache=e},get templateCache(){return R.templateCache}},R=new N;O.clearCache=function(){return R.clearCache()},O.parse=function(e,t){return R.parse(e,t)},O.render=function(e,t,i,s){if("string"!=typeof e)throw new TypeError('Invalid template! Template should be a "string" but "'+(E(n=e)?"array":typeof n)+'" was given as the first argument for mustache#render(template, view, partials)');var n;return R.render(e,t,i,s)},O.escape=function(e){return String(e).replace(/[&<>"'`=\/]/g,(function(e){return T[e]}))},O.Scanner=F,O.Context=M,O.Writer=N;const L="standard",$="custom",U="url_param",V="marketo",W="salesforce",z="firmographic",j="6sense",G="googleAds",B="demandbase",H=[L,$,U,V,W,z,j,G,B];function Q(e){return"object"==typeof e&&e instanceof Error?e:new Error(e)}function q(){return function(e){let t=Date.now();return e.replace(/[xy]/g,(e=>{const i=Math.trunc((t+16*Math.random())%16);return t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)}))}("xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx")}class K{constructor(e,t){o(this,"storage"),o(this,"namespace"),this.storage=e,this.namespace=t}static get delimiter(){return"."}write(e,t){this.storage.write(this.getFullKey(e),t)}read(e){return this.storage.read(this.getFullKey(e))}delete(e){this.storage.delete(this.getFullKey(e))}getFullKey(e){return`${this.namespace}${K.delimiter}${e}`}}class Y{constructor(e,t){o(this,"logger"),o(this,"namespace"),this.logger=e,this.namespace=t}getLevel(){return this.logger.getLevel()}error(e,t,i){this.logger.error(this.getFullMessage(e),t,i)}warn(e,t,i){this.logger.warn(this.getFullMessage(e),t,i)}info(e,t,i){this.logger.info(this.getFullMessage(e),t,i)}debug(e,t,i){this.logger.debug(this.getFullMessage(e),t,i)}group(e){this.logger.group(this.getFullMessage(e))}groupEnd(){this.logger.groupEnd()}time(e){this.logger.time(this.getFullMessage(e))}timeEnd(e){this.logger.timeEnd(this.getFullMessage(e))}getFullMessage(e){return`[${this.namespace}]: ${e}`}}e.ATTRIBUTE_NAMESPACES=H,e.ATTRIBUTE_NAMESPACE_CUSTOM=$,e.ATTRIBUTE_NAMESPACE_DEMANDBASE=B,e.ATTRIBUTE_NAMESPACE_FIRMOGRAPHIC=z,e.ATTRIBUTE_NAMESPACE_GOOGLE_ADS=G,e.ATTRIBUTE_NAMESPACE_MARKETO=V,e.ATTRIBUTE_NAMESPACE_SALESFORCE=W,e.ATTRIBUTE_NAMESPACE_SIXSENSE=j,e.ATTRIBUTE_NAMESPACE_STANDARD=L,e.ATTRIBUTE_NAMESPACE_URL_PARAM=U,e.Extension=class{constructor(e){o(this,"config"),this.config=e}getName(){return this.config.name}getDescription(){return this.config.description}getLabel(){return this.config.label}getIconImgSrc(){return g.ofNullable(this.config.iconImageSrc)}getCss(){return g.ofNullable(this.config.css)}getDom(){return void 0===this.config.dom?g.empty():g.of({html:this.config.dom.html,targetPosition:g.ofNullable(this.config.dom.targetPosition)})}getFields(){return this.config.fields}getViewData(e,t){var i,s;return null==(s=(i=this.config).viewDataFn)?void 0:s.call(i,e,t)}getRunFn(){var e;return g.ofNullable(null==(e=this.config.code)?void 0:e.run)}getResetFn(){var e;return g.ofNullable(null==(e=this.config.code)?void 0:e.reset)}},e.ExtensionExecutor=class{constructor(e,t,i,s=q()){let n;o(this,"extension"),o(this,"runtime"),o(this,"extensionStorage"),o(this,"extensionLogger"),o(this,"config"),o(this,"styleElementId"),o(this,"instanceId"),o(this,"targetPositionTuple"),o(this,"viewData"),e.getDom().ifPresent((e=>{!function(e,t){if(l(e),!e)throw new c(t)}(e.targetPosition.isPresent()||void 0!==i.targetPosition,"ExtensionExecutor expects a TargetPosition for extensions that use HTML"),void 0===i.targetPosition?(t.logger.debug("Using TargetPosition from Extension config"),n=[e.html,e.targetPosition.get()]):(t.logger.debug("Using TargetPosition from Executor config"),n=[e.html,i.targetPosition])})),this.targetPositionTuple=n,this.extension=e,this.runtime=t,this.extensionStorage=new K(t.storage,e.getName()),this.extensionLogger=new Y(t.logger,`Extension: ${e.getName()}`),this.config=i,this.instanceId=s,this.styleElementId=`extension-${e.getName()}`,this.viewData=this.extension.getViewData(this.fieldData,this.runtime)}get fieldData(){const e=((e,t)=>{for(var o in t||(t={}))s.call(t,o)&&r(e,o,t[o]);if(i)for(var o of i(t))n.call(t,o)&&r(e,o,t[o]);return e})({},this.config.fieldData);return this.extension.getFields().forEach((t=>{"defaultValue"in t&&void 0===e[t.name]&&(e[t.name]=t.defaultValue)})),e}run(e){this.runtime.logger.debug(`ExtensionExecutor(${this.extension.getName()}): Calling run()`),this.injectCss(),this.insertElement((()=>{this.runCode(),void 0!==e&&e()}))}reset(){this.runtime.logger.debug(`ExtensionExecutor(${this.extension.getName()}): Calling reset()`),this.resetCode(),this.removeElement(),this.removeCss()}getTargetPosition(){return this.getTargetPositionTuple().isPresent()?g.of(this.getTargetPositionTuple().get()[1]):g.empty()}getTargetElement(){if(this.getTargetPosition().isPresent()){const{selector:e}=this.getTargetPosition().get(),t=this.runtime.localWindow.document.querySelectorAll(e);return t.length>1&&this.runtime.logger.error(`Expected exactly one target element; found ${t.length} elements matching selector "${e}"`,7e3),g.ofNullable(t[0])}return g.empty()}injectCss(){this.extension.getCss().ifPresent((e=>{this.runtime.logger.debug(`ExtensionExecutor(${this.extension.getName()}): Injecting CSS`),this.runtime.injectCss(e,this.styleElementId)}))}insertElement(e){this.getTargetPositionTuple().ifPresent((t=>{const[,{selector:i}]=t;this.getTargetElement().ifPresent((s=>{this.runtime.logger.debug(`ExtensionExecutor(${this.extension.getName()}): Inserting Extension HTML at "${i}" ${JSON.stringify(this.fieldData,void 0,2)}`);try{this.insertElementAtTarget(t,s)}catch(n){const e=Q(n);this.runtime.logger.error(e,7001)}e()})).ifAbsent((()=>{this.runtime.logger.error(`ExtensionExecutor(${this.extension.getName()}): Could not find a TargetElement for selector ${i}`,7002),e()}))})).ifAbsent((()=>{e()}))}insertElementAtTarget(e,t){const[i,{insertPosition:s}]=e,n=O.render(i,{extension:{fieldData:this.fieldData,viewData:this.viewData}}),r=this.createElement(n);t.insertAdjacentElement(s,r)}runCode(){this.extension.getRunFn().ifPresent((e=>{e(this.getContext())}))}resetCode(){this.extension.getResetFn().ifPresent((e=>{e(this.getContext())}))}removeElement(){this.getTargetPositionTuple().isPresent()&&Array.prototype.forEach.call(this.getElements(),(e=>{e.remove()}))}removeCss(){this.extension.getCss().isPresent()&&this.runtime.removeCss(this.styleElementId)}getTargetPositionTuple(){return g.ofNullable(this.targetPositionTuple)}getElements(){return this.getTargetPositionTuple().isPresent()?[...this.runtime.localWindow.document.querySelectorAll(`[data-${b}="${this.instanceId}"]`)]:[]}getContext(){return{fieldData:this.fieldData,localWindow:this.runtime.localWindow,logger:this.extensionLogger,storage:this.extensionStorage}}createElement(e){const t=function(e,t){const i=t.createElement("template");return i.innerHTML=e.trim(),[...i.content.childNodes]}(e,this.runtime.localWindow.document);if(1!==t.length)throw new Error(`Unable to create a single DOM Node from the extension HTML for "${this.extension.getName()}"`);const[i]=t;if(!(i instanceof HTMLElement))throw new TypeError(`The root Node of the tree constructed from the extension HTML for "${this.extension.getName()}" is not an instance of an Element`);return i.setAttribute(`data-${b}`,this.instanceId),i}},e.exceptionToError=Q}(Sn);class In extends Xs{constructor(e,t,i,s,n,r,o){super(t,i,s,n),__publicField(this,"insertExtensionChange"),__publicField(this,"extensionManager"),__publicField(this,"runtime"),__publicField(this,"_executor"),this.insertExtensionChange=e,this.extensionManager=o;const a=n.getWindow();this.runtime={localWindow:a,logger:_s,storage:r,injectCss(e,t){Fs.injectCss(e,t,a.document)},removeCss(e){Fs.removeCss(e,a.document)}}}isReadyToApply(){return!this.getExecutor().getTargetPosition().isPresent()||this.getExecutor().getTargetElement().isPresent()}apply(e,t){_s.group("EnhancedExtensionChange.apply()"),_s.debug(`Applying change: ${Bi(this.insertExtensionChange)}`),this.getExecutor().getTargetPosition().ifPresent((({selector:i})=>{t.registerSelectorAndExecute(i,(()=>{this.getExecutor().run(e)}),{shouldReapply:this.shouldReapply.bind(this)},this.getEntityIds())})),_s.groupEnd()}undo(){_s.group("EnhancedExtensionChange.undo()"),_s.debug(`Undoing change: ${Bi(this.insertExtensionChange)}`),this.getExecutor().reset(),_s.groupEnd()}getSelector(){return D.empty()}shouldReapply(){return!this.getExecutor().getTargetPosition().isPresent()||!this.getExecutor().getTargetElement().isPresent()}getExecutor(){if(void 0===this._executor){const e=this.extensionManager.getExtension(this.insertExtensionChange.getName());if(!e.isPresent())throw new Error(`Could not find extension: ${this.insertExtensionChange.getName()}`);this._executor=new Sn.ExtensionExecutor(e.get(),this.runtime,this.insertExtensionChange.getExecutorJson(),this.insertExtensionChange.getId().map((e=>e)).orElse(void 0))}return this._executor}}class wn extends Xs{constructor(e,t,i,s,n){super(t,i,s,n),__publicField(this,"insertElementChange"),this.insertElementChange=e}isReadyToApply(){return this.insertElementChange.isReadyToApply(this.localDocument)}apply(e,t){_s.group("EnhancedInsertElementChange.apply()"),_s.debug(`Applying change: ${Bi(this.insertElementChange)}`);const i=this.createInsertionElement();t.registerSelectorAndExecute(this.insertElementChange.getTargetPosition().selector,(()=>{this.insertElement(i,e)}),{shouldReapply:this.shouldReapply.bind(this)},this.getEntityIds()),_s.groupEnd()}undo(){_s.group("EnhancedInsertElementChange.undo()"),_s.debug(`Undoing change: ${Bi(this.insertElementChange)}`),this.insertElementChange.getId().ifPresent((e=>{const t=on(e);1===t.length?t[0].remove():_s.warn(`Unexpected error when undoing insertElementChange. Auto-generated attribute\n        selector expected 1 element match but found ${t.length}`,191,this.getEntityIds())})),_s.groupEnd()}getSelector(){return D.empty()}insertElement(e,t){this.removeExistingElements(),this.insertElementChange.getTargetElement(this.localDocument).ifPresent((i=>{i.insertAdjacentElement(this.insertElementChange.getTargetPosition().insertPosition,e),t()})).ifAbsent((()=>{throw new Error("Unexpected error: targetElement not found")})),this.insertElementChange.getId().ifPresent((t=>{en(e,t,{value:this.insertElementChange.getElementType(),type:je.INSERT_ELEMENT}),an(e,t)}))}getInsertedElements(){return document.querySelectorAll(`#${this.insertElementChange.getIdAttribute()}`)}removeExistingElements(){const e=this.getInsertedElements();Array.prototype.forEach.call(e,(e=>{e.remove()}))}createInsertionElement(){let e;if(this.insertElementChange instanceof We)e=`h${this.insertElementChange.getSize()}`;else switch(this.insertElementChange.getElementType()){case"image":e="img";break;case"video":e="video";break;default:e="div"}const t=document.createElement(e);return t.id=this.insertElementChange.getIdAttribute(),t}shouldReapply(){return 0===this.getInsertedElements().length}}const Cn=class extends Xs{constructor(e,t,i,s,n){super(t,i,s,n),__publicField(this,"moveElementChange"),__publicField(this,"hasLoggedMutationWarning",!1),this.moveElementChange=e}static createAndInsertPlaceholderElement(e){const t=document.createElement("imizeplaceholder");return t.style.display="none",t.hidden=!0,e.after(t),t}isReadyToApply(){return this.moveElementChange.isReadyToApply(this.localDocument)}apply(e,t){_s.group("EnhancedMoveElementChange.apply()"),_s.debug(`Applying change: ${Bi(this.moveElementChange)}`),t.registerSelectorAndExecute(this.moveElementChange.getSelector(),(()=>{}),{shouldReapply:this.shouldReapply.bind(this)},this.getEntityIds()),this.moveElement(e),_s.groupEnd()}undo(){_s.group("EnhancedMoveElementChange.undo()"),_s.debug(`Undoing change: ${Bi(this.moveElementChange)}`),this.moveElementChange.getId().ifPresent((e=>{const t=on(e);if(1===t.length){const i=t[0];tn(i,e).ifPresent((({value:e})=>{null!==e.parentElement&&e.parentElement.replaceChild(i,e)})).ifAbsent((()=>{_s.warn(`Unexpected error when undoing moveElementChange. getChangeData(${e}): could not find data`,195,this.getEntityIds())})),ln(i,e),sn(i,e),i.removeAttribute(Cn.MOVE_ELEMENT_DATA_ATTRIBUTE_NAME)}else _s.warn(`Unexpected error when undoing moveElementChange. Auto-generated attribute\n        selector expected 1 element match but found ${t.length}`,196,this.getEntityIds())})),_s.groupEnd()}getSelector(){return D.of(this.moveElementChange.getSelector())}getMovedElement(){const e=document.querySelectorAll(`[${Cn.MOVE_ELEMENT_DATA_ATTRIBUTE_NAME}="${this.moveElementChange.getMoveId()}"]`);return 1===e.length?D.ofNullable(e[0]):D.empty()}shouldReapply(){return this.hasLoggedMutationWarning||(this.getMovedElement().ifPresent((()=>{_s.warn("[EnhancedMoveElementChange]: A mutation was observed for a move element change, however the moved element appears to still exists on the page",225,this.getEntityIds())})).ifAbsent((()=>{_s.warn("[EnhancedMoveElementChange]: A mutation was observed for a move element change and the moved element could not be found on the page.",226,this.getEntityIds())})),this.hasLoggedMutationWarning=!0),!1}moveElement(e){try{this.moveElementChange.getSelectorElement(this.localDocument).ifPresent((e=>{this.moveElementChange.getTargetElement(this.localDocument).ifPresent((t=>{if(e.contains(t))throw new Error("The target element cannot be a child of the selector element");this.moveElementChange.getId().ifPresent((t=>{an(e,t);const i=Cn.createAndInsertPlaceholderElement(e);en(e,t,{value:i,type:je.MOVE_ELEMENT})})),t.insertAdjacentElement(this.moveElementChange.getTargetPosition().insertPosition,e),e.setAttribute(Cn.MOVE_ELEMENT_DATA_ATTRIBUTE_NAME,this.moveElementChange.getMoveId())})).ifAbsent((()=>{throw new Error("Unexpected error: target element could not be found)")}))})).ifAbsent((()=>{throw new Error("Unexpected error: selector element could not be found)")}))}finally{e()}}};let Tn=Cn;__publicField(Tn,"MOVE_ELEMENT_DATA_ATTRIBUTE_NAME",`data-${pi}`);const xn="data-wf-",An=`${xn}experience-`,kn=`${xn}variation-`,Pn=`${xn}hidden-variation`,Dn="data-intellimize-var-";class Fn extends Xs{constructor(e,t,i,s,n){super(t,i,s,n),__publicField(this,"webflowChange"),__publicField(this,"experienceId"),__publicField(this,"variationId"),__publicField(this,"selector"),this.webflowChange=e;const r=t.getEntityIds();this.experienceId=S(r.experienceId,"experienceId must be defined"),this.variationId=S(r.variationId,"variationId must be defined"),w(this.getSelector().isPresent(),"getSelector should always return a selector"),this.selector=this.getSelector().get()}isReadyToApply(){return this.localDocument.querySelectorAll(this.selector).length>0}apply(e,t){_s.group("EnhancedWebflowChange.apply()"),_s.debug(`Applying change: ${Bi(this.webflowChange)} - ${this.selector}`),t.registerSelectorAndExecute(this.selector,(()=>{this.localDocument.querySelectorAll(`[${this.getWebflowExperienceAttribute()}]`).forEach((e=>{e.setAttribute(Pn,"")})),this.localDocument.querySelectorAll(`[${this.getWebflowVariationAttribute()}]`).forEach((e=>{e.removeAttribute(Pn),e.setAttribute(this.getIntellimizeVisibleVariationAttribute(),"")})),e()}),{shouldReapply:()=>this.shouldReapply()},this.getEntityIds()),_s.groupEnd()}undo(){}getSelector(){return D.of(`[${An}${this.experienceId}]`)}getWebflowExperienceAttribute(){return`${An}${this.experienceId}`}getWebflowVariationAttribute(){return`${kn}${this.variationId}`}getIntellimizeVisibleVariationAttribute(){return`${Dn}${this.variationId}`}shouldReapply(){for(const e of this.localDocument.querySelectorAll(`[${this.getWebflowExperienceAttribute()}]`)){const t=e.hasAttribute(this.getWebflowVariationAttribute());if(_s.debug(`CHECKING SHOULDREAPPLY: ${t}, ${e.hasAttribute(Pn)}, ${e.hasAttribute(this.getIntellimizeVisibleVariationAttribute())}, ${e.outerHTML}`),!t&&!e.hasAttribute(Pn))return _s.debug(`shouldReapply(): YES (The [${Pn}] attribute is missing from a non-selected variation)`),!0;if(t&&e.hasAttribute(Pn))return _s.debug(`shouldReapply(): YES (The [${Pn}] attribute is present on the selected variation)`),!0;if(t&&!e.hasAttribute(this.getIntellimizeVisibleVariationAttribute()))return _s.debug(`shouldReapply(): YES (The [${Dn}${this.variationId}] attribute is missing from the selected variation)`),!0}return _s.debug("shouldReapply(): NO (All data attributes are as expected)"),!1}}function Mn(e,t,i,s,n,r,o){switch(e.getType()){case je.ATTRIBUTE:case je.EXTENSION_ATTRIBUTE:return new vn(e,t,i,s,n);case je.CUSTOM_CODE:return new yn(e,t,i,s,n);case je.INSERT_ELEMENT:return new wn(e,t,i,s,n);case je.EXTENSION:return new In(e,t,i,s,n,r,o);case je.MOVE_ELEMENT:return new Tn(e,t,i,s,n);case je.WEBFLOW:return new Fn(e,t,i,s,n);default:throw new Error(`Unknown DomChangeType: ${e.getType()}`)}}class Nn{constructor(){__publicField(this,"state",0),this.state=0}markHiddenIfUnknown(){0===this.state&&(this.state=1)}markRevealed(){this.state=2}isHidden(){return 1===this.state}isRevealed(){return 2===this.state}}class On extends Nn{constructor(e,t,i,s,n){super(),__publicField(this,"experience"),__publicField(this,"environment"),__publicField(this,"extensionManager"),__publicField(this,"browserStorage"),__publicField(this,"attributeData"),this.experience=e,this.environment=t,this.extensionManager=i,this.browserStorage=s,this.attributeData=n}static getId(e){return`exp-${e.getId()}`}getId(){return On.getId(this.experience)}getSelectors(){let e=!1;const t={},i=this.experience.getBoundingSelectors();return this.experience.getRealVariations().forEach((i=>{i.isTypeChange()?i.getChanges().forEach(((s,n)=>{Mn(s,hn(i),n,this.attributeData,this.environment,this.browserStorage,this.extensionManager).getSelector().ifPresent((e=>{t[e]=!0})),s.getType()===je.CUSTOM_CODE&&(e=!0)})):i.isRedirect()?t.body=!0:e=!0})),e&&i.forEach((e=>{t[e]=!0})),Object.keys(t)}getEntityIds(){return{experienceId:this.experience.getId()}}}class Rn extends Nn{constructor(e,t,i,s,n){super(),__publicField(this,"page"),__publicField(this,"environment"),__publicField(this,"extensionManager"),__publicField(this,"browserStorage"),__publicField(this,"attributeData"),this.page=e,this.environment=t,this.extensionManager=i,this.browserStorage=s,this.attributeData=n}static getId(e){return`page-${e.getId()}`}getId(){return Rn.getId(this.page)}getSelectors(){const e={};return this.page.getChanges().forEach(((t,i)=>{Mn(t,gn(this.page),i,this.attributeData,this.environment,this.browserStorage,this.extensionManager).getSelector().ifPresent((t=>{e[t]=!0}))})),Object.keys(e)}getEntityIds(){return{pageId:this.page.getId()}}}class Ln{constructor(e,t){__publicField(this,"environment"),__publicField(this,"extensionManager"),__publicField(this,"regions",{}),this.environment=e,this.extensionManager=t}registerExperience(e,t,i){const s=On.getId(e);return void 0===this.regions[s]&&(this.regions[s]=new On(e,this.environment,this.extensionManager,t,i)),this.regions[s]}registerPage(e,t,i){const s=Rn.getId(e);return void 0===this.regions[s]&&(this.regions[s]=new Rn(e,this.environment,this.extensionManager,t,i)),this.regions[s]}getAll(){return Object.values(this.regions)}}const $n=class{constructor(e,t,i=!1){__publicField(this,"localWindow"),__publicField(this,"skipRegionHiding"),__publicField(this,"regionRegistry"),__publicField(this,"experienceRegionsHidden",!1),__publicField(this,"pageRegionsHidden",!1),this.localWindow=e.getWindow(),this.skipRegionHiding=i,this.regionRegistry=new Ln(e,t)}static revealAll(e){$n._revealDocument(e),$n._revealAllRegions(e)}static get ANTI_FLICKER_CLASS_NAME(){return"anti-flicker"}static get REGION_TIMEOUT_MS(){return 3e3}static get RENDERING_ATTRIBUTE_NAME(){return`${$n.ATTRIBUTE_NAME_PREFIX}rendering`}static getRegionAttribute(e){return`${$n.ATTRIBUTE_NAME_PREFIX}${e.getId()}`}static _revealDocument(e){_s.debug(`Hider.revealDocument() - before:${e.documentElement.className}`),e.documentElement.className=e.documentElement.className.replace(new RegExp(` ?${$n.ANTI_FLICKER_CLASS_NAME}`,"g"),""),_s.debug(`Hider.revealDocument() - after:${e.documentElement.className}`)}static _revealAllRegions(e){_s.info(`Removing ${$n.RENDERING_ATTRIBUTE_NAME} attribute`),e.documentElement.removeAttribute($n.RENDERING_ATTRIBUTE_NAME)}revealDocument(){$n._revealDocument(this.localWindow.document)}revealDocumentIfAllRegionsHidden(){this.experienceRegionsHidden&&this.pageRegionsHidden&&this.revealDocument()}startTimedRegionHider(){_s.debug("Hider.startTimedRegionHider()"),this.localWindow.document.documentElement.setAttribute($n.RENDERING_ATTRIBUTE_NAME,"true"),this.localWindow.setTimeout((()=>{$n._revealAllRegions(this.localWindow.document),this.regionRegistry.getAll().forEach((e=>{e.isHidden()&&_s.warn(`Region (${e.getId()}) was hidden at timeout`,209,e.getEntityIds())}))}),$n.REGION_TIMEOUT_MS)}hideExperiences(e,t,i){for(const s of e)_s.debug(`Hider - hide experience ${s.getId()}`),this.regionRegistry.registerExperience(s,t,i);this.setRegionHidingCss(),this.experienceRegionsHidden=!0}hidePages(e,t,i){for(const s of e)_s.debug(`Hider - hide page ${s.getId()}`),this.regionRegistry.registerPage(s,t,i);this.setRegionHidingCss(),this.pageRegionsHidden=!0}revealExperience(e,t,i){_s.debug(`Hider - reveal experience ${e.getId()}`),this.revealRegion(this.regionRegistry.registerExperience(e,t,i)),this.revealAllIfExperienceRegionsVisible()}revealPage(e,t,i){_s.debug(`Hider - reveal page ${e.getId()}`),this.revealRegion(this.regionRegistry.registerPage(e,t,i))}revealAllIfExperienceRegionsVisible(){this.regionRegistry.getAll().every((e=>e.isRevealed()))&&$n.revealAll(this.localWindow.document)}revealRegion(e){const t=e.getSelectors();if(t.length>0){const i=this.localWindow.document.querySelectorAll(t.join(", "));Array.prototype.forEach.call(i,(t=>{t.setAttribute(`${$n.getRegionAttribute(e)}`,"true")}))}e.markRevealed()}setRegionHidingCss(){if(this.skipRegionHiding)return;const e=[];this.regionRegistry.getAll().forEach((t=>{t.getSelectors().forEach((i=>{const s=`html[${$n.RENDERING_ATTRIBUTE_NAME}] ${i}:not([${$n.getRegionAttribute(t)}])`;e.push(s,`${s} *`)}))}));const t=e.length>0?`${e.join(", ")} { visibility: hidden !important; opacity: 0 !important; }`:"";Fs.injectCss(t,"anti-flicker-regions",this.localWindow.document),this.regionRegistry.getAll().forEach((e=>{e.markHiddenIfUnknown()}))}};let Un=$n;__publicField(Un,"ATTRIBUTE_NAME_PREFIX","data-intellimize-anti-flicker-");const Vn=2,Wn=1,zn=Wn,jn=class{constructor(){__publicField(this,"mutationObserver"),__publicField(this,"mutationHandlers",{}),__publicField(this,"currentUrl"),this.mutationObserver=new MutationObserver((e=>{if(Object.keys(this.mutationHandlers).length>0){if(Os.group("MutationObserver.observe() - window.location.href: "+window.location.href),this.currentUrl||(this.currentUrl=window.location.href),this.currentUrl!==window.location.href)return Os.debug("MutationObserver skip processing since URL changed"),void Os.groupEnd();jn.containsValidMutations(e)?(Os.debug("mutationList contains at least one valid mutation; processing store"),this.processStore()):Os.debug("mutationList contains no valid mutations; skipping store processing"),Os.groupEnd()}})),this.reset()}static get CALLBACK_MAX_COUNT(){return 25}static get MISSING_ELEMENT_MAX_COUNT(){return 5}static get CALLBACK_THROTTLE_MS(){return 50}static selectorExists(e){try{return Boolean(document.querySelector(e))}catch(t){return!1}}static isProcessed(e,t){var i,s,n,r;switch(zn){case Wn:return"string"==typeof(null==(i=e.imizeObserverProcessed)?void 0:i[t])||!0===(null==(s=e.imizeObserverProcessed)?void 0:s[t])?(Os.debug('isProcessed (OPT_CHECK_BOOL): imizeObserverProcessed is "true"'),!0):(Os.debug('isProcessed (OPT_CHECK_BOOL): imizeObserverProcessed is NOT "true"'),!1);case Vn:return"string"==typeof(null==(n=e.imizeObserverProcessed)?void 0:n[t])||!0===(null==(r=e.imizeObserverProcessed)?void 0:r[t])?e.imizeObserverProcessed[t]===e.outerHTML?(Os.debug("isProcessed (OPT_COMPARE_HTML): imizeObserverProcessed outerHTML matches"),!0):(Os.debug("isProcessed (OPT_COMPARE_HTML): imizeObserverProcessed outerHTML DOES NOT match"),Os.debug(`outerHTML: ${e.outerHTML}`),Os.debug(`imizeObserverProcessed: ${e.imizeObserverProcessed[t]}`),e.imizeObserverProcessed[t]=!1,!1):(Os.debug("isProcessed (OPT_COMPARE_HTML): imizeObserverProcessed does not exist on the element"),!1);default:return Os.debug("isProcessed (OPT_ALWAYS_CALLBACK): skipping check"),!1}}static setIsProcessed(e,t){switch(void 0===e.imizeObserverProcessed&&(e.imizeObserverProcessed={}),zn){case Wn:e.imizeObserverProcessed[t]=!0;break;case Vn:e.imizeObserverProcessed[t]=e.outerHTML}}static isValidNodeNameMutation(e){var t;if(jn.INVALID_NODE_NAMES.includes(e.target.nodeName))return Os.debug(`Invalid mutation - Node is one of ${Bi(jn.INVALID_NODE_NAMES)}`),!1;if(!0===(null==(t=e.attributeName)?void 0:t.startsWith(Un.ATTRIBUTE_NAME_PREFIX)))return!1;if("childList"===e.type){if(Array.prototype.every.call([...Array.prototype.slice.call(e.addedNodes),...Array.prototype.slice.call(e.removedNodes)],(e=>jn.INVALID_NODE_NAMES.includes(e.nodeName))))return Os.debug("Invalid mutation - All nodes in child list contain one of "+Bi(jn.INVALID_NODE_NAMES)),!1}return!0}static isUnchangedAttributeMutation(e){const{target:t,type:i,attributeName:s,oldValue:n}=e;if(t instanceof HTMLElement&&"attributes"===i&&s){const e=t.attributes.getNamedItem(s);if(null!==e&&e.value===n)return Os.debug(`Invalid mutation - value for attribute "${s}" hasn't changed (value: "${n}")`),!0}return!1}static isStatusModuleNode(e){const t="intellimize____status-module-root";return e instanceof HTMLElement&&(e.id===t?(Os.debug("Invalid mutation - Node is part of the status module"),!0):null!==e.parentNode&&jn.isStatusModuleNode(e.parentNode))}static containsValidMutations(e){Os.group("containsValidMutations()");const t=e.every((e=>(Os.debug(`Mutation: ${qi(e)}`),!(jn.isValidNodeNameMutation(e)&&!jn.isUnchangedAttributeMutation(e)&&!jn.isStatusModuleNode(e.target))||(Os.debug("Found valid mutation"),!1))));return Os.groupEnd(),!t}registerSelectorAndExecute(e,t,i,s){if(!jn.selectorExists(e))throw new Error(`Selector "${e}" does not exist in the DOM`);const n=bn();this.mutationHandlers[n]={selector:e,callback:t,options:i,startTime:new Date,mutationCnt:0,missingElementCnt:0,entityIds:s},Os.group(`registerSelectorAndExecute(${n})`),Os.debug("Manually calling handleObservation()"),this.detachObserver(),this.handleObservation(n,!1),this.attachObserver(),Os.groupEnd()}attachObserver(){Os.debug("Attaching observer to document"),this.mutationObserver.observe(document.documentElement,jn.observerOpts)}detachObserver(){Os.debug("Detaching observer from document"),this.mutationObserver.disconnect()}reset(){Os.debug("Resetting ElementObserver state"),this.mutationHandlers={},this.currentUrl=void 0,this.detachObserver()}processStore(){Os.group("ReapplyElementObserver.processStore()"),Os.debug(`mutationHandlers: ${Bi(this.mutationHandlers)}`),this.detachObserver(),Object.keys(this.mutationHandlers).forEach((e=>{this.handleObservation(e,!0)})),this.attachObserver(),Os.groupEnd()}handleObservation(e,t){const i=this.mutationHandlers[e];if(Os.group(`handleObservation(${e})`),t&&i.options.observationTimeMs&&Date.now()-i.startTime.getTime()>i.options.observationTimeMs)return 0===i.mutationCnt?void 0!==i.options.onTimeout&&(_s.error(`MutationHandler timed out for ${i.selector}. observationTimeMs (${i.options.observationTimeMs}) has passed.`,140,i.entityIds),i.options.onTimeout()):_s.warn(`Observation cancelled for ${i.selector}. observationTimeMs (${i.options.observationTimeMs}) has passed.`,141,i.entityIds),this.cancelObservation(e),void Os.groupEnd();if(i.mutationCnt>=jn.CALLBACK_MAX_COUNT)return Os.debug(`Reached CALLBACK_MAX_COUNT (${jn.CALLBACK_MAX_COUNT})`),this.cancelObservation(e),void Os.groupEnd();if(void 0!==i.lastCallbackTime){const e=Date.now()-i.lastCallbackTime.getTime();if(e<jn.CALLBACK_THROTTLE_MS)return Os.debug(`Throttling callback (${jn.CALLBACK_THROTTLE_MS}ms). Only (${e})ms have elapsed`),void Os.groupEnd()}const s=document.querySelectorAll(i.selector);if(Os.debug(`Found ${s.length} matching elements`),s.length>0){const n=t=>!jn.isProcessed(t,e)||void 0!==i.options.shouldReapply&&i.options.shouldReapply(t);Array.prototype.forEach.call(s,(s=>{if(Os.debug(`Processing element: ${Ki(s)}`),!t||n(s)){Os.debug("isProcessed: false");let n="Triggering callback for element";t&&(i.mutationCnt+=1,i.lastCallbackTime=new Date,n+=` (mutationCnt: ${i.mutationCnt})`),Os.debug(n),i.callback(s),jn.setIsProcessed(s,e),i.options.once&&this.cancelObservation(e)}else Os.debug("isProcessed: true (skipping)")}))}else _s.warn(`Could not find any matching elements for ${i.selector}`,139,i.entityIds),i.missingElementCnt+=1,i.missingElementCnt>=jn.MISSING_ELEMENT_MAX_COUNT&&(Os.debug(`Reached MISSING_ELEMENT_MAX_COUNT (${jn.MISSING_ELEMENT_MAX_COUNT})`),this.cancelObservation(e));Os.groupEnd()}cancelObservation(e){delete this.mutationHandlers[e]}};let Gn=jn;__publicField(Gn,"INVALID_NODE_NAMES",["HTML","SCRIPT","LINK","STYLE","HEAD","IFRAME","TITLE","META"]),__publicField(Gn,"observerOpts",{subtree:!0,childList:!0,attributes:!0,characterData:!0,attributeOldValue:!0,characterDataOldValue:!0});class Bn{constructor(e){__publicField(this,"rawUrl"),__publicField(this,"urlObject"),this.rawUrl=S(e),this.urlObject=new URL(e)}getRawUrl(){return this.rawUrl}getOrigin(){return this.urlObject.origin}getQueryParam(e,t){let i=D.ofNullable(this.urlObject.searchParams.get(e));return i.isPresent()&&!t(i.get())&&(_s.error(`Validator failed for ${e}`,28),i=D.empty()),i}getAllQueryParamsUnsafe(){const e={};for(const[t,i]of this.urlObject.searchParams.entries())t.length>0&&i.length>0&&!Object.prototype.hasOwnProperty.call(e,t)&&(e[t]=i);return e}}var Hn=(e=>(e[e.LN=0]="LN",e[e.EA=1]="EA",e[e.DT=2]="DT",e[e.EE=3]="EE",e[e.NT=4]="NT",e))(Hn||{}),Qn=(e=>(e[e.WD=0]="WD",e[e.WE=1]="WE",e))(Qn||{});const qn=`${Ui}Domain`,Kn=`${Ui}Site`,Yn=`${Ui}Page`,Jn=`${Ui}Collection`,Xn=`${Ui}ItemSlug`,Zn=`${Ui}Experiences`;class er{constructor(e,t){__publicField(this,"localWindow"),__publicField(this,"nativeFetch"),__publicField(this,"nativeSendBeacon"),__publicField(this,"timeZone"),__publicField(this,"date"),__publicField(this,"windowWidth"),__publicField(this,"windowHeight"),__publicField(this,"webflowPageMetadata"),__publicField(this,"pageviewId"),__publicField(this,"visibilityChangeName"),__publicField(this,"isHidden"),__publicField(this,"hostingPageUrl"),__publicField(this,"referrerUrl"),this.nativeFetch=e.fetch.bind(e),this.nativeSendBeacon=e.navigator.sendBeacon.bind(e.navigator),this.timeZone=t,this.localWindow=e,this.visibilityChangeName="visibilitychange",this.isHidden=()=>!1,this.reinitialize()}reinitialize(){_s.debug("Environment.reinitialize()"),this.hostingPageUrl=new Bn(this.localWindow.location.href),this.referrerUrl=r(this.localWindow.document.referrer)?new Bn(this.localWindow.document.referrer):void 0,void 0!==this.localWindow.document.hidden?(this.isHidden=()=>this.localWindow.document.hidden,this.visibilityChangeName="visibilitychange"):void 0!==this.localWindow.document.msHidden?(this.isHidden=()=>this.localWindow.document.msHidden,this.visibilityChangeName="msvisibilitychange"):void 0!==this.localWindow.document.webkitHidden&&(this.isHidden=()=>this.localWindow.document.webkitHidden,this.visibilityChangeName="webkitvisibilitychange"),this.windowWidth=this.localWindow.innerWidth,this.windowHeight=this.localWindow.innerHeight,this.date=this.getNowDate(),this.pageviewId=bn(),this.reinitializeWebflowPageMetadata()}getHostingPageUrl(){return this.hostingPageUrl}getReferrerUrl(){return D.ofNullable(this.referrerUrl)}hasHostingPageUrlChanged(){const e=new Bn(this.localWindow.location.href);return this.hostingPageUrl.getRawUrl()!==e.getRawUrl()}getTimeZone(){return this.timeZone}getDayPart(){const e=this.getInitializeDate().getHours();let t;return t=e>=0&&e<7?0:e>=7&&e<10?1:e>=10&&e<17?2:e>=17&&e<20?3:4,Hn[t]}getWeekPart(){const e=this.getInitializeDate().getDay();return Qn[0===e||6===e?1:0]}getInitializeDate(){return new Date(this.date.getTime())}getInitializeUnixTime(){return Math.round(this.date.getTime()/vi)}getNowDate(){return new Date}getNowUnixTime(){return Math.round(this.getNowUnixTimeMs()/vi)}getNowUnixTimeMs(){return this.getNowDate().getTime()}getWidowWidth(){return D.ofNullable(this.windowWidth)}getWidowHeight(){return D.ofNullable(this.windowHeight)}getScreenOrientation(){return void 0!==this.windowHeight&&void 0!==this.windowWidth?this.windowWidth>this.windowHeight?D.of("landscape"):D.of("portrait"):D.empty()}getPageviewId(){return this.pageviewId}writeCookie(e){_s.debug("Environment.writeCookie("+e+")"),this.localWindow.document.cookie=e}readAllCookies(){return D.ofNullable(this.localWindow.document.cookie)}readCookie(e){const t=e+"=";let i=D.empty();return this.readAllCookies().ifPresent((e=>{const s=e.split(";");for(let n of s){for(;n.startsWith(" ");)n=n.slice(1);n.startsWith(t)&&(i=D.of(n.slice(t.length)))}})),i}writeLocalStorage(e,t){this.localWindow.localStorage.setItem(e,t)}readLocalStorage(e){return D.ofNullable(this.localWindow.localStorage.getItem(e))}deleteLocalStorage(e){this.localWindow.localStorage.removeItem(e)}writeSessionStorage(e,t){this.localWindow.sessionStorage.setItem(e,t)}readSessionStorage(e){return D.ofNullable(this.localWindow.sessionStorage.getItem(e))}deleteSessionStorage(e){this.localWindow.sessionStorage.removeItem(e)}readLocalStorageMatching(e){const t={};return Object.keys(this.localWindow.localStorage).forEach((i=>{e.test(i)&&(t[i]=this.readLocalStorage(i).get())})),t}getWindow(){return this.localWindow}getNowVisibilityState(){return"document"in this.localWindow&&"visibilityState"in this.localWindow.document?D.ofNullable(this.localWindow.document.visibilityState):D.empty()}isNowDocumentHidden(){return"document"in this.localWindow?D.ofNullable(this.isHidden()):D.empty()}addListener(e,t){this.localWindow.addEventListener(e,t)}addListenerVisibilityChange(e){this.localWindow.document.addEventListener(this.visibilityChangeName,e,{once:!0,capture:!1})}addUnloadHandler(e){this.localWindow.addEventListener("beforeunload",e,!1)}redirect(e){this.localWindow.document.location.replace(e)}generateActionId(){return this.getNowUnixTime()+"-"+En()}injectScript(e,t=!1){const i=this.localWindow.document.createElement("script");i.async=t,i.src=e;const s=this.localWindow.document.querySelectorAll("script")[0];s.parentNode.insertBefore(i,s)}sendBeacon(e,t){return this.nativeSendBeacon(e,t)}fetch(e,t){return __async(this,arguments,(function*(e,t,i={}){const s=gs(e,t);return this.nativeFetch(s,i).then((e=>{if(!e.ok)throw new tr(s,e.status);if(204!==e.status)return e.json()}))}))}legacySynchronousXhr(e,t){return __async(this,arguments,(function*(e,t,i={}){return new Promise(((s,n)=>{var r;const o=gs(e,t),a=new XMLHttpRequest;a.open(null!=(r=i.method)?r:"GET",o,!1),a.addEventListener("load",(()=>{a.status>=200&&a.status<=299?s():n(new tr(o,a.status))})),a.addEventListener("error",(()=>{n(new tr(o,a.status))})),a.send(i.body)}))}))}getWebflowPageMetadata(){return this.webflowPageMetadata}reinitializeWebflowPageMetadata(){var e;const t=this.localWindow.document.documentElement.dataset[qn],i=this.localWindow.document.documentElement.dataset[Kn],s=this.localWindow.document.documentElement.dataset[Yn],n=this.localWindow.document.documentElement.dataset[Jn],r=this.localWindow.document.documentElement.dataset[Xn],o=(null!=(e=this.localWindow.document.documentElement.dataset[Zn])?e:"").split(",");this.webflowPageMetadata={domain:t,pageId:s,siteId:i,collectionId:n,itemSlug:r,experienceIds:o}}}class tr extends Error{constructor(e,t){super(`(${t}) ${e.toString()}`),this.name="JsonFetchError"}}const ir=()=>{const e={};return{getExtension:t=>D.ofNullable(e[t]),registerExtension(t){e[t.getName()]=t}}};class sr{constructor(e,t,i,s){__publicField(this,"iEvent"),__publicField(this,"actionId"),__publicField(this,"eventInstanceId"),__publicField(this,"eventValue"),__publicField(this,"nativeClickEvent"),this.iEvent=e,this.actionId=t,this.eventInstanceId=`${e.getId()}:${t}`,this.eventValue=i,this.nativeClickEvent=s}getEvent(){return this.iEvent}getEventId(){return this.iEvent.getId()}getActionId(){return this.actionId}getEventInstanceId(){return this.eventInstanceId}getEventValue(){return D.ofNullable(this.eventValue)}getNativeMouseEvent(){return D.ofNullable(this.nativeClickEvent)}toString(){return`ConversionEventContext(${this.getEventId()}, ${this.getEventInstanceId()})`}}function nr(e){return e.getIntegrationDemandbase().map((e=>e.isEnabled())).orElse(!1)}function rr(e){return e.getIntegrationFirmographic().map((e=>e.isEnabled())).orElse(!1)}const or=["marketo","salesforce","firmographic","6sense","googleAds","demandbase","hubspot"],ar=(e,t)=>`i${e}${t}`,lr={adGroup:ar("ga","ag"),campaign:ar("ga","cm"),network:ar("ga","nt"),adType:ar("ga","at"),keyword:ar("ga","kw"),creative:ar("ga","cr"),matchType:ar("ga","mt")};function cr(e){return e.getIntegrationGoogleAds().map((e=>e.isEnabled())).orElse(!1)}function ur(e,t,i){if(!ds(e,i).orElse(!1)){const i=dr(e);t.setDataAndMetadata("googleAds",i,void 0)}}function dr(e){const t={};return Object.entries(lr).forEach((([i,s])=>{e.getHostingPageUrl().getQueryParam(s,r).ifPresent((e=>{t[i]=e}))})),t}function hr(e){return e.getIntegrationHubspot().map((e=>e.isEnabled())).orElse(!1)}function gr(e){return e.readCookie($i)}function pr(e){return"hsFormCallback"===e.data.type&&"onFormSubmitted"===e.data.eventName}function mr(e){return e.getIntegrationMarketo().map((e=>e.isEnabled())).orElse(!1)}function vr(e){return e.readCookie(Li)}function br(e){var t,i;return void 0!==(null==(t=null==e?void 0:e.lead)?void 0:t.fields)||void 0!==(null==(i=null==e?void 0:e.lead)?void 0:i.lists)}function fr(e){var t,i;return void 0===(null==(t=null==e?void 0:e.lead)?void 0:t.fields)&&void 0===(null==(i=null==e?void 0:e.lead)?void 0:i.lists)}function Er(e){if(void 0===e)return D.empty();if(br(e))return D.of(e);if(fr(e)){const t=e,{smartLists:i,staticLists:s}=t,n=__objRest(t,["smartLists","staticLists"]),r=(null!=i?i:[]).map((e=>({type:"smart",id:Number(e)}))),o=(null!=s?s:[]).map((e=>({type:"static",id:Number(e)})));return D.of({lead:{fields:n,lists:[...r,...o]}})}return D.empty()}const _r=ar("sf","lh"),yr=ar("sf","ch");function Sr(e){return e.getIntegrationSalesforce().map((e=>e.isEnabled())).orElse(!1)}function Ir(e){const t=e.getHostingPageUrl().getQueryParam(_r,r),i=e.getHostingPageUrl().getQueryParam(yr,r);if(t.isPresent()||i.isPresent()){const e={};return t.ifPresent((t=>{e.leadIdHash=t})),i.ifPresent((t=>{e.contactIdHash=t})),D.of(e)}return D.empty()}function wr(e){return e.getIntegrationSixsense().map((e=>e.isEnabled())).orElse(!1)}const Cr={"6sense":e=>wr(e),demandbase:e=>nr(e),firmographic:e=>rr(e),googleAds:e=>cr(e),marketo:e=>mr(e),salesforce:e=>Sr(e),hubspot:e=>hr(e)};var Tr=(e=>(e[e.NOT_STARTED=0]="NOT_STARTED",e[e.TRY_LATER=1]="TRY_LATER",e[e.WAITING=2]="WAITING",e[e.SUCCEEDED=3]="SUCCEEDED",e[e.FAILED=4]="FAILED",e[e.CANCELED=5]="CANCELED",e))(Tr||{});const xr=new Set([0,1,2]),Ar=class{constructor(){__publicField(this,"manager"),__publicField(this,"id"),__publicField(this,"doneFunctions",[]),__publicField(this,"currentStatus",0),this.id=++Ar.lastId}static isDone(e){return!xr.has(e)}getId(){return this.id}setManager(e){this.manager=e}cancel(){this.currentStatus=5,this.cleanup()}cleanup(){}runWrapper(){_s.group(this.toString()+".run()");const e=this.currentStatus;try{this.currentStatus=this.run()}catch(i){const e=new Ee("Task exception",i);_s.error(e,179,this.getEntityIds()),this.currentStatus=4}const t=this.currentStatus;return!Ar.isDone(e)&&Ar.isDone(t)&&this.executeDoneFunctions(),_s.groupEnd(),this.currentStatus}onDone(e){this.isDone()?Fs.executeFunction(e,153):this.doneFunctions.push(e)}getStatus(){return this.currentStatus}isDone(){return!xr.has(this.currentStatus)}getNotDoneDependencies(){return[]}isBlocked(){if(2===this.currentStatus)return!0;return this.getNotDoneDependencies().filter((e=>e.isBlocked())).length>0}toString(){return`Task(${this.id})`}getEntityIds(){return{}}setStatusTryLater(){this.currentStatus=1}executeDoneFunctions(){for(let e=this.doneFunctions.shift();void 0!==e;e=this.doneFunctions.shift())Fs.executeFunction(e,154)}};let kr=Ar;__publicField(kr,"lastId",0);class Pr extends kr{constructor(e,t,i){super(),__publicField(this,"conversionEventContext"),__publicField(this,"browserEventLogger"),__publicField(this,"customerStorage"),__publicField(this,"trackBrowserEvents",{}),__publicField(this,"hasSentGoals",!1),this.conversionEventContext=S(e),this.browserEventLogger=S(t),this.customerStorage=S(i)}toString(){return"GoalTask("+this.conversionEventContext.toString()+")"}getEntityIds(){return{eventId:this.conversionEventContext.getEventId()}}inTransaction(){return!0}isUnloading(){return!1}run(){this.hasSentGoals||this.sendGoalsOnce();if(Object.keys(this.trackBrowserEvents).map((e=>this.trackBrowserEvents[e])).some((e=>void 0===e||!kr.isDone(e))))return _s.debug("Waiting for goal event delivery confirmation"),Tr.TRY_LATER;return Object.keys(this.trackBrowserEvents).map((e=>this.trackBrowserEvents[e])).every((e=>void 0!==e&&e===Tr.SUCCEEDED))?Tr.SUCCEEDED:Tr.FAILED}sendGoalsOnce(){_s.debug("sendGoalsOnce()"),this.hasSentGoals=!0;const e="click"!==this.conversionEventContext.getEvent().getType();let t=0;this.conversionEventContext.getEvent().getMetrics().forEach((i=>{i.getCampaign().ifPresent((s=>{s.getExperiences().forEach((s=>{this.customerStorage.getVariation(s).ifPresent((n=>{const r=i.getId()+":"+n.getId();this.trackBrowserEvents[r]=Tr.TRY_LATER,_s.info(`Sending goal ${i.getId()} event`),t++,this.browserEventLogger.sendGoal(n,i,this.conversionEventContext,e).then((()=>{_s.info(`Goal ${i.getId()} event delivery success`),this.trackBrowserEvents[r]=Tr.SUCCEEDED})).catch((e=>{const t=new Ee(`Goal ${i.getId()} event delivery failed`,e);_s.error(t,78,{eventId:this.conversionEventContext.getEventId(),experienceId:s.getId(),variationId:n.getId()}),this.trackBrowserEvents[r]=Tr.FAILED}))}))}))}))})),_s.debug(`Sent ${t} goal events`)}}class Dr extends kr{constructor(e,t,i,s,n){super(),__publicField(this,"conversionEventContext"),__publicField(this,"browserEventLogger"),__publicField(this,"customer"),__publicField(this,"customerStorage"),__publicField(this,"statusModel"),__publicField(this,"conversionSent",!1),__publicField(this,"conversionStatus",Tr.NOT_STARTED),__publicField(this,"goalTask"),this.conversionEventContext=S(e),this.browserEventLogger=S(t),this.customer=S(i),this.customerStorage=S(s),this.statusModel=S(n)}toString(){return`ConversionEventTask(${this.conversionEventContext.toString()})`}getEntityIds(){return{eventId:this.conversionEventContext.getEventId()}}inTransaction(){return!this.conversionSent}isUnloading(){return!1}run(){return this.sendOnce(),this.scheduleGoalTaskOnce(),kr.isDone(this.conversionStatus)?!this.customer.hasClassicAccess()||void 0!==this.goalTask&&kr.isDone(this.goalTask.getStatus())?this.conversionStatus===Tr.SUCCEEDED?Tr.SUCCEEDED:Tr.FAILED:(_s.debug("Waiting for goal task event confirmation"),Tr.TRY_LATER):(_s.debug("Waiting for conversion event delivery confirmation"),Tr.TRY_LATER)}sendOnce(){if(!this.conversionSent){_s.info(`Sending conversion event ${this.conversionEventContext.toString()}`);const e=this.conversionEventContext.getEvent(),t=[],i=e.getMetrics().map((i=>{const s=En();return t.push({metric:i,modelEventId:s}),{metric:i,event:e,status:Tr.WAITING,id:s}}));this.statusModel.setMetricEventData(i),this.browserEventLogger.sendConversion(this.conversionEventContext).then((()=>{_s.info(`Conversion event ${this.conversionEventContext.toString()} delivery success`),this.conversionStatus=Tr.SUCCEEDED,this.statusModel.setMetricEventData(t.map((({modelEventId:t,metric:i})=>({metric:i,event:e,status:Tr.SUCCEEDED,id:t}))))})).catch((i=>{const s=new Ee(`Conversion event ${this.conversionEventContext.toString()} delivery failed`,i);_s.warn(s,76,{eventId:this.conversionEventContext.getEventId()}),this.conversionStatus=Tr.FAILED,this.statusModel.setMetricEventData(t.map((({modelEventId:t,metric:i})=>({metric:i,event:e,status:Tr.FAILED,id:t}))))})),this.conversionSent=!0}}scheduleGoalTaskOnce(){this.customer.hasClassicAccess()&&void 0===this.goalTask&&(this.goalTask=new Pr(this.conversionEventContext,this.browserEventLogger,this.customerStorage),this.manager.addTask(this.goalTask))}}class Fr extends kr{constructor(e,t,i,s,n,r){super(),__publicField(this,"sent",!1),__publicField(this,"deliveryStatus",Tr.NOT_STARTED),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"userDomain1"),__publicField(this,"userId1"),__publicField(this,"userDomain2"),__publicField(this,"userId2"),this.environment=e,this.customer=t,this.userDomain1=i,this.userId1=s,this.userDomain2=n,this.userId2=r}static get ENDPOINT(){return"/user-alias"}toString(){return`UserAliasTask(userDomain1: ${this.userDomain1}, userId1: ${this.userId1}, userDomain2: ${this.userDomain2}, userId2: ${this.userId2})`}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.deliveryStatus===Tr.SUCCEEDED?Tr.SUCCEEDED:this.deliveryStatus===Tr.FAILED?Tr.FAILED:(_s.debug("Waiting for user alias delivery confirmation"),Tr.TRY_LATER)}sendOnce(){this.sent||(_s.info(`Sending request to set up user alias for userDomain1: ${this.userDomain1}, userId1: ${this.userId1}, userDomain2: ${this.userDomain2}, userId2: ${this.userId2}`),this.environment.fetch(Ci,Fr.ENDPOINT,{method:"POST",headers:{"Content-Type":"text/plain;charset=UTF-8"},body:Hi({customerId:this.customer.getId(),userDomain1:this.userDomain1,userId1:this.userId1,userDomain2:this.userDomain2,userId2:this.userId2})}).then((()=>{this.deliveryStatus=Tr.SUCCEEDED,_s.info(`Successfully set up user alias for userDomain1: ${this.userDomain1}, userId1: ${this.userId1}, userDomain2: ${this.userDomain2}, userId2: ${this.userId2}`)})).catch((e=>{const t=fe(e);_s.error(t,92),this.deliveryStatus=Tr.FAILED})),this.sent=!0)}}function Mr(e){if("string"==typeof e){const t=e.search(/[.\-\d]/g);if(-1===t)return!1;const i=e.slice(Math.max(0,t));if(!/^-?\d*\.?\d{0,2}$/.test(i))return!1}else{if("number"!=typeof e)return!1;{const t=String(e);if(!/^-?\d*\.?\d{0,2}$/.test(t))return!1}}return!0}function Nr(e){return"string"==typeof e&&/^[\u0021-\u007E]{1,300}$/.test(e)}function Or(e){return Us(e)&&("number"==typeof e.amount||"string"==typeof e.amount)&&"string"==typeof e.currencyCode}function Rr(e,t,i,s,n,r,o,a,l,c,u){$r(e,t).ifPresent((({eventName:d,eventActionId:h,eventValue:g})=>{var p;if(i.getShopifyEvent(d).ifPresent((d=>{const p=new sr(d,h,g,void 0);try{o.add(io.buildShopifyActivity(e,t,p,i,s,a,r,n))}catch(v){const e=new Ee("Failed to build Shopify Activity",v);_s.error(e,234)}const m=new Dr(p,u,i,n,l);c.addTask(m)})).ifAbsent((()=>{_s.error(`Shopify pixel event not configured for customer: "${e.name}"`,252)})),"checkout_completed"===d){const t=null==(p=e.data.checkout.order)?void 0:p.id;void 0===t?_s.error("Received a checkout_completed event without an order id",250):i.getShopifyServerSideEvent().ifPresent((()=>{const e=new Fr(s,i,"__shopifyOrder",t,"intellimize",a.getId());c.addTask(e)})).ifAbsent((()=>{_s.error("Shopify server-side event not configured for customer",253)}))}}))}function Lr(e,t,i){let s;switch(e.name){case"collection_viewed":{const t=e;s=__spreadProps(__spreadValues({},i),{eventType:"s",customerEventName:"collection_viewed",data:Br(t.data.collection)});break}case"product_viewed":{const n=e;s=__spreadProps(__spreadValues({},i),{eventType:"s",customerEventName:"product_viewed",data:Gr(n.data.productVariant,Vr("product_viewed"),t)});break}case"checkout_started":{const n=e;s=__spreadProps(__spreadValues({},i),{eventType:"s",customerEventName:"checkout_started",data:Hr(n.data.checkout,Vr("checkout_started"),t)});break}case"checkout_completed":{const n=e;s=__spreadProps(__spreadValues({},i),{eventType:"s",customerEventName:"checkout_completed",data:Hr(n.data.checkout,Vr("checkout_completed"),t)});break}case"product_added_to_cart":{const n=e;s=__spreadProps(__spreadValues({},i),{eventType:"s",customerEventName:"product_added_to_cart",data:Qr(n.data.cartLine,Vr("product_added_to_cart"),t)});break}case"search_submitted":{const t=e;s=__spreadProps(__spreadValues({},i),{eventType:"s",customerEventName:"search_submitted",data:qr(t.data.searchResult)});break}default:throw new Error(`Unsupported customer event: ${e.name}`)}return _s.debug(`Shopify activity (${e.name}): ${Bi(s.data)}`),s}function $r(e,t){var i,s;let n;if(!Us(e))return jr("Not an object"),D.empty();if(!r(e.name))return jr(`Event name is not a valid event name: "${e.name}"`),D.empty();if(!Ur(e.name))return D.empty();if(!Nr(e.id))return jr(`Event ID is not a valid action id: "${e.id}"`),D.empty();if(!o(e.data)){if(!Us(e.data))return jr(`Event data is defined, and is not an object: "${Bi(e.data)}"`),D.empty();Wr(e.name,e.data,t).ifPresent((e=>{n=e}))}let a=e.id;if("checkout_completed"===e.name){const t=e;(null==(s=null==(i=t.data)?void 0:i.checkout)?void 0:s.order)?a=t.data.checkout.order.id:_s.error("Received a checkout_completed event without an order id",249)}return D.of({eventName:e.name,eventActionId:a,eventValue:n})}function Ur(e){return ui.includes(e)}function Vr(e){switch(e){case"product_viewed":return"productVariant.price.amount";case"product_added_to_cart":return"cartLine.merchandise.price.amount";case"checkout_started":case"checkout_completed":return"checkout.subtotalPrice.amount";default:throw new Error(`Cannot get event value path for ${e}`)}}function Wr(e,t,i){let s,n;function r(e){return Us(e)?!!Or(e.subtotalPrice)||(jr(`Checkout data exists, but subtotal price is not valid: "${Bi(e.subtotalPrice)}"`),!1):(jr("Checkout data is not an object"),!1)}switch(e){case"checkout_started":if(!r(t.checkout))return D.empty();s=t.checkout.subtotalPrice.amount,n=Vr("checkout_started");break;case"checkout_completed":if(!r(t.checkout))return D.empty();s=t.checkout.subtotalPrice.amount,n=Vr("checkout_completed");break;case"product_added_to_cart":if(!Us(t.cartLine))return jr("CartLine data is not an object"),D.empty();if(!Us(t.cartLine.merchandise))return jr("CartLine data exists, but does not include a product variant"),D.empty();if(!Or(t.cartLine.merchandise.price))return jr(`CartLine ProductVariant data exists, but price is not valid: "${Bi(t.cartLine.merchandise.price)}"`),D.empty();s=t.cartLine.merchandise.price.amount,n=Vr("product_added_to_cart");break;case"product_viewed":if(!Us(t.productVariant))return jr("ProductVariant data is not an object"),D.empty();if(!Or(t.productVariant.price))return jr(`ProductVariant data exists, but price is not valid: "${Bi(t.productVariant.price)}"`),D.empty();s=t.productVariant.price.amount,n=Vr("product_viewed");break;default:return D.empty()}const o=zr(s,n,i);return Mr(o)?D.of(o):(jr(`Event value is not valid: "${s}"`),D.empty())}function zr(e,t,i){let s=Number(e)/i;return/^-?\d*\.\d{3,}$/.test(String(s))&&(_s.debug(`Found currency with > 2 decimal places: "${t}" = "${s}"`),s=Math.round(100*(Number(s)+Number.EPSILON))/100),s}function jr(e){_s.error(`Invalid Shopify Pixel Event: ${e}`,233)}function Gr(e,t,i){var s,n;return{productVariantPriceAdjusted:zr(e.price.amount,t,i),productVariantPrice:e.price.amount,productVariantPriceCode:e.price.currencyCode,productVariantSku:null!=(s=e.sku)?s:void 0,productVariantId:e.id,productVariantTitle:e.title,productId:e.product.id,productTitle:e.product.title,productType:null!=(n=e.product.type)?n:void 0}}function Br(e){return{collectionId:e.id}}function Hr(e,t,i){const s=[],n=[];return e.lineItems.forEach((({variant:e})=>{null!==e&&(s.push(e.id),n.push(e.product.id))})),{checkoutSubtotalAdjusted:zr(e.subtotalPrice.amount,t,i),checkoutSubtotal:e.subtotalPrice.amount,checkoutSubtotalCode:e.subtotalPrice.currencyCode,productVariantIds:s,productIds:n}}function Qr(e,t,i){return __spreadValues({cartTotalAdjusted:zr(e.cost.totalAmount.amount,t,i),cartTotal:e.cost.totalAmount.amount,cartTotalCode:e.cost.totalAmount.currencyCode},Gr(e.merchandise,t,i))}function qr(e){return{searchQuery:e.query}}function Kr(){return{"data.productVariantPriceAdjusted":"spvpa","data.productVariantPrice":"spvp","data.productVariantPriceCode":"spvpc","data.productVariantSku":"spvsku","data.productVariantId":"spvid","data.productVariantTitle":"spvt","data.productId":"spid","data.productTitle":"spt","data.productType":"spty","data.collectionId":"scid","data.checkoutSubtotalAdjusted":"scosta","data.checkoutSubtotal":"scost","data.checkoutSubtotalCode":"scostc","data.productVariantIds":"spvids","data.productIds":"spids","data.cartTotalAdjusted":"scata","data.cartTotal":"scat","data.cartTotalCode":"scatc","data.searchQuery":"ssq"}}function Yr(){return[ki,xi,Pi,Ti,Ai,Mi,Di,Ni,Fi,Ri]}function Jr(e){return Yr().map((t=>`${t}${e.getId()}`))}function Xr(e){return Yr().some((t=>e.startsWith(t)))}function Zr(e){return e instanceof DOMException&&("QuotaExceededError"===e.name||"QUOTA_EXCEEDED_ERROR"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)}function eo(e,t){let i=!1;try{const s=e.getWindow();if(t in s){const e="_test_",n="_test_val_";s[t].setItem(e,n);const r=s[t].getItem(e);s[t].removeItem(e),null!==r&&r===n&&(i=!0)}}catch(s){}return i}const to=class{constructor(e,t,i,s){__publicField(this,"storageKey"),__publicField(this,"browserStorage"),__publicField(this,"environment"),__publicField(this,"override"),this.storageKey=Fi+e.getId(),this.browserStorage=t,this.environment=i,this.override=s}static buildPageviewActivity(e,t,i,s,n){return __spreadValues({eventType:"pv"},to.setCommonActivityFields(e,t,i,s,n))}static buildViewActivity(e,t,i,s,n){const r=e.getExperience(),o=r.getCampaign(),a=o.getCustomer();return __spreadValues({eventType:"v",campaignId:o.getId(),experienceId:r.getId(),variationId:e.getId()},to.setCommonActivityFields(a,t,i,s,n))}static buildConversionActivity(e,t,i,s,n,r){const o=__spreadValues({eventType:"c",actionId:e.getActionId(),eventId:e.getEventId(),eventInstanceId:e.getEventInstanceId()},to.setCommonActivityFields(t,i,s,n,r));return e.getEventValue().ifPresent((e=>{o.eventValue=to.transformEventValue(e)})),o}static buildShopifyActivity(e,t,i,s,n,r,o,a){return Lr(e,t,to.buildConversionActivity(i,s,n,r,o,a))}static setCommonActivityFields(e,t,i,s,n){const r={userVisitStatus:n.getUserVisitStatus(i),userBucket:i.getUserBucket(),pageviewId:t.getPageviewId(),sessionId:n.updateAndGetSessionId(),time:t.getNowUnixTimeMs(),timeZone:t.getTimeZone()};n.getCustomerControlStatus(e).ifPresent((e=>{r.controlStatus=e})),t.getReferrerUrl().ifPresent((e=>{r.referrerUrl=e.getRawUrl()})),r.hostingPageUrl=t.getHostingPageUrl().getRawUrl();const o=s.getFlattenedInternalAttributes();Object.keys(o).length>0&&(r.trafficSource=o.ts,r.utmTerm=o.utt,r.utmMedium=o.utm,r.utmSource=o.uts,r.utmContent=o.utcn,r.utmCampaign=o.utcm);const a=s.getFlattenedCustomAttributes();return Object.keys(a).length>0&&(r.customAttributes=a),r}static transformEventValue(e){if("string"==typeof e)return Number.parseFloat(e)}add(e){if(this.override.saveActivity().orElse(!0)){const t=this.compressActivity(e),i=this.getAllCompressed();i.push(t),this.save(i)}}getAll(){return this.getAllCompressed().map((e=>this.decompressActivity(e)))}backoffAndSave(e){e.shift(),this.save(e)}save(e){const t=Hi(e);if(t.length>to.CHARACTER_LIMIT&&e.length>0)this.backoffAndSave(e);else try{this.browserStorage.write(this.storageKey,t)}catch(i){if(!(Zr(i)&&e.length>0))throw i;_s.warn("localStorage quota exceeded. Removing old activity",220),this.backoffAndSave(e)}}getAllCompressed(){let e=[];try{e=this.browserStorage.read(this.storageKey).map((e=>{const t=Qi(e);if(!Array.isArray(t))throw new TypeError("Expected an array");return t})).orElse([])}catch(i){e=[];const t=new Ee("Could not read Activities from localStorage",i);_s.error(t,221)}const t=this.environment.getNowUnixTimeMs()-to.TIME_LIMIT_MS;return e.filter((e=>e.t>=t))}compressActivity(e){const t={};for(const[i,n]of Object.entries(e))if("data"===i&&s(n))for(const[e,s]of Object.entries(n)){const i=`data.${e}`;void 0===to.KEY_MAP[i]?(_s.error(`Unknown key ${i} in Activity`,222),t[i]=s):t[to.KEY_MAP[i]]=s}else void 0===to.KEY_MAP[i]?(_s.error(`Unknown key ${i} in Activity`,222),t[i]=n):t[to.KEY_MAP[i]]=n;return t}decompressActivity(e){const t={};for(const[i,s]of Object.entries(e))if(void 0===to.REVERSE_KEY_MAP[i])_s.error(`Unknown key ${i} in CompressedActivity`,223),t[i]=s;else if(to.REVERSE_KEY_MAP[i].startsWith("data.")){const e=to.REVERSE_KEY_MAP[i].split(".");2===e.length&&(void 0===t.data&&(t.data={}),t.data[e[1]]=s)}else t[to.REVERSE_KEY_MAP[i]]=s;return t}};let io=to;__publicField(io,"TIME_LIMIT_MS",15552e6),__publicField(io,"CHARACTER_LIMIT",1048576),__publicField(io,"KEY_MAP",__spreadValues({eventType:"et",customerEventName:"en",campaignId:"cmid",experienceId:"eid",variationId:"vid",actionId:"acid",eventId:"evid",eventInstanceId:"eii",eventValue:"ev",userVisitStatus:"uvs",userBucket:"ub",pageviewId:"pvid",sessionId:"sid",controlStatus:"cs",referrerUrl:"rurl",hostingPageUrl:"hpurl",time:"t",timeZone:"tz",trafficSource:"ts",utmTerm:"utt",utmMedium:"utm",utmSource:"uts",utmContent:"utcn",utmCampaign:"utcm",customAttributes:"ca"},Kr())),__publicField(io,"REVERSE_KEY_MAP",Bs(to.KEY_MAP));class so extends kr{constructor(e){super(),__publicField(this,"callbacks",[]),this.callbacks=e}toString(){return"ActivateTask()"}inTransaction(){return!1}isUnloading(){return!0}addCallback(e){this.callbacks.push(e)}run(){return this.manager.getClient().reRun(this.callbacks),Tr.SUCCEEDED}}class no extends kr{constructor(e,t,i){super(),__publicField(this,"environment"),__publicField(this,"callbacks",[]),__publicField(this,"startTimeMs"),this.environment=e,this.callbacks=i,this.resetExpiration(),t.requestAnimationFrame().orElse(!0)&&this.environment.getWindow().requestAnimationFrame((()=>{this.handleRaf()})),this.environment.getWindow().requestAnimationFrame((()=>{this.handleRaf()}))}handleRaf(){this.manager&&this.manager.runNow(),kr.isDone(this.getStatus())||this.environment.getWindow().requestAnimationFrame((()=>{this.handleRaf()}))}toString(){return"RequestActivateTask()"}inTransaction(){return!1}isUnloading(){return!1}resetExpiration(){_s.debug("RequestActivateTask.resetExpiration()"),this.startTimeMs=this.environment.getNowUnixTimeMs()}addCallback(e){this.callbacks.push(e)}run(){if(!this.environment.hasHostingPageUrlChanged())return _s.debug("URL has not changed yet"),this.hasExceededTimeBudget()?(_s.info(`activate() timeout due to URL not changing after ${yi}ms`),Tr.SUCCEEDED):Tr.TRY_LATER;if(0===this.manager.findTasks((e=>e instanceof so&&!e.isDone())).length){const e=new so(this.callbacks);this.manager.addTask(e)}else _s.debug("Not scheduling new ActivateTask since one is already running");return Tr.SUCCEEDED}hasExceededTimeBudget(){const e=this.environment.getNowUnixTimeMs(),t=e-this.startTimeMs,i=t>yi;return _s.debug("hasExceededTimeBudget: "+e+" - "+this.startTimeMs+" ("+t+") > "+yi+"? => "+i),i}}class ro extends kr{constructor(e,t,i,s){super(),__publicField(this,"elementObserver"),__publicField(this,"entityIds"),__publicField(this,"workQueue",[]),__publicField(this,"readyToRender"),__publicField(this,"isTaskDone",!1),this.elementObserver=s,this.readyToRender=t,this.entityIds=i,this.workQueue=e.map((e=>({enhancedChange:e,applied:!1,rendered:!1})))}toString(){return`ChangelistTask(count:${this.workQueue.length}, ${Bi(this.entityIds)})`}cleanup(){this.isTaskDone=!0,this.readyToRenderCallbackIfDone()}inTransaction(){return!0}isUnloading(){return!1}getEntityIds(){return this.entityIds}run(){for(const t of this.workQueue)if(!t.applied)try{if(!t.enhancedChange.isReadyToApply())return Tr.TRY_LATER;t.enhancedChange.apply((()=>{t.rendered=!0,this.readyToRenderCallbackIfDone()}),this.elementObserver),t.applied=!0}catch(e){const i=new Ee(`Failed to apply change: ${Bi(t.enhancedChange.getEntityIds())}`,e);return _s.error(i,125,t.enhancedChange.getEntityIds()),this.isTaskDone=!0,this.readyToRenderCallbackIfDone(),Tr.FAILED}return this.isTaskDone=!0,this.readyToRenderCallbackIfDone(),Tr.SUCCEEDED}readyToRenderCallbackIfDone(){if(!this.isTaskDone)return;this.workQueue.filter((e=>e.applied)).every((e=>__async(this,null,(function*(){return e.rendered}))))&&this.readyToRender()}}class oo extends kr{constructor(e,t,i,s,n,r,o,a,l,c,u,d,h,g,p,m,v,b){super(),__publicField(this,"variation"),__publicField(this,"environment"),__publicField(this,"browserStorage"),__publicField(this,"extensionManager"),__publicField(this,"browserEventLogger"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"pageContext"),__publicField(this,"attributeData"),__publicField(this,"user"),__publicField(this,"decisionContext"),__publicField(this,"startPageviewId"),__publicField(this,"override"),__publicField(this,"statusModel"),__publicField(this,"getVariationRecordedCallbackTuples"),__publicField(this,"elementObserver"),__publicField(this,"hider"),this.environment=S(e),this.browserStorage=S(t),this.extensionManager=S(i),this.browserEventLogger=S(s),this.customerStorage=S(n),this.attributeStorage=S(r),this.activityStorage=S(o),this.pageContext=S(a),this.attributeData=S(l),this.decisionContext=S(c),this.user=S(u),this.override=S(d),this.statusModel=S(h),this.startPageviewId=S(g),this.hider=S(p),this.variation=S(m),this.getVariationRecordedCallbackTuples=S(v),this.elementObserver=S(b)}toString(){return`ExecuteVariationTask(${this.variation.getId()})`}getEntityIds(){return{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}}inTransaction(){return this.isReadyToExecute()}isUnloading(){return!1}getNotDoneDependencies(){return this.findDependentPageChangelistTasks().filter((e=>!e.isDone()))}run(){let e=Tr.TRY_LATER;return this.isReadyToExecute()&&(e=this.executeVariation()),e}injectVariationCss(e){if(e.getCss().isPresent()){const i=e.getCss().get();try{_s.info(`Variation ${e.getExperience().getId()}/${e.getId()} injecting css`),Fs.injectCss(i,`variation-${e.getId()}`,this.environment.getWindow().document)}catch(t){const i=new Ee(`Variation (${e.getId()}) css injection failed`,t);return _s.error(i,91,{variationId:e.getId(),experienceId:e.getExperience().getId()}),!1}}return!0}onReadyToRender(){this.hider.revealExperience(this.variation.getExperience(),this.browserStorage,this.attributeData)}isReadyToExecute(){const e=this.passDependencies(),t=this.passExperiencePreconditions(),i=this.passVariationPreconditions(),s=this.hasAppliedPageChanges();return e&&t&&i&&s}passDependencies(){const e=this.variation.getExperience();_s.group("check experience dependsOnExperiences "+e.getId());const t=e.getDependsOnExperiences().every((e=>!this.decisionContext.isDecidingExperience(e)));return _s.debug(t.toString()),_s.groupEnd(),this.statusModel.setExperience(e,"dependsOnExperiences",t),t}passExperiencePreconditions(){const e=this.variation.getExperience();_s.group("check experience preconditions "+e.getId());const t=e.getPreconditions().every((t=>{let i=!1;try{i=Fs.evalBoolean(t),_s.info(`Experience ${e.getId()} precondition => ${i}`)}catch(s){const t=new Ee(`Experience (${e.getId()}) precondition code execution failed`,s);i=!1,_s.error(t,15,{experienceId:e.getId()})}return i}));return _s.debug(t.toString()),_s.groupEnd(),this.statusModel.setExperience(e,"preconditions",t),t}passVariationPreconditions(){const e=this.variation.getExperience();_s.group("check variations preconditions "+this.variation.getId());const t=this.variation.getPreconditions().every((t=>{let i=!1;try{i=Fs.evalBoolean(t),_s.info(`Variation ${e.getId()}/${this.variation.getId()} precondition => ${i}`)}catch(s){const t=new Ee(`Variation (${this.variation.getId()}) precondition code execution failed`,s);i=!1,_s.error(t,16,{experienceId:e.getId(),variationId:this.variation.getId()})}return i}));return _s.debug(t.toString()),_s.groupEnd(),this.statusModel.setVariation(this.variation,"preconditions",t),t}hasAppliedPageChanges(){return this.findDependentPageChangelistTasks().every((e=>e.isDone()))}findDependentPageChangelistTasks(){return this.variation.getExperience().getPages().map((e=>this.pageContext.getPageChangelistTask(e))).filter((e=>e.isPresent())).map((e=>e.get()))}}const ao=/^UA-\d+(-\d+)?$/,lo=/^G-[\dA-Z]+$/,co=e=>"string"==typeof e&&ao.test(e),uo=e=>"string"==typeof e&&lo.test(e),ho=t=>{const i=[],n=[],r=e=>{co(e)&&!i.includes(e)?(_s.debug(`Found UA Tracking ID: ${e}`),i.push(e)):uo(e)&&!n.includes(e)&&(_s.debug(`Found GA4 Measurement ID: ${e}`),n.push(e))},{gaData:o}=t;s(o)&&Object.keys(o).forEach((e=>{r(e)}));const a=t.google_tag_data;s(a)&&Object.values(a).forEach((e=>{s(e)&&Object.keys(e).forEach((e=>{r(e)}))}));const l=t.google_tag_manager;s(l)&&Object.values(l).forEach((t=>{s(t)&&Object.values(t).forEach((t=>{e(t)&&t.forEach((({message:e})=>{$s(e)&&"config"===e[0]&&r(e[1])}))}))}));const{dataLayer:c}=t;return e(c)&&c.forEach((e=>{s(e)?Object.values(e).forEach((e=>{$s(e)&&"config"===e[0]&&r(e[1])})):$s(e)&&"config"===e[0]&&r(e[1])})),{gua:i,ga4:n}};class go extends kr{constructor(e,t,i){super(),__publicField(this,"targetUrl"),__publicField(this,"environment"),__publicField(this,"variation"),this.targetUrl=e,this.environment=t,this.variation=i}toString(){return"RedirectTask("+this.targetUrl+")"}inTransaction(){return!1}isUnloading(){return!0}getRedirectVariation(){return this.variation}run(){return _s.info("Executing redirect to "+this.targetUrl),this.environment.redirect(this.targetUrl),Tr.SUCCEEDED}}class po extends kr{constructor(e,t,i,s,n){super(),__publicField(this,"environment"),__publicField(this,"guaIntegration"),__publicField(this,"ga4Integration"),__publicField(this,"variation"),__publicField(this,"override"),__publicField(this,"states",{uaState:"notStarted",ga4State:"notStarted"}),__publicField(this,"uATrackingIdQueue",[]),__publicField(this,"ga4MeasurementIdQueue",[]),__publicField(this,"taskStartTime"),this.environment=e,this.guaIntegration=t,this.ga4Integration=i,this.variation=s,this.override=n,w(!t.isPresent()||t.get().isEnabled()),w(!i.isPresent()||i.get().isEnabled())}static get GA4_EVENT_NAME(){return"variation_viewed"}static get WAIT_FOR_GA_TIMEOUT_MS(){return 3e3}static get WAIT_FOR_PROPERTY_IDS_MS(){return 5e3}static isSent(e){return"sent"===e||po.isCompleted(e)}static isCompleted(e){return po.isSuccessful(e)||"failed"===e}static isSuccessful(e){return"delivered"===e||"skipped"===e}cleanup(){_s.group("GoogleAnalyticsTask.cleanup()");const e=this.guaIntegration.map((e=>e.isEnabled())).orElse(!1),t=this.ga4Integration.map((e=>e.isEnabled())).orElse(!1),i=this.manager.findTasks((e=>e instanceof go)).map((e=>e.getRedirectVariation().getId())),s=`GoogleAnalyticsTask did not complete. Enabled: { gua: ${e}, ga4: ${t} }, GaStates: ${Bi(this.states)}, uATrackingIdQueue: ${Bi(this.uATrackingIdQueue)}, ga4MeasurementIdQueue: ${Bi(this.ga4MeasurementIdQueue)}, redirectVariationId(s): ${Bi(i)}, Task ran for: ${this.getTimePassedMs()}ms`;_s.error(s,258),_s.groupEnd()}toString(){return"GoogleAnalyticsTask("+this.variation.getId()+")"}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.isAllCompleted()?this.isAllSuccessful()?Tr.SUCCEEDED:Tr.FAILED:(_s.debug("Waiting for GA delivery confirmation"),Tr.TRY_LATER)}isAllSent(){return po.isSent(this.states.uaState)&&po.isSent(this.states.ga4State)}isAllCompleted(){return po.isCompleted(this.states.uaState)&&po.isCompleted(this.states.ga4State)}isAllSuccessful(){return po.isSuccessful(this.states.uaState)&&po.isSuccessful(this.states.ga4State)}setState(e,t){this.states[e]!==t&&(_s.debug(`Transitioning ${e} from ${this.states[e]} to ${t}`),this.states[e]=this.isValidStateTransition(this.states[e],t)?t:"failed")}isValidStateTransition(e,t){switch(e){case"notStarted":if("polling"===t||"skipped"===t)return!0;break;case"polling":if("sent"===t||"failed"===t)return!0;break;case"sent":if("delivered"===t)return!0}return this.sendError(`Invalid state transition. Cannot transition from "${e}" to "${t}".`,189),!1}sendOnce(){if(!this.isAllSent()){void 0===this.taskStartTime&&(this.taskStartTime=this.environment.getNowDate(),_s.debug(`GoogleAnalyticsTask start time: ${this.taskStartTime.getTime()}`));const e=this.getTimePassedMs();if(this.override.sendGoogleAnalytics().orElse(!0)){this.guaIntegration.ifPresent((()=>{_s.debug("GoogleUniversalAnalytics - integration is enabled")})).ifAbsent((()=>{_s.debug("Google Universal Analytics - integration is not enabled"),this.setState("uaState","skipped")})),this.ga4Integration.ifPresent((()=>{_s.debug("GoogleAnalytics4 - integration is enabled")})).ifAbsent((()=>{_s.debug("Google Analytics 4 - integration is not enabled"),this.setState("ga4State","skipped")}));this.waitForDataLayer(e).ifPresent((t=>{this.guaIntegration.ifPresent((i=>{if(i.isAutoConfig()){_s.debug("GoogleUniversalAnalytics - AutoConfig is enabled");const s=this.waitForTrackingId(e);s.length>0&&this.sendToUaUsingGtagJsOnce(i,t,s)}else _s.debug("GoogleUniversalAnalytics - AutoConfig is disabled"),this.sendToUaUsingGtagJsOnce(i,t)})),this.ga4Integration.ifPresent((i=>{if(i.isAutoConfig()){_s.debug("GoogleAnalytics4 - AutoConfig is enabled");const s=this.waitForMeasurementId(e);s.length>0&&this.sendToGa4Once(i,t,s)}else _s.debug("GoogleAnalytics4 - AutoConfig is disabled"),this.sendToGa4Once(i,t)}))}))}else _s.debug("Google Analytics - Override behavior has prevented all events from being sent"),this.setState("uaState","skipped"),this.setState("ga4State","skipped")}}sendError(e,t){_s.error(e,t,{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()})}shimGtag(e){return function(){e.push(arguments)}}waitForDataLayer(e){const t=this.environment.getWindow();if(po.isSent(this.states.uaState)||po.isCompleted(this.states.uaState)||this.setState("uaState","polling"),po.isSent(this.states.ga4State)||po.isCompleted(this.states.ga4State)||this.setState("ga4State","polling"),void 0===t.dataLayer)_s.debug(`window.dataLayer not defined after ${e} ms`);else{if(Ls(t.dataLayer))return D.of(t.dataLayer);_s.debug("window.dataLayer is not an array")}return e>=po.WAIT_FOR_GA_TIMEOUT_MS&&(po.isCompleted(this.states.uaState)||this.setState("uaState","failed"),po.isCompleted(this.states.ga4State)||this.setState("ga4State","failed"),this.sendError(`window.dataLayer not present within ${po.WAIT_FOR_GA_TIMEOUT_MS} ms`,185)),D.empty()}waitForTrackingId(e){const t=ho(this.environment.getWindow());return 0===t.gua.length?(_s.debug(`Auto-configured Tracking ID not present after ${e} ms`),this.setState("uaState","polling"),e>=po.WAIT_FOR_PROPERTY_IDS_MS&&(this.setState("uaState","failed"),this.sendError(`GoogleUniversalAnalytics - Auto-configured Tracking ID is not present within ${po.WAIT_FOR_PROPERTY_IDS_MS} ms`,186)),[]):t.gua}waitForMeasurementId(e){const t=ho(this.environment.getWindow());return 0===t.ga4.length?(_s.debug(`Auto-configured Measurement ID not present after ${e} ms`),this.setState("ga4State","polling"),e>=po.WAIT_FOR_PROPERTY_IDS_MS&&(this.setState("ga4State","failed"),this.sendError(`GoogleAnalytics4 - Auto-configured Measurement ID is not present within ${po.WAIT_FOR_PROPERTY_IDS_MS} ms`,187)),[]):t.ga4}sendToUaUsingGtagJsOnce(e,t,i){if(!po.isSent(this.states.uaState)){const s=this.shimGtag(t);e.getDimensionName().ifPresent((e=>{_s.debug(`Found UA custom dimension: ${e}`),s("set",{[e]:"Intellimize"})}));const n=null!=i?i:e.getTrackingIds(),r={event_category:this.getUaEventCategory(),event_label:this.getUaEventLabel(),non_interaction:!0,send_to:n,event_callback:e=>{co(e)&&(this.handleGaEventSuccess(`UA configuration (iint.gua) + gtag.js. Tracking ID: ${e}`),this.checkDelivered("uaState",e))}};_s.debug(`Sending UA event using gtag.js: ${Bi(r)}`),this.uATrackingIdQueue.push(...n),_s.debug("Google Analytics UA payload sent"),this.setState("uaState","sent"),s("event",this.getUaEventAction(),r)}}sendToGa4Once(e,t,i){if(!po.isSent(this.states.ga4State)){const s=this.shimGtag(t),n=null!=i?i:e.getMeasurementIds(),r={experienceId:this.variation.getExperience().getId(),experienceName:this.variation.getExperience().getName(),experienceType:this.variation.getExperience().getType(),variationId:this.variation.getId(),variationName:this.variation.getName(),ccStatus:this.variation.getId()===ci?"holdout":"optimized",send_to:n,event_callback:e=>{uo(e)&&(this.handleGaEventSuccess(`GA4 configuration (iint.ga4) + gtag.js. Measurement ID: ${e}`),this.checkDelivered("ga4State",e))}};_s.debug(`Sending GA4 event using gtag.js: ${Bi(r)}`),this.ga4MeasurementIdQueue.push(...n),_s.debug("Google Analytics 4 payload sent"),this.setState("ga4State","sent"),s("event",po.GA4_EVENT_NAME,r)}}getUaEventAction(){return`{${this.variation.getExperience().getName()}}:{${this.variation.getName()}}`}getUaEventCategory(){return`Intellimize - {${this.variation.getExperience().getCampaign().getName()}}`}getUaEventLabel(){return`PageURL: ${this.environment.getHostingPageUrl().getRawUrl()}`}handleGaEventSuccess(e){_s.debug(`Google Analytics payload delivery complete - using ${e}`)}checkDelivered(e,t){const i="uaState"===e?this.uATrackingIdQueue:this.ga4MeasurementIdQueue;Gs(i,t),0===i.length&&this.setState(e,"delivered")}getTimePassedMs(){if(void 0===this.taskStartTime)return 0;return this.environment.getNowDate().getTime()-this.taskStartTime.getTime()}}class mo extends kr{constructor(e,t,i){super(),__publicField(this,"environment"),__publicField(this,"variation"),__publicField(this,"override"),__publicField(this,"sent",!1),__publicField(this,"delivered",!1),__publicField(this,"timedOut",!1),__publicField(this,"taskStartTime"),this.environment=e,this.variation=t,this.override=i}static get WAIT_FOR_MIXPANEL_TIMEOUT_MS(){return 3e3}toString(){return"MixpanelTask("+this.variation.getId()+")"}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.timedOut?Tr.FAILED:this.sent?this.delivered?Tr.SUCCEEDED:(_s.debug("Waiting for Mixpanel delivery confirmation"),Tr.TRY_LATER):Tr.TRY_LATER}sendOnce(){if(!this.sent){void 0===this.taskStartTime&&(this.taskStartTime=this.environment.getNowDate(),_s.debug(`MixpanelTask start time: ${this.taskStartTime.getTime()}`));if(this.environment.getNowDate().getTime()-this.taskStartTime.getTime()>=mo.WAIT_FOR_MIXPANEL_TIMEOUT_MS)return _s.error(`MixpanelTask - window.mixpanel.track not present within ${mo.WAIT_FOR_MIXPANEL_TIMEOUT_MS} ms`,199),void(this.timedOut=!0);if(this.override.sendMixpanel().orElse(!0)){const e=this.environment.getWindow();if(void 0===e.mixpanel)return void _s.debug("window.mixpanel not defined");if(void 0===e.mixpanel.track)return void _s.debug("window.mixpanel.track not defined");const t="Intellimize Viewed",i={[`${this.variation.getExperience().getName()} (${this.variation.getExperience().getId()})`]:`${this.variation.getName()} (${this.variation.getId()})`};e.mixpanel.track(t,i,{send_immediately:!0},(()=>{_s.debug("Mixpanel payload delivery complete"),this.delivered=!0})),_s.debug("Mixpanel payload sent")}else this.delivered=!0,_s.debug("Skipping Mixpanel");this.sent=!0}}}class vo extends kr{constructor(e,t,i,s){super(),__publicField(this,"environment"),__publicField(this,"segmentIntegration"),__publicField(this,"variation"),__publicField(this,"override"),__publicField(this,"sent",!1),__publicField(this,"delivered",!1),__publicField(this,"timedOut",!1),__publicField(this,"onTrack",!1),__publicField(this,"onReady",!1),__publicField(this,"trackCallback",!1),__publicField(this,"taskStartTime"),this.environment=e,this.segmentIntegration=t,this.variation=i,this.override=s}static get WAIT_FOR_SEGMENT_TIMEOUT_MS(){return 3e3}toString(){return"SegmentAnalyticsTask("+this.variation.getId()+")"}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.timedOut?Tr.FAILED:this.sent?this.delivered||this.onReady&&this.onTrack&&this.trackCallback?Tr.SUCCEEDED:(_s.debug("Waiting for Segment delivery confirmation"),Tr.TRY_LATER):Tr.TRY_LATER}sendOnce(){if(!this.sent){void 0===this.taskStartTime&&(this.taskStartTime=this.environment.getNowDate(),_s.debug(`SegmentAnalyticsTask start time: ${this.taskStartTime.getTime()}`));if(this.environment.getNowDate().getTime()-this.taskStartTime.getTime()>=vo.WAIT_FOR_SEGMENT_TIMEOUT_MS)return _s.error(`SegmentAnalyticsTask - window.analytics.track not present within ${vo.WAIT_FOR_SEGMENT_TIMEOUT_MS} ms`,200),void(this.timedOut=!0);if(this.override.sendSegmentAnalytics().orElse(!0)){const e=this.environment.getWindow();if(void 0===e.analytics)return void _s.debug("window.analytics not defined");if(void 0===e.analytics.track)return void _s.debug("window.analytics.track not defined");const t=this.segmentIntegration.getEventName();e.analytics.on("track",((e,i)=>{e===t&&void 0!==i.variationId&&i.variationId===this.variation.getId()&&(_s.debug("Segment on track event received"),this.onTrack=!0)}));const i={campaignId:this.variation.getExperience().getCampaign().getId(),campaignName:this.variation.getExperience().getCampaign().getName(),experimentId:this.variation.getExperience().getId(),experimentName:this.variation.getExperience().getName(),variationName:this.variation.getName(),variationId:this.variation.getId(),nonInteraction:1};e.analytics.track(t,i,(()=>{_s.debug("Segment track() callback called"),this.trackCallback=!0})),e.analytics.ready((()=>{_s.debug("Segment ready() callback called"),this.onReady=!0}))}else this.delivered=!0;_s.debug("Segment payload sent"),this.sent=!0}}}class bo extends kr{constructor(e,t,i){super(),__publicField(this,"variation"),__publicField(this,"browserEventLogger"),__publicField(this,"decisionContext"),__publicField(this,"sent",!1),__publicField(this,"deliveryStatus",Tr.NOT_STARTED),this.variation=S(e),this.browserEventLogger=S(t),this.decisionContext=S(i)}toString(){return"ViewEventTask("+this.variation.getId()+")"}getEntityIds(){return{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.deliveryStatus===Tr.SUCCEEDED?Tr.SUCCEEDED:this.deliveryStatus===Tr.FAILED?Tr.FAILED:(_s.debug("Waiting for view event delivery confirmation"),Tr.TRY_LATER)}sendOnce(){this.sent||(_s.info(`Variation ${this.variation.getExperience().getId()}/${this.variation.getId()} sending view event`),this.browserEventLogger.sendView(this.variation,this.decisionContext).then((()=>{_s.info(`Variation ${this.variation.getExperience().getId()}/${this.variation.getId()} view event delivery success`),this.deliveryStatus=Tr.SUCCEEDED})).catch((e=>{const t=new Ee(`Variation ${this.variation.getExperience().getId()}/${this.variation.getId()} view event delivery failed`,e);_s.warn(t,93,{experienceId:this.variation.getExperience().getId(),variationId:this.variation.getId()}),this.deliveryStatus=Tr.FAILED})),this.sent=!0)}}class fo extends kr{constructor(e,t){super(),__publicField(this,"environment"),__publicField(this,"viewabilityTimeMs"),__publicField(this,"startViewableTimeMs"),__publicField(this,"ignoreCallback",!1),__publicField(this,"activeEventListener",!1),this.environment=e,this.viewabilityTimeMs=t}toString(){return"ViewabilityTask()"}inTransaction(){return!1}isUnloading(){return!1}cleanup(){this.ignoreCallback=!0}run(){const e=this.environment.getNowUnixTimeMs();if(!this.environment.isNowDocumentHidden().orElse(!0)){void 0===this.startViewableTimeMs&&(this.startViewableTimeMs=e);const t=e-this.startViewableTimeMs;return t>=this.viewabilityTimeMs?(_s.debug(`page viewable for ${t}ms > threshold ${this.viewabilityTimeMs}ms`),Tr.SUCCEEDED):(_s.debug(`page viewable for ${t}ms < threshold ${this.viewabilityTimeMs}ms`),Tr.TRY_LATER)}return this.startViewableTimeMs=void 0,this.activeEventListener||(_s.debug("page not viewable, scheduling visibility change listener"),this.environment.addListenerVisibilityChange((()=>{try{this.ignoreCallback?_s.debug("visibility change event - ignoring"):(_s.debug("visibility change event - ask TM for polling"),this.setStatusTryLater(),this.manager.runNow())}catch(e){const t=new Ee("Exception in ViewabilityTask visibilitychange handler",e);_s.error(t,238)}})),this.activeEventListener=!0),Tr.WAITING}}class Eo extends kr{constructor(e,t,i,s,n,r,o,a,l,c,u){super(),__publicField(this,"variation"),__publicField(this,"environment"),__publicField(this,"browserEventLogger"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"user"),__publicField(this,"decisionContext"),__publicField(this,"startPageviewId"),__publicField(this,"override"),__publicField(this,"viewabilityTask"),__publicField(this,"getVariationRecordedCallbackTuples"),__publicField(this,"haveUpdatedCustomerStorage",!1),__publicField(this,"haveUpdatedActivityStorage",!1),__publicField(this,"haveScheduledGoogleAnalytics",!1),__publicField(this,"googleAnalyticsTask"),__publicField(this,"haveScheduledSegmentAnalytics",!1),__publicField(this,"segmentAnalyticsTask"),__publicField(this,"haveScheduledMixpanel",!1),__publicField(this,"mixpanelTask"),__publicField(this,"viewEventTask"),__publicField(this,"haveRunSuccessCallbacks",!1),this.variation=S(e),this.environment=S(t),this.browserEventLogger=S(i),this.customerStorage=S(s),this.attributeStorage=S(n),this.activityStorage=S(r),this.user=S(o),this.decisionContext=S(a),this.startPageviewId=S(l),this.override=S(c),this.getVariationRecordedCallbackTuples=S(u)}toString(){return"RecordVariationTask("+this.variation.getId()+")"}getEntityIds(){return{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}}inTransaction(){return!1}isUnloading(){return!1}getNotDoneDependencies(){const e=[];return void 0===this.googleAnalyticsTask||this.googleAnalyticsTask.isDone()||e.push(this.googleAnalyticsTask),void 0===this.segmentAnalyticsTask||this.segmentAnalyticsTask.isDone()||e.push(this.segmentAnalyticsTask),void 0===this.mixpanelTask||this.mixpanelTask.isDone()||e.push(this.mixpanelTask),void 0===this.viewEventTask||this.viewEventTask.isDone()||e.push(this.viewEventTask),void 0===this.viewabilityTask||this.viewabilityTask.isDone()||e.push(this.viewabilityTask),e}updateCustomerStorageOnce(){this.haveUpdatedCustomerStorage||(_s.debug("RecordVariationTask.updateCustomerStorageOnce() "+this.variation.getId()),this.decisionContext.isStickyVariation(this.variation)?this.customerStorage.saveVariationStickySelection(this.variation,this.environment.getPageviewId()):this.customerStorage.saveVariationPredictionSelection(this.variation,this.decisionContext.getModelVersion(this.variation.getExperience().getId()),this.environment.getPageviewId()),this.haveUpdatedCustomerStorage=!0)}updateActivityStorageOnce(){if(!this.haveUpdatedActivityStorage){_s.debug(`RecordVariationTask.haveUpdatedActivityStorage() ${this.variation.getId()}`);const e=io.buildViewActivity(this.variation,this.environment,this.user,this.attributeStorage,this.customerStorage);this.activityStorage.add(e),this.haveUpdatedActivityStorage=!0}}sendGoogleAnalyticsOnce(){if(!this.haveScheduledGoogleAnalytics){const e=this.variation.getExperience().getCampaign().getCustomer(),t=e.getIntegrationGoogleUniversalAnalytics(),i=e.getIntegrationGoogle4Analytics(),s=t.isPresent()&&t.get().isEnabled(),n=i.isPresent()&&i.get().isEnabled();(s||n)&&(this.googleAnalyticsTask=new po(this.environment,s?t:D.empty(),n?i:D.empty(),this.variation,this.override),this.manager.addTask(this.googleAnalyticsTask)),this.haveScheduledGoogleAnalytics=!0}}sendSegmentAnalyticsOnce(){this.haveScheduledSegmentAnalytics||(this.variation.getExperience().getCampaign().getCustomer().getIntegrationSegmentAnalytics().ifPresent((e=>{e.isEnabled()&&(this.segmentAnalyticsTask=new vo(this.environment,e,this.variation,this.override),this.manager.addTask(this.segmentAnalyticsTask))})),this.haveScheduledSegmentAnalytics=!0)}sendMixpanelOnce(){this.haveScheduledMixpanel||(this.variation.getExperience().getCampaign().getCustomer().getIntegrationMixpanel().ifPresent((e=>{e.isEnabled()&&(this.mixpanelTask=new mo(this.environment,this.variation,this.override),this.manager.addTask(this.mixpanelTask))})),this.haveScheduledMixpanel=!0)}sendViewEventOnce(){void 0===this.viewEventTask&&(this.viewEventTask=new bo(this.variation,this.browserEventLogger,this.decisionContext),this.manager.addTask(this.viewEventTask))}checkDependency(e){switch(e.getStatus()){case Tr.NOT_STARTED:case Tr.TRY_LATER:case Tr.WAITING:return Tr.TRY_LATER;case Tr.FAILED:case Tr.CANCELED:return Tr.FAILED;case Tr.SUCCEEDED:return Tr.SUCCEEDED;default:return _s.error(`Unrecognized status from dependency ${e.getStatus()}`,88,{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}),Tr.FAILED}}getRecordViewStatus(){if(!this.haveUpdatedCustomerStorage)return _s.debug("Waiting for CustomerStorage to be updated"),Tr.TRY_LATER;if(!this.haveScheduledGoogleAnalytics)return _s.debug("Waiting for GoogleAnalytics to be scheduled"),Tr.TRY_LATER;if(void 0!==this.googleAnalyticsTask){const e=this.checkDependency(this.googleAnalyticsTask);if(e!==Tr.SUCCEEDED)return _s.debug(`GoogleAnalytics returned ${Tr[e]}`),e}if(!this.haveScheduledSegmentAnalytics)return _s.debug("Waiting for SegmentAnalytics to be scheduled"),Tr.TRY_LATER;if(void 0!==this.segmentAnalyticsTask){const e=this.checkDependency(this.segmentAnalyticsTask);if(e!==Tr.SUCCEEDED)return _s.debug(`SegmentAnalytics returned ${Tr[e]}`),e}if(!this.haveScheduledMixpanel)return _s.debug("Waiting for Mixpanel to be scheduled"),Tr.TRY_LATER;if(void 0!==this.mixpanelTask){const e=this.checkDependency(this.mixpanelTask);if(e!==Tr.SUCCEEDED)return _s.debug(`Mixpanel returned ${Tr[e]}`),e}if(void 0===this.viewEventTask)return _s.debug("Waiting for ViewEvent to be scheduled"),Tr.TRY_LATER;const e=this.checkDependency(this.viewEventTask);return e!==Tr.SUCCEEDED?(_s.debug(`ViewEvent returned ${Tr[e]}`),e):Tr.SUCCEEDED}doSuccessCallbacksOnce(){this.haveRunSuccessCallbacks||(this.getVariationRecordedCallbackTuples().forEach((e=>{const t=e[0];try{t({experienceId:this.variation.getExperience().getId(),experienceName:this.variation.getExperience().getName(),experienceType:this.variation.getExperience().getType(),variationId:this.variation.getId(),variationName:this.variation.getName(),ccStatus:this.variation.getId()===ci?"holdout":"optimized"})}catch(i){const e=new Ee("Caught exception in onVariationRecorded success callback",i);Do.consoleError(e.message,165)}})),this.haveRunSuccessCallbacks=!0)}scheduleViewabilityOnce(e){void 0===this.viewabilityTask&&(this.viewabilityTask=new fo(this.environment,e),this.manager.addTask(this.viewabilityTask))}}class _o extends Eo{toString(){return"RecordCodeVariationTask("+this.variation.getId()+")"}run(){this.startPageviewId!==this.environment.getPageviewId()&&_s.error(`RecordCodeVariationTask executing, but pageviewId has changed from ${this.startPageviewId} to ${this.environment.getPageviewId()}`,85,{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}),this.scheduleViewabilityOnce(Si);const e=D.ofNullable(this.viewabilityTask).map((e=>e.getStatus())).orElse(Tr.NOT_STARTED);return kr.isDone(e)?e!==Tr.SUCCEEDED?(_s.info(`Variation ${this.variation.getExperience().getId()}/${this.variation.getId()} aborting record view event since viewability did not succeed`),Tr.CANCELED):(this.updateCustomerStorageOnce(),this.updateActivityStorageOnce(),this.sendGoogleAnalyticsOnce(),this.sendSegmentAnalyticsOnce(),this.sendMixpanelOnce(),this.sendViewEventOnce(),this.doSuccessCallbacksOnce(),this.getRecordViewStatus()):(_s.debug("RecordCodeVariationTask waiting for viewability"),Tr.TRY_LATER)}}class yo extends oo{constructor(){super(...arguments),__publicField(this,"changelistTask")}toString(){return`ExecuteChangelistVariationTask(${this.variation.getId()})`}getNotDoneDependencies(){return void 0===this.changelistTask||this.changelistTask.isDone()?[]:[this.changelistTask]}isReadyToExecute(){if(void 0===this.changelistTask){const e=this.passDependencies(),t=this.passExperiencePreconditions(),i=this.passVariationPreconditions(),s=this.hasAppliedPageChanges();return e&&t&&i&&s}return!0}executeVariation(){if(void 0===this.changelistTask){const e=this.variation.getChanges().map(((e,t)=>Mn(e,hn(this.variation),t,this.attributeData,this.environment,this.browserStorage,this.extensionManager)));this.changelistTask=new ro(e,(()=>{this.onReadyToRender()}),{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()},this.elementObserver),this.manager.addTask(this.changelistTask)}if(this.changelistTask.isDone()){if(this.changelistTask.getStatus()===Tr.FAILED||this.changelistTask.getStatus()===Tr.CANCELED)return this.statusModel.setVariation(this.variation,"failChange",!0),Tr.FAILED;if(this.changelistTask.getStatus()===Tr.SUCCEEDED)return this.manager.addTask(new _o(this.variation,this.environment,this.browserEventLogger,this.customerStorage,this.attributeStorage,this.activityStorage,this.user,this.decisionContext,this.startPageviewId,this.override,this.getVariationRecordedCallbackTuples)),this.statusModel.setVariation(this.variation,"apply",!0),Tr.SUCCEEDED}return Tr.TRY_LATER}}class So extends oo{toString(){return`ExecuteCodeVariationTask(${this.variation.getId()})`}executeVariation(){if(!this.injectVariationCss(this.variation))return this.statusModel.setVariation(this.variation,"failCSS",!0),this.onReadyToRender(),Tr.FAILED;this.elementObserver.detachObserver();const e=this.runVariationCode(this.variation);return this.elementObserver.attachObserver(),e?(this.onReadyToRender(),this.manager.addTask(new _o(this.variation,this.environment,this.browserEventLogger,this.customerStorage,this.attributeStorage,this.activityStorage,this.user,this.decisionContext,this.startPageviewId,this.override,this.getVariationRecordedCallbackTuples)),this.statusModel.setVariation(this.variation,"apply",!0),Tr.SUCCEEDED):(this.statusModel.setVariation(this.variation,"failCode",!0),this.onReadyToRender(),Tr.FAILED)}runVariationCode(e){if(e.getCode().isPresent()){const i=e.getCode().get();try{_s.info(`Variation ${e.getExperience().getId()}/${e.getId()} running code`),Fs.eval(i)}catch(t){const i=new Ee(`Variation (${e.getId()}) code execution failed`,t);return _s.error(i,17,{variationId:e.getId(),experienceId:e.getExperience().getId()}),!1}}return!0}}class Io extends Eo{constructor(e,t,i,s,n,r,o,a,l,c,u,d,h){super(e,t,i,s,n,r,o,a,l,c,u),__publicField(this,"redirectUrl"),__publicField(this,"onReadyToRender"),__publicField(this,"startTimeMs"),__publicField(this,"redirectScheduled",!1),this.redirectUrl=S(d),this.onReadyToRender=S(h)}static get REDIRECT_TIME_BUDGET_MS(){return 3e3}toString(){return"RecordRedirectVariationTask("+this.variation.getId()+")"}cleanup(){this.onReadyToRender()}run(){this.startPageviewId!==this.environment.getPageviewId()&&_s.error(`RecordRedirectVariationTask executing, but pageviewId has changed from ${this.startPageviewId} to ${this.environment.getPageviewId()}`,87,{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}),this.scheduleViewabilityOnce(Ii);const e=D.ofNullable(this.viewabilityTask).map((e=>e.getStatus())).orElse(Tr.NOT_STARTED);if(!kr.isDone(e))return _s.debug("RecordCodeVariationTask waiting for viewability"),Tr.TRY_LATER;if(e!==Tr.SUCCEEDED)return _s.info(`Variation ${this.variation.getExperience().getId()}/${this.variation.getId()} aborting record view event since viewability did not succeed`),Tr.CANCELED;this.startTimeMs||(this.startTimeMs=this.environment.getNowUnixTimeMs());let t=this.runSteps();return!kr.isDone(t)&&this.hasExceededTimeBudget()&&(this.scheduleRedirectOnce(),t=Tr.FAILED),this.doSuccessCallbacksOnce(),t}runSteps(){this.updateCustomerStorageOnce(),this.updateActivityStorageOnce(),this.sendGoogleAnalyticsOnce(),this.sendSegmentAnalyticsOnce(),this.sendMixpanelOnce(),this.sendViewEventOnce();const e=this.getRecordViewStatus();return kr.isDone(e)?(this.scheduleRedirectOnce(),Tr.SUCCEEDED):e}scheduleRedirectOnce(){if(!this.redirectScheduled){const e=new go(this.redirectUrl,this.environment,this.variation);this.manager.addTask(e),this.redirectScheduled=!0,this.environment.getWindow().setTimeout((()=>{this.onReadyToRender()}),this.getTimeRemainingMs()+vi)}}getTimeRemainingMs(){const e=this.environment.getNowUnixTimeMs()-this.startTimeMs,t=Io.REDIRECT_TIME_BUDGET_MS;return _s.debug("getTimeRemainingMs elapsed: "+e+", budget: "+t),t-e}hasExceededTimeBudget(){return this.getTimeRemainingMs()<0}}class wo extends oo{toString(){return`ExecuteRedirectVariationTask(${this.variation.getId()})`}executeVariation(){const e=this.runVariationRedirectCode(this.variation);if(void 0===e)return this.onReadyToRender(),Tr.FAILED;return this.injectVariationCss(this.variation)?(this.manager.addTask(new Io(this.variation,this.environment,this.browserEventLogger,this.customerStorage,this.attributeStorage,this.activityStorage,this.user,this.decisionContext,this.startPageviewId,this.override,this.getVariationRecordedCallbackTuples.bind(this),e,this.onReadyToRender.bind(this))),this.statusModel.setVariation(this.variation,"apply",!0),Tr.SUCCEEDED):(this.onReadyToRender(),Tr.FAILED)}runVariationRedirectCode(e){let t;if(e.getRedirect().isPresent()){const s=e.getRedirect().get();try{_s.info(`Variation ${e.getExperience().getId()}/${e.getId()} running redirect code`),t=Fs.evalString(s),_s.info(`Redirect URL is ${t}`)}catch(i){const s=new Ee(`Variation (${e.getId()}) redirect code execution failed`,i);_s.error(s,18,{variationId:e.getId(),experienceId:e.getExperience().getId()}),t=void 0}}return t}}function Co(e,t,i,s,n,r,o,a,l,c,u,d,h,g,p,m,v,b){let f;return f=m.isTypeChange()?yo:m.isRedirect()?wo:So,new f(e,t,i,s,n,r,o,a,l,c,u,d,h,g,p,m,v,b)}class To extends kr{constructor(e,t,i,s,n,r,o,a,l,c,u,d,h,g,p,m,v){super(),__publicField(this,"environment"),__publicField(this,"browserStorage"),__publicField(this,"extensionManager"),__publicField(this,"browserEventLogger"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"customerStorage"),__publicField(this,"decisionContext"),__publicField(this,"pageContext"),__publicField(this,"attributeData"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"statusModel"),__publicField(this,"hider"),__publicField(this,"getVariationRecordedCallbackTuples"),__publicField(this,"elementObserver"),__publicField(this,"startPageviewId"),__publicField(this,"startTimeMs"),__publicField(this,"executeVariationTasks",{}),__publicField(this,"didHide",!1),this.environment=S(e),this.browserStorage=S(t),this.extensionManager=S(i),this.environment=S(e),this.browserEventLogger=S(s),this.attributeStorage=S(n),this.activityStorage=S(r),this.customerStorage=S(o),this.decisionContext=S(a),this.pageContext=S(l),this.attributeData=S(c),this.user=S(u),this.override=S(d),this.statusModel=S(h),this.hider=S(g),this.getVariationRecordedCallbackTuples=S(m),this.elementObserver=S(v),this.startTimeMs=this.environment.getNowUnixTimeMs(),this.startPageviewId=e.getPageviewId(),this.override.requestAnimationFrame().orElse(p)&&this.environment.getWindow().requestAnimationFrame((()=>{this.handleRaf()}))}static get RAF_RUNTIME_MS(){return 3e4}toString(){return`ExecuteExperiencesTask(${this.startPageviewId})`}inTransaction(){return!1}isUnloading(){return!1}getStartPageviewId(){return this.startPageviewId}hideExperiencesOnce(){this.didHide||(this.hider.hideExperiences(this.decisionContext.getExperiences(),this.browserStorage,this.attributeData),this.hider.revealDocumentIfAllRegionsHidden(),this.didHide=!0)}run(){return this.decisionContext.getExperiences().forEach((e=>{if(this.decisionContext.hasNext(e.getId())){const t=this.decisionContext.getFirst(e.getId());void 0===this.executeVariationTasks[e.getId()]&&(_s.debug(`Queueing ExecuteVariationTask for ExperienceID: ${e.getId()}, Variation ID: ${t.getId()}`),this.executeVariationTasks[e.getId()]=Co(this.environment,this.browserStorage,this.extensionManager,this.browserEventLogger,this.customerStorage,this.attributeStorage,this.activityStorage,this.pageContext,this.attributeData,this.decisionContext,this.user,this.override,this.statusModel,this.startPageviewId,this.hider,t,this.getVariationRecordedCallbackTuples,this.elementObserver),this.manager.addTask(this.executeVariationTasks[e.getId()]));const i=this.executeVariationTasks[e.getId()];i.getStatus()===Tr.FAILED||i.getStatus()===Tr.CANCELED?this.handleOnExperienceError(e):i.getStatus()===Tr.SUCCEEDED&&this.handleOnExperienceSuccess(e)}})),this.decisionContext.isEmpty()?Tr.SUCCEEDED:Tr.TRY_LATER}handleOnExperienceSuccess(e){this.decisionContext.removeExperience(e.getId())}handleOnExperienceError(e){this.decisionContext.removeExperience(e.getId()),this.hider.revealExperience(e,this.browserStorage,this.attributeData)}handleRaf(){this.manager&&this.manager.runNow(),this.environment.getNowUnixTimeMs()-this.startTimeMs<To.RAF_RUNTIME_MS&&!kr.isDone(this.getStatus())&&this.environment.getWindow().requestAnimationFrame((()=>{this.handleRaf()}))}}const xo=class extends kr{constructor(e,t,i,s,n){super(),__publicField(this,"instanceNumber"),__publicField(this,"pageviewId"),__publicField(this,"customer"),__publicField(this,"environment"),__publicField(this,"customerStorage"),__publicField(this,"success"),__publicField(this,"startTimeMs"),this.instanceNumber=++xo.instanceCount,this.environment=e,this.pageviewId=t,this.customerStorage=i,this.customer=s,this.success=n}static get DEPENDENCIES_TIME_BUDGET_MS(){return 3e3}toString(){return`SelectedVariationsCallbackTask(${this.pageviewId}, ${this.instanceNumber})`}inTransaction(){return!0}isUnloading(){return!1}getNotDoneDependencies(){const e=[],t=this.getRunningDependentRecordTasks();Array.prototype.push.apply(e,t);const i=this.getDependentExecuteExperiencesTask();return i.length>0&&!i[0].isDone()&&Array.prototype.push.apply(e,i),e}run(){this.startTimeMs||(this.startTimeMs=this.environment.getNowUnixTimeMs());const e=this.getRunningDependentRecordTasks();if(e.length>0)return _s.debug("Waiting for "+e[0].toString()+", "+Tr[e[0].getStatus()]),Tr.TRY_LATER;const t=this.getDependentExecuteExperiencesTask();if(t.length>1)return _s.error(`Found multiple ExecuteExperiencesTasks for pageviewId ${this.pageviewId}`,89),Tr.FAILED;if(0===t.length)return Tr.TRY_LATER;const i=t[0];return kr.isDone(i.getStatus())?(this.doCallback(),Tr.SUCCEEDED):this.hasExceededTimeBudget()?(_s.debug(`Time budget of ${xo.DEPENDENCIES_TIME_BUDGET_MS} ms exceeded while waiting for ExecuteVariationTasks to complete; triggering success callbacks now`),this.doCallback(),Tr.SUCCEEDED):(_s.debug("Waiting for "+i.toString()+", "+Tr[i.getStatus()]),Tr.TRY_LATER)}getRunningDependentRecordTasks(){return this.manager.findTasks((e=>e instanceof Eo&&!e.isDone()))}getDependentExecuteExperiencesTask(){return this.manager.findTasks((e=>e instanceof To&&this.pageviewId===e.getStartPageviewId()))}doCallback(){const e=this.customerStorage.getPageviewSelections(this.pageviewId),t=this.generateResponse(e);_s.debug("Callback data: "+Bi(t));try{this.success.call(void 0,t)}catch(i){const e=new Ee("Caught exception in customer callback",i);_s.error(e,8)}}getTimeRemainingMs(){const e=this.environment.getNowUnixTimeMs()-this.startTimeMs,t=xo.DEPENDENCIES_TIME_BUDGET_MS;return _s.debug("getTimeRemainingMs elapsed: "+e+", budget: "+t),t-e}hasExceededTimeBudget(){return this.getTimeRemainingMs()<0}};let Ao=xo;__publicField(Ao,"instanceCount",0);class ko extends Ao{toString(){return"SelectedVariationIdsCallbackTask("+this.pageviewId+","+this.instanceNumber+")"}generateResponse(e){const t={};return e.forEach((e=>{t[e.experienceId]=e.variationId})),t}}class Po extends Ao{toString(){return"SelectedVariationNamesCallbackTask("+this.pageviewId+","+this.instanceNumber+")"}generateResponse(e){const t={};return e.forEach((e=>{e.campaignId in t||(t[e.campaignId]={});const i={};i.varId=e.variationId,this.customer.getCampaign(e.campaignId).ifPresent((s=>{t[e.campaignId].campaignName=s.getName(),s.getExperience(e.experienceId).ifPresent((t=>{i.expName=t.getName(),t.getVariation(e.variationId).ifPresent((e=>{i.varName=e.getName()}))}))})),t[e.campaignId][e.experienceId]=i})),t}}class Do{constructor(e,t,i,s,n,r,o,a,l,c,u,d,h,g,p){__publicField(this,"environment"),__publicField(this,"extensionManager"),__publicField(this,"browserEventLogger"),__publicField(this,"taskManager"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"integrationDataStorage"),__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"statusModel"),__publicField(this,"callQueue"),__publicField(this,"readyCallbackQueue"),__publicField(this,"addVariationRecordedCallbackTuple"),__publicField(this,"initialized"),this.environment=S(e),this.extensionManager=t,this.browserEventLogger=S(i),this.taskManager=S(s),this.customerStorage=S(n),this.attributeStorage=S(r),this.activityStorage=S(o),this.integrationDataStorage=S(a),this.customer=S(l),this.user=S(c),this.override=S(u),this.statusModel=S(d),this.callQueue=S(h),this.readyCallbackQueue=S(g),this.addVariationRecordedCallbackTuple=S(p),this.initialized=!1}static validatePushCommand(e){return e&&"object"==typeof e&&e.constructor===Array?!(!e[0]||"string"!=typeof e[0])||(Do.consoleError(`intellimize.push(): First parameter must be a string: ${Bi(e)}`,114),!1):(Do.consoleError(`intellimize.push(): Parameter must be an array: ${Bi(e)}`,113),!1)}static validateReadyCallback(e){return!!Vs(e)||(Do.consoleError("intellimize.ready() was called with a non-function argument",115),!1)}static consoleError(e,t){console.error(e),_s.error(e,t)}static validateAttributeScope(e){return"user"===e||"pageview"===e}static validateAttributes(e){return null!=e&&Us(e)}static filterAttributePairs(e){for(const t in e){if(!Object.prototype.hasOwnProperty.call(e,t))continue;if(!Do.validateAttributeName(t)){Do.consoleError(`intellimize.setAttributes() invalid attribute ${t}`,96),delete e[t];continue}const i=Do.transformAttributeValue(e[t]);Do.validateAttributeValue(i)?e[t]=i:(Do.consoleError(`intellimize.setAttributes() invalid attribute ${t}: ${e[t]}`,97),delete e[t])}}static validateAttributeName(e){return/^[\u0020-\u003C\u003E-\u007E]{1,40}$/.test(e)}static transformAttributeValue(e){let t=e;return"boolean"==typeof t&&(t=t.toString()),"number"==typeof t&&(t=t.toString()),null===t&&(t=""),void 0===t&&(t=""),"string"==typeof t&&t.length>255&&(t=t.slice(0,255)),t}static validateAttributeValue(e){return void 0!==e&&"string"==typeof e&&e.length>=0&&e.length<256}static validateAttributeNames(e){if(void 0===e||!Array.isArray(e))return!1;for(const t of e)if(!Do.validateAttributeName(t))return!1;return!0}static validateCustomEventApiName(e){return/^[\u0021-\u007E]{1,40}$/.test(e)}static validateCustomEventProperties(e){const t=new Set(["value","actionId"]);return!!Object.keys(e).every((e=>t.has(e)))&&(!(void 0!==e.value&&!Mr(e.value))&&!(void 0!==e.actionId&&!Nr(e.actionId)))}static validateCustomerUserId(e){return/^[\u0021-\u007E]{1,300}$/.test(e)}static validateCustomerUserDomain(e){return"intellimize"!==e&&!e.startsWith("__")&&/^[\u0021-\u007E]{1,50}$/.test(e)}static doCallback(e){void 0!==e&&Fs.executeFunction(e,5)}get isInitialized(){return this.initialized}initialize(){const e=this,t=this.environment.getWindow(),{intellimize:i}=t;void 0!==i?(i.getSelectedVariationIds=(e,t)=>{"function"==typeof e?void 0===t||"function"==typeof t?this.getSelectedVariationIds(e,t):Do.consoleError("intellimize.getSelectedVariationIds() second parameter must be an error function",103):Do.consoleError("intellimize.getSelectedVariationIds() first parameter must be a success function",102)},i.getSelectedVariationNames=(e,t)=>{"function"==typeof e?void 0===t||"function"==typeof t?this.getSelectedVariationNames(e,t):Do.consoleError("intellimize.getSelectedVariationNames() second parameter must be an error function",105):Do.consoleError("intellimize.getSelectedVariationNames() First parameter must be a success function",104)},i.onVariationRecorded=function(t,i){e.onVariationRecorded(t.bind(this),void 0===i?void 0:i.bind(this))},i.setAttributes=(e,t)=>{this.setAttributes(e,t)},i.getAttributes=(e,t)=>this.getAttributes(e,t),i.getAllAttributes=e=>this.getAllAttributes(e),i.deleteAttributes=(e,t)=>{this.deleteAttributes(e,t)},i.deleteAllAttributes=e=>{this.deleteAllAttributes(e)},i.getIntegrationData=e=>this.getIntegrationData(e),i.sendEvent=(e,t,i)=>{this.sendEvent(e,t,i)},i.activate=e=>{this.activate(e)},i.setUserId=(e,t)=>{this.setCustomerUserId(e,t)},i.getActivities=()=>this.getActivities(),i.registerExtension=e=>{_s.debug(`intellimize.registerExtension(${e.getName()})`),this.extensionManager.registerExtension(e)},i.push=e=>{Do.validatePushCommand(e)&&this.push(e)},i.ready=e=>{Do.validateReadyCallback(e)&&this.ready(e)},this.callQueue.forEach((e=>{e&&"object"==typeof e&&e.constructor===Array?"push"!==e[0]?this.push(e):Do.consoleError('intellimize.push() Refusing to process command "push", to prevent infinite recursion.',10):Do.consoleError("intellimize.push() Parameter must be an array: "+Bi(e),9)})),this.readyCallbackQueue.forEach(((e,t)=>{_s.debug(`intellimize.ready() executing registered callback #${t+1}`),this.ready(e)})),this.initialized=!0):_s.error("window.intellimize is undefined: Cannot initialize ExternalApi",218)}getSelectedVariationIds(e,t){_s.debug("getSelectedVariationIds()"),_s.warn("getSelectedVariationIds",160);const i=this.environment.getPageviewId(),s=new ko(this.environment,i,this.customerStorage,this.customer,e);this.taskManager.addTask(s)}getSelectedVariationNames(e,t){_s.debug("getSelectedVariationNames()"),_s.warn("getSelectedVariationNames",161);const i=this.environment.getPageviewId(),s=new Po(this.environment,i,this.customerStorage,this.customer,e);this.taskManager.addTask(s)}onVariationRecorded(e,t){_s.debug("onVariationRecorded()"),_s.warn("onVariationRecorded",203),"function"==typeof e?void 0===t||"function"==typeof t?this.addVariationRecordedCallbackTuple([e,D.ofNullable(t)]):Do.consoleError("intellimize.onVariationRecorded() second parameter must be an error function",164):Do.consoleError("intellimize.onVariationRecorded() first parameter must be a success function",163)}setAttributes(e,t){_s.debug(`setAttributes(${e}, ${Bi(t)})`),Do.validateAttributeScope(e)?Do.validateAttributes(t)?(Do.filterAttributePairs(t),this.attributeStorage.setCustomAttributes(e,t)):Do.consoleError("intellimize.setAttributes() invalid attributes parameter",110):Do.consoleError("intellimize.setAttributes() invalid scope parameter",109)}getAttributes(e,t){return _s.debug(`getAttributes(${e}, ${t})`),Do.validateAttributeScope(e)?Do.validateAttributeNames(t)?this.attributeStorage.getCustomAttributes(e,t):(Do.consoleError("intellimize.getAttributes() invalid names parameter",100),{}):(Do.consoleError("intellimize.getAttributes() invalid scope parameter",99),{})}getAllAttributes(e){return _s.debug(`getAllAttributes(${e}`),Do.validateAttributeScope(e)?this.attributeStorage.getCustomAttributes(e):(Do.consoleError("intellimize.getAllAttributes() invalid scope parameter",98),{})}deleteAttributes(e,t){_s.debug(`deleteAttributes(${e}, ${t})`),Do.validateAttributeScope(e)?Do.validateAttributeNames(t)?this.attributeStorage.deleteCustomAttributes(e,t):Do.consoleError("intellimize.deleteAttributes() invalid names parameter",95):Do.consoleError("intellimize.deleteAttributes() invalid scope parameter",94)}deleteAllAttributes(e){_s.debug(`deleteAllAttributes(${e})`),Do.validateAttributeScope(e)?this.attributeStorage.deleteCustomAttributes(e):Do.consoleError("intellimize.deleteAllAttributes() invalid scope parameter",20)}getIntegrationData(e){var t;if(_s.debug(`getIntegrationData(${e})`),"marketoLead"===e){return null!=(t=this.integrationDataStorage.getData("marketo").flatMap((e=>Er(e))).orElse({lead:{fields:{},lists:[]}}).lead)?t:{}}return or.includes(e)?this.integrationDataStorage.getData(e).flatMap((e=>D.ofNullable(e))).orElse({}):(Do.consoleError("intellimize.getData() invalid integration name parameter",101),{})}sendEvent(e,t,i){return _s.debug(`sendEvent(${e}, ${Bi(t)} )`),Do.validateCustomEventApiName(e)?void 0===t||Do.validateCustomEventProperties(t)?void this.customer.getCustomEvent(e).flatMap((t=>this.override.isEventLive(t).orElse("live"===t.getState())?D.ofNullable(t):(_s.debug(`sendEvent(${e}) event is not live`),D.empty()))).ifPresent((e=>{const s=void 0===t?void 0:t.value;let n=void 0===t?void 0:t.actionId;void 0===n&&(n=this.environment.generateActionId());const r=new sr(e,n,s,void 0);this.activityStorage.add(io.buildConversionActivity(r,this.customer,this.environment,this.user,this.attributeStorage,this.customerStorage));const o=new Dr(r,this.browserEventLogger,this.customer,this.customerStorage,this.statusModel);void 0!==i&&o.onDone(i),this.taskManager.addTask(o)})).ifAbsent((()=>{Do.consoleError(`intellimize.sendEvent() apiName not found "${e}"`,19),Do.doCallback(i)})):(Do.consoleError(`intellimize.sendEvent() invalid properties "${Bi(t)}"`,108),void Do.doCallback(i)):(Do.consoleError(`intellimize.sendEvent() invalid apiName "${e}"`,107),void Do.doCallback(i))}activate(e){_s.debug("activate()");const t=this.taskManager.findTasks((e=>e instanceof so&&!e.isDone()));if(t.length>0){_s.debug("Ignoring activate() since there is an outstanding ActivateTask");const i=t[0];return void(void 0!==e&&i.addCallback(e))}const i=this.taskManager.findTasks((e=>e instanceof no&&!e.isDone()));if(i.length>0){_s.debug("Extending activate() expiration time");const t=i[0];return void 0!==e&&t.addCallback(e),void t.resetExpiration()}const s=void 0===e?[]:[e],n=new no(this.environment,this.override,s);this.taskManager.addTask(n)}setCustomerUserId(e,t){if(_s.debug(`setCustomerUserId(${e}, ${t})`),!Do.validateCustomerUserDomain(e))return void Do.consoleError("intellimize.setCustomerUserId() invalid user domain",111);if(!Do.validateCustomerUserId(t))return void Do.consoleError("intellimize.setCustomerUserId() invalid user id",112);const i=new Fr(this.environment,this.customer,"intellimize",this.user.getId(),e,t);this.taskManager.addTask(i)}getActivities(){return _s.debug("getActivities()"),this.activityStorage.getAll()}push(e){_s.debug("push("+e[0]+")");const t=this.environment.getWindow();try{if(void 0===t.intellimize)return void _s.error("push() called, but window.intellimize undefined",30);const i=e.shift();if(void 0===t.intellimize[i])return void Do.consoleError(`intellimize.${i}() is not a valid function`,106);t.intellimize[i].apply(void 0,e)}catch(i){const e=new Ee("Error executing push()",i);_s.error(e,3)}}ready(e){Do.doCallback(e)}}class Fo{constructor(e){__publicField(this,"environment"),__publicField(this,"callQueue"),__publicField(this,"readyCallbackQueue"),this.environment=e,this.callQueue=[],this.readyCallbackQueue=[]}static isValidObjectDefinition(e){if(Us(e)){const t=Object.keys(e);if(4===t.length){if(0===zs(["p","r","push","ready"],t).length&&Ls(e.p)&&Ls(e.r)&&Vs(e.push)&&Vs(e.ready))return!0}}return!1}initialize(){const e=this.environment.getWindow();if(void 0!==e.intellimize)if(Ls(e.intellimize))this.setCallQueue(e.intellimize);else if(Us(e.intellimize))if(Fo.isValidObjectDefinition(e.intellimize)){const t=e.intellimize;this.setCallQueue(t.p),this.setReadyCallbackQueue(t.r)}else Do.consoleError("[Intellimize Api]: window.intellimize is an object that does not match the expected definition",116);else Do.consoleError("[Intellimize Api]: window.intellimize is not an object or an array",117);e.intellimize={ready:this.ready.bind(this),push:this.push.bind(this)}}extractCallQueue(){const{callQueue:e}=this;return this.callQueue=[],e}extractReadyCallbackQueue(){const{readyCallbackQueue:e}=this;return this.readyCallbackQueue=[],e}ready(e){Do.validateReadyCallback(e)&&(_s.debug("[Intellimize Api]: registering ready() callback"),this.readyCallbackQueue.push(e))}push(e){Do.validatePushCommand(e)&&(_s.debug("[Intellimize Api]: adding command to call queue"),this.callQueue.push([...e]))}setCallQueue(e){_s.debug("[Intellimize Api]: storing window.intellimize callQueue"),this.callQueue=[],e.forEach((e=>{Do.validatePushCommand(e)&&this.callQueue.push([...e])}))}setReadyCallbackQueue(e){_s.debug("[Intellimize Api]: storing window.intellimize readyCallbackQueue"),this.readyCallbackQueue=[],e.forEach((e=>{Do.validateReadyCallback(e)&&this.readyCallbackQueue.push(e)}))}}class Mo{constructor(e,t,i,s,n,r,o,a,l,c,u){__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"environment"),__publicField(this,"extensionManager"),__publicField(this,"serverContext"),__publicField(this,"taskManager"),__publicField(this,"browserStorage"),__publicField(this,"customerStorage"),__publicField(this,"externalApi"),__publicField(this,"attributeData"),__publicField(this,"elementObserver"),__publicField(this,"storageKey"),this.customer=e,this.user=t,this.environment=i,this.extensionManager=s,this.serverContext=n,this.taskManager=r,this.browserStorage=o,this.customerStorage=a,this.externalApi=l,this.attributeData=c,this.elementObserver=u,this.storageKey=Ti+e.getId()}initialize(){if(!this.externalApi.isInitialized)throw new Error("ExternalApi needs to be initialized before calling InternalApi.initialize()");const e=this.environment.getWindow(),{intellimize:t}=e;void 0!==t?(t.plugins={},t.setLocalState=(e,t)=>{_s.info(`intellimize.setLocalState(${e}, ${t})`),this.setLocalState(e,t)},t.getLocalState=e=>{const t=this.getLocalState(e);return _s.info(`intellimize.getLocalState(${e}) => ${t}`),t},t.deleteLocalState=e=>{_s.info(`intellimize.deleteLocalState(${e})`),this.deleteLocalState(e)},t.getSessionId=()=>(_s.info("intellimize.getSessionId()"),this.getSessionId()),t.getUserId=()=>(_s.info("intellimize.getUserId()"),this.getUserId()),t.getPageviewId=()=>(_s.info("intellimize.getPageviewId()"),this.getPageviewId()),t.logErr=e=>{_s.error(`Customer error: ${e}`,1)},t.log=(e,t,i)=>{const s=1e4;i&&(!/^\d{5}$/.test(`${i}`)||i<10001||i>10999)&&(_s.error(`Called intellimize.log with an invalid message code. (Wanted: 10001 < code < 10999. Found: ${i})`,998),i=s);const n=null!=i?i:s;switch(t){case L.LogLevel.TRACE:case L.LogLevel.DEBUG:return void _s.debug(e,n);case L.LogLevel.INFO:return void _s.info(e,n);case L.LogLevel.WARN:return void _s.warn(e,n);case L.LogLevel.ERROR:return void _s.error(e,n);default:_s.error(`Called intellimize.log with an invalid LogLevel (${t}). Treating as "debug".`,999),_s.debug(e,n)}},t.applyChange=e=>{const t=Mn(Ct(e),pn(e),0,this.attributeData,this.environment,this.browserStorage,this.extensionManager);return t.isReadyToApply()?(t.apply((()=>{}),this.elementObserver),b.APPLIED):b.UNAPPLIED},t.undoChange=e=>(Mn(Ct(e),pn(e),0,this.attributeData,this.environment,this.browserStorage,this.extensionManager).undo(),b.UNAPPLIED),t.hasChangeData=e=>nn(e),t.getChangeTypeData=(e,t)=>dn(e,t),t.hasStarted=()=>{const e=this.taskManager.hasStarted();return _s.debug(`intellimize.hasStarted() => ${e}`),e},t.isDone=()=>{const e=this.taskManager.isDone();return _s.debug(`intellimize.isDone() => ${e}`),e},t.onDone=e=>{_s.debug("intellimize.onDone(callbackFunction)"),this.taskManager.onDone(e)},t.isRestarting=()=>{const e=this.taskManager.getClient().isRestarting();return _s.debug(`intellimize.isRestarting() => ${e}`),e},_s.getLevel()<=L.LogLevel.INFO&&(e[e.atob("aWNqc24=")]=this.customer.getData(),e[e.atob("aXBqc24=")]=()=>this.browserStorage.read(Pi+this.customer.getId()).map((e=>Qi(Xi(this.environment,e)))).orElse({})),this.reinitialize()):_s.error("window.intellimize is undefined: Cannot initialize InternalApi",219)}reinitialize(){this.exposeAttributeData()}setLocalState(e,t){const i=this.readState();i[e]=t,this.writeState(i)}getLocalState(e){return this.readState()[e]}deleteLocalState(e){const t=this.readState();delete t[e],this.writeState(t)}getSessionId(){return this.customerStorage.updateAndGetSessionId()}getUserId(){return this.user.getId()}getPageviewId(){return this.environment.getPageviewId()}readState(){let e={};return this.browserStorage.read(this.storageKey).ifPresent((t=>{try{e=Qi(t)}catch(i){const e=new Ee("Could not parse internal api storage",i);_s.error(e,33)}})),e}writeState(e){const t=Hi(e);this.browserStorage.write(this.storageKey,t)}exposeAttributeData(){var e;const t=this.environment.getWindow(),i=e=>{if(void 0!==e.cityName)return e.cityName.replace(/\s/g,"").toUpperCase()};t.iiloc={country:this.serverContext.location.countryIso,region:null!=(e=this.serverContext.location.subdivision2Iso)?e:this.serverContext.location.subdivision1Iso,city:i(this.serverContext.location),dma:this.serverContext.location.dmaCode,postal:this.serverContext.location.postalCode,tz:this.environment.getTimeZone()};const s=this.attributeData.getUserAgentData(),n=this.attributeData.getTrafficSourceData();t.icntxtlftrs={IP:this.serverContext.clientIp,D:s.deviceType,B:s.browser,OS:s.os,DC:s.deviceClass,DN:s.deviceName,DB:s.deviceBrand,OC:s.osClass,ON:s.osName,OV:s.osVersion,AC:s.agentClass,AN:s.agentName,AV:s.agentVersionMajor,TS:n};const r=this.attributeData.getUtmParamsData();t.iutmprms={uts:r.utmSource,utm:r.utmMedium,utcm:r.utmCampaign,utcn:r.utmContent,utt:r.utmTerm}}}const No="UTC";let Oo,Ro=!0;function Lo(e){var t;if(void 0!==Oo)return Oo;if(Ro){if("undefined"===(null==(t=e.Intl)?void 0:t.DateTimeFormat))return void $o();const i=e.Intl.DateTimeFormat();return void 0===i||void 0===i.resolvedOptions?void $o():(Oo=e.Intl,Oo)}}function $o(){Ro=!1,_s.error("Intl.DateTimeFormat().resolvedOptions() is not supported by the browser",1014)}function Uo(e){const t=Lo(e);let i="";return void 0!==t&&(i=t.DateTimeFormat().resolvedOptions().timeZone),void 0===i||""===i?No:i}const Vo=e=>"0"===e||"1"===e;function Wo(e){return t=>new RegExp("^"+e+"$").test(t)}const zo=e=>"true"===e||"false"===e;class jo{constructor(e,t){__publicField(this,"isEditorMode"),__publicField(this,"_shouldRun"),__publicField(this,"_originAllowed"),__publicField(this,"experienceVariations",{}),__publicField(this,"_allPagesLive"),__publicField(this,"_allAudiencesLive"),__publicField(this,"_allEventsLive"),__publicField(this,"_passExperienceAudience"),__publicField(this,"_passVariationAudience"),__publicField(this,"_isControl"),__publicField(this,"_saveCustomerStorage"),__publicField(this,"_sendBrowserEvents"),__publicField(this,"_sendGoogleAnalytics"),__publicField(this,"_sendSegmentAnalytics"),__publicField(this,"_sendMixpanel"),__publicField(this,"_showStatusModule"),__publicField(this,"_showBasesite"),__publicField(this,"_expires"),__publicField(this,"attributeData",{location:{},utmParams:{},userAgent:{},dayPart:void 0,weekPart:void 0,trafficSource:void 0,custom:{},urlParam:{},userVisitStatus:void 0,userBucket:void 0}),__publicField(this,"_requestAnimationFrame");const i=hs(t,e.getHostingPageUrl().getOrigin());i.isPresent()&&!i.get()&&(this._originAllowed=!1);const s=e.getHostingPageUrl().getQueryParam("intellimize_no_run",Wo("true")).isPresent(),n=e.getHostingPageUrl().getQueryParam("imize_editor",Wo("true")).isPresent();if(n)return void(this.isEditorMode=!0);s&&!n&&(this._shouldRun=!1);const r=e.getWindow().iOverride;if(void 0!==r){if(void 0!==r.experienceVariations){const{experienceVariations:e}=r;Object.keys(e).forEach((t=>{var i;null==(i=e[t])||i.forEach((e=>{t in this.experienceVariations||(this.experienceVariations[t]={}),this.experienceVariations[t][e]=!0}))}))}this._allPagesLive=r.allPagesLive,this._allAudiencesLive=r.allAudiencesLive,this._allEventsLive=r.allEventsLive,this._passExperienceAudience=r.passExperienceAudience,this._passVariationAudience=r.passVariationAudience,this._isControl=r.isControl,this._saveCustomerStorage=r.saveCustomerStorage,this._sendBrowserEvents=r.sendBrowserEvents,this._sendGoogleAnalytics=r.sendGoogleAnalytics,this._sendSegmentAnalytics=r.sendSegmentAnalytics,this._sendMixpanel=r.sendMixpanel,this._showStatusModule=r.showStatusModule,this._expires=r.expires}e.readLocalStorage("intellimize_override").ifPresent((e=>{let t={};try{t=Qi(e)}catch(i){const e=new Ee("Could not parse override",i);_s.error(e,192)}void 0!==t.raf&&(this._requestAnimationFrame=t.raf)})),e.getHostingPageUrl().getQueryParam("iev",Wo("[0-9;:]+")).ifPresent((e=>{this.experienceVariations={},e.split(";").forEach((t=>{const i=t.split(":");if(2===i.length){const e=i[0],t=i[1];e in this.experienceVariations||(this.experienceVariations[e]={}),this.experienceVariations[e][t]=!0}else _s.error(`Override could not parse iev ${e}`,34)})),void 0!==r&&0!==Object.keys(r).length||(this._passExperienceAudience=!0,this._passVariationAudience=!0,this._saveCustomerStorage=!1,this._sendBrowserEvents=!1),this._isControl=!1,this._sendGoogleAnalytics=!1,this._sendSegmentAnalytics=!1,this._sendMixpanel=!1,this._showStatusModule=!0})),e.getHostingPageUrl().getQueryParam("showBasesite",Wo("1")).ifPresent((()=>{this._showBasesite=!0,this._showStatusModule=!0})),e.getHostingPageUrl().getQueryParam("iea",Vo).ifPresent((e=>{"1"===e&&(this._passExperienceAudience=void 0)})),e.getHostingPageUrl().getQueryParam("iva",Vo).ifPresent((e=>{"1"===e&&(this._passVariationAudience=void 0)})),e.getHostingPageUrl().getQueryParam("is",Vo).ifPresent((e=>{"1"===e?this._showStatusModule=!0:"0"===e&&(this._showStatusModule=!1)}));let o=!1;[["ictxt_city","city","([A-Z0-9]){1,40}"],["ictxt_region","state","([a-zA-Z0-9]){1,40}"],["ictxt_country","country","[A-Z]{2}"],["ictxt.city","city","([A-Z0-9]){1,40}"],["ictxt.region","state","([a-zA-Z0-9]){1,40}"],["ictxt.country","country","[A-Z]{2}"]].forEach((t=>{e.getHostingPageUrl().getQueryParam(t[0],Wo(t[2])).ifPresent((e=>{this.attributeData.location[t[1]]=e,o=!0}))}));[["ictxt_d","deviceType","[DPT]"]].forEach((t=>{e.getHostingPageUrl().getQueryParam(t[0],Wo(t[2])).ifPresent((e=>{this.attributeData.userAgent[t[1]]=e,o=!0}))})),e.getHostingPageUrl().getQueryParam("ictxt_ts",Wo("[A-Z]{2}")).ifPresent((e=>{this.attributeData.trafficSource=e,o=!0})),e.getHostingPageUrl().getQueryParam("raf",zo).ifPresent((e=>{"true"===e?this._requestAnimationFrame=!0:"false"===e&&(this._requestAnimationFrame=!1)})),o&&(this._isControl=!1,this._saveCustomerStorage=!1,this._sendBrowserEvents=!1,this._sendGoogleAnalytics=!1,this._sendSegmentAnalytics=!1,this._sendMixpanel=!1)}getExpirationMs(){return D.ofNullable(this._expires)}setExpiration(e){this._expires=e}getOverrideJson(){const e={allPagesLive:this._allPagesLive,allAudiencesLive:this._allAudiencesLive,allEventsLive:this._allEventsLive,isControl:this._isControl,passExperienceAudience:this._passExperienceAudience,passVariationAudience:this._passVariationAudience,saveCustomerStorage:this._saveCustomerStorage,sendBrowserEvents:this._sendBrowserEvents,sendGoogleAnalytics:this._sendGoogleAnalytics,sendMixpanel:this._sendMixpanel,showStatusModule:this._showStatusModule},t={};return Object.keys(this.experienceVariations).forEach((e=>{t[e]=Object.keys(this.experienceVariations[e])})),t&&Object.keys(t).length>0&&(e.experienceVariations=t),Object.keys(e).forEach((t=>{void 0===e[t]&&delete e[t]})),e}isPageLive(e){return D.ofNullable(this._allPagesLive)}isAudienceLive(e){return D.ofNullable(this._allAudiencesLive)}isEventLive(e){return D.ofNullable(this._allEventsLive)}isExperienceEnabled(e){return this.hasExperienceVariationsSet()?D.of(this.isExperienceSet(e)):D.empty()}passExperienceCondition(){return D.ofNullable(this._passExperienceAudience)}isExperienceIncluded(e){return this.hasExperienceVariationsSet()?D.of(this.isExperienceSet(e)):D.empty()}hasExperienceIds(){if(this.hasExperienceVariationsSet()){const e=Object.keys(this.experienceVariations);return _s.debug("hasExperienceIds => "+e+" (override)"),D.of(e)}return D.empty()}hasVariationIds(e){const t=e.getId();if(this.hasExperienceVariationsSet()&&t in this.experienceVariations){const e=Object.keys(this.experienceVariations[t]);return _s.debug("hasVariationIds => "+e+" (override)"),D.of(e)}return D.empty()}isVariationEnabled(e){return this.hasExperienceVariationsSet()?D.of(this.isVariationSet(e)):D.empty()}passVariationCondition(){return D.ofNullable(this._passVariationAudience)}isControl(){return D.ofNullable(this._isControl)}saveCustomerStorage(){const e=D.ofNullable(this._saveCustomerStorage);return e.ifPresent((e=>{_s.debug(`save CustomerStorage => ${e} (override)`)})),e}sendGoogleAnalytics(){const e=D.ofNullable(this._sendGoogleAnalytics);return e.ifPresent((e=>{_s.debug(`send GoogleAnalytics => ${e} (override)`)})),e}sendSegmentAnalytics(){const e=D.ofNullable(this._sendSegmentAnalytics);return e.ifPresent((e=>{_s.debug(`send SegmentAnalytics => ${e} (override)`)})),e}sendMixpanel(){const e=D.ofNullable(this._sendMixpanel);return e.ifPresent((e=>{_s.debug(`send Mixpanel => ${e} (override)`)})),e}getAttributeDataOverrides(){return __spreadValues({},this.attributeData)}showStatusModule(){return D.ofNullable(this._showStatusModule)}isExperienceSet(e){return!0!==this._showBasesite&&e.getId()in this.experienceVariations}isVariationSet(e){var t;const i=e.getExperience().getId(),s=e.getId();return Boolean(null==(t=this.experienceVariations[i])?void 0:t[s])}showBasesite(){return D.ofNullable(this._showBasesite)}requestAnimationFrame(){return D.ofNullable(this._requestAnimationFrame)}hasExperienceVariationsSet(){return!0===this._showBasesite||Object.keys(this.experienceVariations).length>0}shouldRun(){return D.ofNullable(this._shouldRun)}shouldHide(){return!0===this.isEditorMode||!1===this._originAllowed?D.of(!1):D.empty()}useStorageType(){return!0===this.isEditorMode||!1===this._originAllowed||this.hasExperienceVariationsSet()?D.of("SessionStorage"):D.empty()}useElementObserver(){return!0===this.isEditorMode||!1===this._originAllowed?D.of(!1):D.empty()}injectVisualEditor(){return!0===this.isEditorMode?D.of(!0):D.empty()}shouldRunTasks(){let e;return!0!==this.isEditorMode&&!1!==this._originAllowed||(e=!1),void 0!==e&&_s.debug(`send BrowserEvent => ${e} (override)`),D.ofNullable(e)}sendNonPageviewBrowserEvents(){let e;return!1!==this._sendBrowserEvents&&!1!==this._originAllowed&&!0!==this.isEditorMode||(e=!1),void 0!==e&&_s.debug(`send BrowserEvent => ${e} (override)`),D.ofNullable(e)}sendPageviewBrowserEvents(){let e;return!1===this._sendBrowserEvents&&(e=!1),!0===this.isEditorMode&&(e=!1),void 0!==e&&_s.debug(`send BrowserEvent => ${e} (override)`),D.ofNullable(e)}shouldCheckOptOut(){return!0===this.isEditorMode||!1===this._originAllowed?D.of(!1):D.empty()}saveActivity(){let e;return!1!==this._sendBrowserEvents&&!1!==this._originAllowed&&!0!==this.isEditorMode||(e=!1),void 0!==e&&_s.debug(`save activity => ${e} (override)`),D.ofNullable(e)}}class Go{constructor(e,t,i,s,n,r,o,a,l,c,u){__publicField(this,"environment"),__publicField(this,"browserStorage"),__publicField(this,"extensionManager"),__publicField(this,"customer"),__publicField(this,"conditionEvaluationRuntime"),__publicField(this,"attributeData"),__publicField(this,"override"),__publicField(this,"taskManager"),__publicField(this,"elementObserver"),__publicField(this,"hider"),__publicField(this,"statusModel"),__publicField(this,"pages",[]),__publicField(this,"audiences",[]),__publicField(this,"pageviewId"),__publicField(this,"pageChangelistTasks",{}),this.environment=e,this.browserStorage=t,this.extensionManager=i,this.customer=s,this.conditionEvaluationRuntime=n,this.attributeData=r,this.override=o,this.taskManager=a,this.hider=l,this.elementObserver=c,this.statusModel=u}reinitialize(){const e=this.environment.getPageviewId();this.pageviewId===e&&_s.error("PageContext.reinitialize() called more than once per pageview",244),this.pages=this.determineMatchingPages(),this.hider.hidePages(this.pages,this.browserStorage,this.attributeData),this.hider.revealDocumentIfAllRegionsHidden(),this.pageChangelistTasks=this.schedulePageChangeListTasks(),this.audiences=this.determineMatchingAudiences(),this.pageviewId=e}getPages(){return this.pageviewId!==this.environment.getPageviewId()&&_s.error("PageContext.getPages() called before initialization",151),this.pages}getPageChangelistTask(e){return this.pageviewId!==this.environment.getPageviewId()&&_s.error("PageContext.getPageChangeListTask() called before initialization",243,{pageId:e.getId()}),D.ofNullable(this.pageChangelistTasks[e.getId()])}getAudiences(){return this.pageviewId!==this.environment.getPageviewId()&&_s.error("PageContext.getAudiences() called before initialization",152),this.audiences}determineMatchingPages(){const e=this.customer.getPages().filter((e=>this.override.isPageLive(e).orElse("live"===e.getState()))),t=this.environment.getHostingPageUrl().getRawUrl(),i=e.filter((e=>e.matches(t,Fs.evalBoolean))),s=Wt.filterPages(i);return s.length>0?s:i}schedulePageChangeListTasks(){const e={};return this.override.shouldRunTasks().orElse(!0)&&this.pages.forEach((t=>{const i=t.getChanges().map(((e,i)=>Mn(e,gn(t),i,this.attributeData,this.environment,this.browserStorage,this.extensionManager)));if(i.length>0){const s=new ro(i,(()=>{this.hider.revealPage(t,this.browserStorage,this.attributeData)}),{pageId:t.getId()},this.elementObserver);e[t.getId()]=s,this.taskManager.addTask(s),this.statusModel.setPage(t,"status",s.getStatus()),s.onDone((()=>{this.statusModel.setPage(t,"status",s.getStatus())}))}else this.hider.revealPage(t,this.browserStorage,this.attributeData)})),e}determineMatchingAudiences(){return this.customer.getAudiences().filter((e=>this.override.isAudienceLive(e).orElse("live"===e.getState()))).filter((e=>{let t=!1;try{t=e.getCondition().evaluate(this.conditionEvaluationRuntime)}catch(i){t=!1;const s=new Ee("Audience condition evaluation failed ",i);_s.error(s,205,{audienceId:e.getId()})}return _s.debug(`check audience: ${e.getName()} (${e.getId()}) => ${t}`),t}))}}class Bo{update(){}}class Ho{constructor(e,t,i,s){__publicField(this,"environment"),__publicField(this,"localStorage"),__publicField(this,"customer"),__publicField(this,"override"),__publicField(this,"overrideModule"),__publicField(this,"eventLogStorageKey"),__publicField(this,"expVarModel",{campaigns:{}}),__publicField(this,"pageModel",{}),__publicField(this,"eventModel",{count:0,campaigns:{}}),this.customer=t,this.environment=e,this.localStorage=s,this.override=i,this.eventLogStorageKey=`${Ri}event_log_${t.getId()}`,this.overrideModule=new Bo(this.environment,i,this.customer,this.reinitializeGoalEvents.bind(this)),this.initializeGoalEvents()}reinitializeExperienceVariations(){this.expVarModel={campaigns:{}},this.overrideModule.update({experienceVariations:this.expVarModel})}reinitializeGoalEvents(){this.eventModel={count:0,campaigns:{}},this.writeEventModelToLocalStorage(),this.initializeGoalEvents(),this.overrideModule.update({goalEvents:this.eventModel})}initializeGoalEvents(){this.eventModel=this.readEventModelFromLocalStorage();const e=this.environment.getHostingPageUrl().getRawUrl();this.customer.getEvents().forEach((t=>{let i="custom"===t.getType();(t instanceof Se||t instanceof Ae)&&(i=t.getPages().some((t=>t.matches(e,(()=>!0))))),i&&t.getMetrics().forEach((e=>{e.getCampaign().ifPresent((t=>{this.getCampaignEventData(t).metrics[e.getId()]=this.getMetricEventData(e)}))}))})),this.overrideModule.update({goalEvents:this.eventModel})}setCustomer(e,t){this.expVarModel[e]=t,this.overrideModule.update({experienceVariations:this.expVarModel})}setCampaign(e,t,i){const s=this.getCampaignData(e),n=s[t];s[t]=i,n!==i&&this.overrideModule.update({experienceVariations:this.expVarModel})}setExperience(e,t,i){const s=this.getExperienceData(e),n=s[t];s[t]=i,n!==i&&!0===(null==s?void 0:s.enabled)&&this.overrideModule.update({experienceVariations:this.expVarModel})}setVariation(e,t,i){const s=this.getVariationData(e),n=s[t];s[t]=i,n!==i&&this.overrideModule.update({experienceVariations:this.expVarModel})}setPage(e,t,i){this.getPageData(e)[t]=i,this.overrideModule.update({pagesChanges:this.pageModel})}setExperienceSortedVariations(e,t){this.getExperienceData(e).variationsSorted=t,this.overrideModule.update({experienceVariations:this.expVarModel})}setMetricEventData(e){this.eventModel=this.readEventModelFromLocalStorage(),e.forEach((({metric:e,event:t,status:i,id:s})=>{if(!e.getCampaign().isPresent())return;const n=this.getCampaignEventData(e.getCampaign().get()),r=this.getMetricEventData(e);void 0===r.events[s]?(r.events[s]={name:t.getName(),type:t.getType(),status:i,instanceId:s},this.eventModel.count+=1,n.count+=1,r.count+=1):(r.events[s].status=i,r.events[s].timestamp=i===Tr.SUCCEEDED?(new Date).toISOString():void 0,r.count=Object.keys(r.events).length)})),this.overrideModule.update({goalEvents:this.eventModel}),this.writeEventModelToLocalStorage()}getCampaignData(e){return void 0===this.expVarModel.campaigns[e.getId()]&&(this.expVarModel.campaigns[e.getId()]={campaign:e,experiences:{}}),this.expVarModel.campaigns[e.getId()]}getExperienceData(e){const t=this.getCampaignData(e.getCampaign());return void 0===t.experiences&&(t.experiences={}),void 0===t.experiences[e.getId()]&&(t.experiences[e.getId()]={experience:e,variations:{},variationsSorted:[]}),t.experiences[e.getId()]}getVariationData(e){const t=this.getExperienceData(e.getExperience());return void 0===t.variations&&(t.variations={}),void 0===t.variations[e.getId()]&&(t.variations[e.getId()]={variation:e}),t.variations[e.getId()]}getPageData(e){var t;const i=null!=(t=this.pageModel[e.getId()])?t:{page:e,status:Tr.NOT_STARTED};return this.pageModel[e.getId()]=i,i}getMetricEventData(e){if(!e.getCampaign().isPresent())throw new x("Metric not in campaign");const t=this.getCampaignEventData(e.getCampaign().get());return void 0===t.metrics[e.getId()]&&(t.metrics[e.getId()]=this.getInitialMetricEventData(e)),t.metrics[e.getId()]}getCampaignEventData(e){return void 0===this.eventModel.campaigns[e.getId()]&&(this.eventModel.campaigns[e.getId()]={name:e.getName(),count:0,metrics:{}}),this.eventModel.campaigns[e.getId()]}getMetricMeasurement(e){const t=e.getCountingMethod(),i=e.getScope();let s,n;return e instanceof Kt?(n=`$${(e.getValue()/100).toFixed(2)}`,s=`${t} static value per ${i}`):s=e instanceof qt?`${t} dynamic value per ${i}`:`${t} conversion per ${i}`,{measurement:s,value:n}}getInitialMetricEventData(e){return __spreadValues({name:e.getName(),isGoal:e.isGoal(),events:{},count:0},this.getMetricMeasurement(e))}shouldUseLocalStorage(){let e=!1;return this.override.getExpirationMs().ifPresent((t=>{e=t>Date.now()})),e}deleteEventModelFromLocalStorage(){this.localStorage.delete(this.eventLogStorageKey)}writeEventModelToLocalStorage(){this.shouldUseLocalStorage()&&this.localStorage.write(this.eventLogStorageKey,Hi(this.eventModel))}readEventModelFromLocalStorage(){let e=this.eventModel;return this.shouldUseLocalStorage()?this.localStorage.read(this.eventLogStorageKey).ifPresent((t=>{try{e=Qi(t)}catch(i){}})):this.deleteEventModelFromLocalStorage(),e}}class Qo{reinitializeExperienceVariations(){}reinitializeGoalEvents(){}setCustomer(e,t){}setCampaign(e,t,i){}setExperience(e,t,i){}setVariation(e,t,i){}setPage(e,t,i){}setExperienceSortedVariations(e,t){}setMetricEventData(e){}}class qo{constructor(e,t,i,s){__publicField(this,"storageKey"),__publicField(this,"environment"),__publicField(this,"browserStorage"),__publicField(this,"user"),__publicField(this,"pageviewAttributes",{id:void 0,custom:{},internal:{}}),this.storageKey=xi+e.getId(),this.browserStorage=i,this.environment=t,this.user=s}setCustomAttributes(e,t){const i=this.getAttributeData(e);Object.keys(t).forEach((e=>{i.custom[e]=t[e]})),this.saveAttributeData(e,i)}setInternalAttributes(e,t){const i=this.getAttributeData(e);Object.keys(t).forEach((e=>{i.internal[e]=t[e]})),this.saveAttributeData(e,i)}getCustomAttributes(e,t){const i=this.getAttributeData(e),s={};return Object.keys(i.custom).forEach((e=>{(void 0===t||t.includes(e))&&(s[e]=i.custom[e])})),s}getInternalAttributes(e,t){const i=this.getAttributeData(e),s={};return Object.keys(i.internal).forEach((e=>{(void 0===t||t.includes(e))&&(s[e]="object"==typeof i.internal[e]?Qi(Hi(i.internal[e])):i.internal[e])})),s}getFlattenedCustomAttributes(){const e=this.getCustomAttributes("user"),t=this.getCustomAttributes("pageview");return Object.keys(t).forEach((i=>{e[i]=t[i]})),e}getFlattenedInternalAttributes(){const e=this.getInternalAttributes("user"),t=this.getInternalAttributes("pageview");return Object.keys(t).forEach((i=>{e[i]=t[i]})),e}deleteCustomAttributes(e,t){const i=this.getAttributeData(e);for(const s in i.custom)Object.prototype.hasOwnProperty.call(i.custom,s)&&(void 0===t||t.includes(s))&&delete i.custom[s];this.saveAttributeData(e,i)}deleteInternalAttributes(e,t){const i=this.getAttributeData(e);void 0===t?i.internal={}:t.forEach((e=>{delete i.internal[e]})),this.saveAttributeData(e,i)}getAttributeData(e){let t,i={id:void 0,custom:{},internal:{}};return"pageview"===e?(i=this.pageviewAttributes,t=this.environment.getPageviewId()):"user"===e?(i=this.readBrowserStorage(),t=this.user.getId()):_s.error(`Tried to get attribute data for invalid scope ${e}`,49),t!==i.id&&(_s.debug(`Mismatching IDs ("${t}" != "${i.id}"). Resetting AttributeData`),i.id=t,i.internal={},i.custom={}),i}saveAttributeData(e,t){"pageview"===e||("user"===e?this.saveBrowserStorage(t):_s.error(`Tried to save attribute data for invalid scope ${e}`,50))}readBrowserStorage(){let e={id:void 0,custom:{},internal:{}};return this.browserStorage.read(this.storageKey).ifPresent((t=>{try{e=Qi(t)}catch(i){const e=new Ee("Could not parse attribute storage",i);_s.error(e,51)}})),e}saveBrowserStorage(e){const t=Hi(e);this.browserStorage.write(this.storageKey,t)}}class Ko{constructor(e,t,i,s){__publicField(this,"storageKey"),__publicField(this,"browserStorage"),__publicField(this,"environment"),__publicField(this,"override"),this.storageKey=ki+e.getId(),this.browserStorage=i,this.environment=t,this.override=s}static get VERSION(){return 2}static getPath(e,t){if(0===t.length)return e;const i=t[0];return i in e||(e[i]={}),t.splice(0,1),Ko.getPath(e[i],t)}getCustomerControlStatus(e){if(!e.isCampaignControl()){const e=this.readState();if(!0===e.c)return D.of("c");if(!1===e.c)return D.of("i");this.override.saveCustomerStorage().orElse(!0)&&_s.warn("Attempting to retrieve control value, but not set",52)}return D.empty()}updateAndGetControl(e){_s.debug("updateAndGetControl(campaign)");const t=e.getCustomer();return t.isCampaignControl()?this.setAndGetCampaignControl(e):this.setAndGetCustomerControl(t)}setAndGetCustomerControl(e){w(!e.isCampaignControl());const t=this.readState(),i=t,s=e.getControlTrafficPercentage().get();return void 0!==t.cpg&&Object.keys(t.cpg).forEach((e=>{void 0!==t.cpg&&(delete t.cpg[e].c,delete t.cpg[e].ct)})),this.setAndGetControl(e,i,t,s)}updateAndGetExperienceInclusion(e){const t=this.environment.getInitializeUnixTime(),i=this.readState(),s=e.getId(),n=e.getCampaign().getId(),r=Ko.getPath(i,["cpg",n,"exp",s]);if(e.getInclusionStickyConfig().isSticky()&&void 0!==r.i&&void 0!==r.it){const i=r.it;if(!e.getInclusionStickyConfig().isExpired(t,i)){const t=r.i;return _s.info(`Experience ${e.getId()} sticky inclusion decision => ${t}`),t}}const o=Math.random()<1-e.getIgnore()/1e4;return r.i=o,r.it=t,this.writeState(i),_s.info(`Experience ${e.getId()} new inclusion decision => ${o}`),o}getStickyVariation(e){_s.group("getStickyVariation(experience:"+e.getId()+")");const t=this.environment.getInitializeUnixTime(),i=this.readState(),s=e.getId(),n=e.getCampaign().getId(),r=Ko.getPath(i,["cpg",n,"exp",s]);if(e.getVariationStickyConfig().isSticky()&&void 0!==r.v&&void 0!==r.vt){const i=r.vt;if(!e.getVariationStickyConfig().isExpired(t,i))return _s.debug("found sticky, non-expired variation: "+r.v),_s.groupEnd(),e.getVariation(r.v)}return _s.groupEnd(),D.empty()}getVariation(e){_s.group("getVariation(experience:"+e.getId()+")");const t=this.readState(),i=e.getId(),s=e.getCampaign().getId(),n=Ko.getPath(t,["cpg",s,"exp",i]);return void 0!==n.v?(_s.groupEnd(),e.getVariation(n.v)):(_s.groupEnd(),D.empty())}saveVariationStickySelection(e,t){const i=e.getExperience().getId(),s=e.getExperience().getCampaign().getId(),n=this.readState(),r=Ko.getPath(n,["s"]),o=Ko.getPath(n,["cpg",s,"exp",i]);e.getId()!==o.v&&_s.error(`Updating variation page view id in local storage, but variation changed from ${o.v} to ${e.getId()}`,53,{campaignId:s,experienceId:i,variationId:e.getId()}),o.v=e.getId(),o.gpvid=t,o.gsid=r.id,this.writeState(n)}saveVariationPredictionSelection(e,t,i){const s=e.getExperience().getId(),n=e.getExperience().getCampaign().getId(),r=this.readState(),o=Ko.getPath(r,["s"]),a=Ko.getPath(r,["cpg",n,"exp",s]);a.v=e.getId(),a.vt=this.environment.getNowUnixTime(),a.mv=t,a.gpvid=i,a.gsid=o.id,this.writeState(r)}deleteExperiencePredictionSelection(e){const t=e.getId(),i=e.getCampaign().getId(),s=this.readState(),n=Ko.getPath(s,["cpg",i,"exp",t]);0!==Object.keys(n).length&&(delete n.v,delete n.vt,delete n.mv,delete n.gpvid,delete n.gsid,this.writeState(s))}updateAndGetIsCampaignFirstTimeView(e,t){return this.updateAndGetIsFirstTime([e.getId(),"v"],t)}updateAndGetIsCampaignFirstTimeGoal(e,t,i){return this.updateAndGetIsFirstTime([e.getId(),t.getId(),"g"],i)}updateAndGetIsVariationFirstTimeView(e,t){return this.updateAndGetIsFirstTime([e.getExperience().getCampaign().getId(),e.getExperience().getId(),e.getId(),"v"],t)}updateAndGetIsVariationFirstTimeGoal(e,t,i){return this.updateAndGetIsFirstTime([e.getExperience().getCampaign().getId(),t.getId(),e.getExperience().getId(),e.getId(),"g"],i)}getVariationPredictionModelVersion(e){const t=this.readState(),i=Ko.getPath(t,["cpg",e.getExperience().getCampaign().getId(),"exp",e.getExperience().getId()]);return D.ofNullable(i.mv)}getVariationPredictionPageviewId(e){const t=this.readState(),i=Ko.getPath(t,["cpg",e.getExperience().getCampaign().getId(),"exp",e.getExperience().getId()]);return D.ofNullable(i.gpvid)}getVariationPredictionSessionId(e){const t=this.readState(),i=Ko.getPath(t,["cpg",e.getExperience().getCampaign().getId(),"exp",e.getExperience().getId()]);return D.ofNullable(i.gsid)}getPageviewSelections(e){const t=[],i=this.readState();return void 0!==i.cpg&&Object.keys(i.cpg).forEach((s=>{if(void 0!==i.cpg){const n=i.cpg[s];"exp"in n&&Object.keys(n.exp).forEach((i=>{const r=n.exp[i];void 0!==r.v&&"gpvid"in r&&r.gpvid===e&&t.push({campaignId:s,experienceId:i,variationId:r.v})}))}})),t}getSessionId(){const e=this.readState(),t=Ko.getPath(e,["s"]);return D.ofNullable(t.id)}updateAndGetSessionId(){const e=this.environment.getNowUnixTime(),t=this.readState(),i=Ko.getPath(t,["s"]);return void 0===i.st&&(i.st=e),(void 0===i.id||void 0===i.t||e-i.t>fi||e-i.st>Ei)&&(_s.debug("Starting a new session"),i.id=this.generateSessionId(),i.st=e),_s.debug("Extending current session"),i.t=e,this.writeState(t),i.id}getUserVisitStatus(e){return this.isFirstSession(e)?"N":"R"}isFirstSession(e){const t=e.getFirstVisitTimeSec();this.updateAndGetSessionId();const i=this.readState(),s=Ko.getPath(i,["s"]).st;return _s.info(`user.getId(): ${e.getId()}`),_s.info(`userCreationTimeSec: ${t}`),_s.info(`currentSessionStartTimeSec: ${s}`),Math.abs(t-s)<fi/2}setAndGetCampaignControl(e){const t=e.getCustomer();w(t.isCampaignControl());const i=this.readState(),s=Ko.getPath(i,["cpg",e.getId()]),n=e.getControlTrafficPercentage().get();return delete i.c,delete i.ct,this.setAndGetControl(t,s,i,n)}setAndGetControl(e,t,i,s){const n=this.environment.getInitializeUnixTime();if(e.getControlStickyConfig().isSticky()||_s.error("Control is not sticky, but should be",54),e.getControlStickyConfig().isSticky()&&void 0!==t.c&&void 0!==t.ct){const i=t.ct;if(!e.getControlStickyConfig().isExpired(n,i))return _s.debug("control: "+t.c+" (sticky decision)"),t.c;_s.error(`Control sticky decision expired. now:${n}, last:${i}`,55)}void 0!==t.c&&_s.error(`Making new control decision, but c is present: ${t.c}`,56),void 0!==t.ct&&_s.error(`Making new control decision, but ct is present: ${t.ct}`,57);const r=Math.random()<s;return t.c=r,t.ct=n,this.writeState(i),_s.debug("control: "+t.c),r}generateSessionId(){return this.environment.getNowUnixTime()+"-"+fn()}updateAndGetIsFirstTime(e,t){let i=!1;const s=this.readState(),n=Ko.getPath(s,["uu"]),r=e.join(":");return r in n?n[r]===t&&(i=!0):(n[r]=t,this.writeState(s),i=!0),i}readState(){let e={};return this.browserStorage.read(this.storageKey).ifPresent((t=>{try{e=Qi(t)}catch(i){const e=new Ee("Could not parse customer storage",i);_s.error(e,58)}})),T(!Object.prototype.hasOwnProperty.call(e,"vr")||e.vr===Ko.VERSION),e}writeState(e){e.vr=Ko.VERSION;const t=Hi(e);this.override.saveCustomerStorage().orElse(!0)&&this.browserStorage.write(this.storageKey,t)}}class Yo{constructor(e,t){__publicField(this,"customer"),__publicField(this,"storageKey"),__publicField(this,"browserStorage"),this.customer=e,this.storageKey=`${Ai}${e.getId()}`,this.browserStorage=t,this.initialize()}setDataAndMetadata(e,t,i){const s=this.getAllDataAndMetadata();s.data[e]=t,s.meta[e]=i,this.setAll(s)}getData(e){const t=this.getAllData()[e];return void 0===t||0===Object.keys(t).length?D.empty():D.ofNullable(t)}getAllData(){return this.getAllDataAndMetadata().data}getMetadata(e){const t=this.getAllMetdata()[e];return void 0===t||0===Object.keys(t).length?D.empty():D.ofNullable(t)}getAllMetdata(){return this.getAllDataAndMetadata().meta}setAllDataAndMetadata(e,t){const i={data:e,meta:t};this.setAll(i)}deleteAll(){this.browserStorage.delete(this.storageKey)}getAllDataAndMetadata(){const e=this.browserStorage.read(this.storageKey);let t=this.emptyStorage();if(e.ifPresent((e=>{try{t=Qi(e)}catch(i){const e=new Ee("Could not parse integration data storage",i);_s.error(e,59),this.deleteAll()}})),null==t||0===Object.keys(t).length)t=this.emptyStorage();else{const e=t;Us(e)&&void 0===e.__marketoLead||(t=this.emptyStorage())}return void 0===t.meta&&(t.meta={}),br(t.data.marketo)&&(t.data.marketo={}),t}setAll(e){const t=this.emptyStorage();or.forEach((i=>{Cr[i](this.customer)&&(t.data[i]=e.data[i],t.meta[i]=e.meta[i])})),this.browserStorage.write(this.storageKey,Hi(t))}emptyStorage(){return{data:{},meta:{}}}initialize(){const e=this.getAllDataAndMetadata();or.forEach((t=>{Cr[t](this.customer)||(delete e.data[t],delete e.meta[t])})),this.setAll(e)}}class Jo{constructor(e){if(__publicField(this,"environment"),!eo(e,"localStorage"))throw new Error("LocalStorage is not available");this.environment=e}write(e,t){Xr(e)||_s.error(`Writing an unknown key to LocalStorage: ${e}`,180),this.environment.writeLocalStorage(e,t)}read(e){return this.environment.readLocalStorage(e)}delete(e){this.environment.deleteLocalStorage(e)}}class Xo{constructor(e,t){__publicField(this,"storageKey"),__publicField(this,"browserStorage"),this.storageKey=Di+e.getId(),this.browserStorage=t}static fromJson(e){try{const t=Qi(e);return D.of(t)}catch(t){const e=new Ee("Could not build server context from localStorage",t);_s.error(e,157)}return D.empty()}set(e){this.browserStorage.write(this.storageKey,Hi(e))}get(){return this.browserStorage.read(this.storageKey).flatMap((e=>Xo.fromJson(e)))}clear(){this.browserStorage.delete(this.storageKey)}}var Zo={},ea={get exports(){return Zo},set exports(e){Zo=e}},ta={};!function(e){function t(e,t){var i,s,n,r,o,a,l,c;for(i=3&e.length,s=e.length-i,n=t,o=3432918353,a=461845907,c=0;c<s;)l=255&e.charCodeAt(c)|(255&e.charCodeAt(++c))<<8|(255&e.charCodeAt(++c))<<16|(255&e.charCodeAt(++c))<<24,++c,n=27492+(65535&(r=5*(65535&(n=(n^=l=(65535&(l=(l=(65535&l)*o+(((l>>>16)*o&65535)<<16)&4294967295)<<15|l>>>17))*a+(((l>>>16)*a&65535)<<16)&4294967295)<<13|n>>>19))+((5*(n>>>16)&65535)<<16)&4294967295))+((58964+(r>>>16)&65535)<<16);switch(l=0,i){case 3:l^=(255&e.charCodeAt(c+2))<<16;case 2:l^=(255&e.charCodeAt(c+1))<<8;case 1:n^=l=(65535&(l=(l=(65535&(l^=255&e.charCodeAt(c)))*o+(((l>>>16)*o&65535)<<16)&4294967295)<<15|l>>>17))*a+(((l>>>16)*a&65535)<<16)&4294967295}return n^=e.length,n=2246822507*(65535&(n^=n>>>16))+((2246822507*(n>>>16)&65535)<<16)&4294967295,n=3266489909*(65535&(n^=n>>>13))+((3266489909*(n>>>16)&65535)<<16)&4294967295,(n^=n>>>16)>>>0}e.exports=t}({get exports(){return ta},set exports(e){ta=e}});var ia={};!function(e){function t(e,t){for(var i,s=e.length,n=t^s,r=0;s>=4;)i=1540483477*(65535&(i=255&e.charCodeAt(r)|(255&e.charCodeAt(++r))<<8|(255&e.charCodeAt(++r))<<16|(255&e.charCodeAt(++r))<<24))+((1540483477*(i>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(i=1540483477*(65535&(i^=i>>>24))+((1540483477*(i>>>16)&65535)<<16)),s-=4,++r;switch(s){case 3:n^=(255&e.charCodeAt(r+2))<<16;case 2:n^=(255&e.charCodeAt(r+1))<<8;case 1:n=1540483477*(65535&(n^=255&e.charCodeAt(r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}e.exports=t}({get exports(){return ia},set exports(e){ia=e}});var sa=ta,na=ia;ea.exports=sa;var ra=Zo.murmur3=sa;function oa(e,t){return ra(e,t)}Zo.murmur2=na;const aa=__pow(2,32);function la(e,t){const i=(e>>>0)/aa;return Math.floor(i*t)}class ca{constructor(e,t,i){let s;__publicField(this,"browserStorage"),__publicField(this,"environment"),__publicField(this,"id"),__publicField(this,"storageKey"),this.browserStorage=e,this.environment=t,this.storageKey=`${Mi}${i.getId()}`,this.browserStorage.read(this.storageKey).ifPresent((e=>{s=e,_s.debug(`User: Found existing User ID: ${s}`)})),void 0===s&&(s=this.generateId(),_s.debug(`User: No existing User ID; generated new ID: ${s}`),this.browserStorage.write(this.storageKey,s)),this.id=s}getId(){if(void 0===this.id)throw new C("user id not defined");const e=this.browserStorage.read(this.storageKey);return e.isPresent()?e.get()!==this.id&&_s.error(`User id in memory (${this.id}) not the same as user id in localStorage (${e.get()})`,62):_s.error("User id is missing from localStorage",61),this.id}isNewVisitor(){const e=this.getFirstVisitTimeSec();return this.environment.getNowUnixTime()-e<_i}isReturningVisitor(){return!this.isNewVisitor()}getFirstVisitTimeSec(){const e=this.getId().split(".",2);return Number(e[1])}getUserBucket(){const e=100,t=la(oa(this.getId(),1),e);return Math.floor(t+1)}generateId(){const e=this.environment.getNowUnixTime();return`${En()}.${e}`}}class ua{constructor(e,t){__publicField(this,"client"),__publicField(this,"environment"),__publicField(this,"taskQueue",[]),__publicField(this,"completedTasks",[]),__publicField(this,"isRunning",!1),__publicField(this,"isStopping",!1),__publicField(this,"timeoutId"),__publicField(this,"queueChecksum"),__publicField(this,"doneCallbacks",[]),__publicField(this,"latestQueueChecksum"),__publicField(this,"latestQueueTimeMs"),this.client=e,this.environment=t}onDone(e){this.doneCallbacks.push(e)}isDone(){return 0===this.taskQueue.length}hasStarted(){return this.taskQueue.length>0||this.completedTasks.length>0}getClient(){return this.client}addTask(e){_s.debug("TaskManager.addTask("+e.toString()+")"),this.isStopping?_s.warn(`Rejecting addTask(${e.toString()}) request since TaskManager is stopping`,35,e.getEntityIds()):(e.setManager(this),this.handleNotDone(e),this.queueChecksum=void 0,this.runAfter(0))}runNow(){_s.debug("TaskManager run now - synchronously"),this.eventLoop()}findTasks(e){return[...this.taskQueue,...this.completedTasks].filter((t=>e(t)))}stop(){_s.debug("TaskManager.stop()"),this.isStopping=!0,this.runAfter(0)}eventLoop(){if(_s.group("TaskManager.eventLoop()"),_s.time("TaskManager.eventLoop()"),this.isRunning)return _s.debug("TaskManager called again when already running. Back to work..."),void _s.groupEnd();if(this.isRunning=!0,this.clearTimeout(),this.taskQueue.length>0&&void 0!==this.latestQueueChecksum&&void 0!==this.latestQueueTimeMs&&this.environment.getNowUnixTimeMs()-this.latestQueueTimeMs>NO_PROGRESS_TOLERANCE_TIME_MS&&!this.isQueueBlocked()){const e=this.extractVictim();void 0===e?_s.error("Unable to extract latest task when trying to make progress",37):(_s.error(`Unable to make progress. Canceling task ${e.toString()}. Queue: ${this.queueToString()}`,36,e.getEntityIds()),this.cancelTask(e))}if(this.isStopping?this.stopTasks():this.runTasks(),this.taskQueue.length>0){const e=this.computeChecksum();e!==this.latestQueueChecksum&&(this.latestQueueChecksum=e,this.latestQueueTimeMs=this.environment.getNowUnixTimeMs())}else this.latestQueueChecksum=void 0,this.latestQueueTimeMs=void 0;if(this.taskQueue.length>0)this.isQueueBlocked()?(_s.debug("TaskManager queue is blocked on WAITING tasks. Sleeping."),this.clearTimeout(),this.latestQueueChecksum=void 0,this.latestQueueTimeMs=void 0):(_s.debug("TaskManager schedule callback for later"),this.runAfter(bi));else if(this.isStopping)_s.debug("TaskManager schedule callback for now"),this.runAfter(0);else{for(_s.group("TaskManager done"),this.clearTimeout(),this.latestQueueChecksum=void 0,this.latestQueueTimeMs=void 0;this.doneCallbacks.length>0;){const e=this.doneCallbacks.shift();void 0!==e&&(_s.group("executing done callback"),Fs.executeFunction(e,155),_s.groupEnd())}_s.groupEnd()}this.isRunning=!1,_s.timeEnd("TaskManager.eventLoop()"),_s.groupEnd()}extractVictim(){let e;for(let t=0;t<this.taskQueue.length;t++)this.taskQueue[t].isBlocked()||(void 0===e||this.taskQueue[t].getId()>this.taskQueue[e].getId())&&(e=t);if(void 0!==e)return this.taskQueue.splice(e,1)[0]}stopTasks(){_s.group("TaskManager.stopTasks()");for(const e of this.completedTasks)e.cleanup();for(;this.taskQueue.length>0;){const e=this.taskQueue.shift();void 0!==e&&(_s.error(`Stopping and had to cancel task ${e.toString()}`,38,e.getEntityIds()),this.cancelTask(e))}for(;this.completedTasks.length>0;)this.completedTasks.shift();_s.debug("Cleanup of all Tasks complete. taskQueue and completedTasks are now empty"),_s.groupEnd(),this.isStopping=!1}cancelTask(e){void 0!==e&&(_s.debug("Canceling task "+e.toString()),e.cancel(),this.handleDone(e))}handleNotDone(e){this.taskQueue.push(e)}handleDone(e){this.completedTasks.push(e),this.queueChecksum=void 0}runTasks(){_s.group("TaskManager.runTasks()"),this.queueChecksum=this.computeChecksum();let e=!0;for(;0!==this.taskQueue.length;){const t=this.getUnloadingTasks();if(!e&&0===t.length)break;_s.debug(`task queue: ${this.queueToString()}`);const i=this.taskQueue.shift();if(void 0===i)continue;let s=!1,n=!1;t.length>0&&(i.isUnloading()&&e?s=!0:0===i.getNotDoneDependencies().length&&(n=!0));const r=this.computeChecksum();let o;s?(_s.debug(`Skipping unloading task ${i.toString()}. TM in unloading state and still making progress`),o=Tr.TRY_LATER):i.getStatus()===Tr.WAITING?(_s.debug(`Skipping waiting task ${i.toString()}`),o=Tr.WAITING):(_s.debug(`TaskManager running ${i.toString()}`),_s.time(`Task running ${i.toString()}`),o=i.runWrapper(),_s.timeEnd(`Task running ${i.toString()}`),_s.debug("TaskManager "+i.toString()+" returned "+Tr[o]));const a=this.computeChecksum();if(n&&r!==a&&(n=!1),n&&!i.isDone())i.inTransaction()&&_s.warn(`Unloading ${t[0].toString()} and transaction task is not done. Canceling ${i.toString()}`,39,i.getEntityIds()),this.cancelTask(i);else switch(o){case Tr.TRY_LATER:this.handleNotDone(i);break;case Tr.FAILED:case Tr.SUCCEEDED:this.handleDone(i);break;case Tr.CANCELED:this.handleDone(i),_s.debug("Task self-canceled "+i.toString());break;case Tr.WAITING:this.handleNotDone(i);break;default:this.handleDone(i),_s.error(`Invalid task status ${o} for ${i.toString()}`,40,i.getEntityIds())}const l=this.computeChecksum();if(l!==this.queueChecksum){if(this.isStopping)break;void 0===this.queueChecksum&&(this.queueChecksum=l)}else e=!1}_s.debug("No more work to do now."),_s.groupEnd()}getUnloadingTasks(){return this.taskQueue.filter((e=>e.isUnloading()))}clearTimeout(){void 0!==this.timeoutId&&(_s.debug("TaskManager clearing timeoutId: "+this.timeoutId),this.environment.getWindow().clearTimeout(this.timeoutId),this.timeoutId=void 0)}runAfter(e){_s.debug("TaskManager runAfter("+e+"ms)"),this.clearTimeout(),this.timeoutId=this.environment.getWindow().setTimeout((()=>{try{_s.debug("TaskManager callback triggered"),this.eventLoop()}catch(e){const t=new Ee("TaskManager exception",e);_s.error(t,41)}}),e),_s.debug("TaskManager set new timer: "+this.timeoutId)}computeChecksum(){return this.taskQueue.map((e=>e.getId().toString())).join("-")}queueToString(){return this.taskQueue.map((e=>e.toString())).join(", ")}isQueueBlocked(){return this.taskQueue.every((e=>e.isBlocked()))}}class da extends kr{constructor(e,t,i){super(),__publicField(this,"environment"),__publicField(this,"browserEventLogger"),__publicField(this,"integrationDataStorage"),__publicField(this,"sent",!1),__publicField(this,"deliveryStatus",Tr.NOT_STARTED),this.environment=S(e),this.browserEventLogger=S(t),this.integrationDataStorage=S(i)}toString(){return`ContextEventTask(${this.environment.getPageviewId()})`}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.deliveryStatus===Tr.SUCCEEDED?Tr.SUCCEEDED:this.deliveryStatus===Tr.FAILED?Tr.FAILED:(_s.debug("Waiting for context event delivery confirmation"),Tr.TRY_LATER)}sendOnce(){this.sent||(_s.info("Sending context event"),this.browserEventLogger.sendContext(this.integrationDataStorage).then((()=>{_s.info(`Context ${this.environment.getPageviewId()} event delivery success`),this.deliveryStatus=Tr.SUCCEEDED})).catch((e=>{const t=new Ee(`Context ${this.environment.getPageviewId()} event delivery failed`,e);_s.warn(t,224),this.deliveryStatus=Tr.FAILED})),this.sent=!0)}}function ha(e,t){return t.filter((t=>pa(e,t)))}function ga(e,t){return t.some((t=>pa(e,t)))}function pa(e,t){return e.getPages().some((e=>e.getId()===t.getId()))}class ma{constructor({environment:e,browserEventLogger:t,customer:i,customerStorage:s,attributeStorage:n,activityStorage:r,user:o,override:a,pageContext:l,statusModel:c,taskManager:u}){__publicField(this,"override"),__publicField(this,"pageContext"),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"taskManager"),__publicField(this,"browserEventLogger"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"user"),__publicField(this,"statusModel"),this.environment=S(e),this.browserEventLogger=S(t),this.customer=S(i),this.customerStorage=S(s),this.attributeStorage=S(n),this.activityStorage=S(r),this.user=S(o),this.override=S(a),this.pageContext=S(l),this.statusModel=S(c),this.taskManager=S(u)}cleanup(){}sendConversionEvent(e,t,i){_s.group(`sendConversionEvent(${e.getName()}, ${t})`);const s=new sr(e,t,void 0,i);this.activityStorage.add(io.buildConversionActivity(s,this.customer,this.environment,this.user,this.attributeStorage,this.customerStorage));const n=new Dr(s,this.browserEventLogger,this.customer,this.customerStorage,this.statusModel);this.taskManager.addTask(n),_s.groupEnd()}}class va extends ma{constructor(){super(...arguments),__publicField(this,"registeredClickEvents",[])}cleanup(){_s.group("InstrumentClickEvent.cleanup()"),this.registeredClickEvents.forEach((([e,t])=>{_s.debug('removing handler: events="'+this.getEventName()+'", selector="'+e.getSelector()+'"');try{this.environment.getWindow().document.removeEventListener("click",t,!0)}catch(i){const t=new Ee("Failed to unregister click event",i);_s.error(t,194,{eventId:e.getId()})}})),_s.groupEnd()}instrumentClickEvent(e){_s.group("instrumentClickEvent("+e.getName()+")"),_s.info(`Instrument click event ${e.getId()}, selector ${e.getSelector()}`),_s.debug('adding handler: events="'+this.getEventName()+'", selector="'+e.getSelector()+'"');const t=t=>{try{if(t.target instanceof HTMLElement&&t.target.closest(e.getSelector())instanceof Element){const i=this.environment.generateActionId();this.handleClickEvent(e,i,t)}}catch(i){const t=new Ee("Failed to handle click event",i);_s.error(t,167,{eventId:e.getId()})}};try{this.environment.getWindow().document.addEventListener("click",t,!0)}catch(i){const t=new Ee("Failed to register click event",i);_s.error(t,193,{eventId:e.getId()})}this.registeredClickEvents.push([e,t]),_s.groupEnd()}getEventName(){return"click."+this.environment.getPageviewId()}}class ba extends va{initialize(e){_s.group("InstrumentStandardClickEvents.initialize()"),Se.filterEvents(e).filter((e=>ga(this.pageContext,e.getPages()))).forEach((e=>{this.instrumentClickEvent(e)})),_s.groupEnd()}handleClickEvent(e,t,i){_s.group(`handleClickEvent(${e.getName()}, ${t})`),_s.debug("handleClickEvent run code");e.executeCode(Fs.evalBoolean)?(this.sendConversionEvent(e,t,i),_s.groupEnd(),this.taskManager.runNow()):_s.groupEnd()}}class fa extends ma{initialize(e){_s.group("InstrumentViewEvents.initialize()");const t=this.environment.getPageviewId();Ae.filterEvents(e).filter((e=>ga(this.pageContext,e.getPages()))).forEach((e=>{this.handleViewEvent(e,t)}))}handleViewEvent(e,t){_s.group(`handleViewEvent(${e.getName()}, ${t})`),_s.debug("handleViewEvent run code");e.executeCode(Fs.evalBoolean)?(this.sendConversionEvent(e,t),_s.groupEnd()):_s.groupEnd()}}class Ea extends va{initialize(e){_s.group("InstrumentWebflowClickEngagementEvents.initialize()");const t=ke.filterEvents(e);if(t.length>0){const e=t[0];t.length>1&&_s.error(`Expected exactly one WebflowClickEngagementEvent, but found ${t.length}`,256),this.instrumentClickEvent(e)}_s.groupEnd()}handleClickEvent(e,t,i){_s.group(`handleClickEvent(${e.getName()}, ${t})`),this.sendConversionEvent(e,t,i),_s.groupEnd(),this.taskManager.runNow()}}class _a extends kr{constructor(e,t,i,s,n,r,o,a,l,c){super(),__publicField(this,"environment"),__publicField(this,"browserEventLogger"),__publicField(this,"customer"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"pageContext"),__publicField(this,"instrumentations",[]),__publicField(this,"statusModel"),this.environment=S(e),this.browserEventLogger=S(t),this.customer=S(i),this.customerStorage=S(s),this.attributeStorage=S(n),this.activityStorage=S(r),this.user=S(o),this.override=S(a),this.pageContext=S(l),this.statusModel=S(c)}toString(){return"ConversionEventInstrumentationTask()"}inTransaction(){return!0}isUnloading(){return!1}cleanup(){this.instrumentations.forEach((e=>{e.cleanup()}))}run(){return this.instrumentEvents(),Tr.SUCCEEDED}instrumentEvents(){_s.group("instrumentEvents()");const e=this.customer.getEvents().filter((e=>this.override.isEventLive(e).orElse("live"===e.getState()))),t={environment:this.environment,browserEventLogger:this.browserEventLogger,customer:this.customer,customerStorage:this.customerStorage,attributeStorage:this.attributeStorage,activityStorage:this.activityStorage,user:this.user,override:this.override,pageContext:this.pageContext,statusModel:this.statusModel,taskManager:this.manager},i=new ba(t);i.initialize(e),this.instrumentations.push(i);const s=new fa(t);s.initialize(e),this.instrumentations.push(s);const n=new Ea(t);n.initialize(e),this.instrumentations.push(n),_s.groupEnd()}}const ya=class extends kr{constructor(e,t,i,s){super(),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"endpoint"),__publicField(this,"getCookie"),__publicField(this,"startTimeMs"),__publicField(this,"sent",!1),__publicField(this,"deliveryStatus",Tr.NOT_STARTED),this.environment=e,this.customer=t,this.endpoint=i,this.getCookie=s,this.startTimeMs=this.environment.getNowUnixTimeMs()}toString(){return`CookieAssociatorTask(${this.endpoint})`}inTransaction(){return!0}isUnloading(){return!1}run(){if(this.sendOnce(),this.deliveryStatus===Tr.SUCCEEDED)return Tr.SUCCEEDED;if(this.deliveryStatus===Tr.FAILED)return Tr.FAILED;return this.environment.getNowUnixTimeMs()-this.startTimeMs>=ya.WAIT_FOR_COOKIE_MS?(_s.warn(`Cookie not present on the page within ${ya.WAIT_FOR_COOKIE_MS}ms (${this.endpoint} )`,81),Tr.SUCCEEDED):Tr.TRY_LATER}sendOnce(){if(this.sent)return;const e=this.getCookie();if(!e.isPresent())return;const t=e.get(),i=this.customer.getId();_s.info(`Sending id association request. Customer: ${i}`),this.environment.fetch(Ci,this.endpoint,{method:"POST",headers:{"Content-Type":"text/plain;charset=UTF-8"},body:Hi({customerId:this.customer.getId(),cookie:t})}).then((()=>{_s.info("Successfully sent id association request"),this.deliveryStatus=Tr.SUCCEEDED})).catch((e=>{const t=new Ee(`Error calling ${this.endpoint} `,e);_s.error(t,82),this.deliveryStatus=Tr.FAILED})),this.sent=!0}};let Sa=ya;__publicField(Sa,"WAIT_FOR_COOKIE_MS",5e3);class Ia extends kr{constructor(e){super(),__publicField(this,"elementObserver"),this.elementObserver=e}toString(){return"ElementObserverTask()"}inTransaction(){return!1}isUnloading(){return!1}cleanup(){_s.group("ElementObserverTask.cleanup()"),this.elementObserver.reset(),_s.groupEnd()}run(){return _s.debug("ElementObserverTask no-op done"),Tr.SUCCEEDED}}class wa extends kr{constructor(e,t,i,s,n,r,o,a,l){if(super(),__publicField(this,"environment"),__publicField(this,"browserEventLogger"),__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"activityStorage"),__publicField(this,"attributeStorage"),__publicField(this,"customerStorage"),__publicField(this,"statusModel"),!hr(i))throw new Error("Hubspot integration must be enabled for the customer to use the HubspotFormsTask");this.environment=S(e),this.browserEventLogger=S(t),this.customer=S(i),this.user=S(s),this.override=S(n),this.activityStorage=S(r),this.attributeStorage=S(o),this.customerStorage=S(a),this.statusModel=S(l)}toString(){return"HubspotFormsTask()"}inTransaction(){return!1}isUnloading(){return!1}run(){return this.attachFormHandler(),Tr.SUCCEEDED}attachFormHandler(){window.addEventListener("message",(e=>{if(pr(e)){const t=e.data.id;_s.debug(`handler fired for hubspot form; triggering lead association request (Form ID: ${t})`);const i=this.environment.generateActionId();this.findEvents(t).forEach((e=>{this.sendConversionEvent(e,i)}));const s=new Sa(this.environment,this.customer,"/hubspot-id-associator",(()=>gr(this.environment)));this.manager.addTask(s)}}))}findEvents(e){return we.filterEvents(this.customer.getEvents()).filter((e=>this.override.isEventLive(e).orElse("live"===e.getState()))).filter((t=>t.getFormId()===e))}sendConversionEvent(e,t){_s.debug("Hubspot form submission send conversion event");const i=new sr(e,t,void 0,void 0);this.activityStorage.add(io.buildConversionActivity(i,this.customer,this.environment,this.user,this.attributeStorage,this.customerStorage));const s=new Dr(i,this.browserEventLogger,this.customer,this.customerStorage,this.statusModel);this.manager.addTask(s)}}const Ca=class extends kr{constructor(e,t,i,s,n,r,o,a,l){if(super(),__publicField(this,"environment"),__publicField(this,"browserEventLogger"),__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"activityStorage"),__publicField(this,"attributeStorage"),__publicField(this,"customerStorage"),__publicField(this,"statusModel"),__publicField(this,"startTimeMs"),__publicField(this,"trackedForms",[]),!mr(i))throw new Error("Marketo integration must be enabled for the customer to use the MarketoFormsTask");this.environment=S(e),this.browserEventLogger=S(t),this.customer=S(i),this.user=S(s),this.override=S(n),this.activityStorage=S(r),this.attributeStorage=S(o),this.customerStorage=S(a),this.statusModel=S(l),this.startTimeMs=this.environment.getNowUnixTimeMs()}toString(){return"MarketoFormsTask()"}inTransaction(){return!1}isUnloading(){return!1}run(){const e=this.environment.getNowUnixTimeMs(),t=this.environment.getWindow();if(void 0!==t.MktoForms2)return _s.debug("marketo forms library ready"),this.attachFormHandlers(t.MktoForms2),Tr.SUCCEEDED;return e-this.startTimeMs>=Ca.WAIT_FOR_MKTOFORMS2_MS?(_s.debug(`marketo forms library not present on the page within ${Ca.WAIT_FOR_MKTOFORMS2_MS}ms`),Tr.SUCCEEDED):(_s.debug("marketo forms library not present; Will try again later."),Tr.TRY_LATER)}attachFormHandlers(e){e.whenReady((e=>{const t=String(e.getId());this.trackedForms.includes(t)?_s.debug(`marketo form already tracked (Form ID: ${t})`):(this.trackedForms.push(t),_s.debug(`attaching success handler to marketo (Form ID: ${t})`),e.onSuccess((()=>{_s.debug(`success handler fired for marketo form; triggering lead association request (Form ID: ${t})`);const e=this.environment.generateActionId();this.findEvents(t).forEach((t=>{this.sendConversionEvent(t,e)}));const i=new Sa(this.environment,this.customer,"/marketo-id-associator",(()=>vr(this.environment)));this.manager.addTask(i)})))}))}findEvents(e){return Ce.filterEvents(this.customer.getEvents()).filter((e=>this.override.isEventLive(e).orElse("live"===e.getState()))).filter((t=>t.getFormId()===e))}sendConversionEvent(e,t){_s.debug("Marketo form submission send conversion event");const i=new sr(e,t,void 0,void 0);this.activityStorage.add(io.buildConversionActivity(i,this.customer,this.environment,this.user,this.attributeStorage,this.customerStorage));const s=new Dr(i,this.browserEventLogger,this.customer,this.customerStorage,this.statusModel);this.manager.addTask(s)}};let Ta=Ca;__publicField(Ta,"WAIT_FOR_MKTOFORMS2_MS",5e3);class xa extends kr{toString(){return"PageUnloadingTask()"}inTransaction(){return!1}isUnloading(){return!0}run(){return _s.debug("page unload no-op done"),Tr.SUCCEEDED}}class Aa extends kr{constructor(e,t){super(),__publicField(this,"environment"),__publicField(this,"browserEventLogger"),__publicField(this,"sent",!1),__publicField(this,"deliveryStatus",Tr.NOT_STARTED),this.environment=S(e),this.browserEventLogger=S(t)}toString(){return`PageviewEventTask(${this.environment.getPageviewId()})`}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.deliveryStatus===Tr.SUCCEEDED?Tr.SUCCEEDED:this.deliveryStatus===Tr.FAILED?Tr.FAILED:(_s.debug("Waiting for pageview event delivery confirmation"),Tr.TRY_LATER)}sendOnce(){this.sent||(_s.info("Sending pageview event"),this.browserEventLogger.sendPageview().then((()=>{_s.info(`Pageview ${this.environment.getPageviewId()} event delivery success`),this.deliveryStatus=Tr.SUCCEEDED})).catch((e=>{const t=new Ee(`Pageview ${this.environment.getPageviewId()} event delivery failed`,e);_s.warn(t,83),this.deliveryStatus=Tr.FAILED})),this.sent=!0)}}var ka=(e=>(e[e.TS=0]="TS",e[e.TZ=1]="TZ",e[e.DP=2]="DP",e[e.WP=3]="WP",e[e.US=4]="US",e[e.UM=5]="UM",e[e.UCM=6]="UCM",e[e.UT=7]="UT",e[e.UCN=8]="UCN",e[e.UPN=9]="UPN",e[e.UPNV=10]="UPNV",e[e.CAN=11]="CAN",e[e.CANV=12]="CANV",e[e.PID=13]="PID",e[e.IFTU=14]="IFTU",e[e.AID=15]="AID",e))(ka||{});const Pa="=",Da="-";class Fa{static buildBrowserContext(e,t,i,s,n){const r=t.getInternalAttributes("user"),o=[];n.getExperiences().forEach((e=>{if("cc"!==e.getType()){const t=n.getVariationIds(e.getId());1===t.length?o.push(t[0]):_s.error("Non-cc experience does not have exactly one variation selected",181,{experienceId:e.getId()})}}));const a={isFirstTimeUser:i.isNewVisitor(),timestamp:e.getNowUnixTime(),customAttributes:t.getFlattenedCustomAttributes(),pageIds:s.getPages().map((e=>e.getId())),audienceIds:s.getAudiences().map((e=>e.getId())),selectedVariationIds:o};return void 0!==r.ts&&(a.trafficSource=r.ts),a.timeZone=e.getTimeZone(),void 0!==r.uts&&(a.utmSource=r.uts),void 0!==r.utm&&(a.utmMedium=r.utm),void 0!==r.utcm&&(a.utmCampaign=r.utcm),void 0!==r.utt&&(a.utmTerm=r.utt),void 0!==r.utcn&&(a.utmContent=r.utcn),a.hostingPageUrl=e.getHostingPageUrl().getRawUrl(),a}static buildFeatures(e,t,i,s){const n={},r=t.getInternalAttributes("user");return Fa.addFeature(n,0,Fa.getFeatureFromAttribute(r.ts)),Fa.addFeature(n,4,Fa.getFeatureFromAttribute(r.uts)),Fa.addFeature(n,5,Fa.getFeatureFromAttribute(r.utm)),Fa.addFeature(n,6,Fa.getFeatureFromAttribute(r.utcm)),Fa.addFeature(n,7,Fa.getFeatureFromAttribute(r.utt)),Fa.addFeature(n,8,Fa.getFeatureFromAttribute(r.utcn)),Fa.addFeature(n,9,Fa.getUrlParameterName(e)),Fa.addFeature(n,10,Fa.getUrlParameterNameValue(e)),Fa.addFeature(n,1,Fa.getTimeZoneValue(e)),Fa.addFeature(n,2,Fa.getDayPartValue(e)),Fa.addFeature(n,3,Fa.getWeekPartValue(e)),Fa.addFeature(n,11,Fa.getCustomAttributeName(t)),Fa.addFeature(n,12,Fa.getCustomAttributeNameValue(t)),Fa.addFeature(n,13,Fa.getPageId(s)),Fa.addFeature(n,14,Fa.getIsFirstTimeUser(i)),Fa.addFeature(n,15,Fa.getAudienceId(s)),n}static getFeatureFromAttribute(e){return D.ofNullable(e).toArray()}static getTimeZoneValue(e){return[e.getTimeZone()]}static getDayPartValue(e){return[e.getDayPart()]}static getWeekPartValue(e){return[e.getWeekPart()]}static getUrlParameterName(e){return Object.keys(e.getHostingPageUrl().getAllQueryParamsUnsafe()).filter((e=>""!==e))}static getUrlParameterNameValue(e){const t=e.getHostingPageUrl().getAllQueryParamsUnsafe(),i=[];return Object.keys(t).forEach((e=>{i.push(e+Da+t[e])})),i}static getCustomAttributeName(e){const t=e.getFlattenedCustomAttributes();return Object.keys(t)}static getCustomAttributeNameValue(e){const t=e.getFlattenedCustomAttributes();return Object.keys(t).map((e=>e+Da+t[e]))}static getPageId(e){return e.getPages().map((e=>e.getId()))}static getIsFirstTimeUser(e){return[e.isNewVisitor().toString()]}static getAudienceId(e){return e.getAudiences().map((e=>e.getId()))}static buildUnaryFeature(e,t){return ka[e]+Pa+t}static addFeature(e,t,i){i.forEach((i=>{e[Fa.buildUnaryFeature(t,i)]=!0}))}}class Ma extends As{constructor(e){super(e),__publicField(this,"urlParamsEncoded"),__publicField(this,"utmMedium"),__publicField(this,"utmSource"),this.urlParamsEncoded=xs(Ma.standardUrlParameterParser(e)),this.utmSource=this.urlParamsUnsafe.utm_source,this.utmMedium=this.urlParamsUnsafe.utm_medium}static standardUrlParameterParser(e){const t={};if(void 0===e)return t;const i=e.indexOf("#");let s=e.length-1;-1!==i&&(s=i-1);const n=e.indexOf("?"),r=n+1;return-1===n||r>=s||e.slice(r,s+1).split("&").filter((e=>void 0!==e&&e.length>0)).forEach((e=>{let i=e,s="";const n=e.indexOf("=");-1!==n&&(i=e.slice(0,Math.max(0,n)),s=e.slice(n+1)),void 0===t[i]?t[i]=[s]:t[i].push(s)})),t}get emailTagRegExp(){return/email|^send|hs_em|[\W_^]mail[\W_$]|sms|newsletter|^em[\W_$]|^attentive$/}get searchTagRegExp(){return/(search|bing|google|googlepla|sem|adwords)/i}get socialTagRegExp(){return/facebook|[\W_^]fb[\W_$]|youtube|[\W_^]ig[\W_$]|twitter|igstories|^tw$|twtr|profile|pinterest|instagram|socialmedia|quora|newsfeed|reddit|social|influencer|yelp|snapchat|linkedin|googleplus|g\+|gplus|google\+/i}get paidSocialRegExp(){return/influencer|ctc|ocpm|smm|socialp|cbo|bid|paidsocial/i}get organicSocialRegExp(){return/organic|socialo|stories|story|profile/i}get paidRegExp1(){return/(placement|attentive|taboola|gdn|criteo|googlepla|mrkt_adwords|outbrain|shareasale|klaviyo|inboxdollars|liveintent|adwords|ads|listrak|gsp|bluecore)/i}get paidRegExp2(){return/(cpc|affiliate|paid|smm|sem|ocpm|adroll|reengagement|remarketing|retargeting|cpa|paids|native|ppc|leads|display|[\W_^]ad[\W_$]|cpm|advertising|channel_partner|sponsored)/i}get searchIdRegExp(){return/([?&])(gclid|msclkid)=/i}get socialIdRegEx(){return/([?&])fbclid=/i}getAllUrlParamsEncoded(){return this.urlParamsEncoded}getSourceFromAllParams(e){let t=!1;for(const i of Object.keys(this.urlParamsUnsafe))if(Object.prototype.hasOwnProperty.call(this.urlParamsUnsafe,i)){const s=this.urlParamsUnsafe[i];if(t=t||this.isParamPaid(s),this.isParamSocialTagged(s))return e||t||this.isParamSocialPaid(s)?"CP":"CO";if(this.isParamSearchTagged(s))return e||t||this.isSearchPaid()?"SP":"SO";if(this.getUrl().isPresent()&&this.isParamEmailTagged(s))return"EM"}return t?"OP":"OT"}isSocialTagged(){return!(!this.optionalUrl.isPresent()||!this.socialIdRegEx.test(this.optionalUrl.get()))||(this.isParamSocialTagged(this.utmMedium)||this.isParamSocialTagged(this.utmSource))}isSocialPaid(){return this.isParamSocialPaid(this.utmMedium)||this.isParamSocialPaid(this.utmSource)}isSearchTagged(e){return!(!this.optionalUrl.isPresent()||!this.searchIdRegExp.test(this.optionalUrl.get()))||(!(!this.isParamSearchTagged(this.utmSource)&&!this.isParamSearchTagged(this.utmMedium))||e.getUrl().isPresent()&&e.isFromSearchEngine()&&(Boolean(this.utmMedium)||Boolean(this.utmSource)))}isSearchPaid(){return!(!this.optionalUrl.isPresent()||!this.searchIdRegExp.test(this.optionalUrl.get()))||(this.isParamSearchPaid(this.utmMedium)||this.isParamSearchPaid(this.utmSource))}isPaidTraffic(){return this.isParamPaid(this.utmSource)||this.isParamPaid(this.utmMedium)}isEmailTagged(){return this.isParamEmailTagged(this.utmSource)||this.isParamEmailTagged(this.utmMedium)}isParamPaid(e){return void 0!==e&&(this.paidRegExp1.test(e)||this.paidRegExp2.test(e))}isParamEmailTagged(e){return void 0!==e&&this.emailTagRegExp.test(e)}isParamSearchTagged(e){return void 0!==e&&this.searchTagRegExp.test(e)}isParamSearchPaid(e){return void 0!==e&&/googlep|adwords/.test(e)}isParamSocialPaid(e){return(void 0===e||!this.organicSocialRegExp.test(e))&&(void 0!==e&&this.paidSocialRegExp.test(e))}isParamSocialTagged(e){return void 0!==e&&this.socialTagRegExp.test(e)}}class Na extends As{get emailDomainRegExp(){return/([/.])(webmail|live|mail|inbox|zimbra|email|em)\d{0,2}\.|google.android.gm/i}get socialDomainRegExp(){return/([/.])(t\.co|(plus\.google|facebook|twitter|linkedin|youtube|instagram|pinterest|quora|reddit|github|medium|producthunt|yelp|ycombinator|messenger)\.)/i}get paidDomainRegExp(){return/([/.])(taboola|aimtell|attentive|googlesyndication|shareasale|outbrain|shareasale-analytics|doubleclick)\./i}get invalidSearchRegExp(){return/([/.])((plus|mail|myactivity|chrome|classroom|accounts|news|docs|keep|sites)\.google|googlesyndication|google\.android\.(?!googlequicksearchbox))/i}get paidSearchRegExp(){return/([/.])(google|googleadservices)\..*?\/aclk\?/i}get validSearchRegExp(){return/([/.])(google|bing|baidu|duckduckgo|ask|search\.(yahoo|xfinity|aol|naver))\./i}isFromSearchEngine(){return this.optionalUrl.isPresent()&&!this.invalidSearchRegExp.test(this.optionalUrl.get())&&this.validSearchRegExp.test(this.optionalUrl.get())}isFromEmail(){return this.optionalUrl.isPresent()&&this.emailDomainRegExp.test(this.optionalUrl.get())}isFromSocialNetwork(){return this.optionalUrl.isPresent()&&this.socialDomainRegExp.test(this.optionalUrl.get())}isPaidTraffic(){return this.optionalUrl.isPresent()&&this.paidDomainRegExp.test(this.optionalUrl.get())}isSearchPaid(){return this.optionalUrl.isPresent()&&!this.invalidSearchRegExp.test(this.optionalUrl.get())&&this.paidSearchRegExp.test(this.optionalUrl.get())}}function Oa(e,t){const i=e.getReferrerUrl(),s=e.getHostingPageUrl(),n=new Na(i.map((e=>e.getRawUrl())).orElse(void 0)),r=new Ma(s.getRawUrl()),o=n.isPaidTraffic()||r.isPaidTraffic();let a=Ra(n,r,o);return"OT"===a&&(a=La(n,r,o)),"OT"===a&&(a=r.getSourceFromAllParams(o)),"OT"===a&&(a=o?"OP":n.getUrl().isPresent()?ds(e,t).orElse(!1)?"RC":"OT":"DN"),a}function Ra(e,t,i){return e.isFromEmail()?"EM":e.isFromSocialNetwork()?i||t.isSocialPaid()?"CP":"CO":e.isFromSearchEngine()?i||t.isSearchTagged(e)||e.isSearchPaid()||t.isSearchPaid()?"SP":"SO":"OT"}function La(e,t,i){return t.isSocialTagged()?i||t.isSocialPaid()?"CP":"CO":t.isSearchTagged(e)?i||t.isSearchPaid()?"SP":"SO":t.getUrl().isPresent()&&t.isEmailTagged()?"EM":"OT"}const $a=["xo"],Ua={debug(e,t,i){_s.debug(e,t,i,$a)}};class Va extends kr{constructor(e,t,i){super(),__publicField(this,"localStorage"),__publicField(this,"storageKey"),__publicField(this,"storageDatum"),this.localStorage=e,this.storageKey=t,this.storageDatum=i}toString(){return`StorageCleanupTask(${this.storageKey})`}inTransaction(){return!1}isUnloading(){return!1}getStorageKey(){return this.storageKey}setStorageDatum(e){this.storageDatum=void 0===e?void 0:__spreadValues({},e)}getNotDoneDependencies(){return this.manager.findTasks((e=>!(e instanceof Va||e.isUnloading()||e.isDone())))}run(){return Ua.debug(`Running storage cleanup task for "${this.storageKey}".`),this.getNotDoneDependencies().length>0?(Ua.debug("Deferring storage cleanup; other tasks still running"),Tr.TRY_LATER):(void 0===this.storageDatum?(Ua.debug("Deleting data locally because the common origin is empty for this storageKey"),this.localStorage.delete(this.storageKey)):(Ua.debug(`Writing latest data from the common origin to the customer origin. ${Bi(this.storageDatum,void 0,2)}`),this.localStorage.write(this.storageKey,Hi(this.storageDatum))),Tr.SUCCEEDED)}}class Wa{constructor(e,t){__publicField(this,"localStorage"),__publicField(this,"taskManager"),this.localStorage=e,this.taskManager=t}run(){return __async(this,null,(function*(){return new Promise((e=>{this.taskManager.isDone()?(Ua.debug("[CleanupTaskManager]: no tasks to run"),e()):(Ua.debug("[CleanupTaskManager]: waiting for all tasks to complete"),this.taskManager.onDone((()=>{e()})))}))}))}queueCleanupTask(e,t){this.findNotDoneCleanupTask(e).ifPresent((i=>{Ua.debug(`Cleanup task already exists for ${e}; updating storageDatum`),i.setStorageDatum(t)})).ifAbsent((()=>{Ua.debug(`Creating cleanup task for ${e} with ${Bi(t,void 0,2)}`),this.taskManager.addTask(new Va(this.localStorage,e,t))}))}findNotDoneCleanupTask(e){const[t]=this.taskManager.findTasks((t=>t instanceof Va&&t.getStorageKey()===e&&!t.isDone()));return D.ofNullable(t)}}class za{constructor(e,t,i){__publicField(this,"localStorage"),__publicField(this,"requestId"),__publicField(this,"storageOrigin"),__publicField(this,"message"),__publicField(this,"iframe"),__publicField(this,"resolver"),__publicField(this,"isDone",!1),__publicField(this,"timeStart"),this.localStorage=e,this.requestId=bn(),this.storageOrigin=t,void 0!==i&&this.setMessage(i)}static get MESSAGE_EVENT_TIMEOUT_MS(){return 1e3}getRequestId(){return this.requestId}getStorageKey(){var e;return null==(e=this.message)?void 0:e.storageKey}setMessage(e){let t;this.getExpectedVersion(e.storageKey).ifPresent((e=>{t=e})),this.message=__spreadProps(__spreadValues({},e),{requestId:this.requestId,expectedVersion:t})}setIframe(e){this.iframe=e}send(){return __async(this,null,(function*(){if(void 0===this.iframe)throw new Error("Cannot call send() without setting the iframe");if(void 0===this.message)throw new Error("Cannot call send() without setting the message");const{iframe:e,message:t}=this;yield new Promise(((i,s)=>{var n;try{const r={resolve:i,reject:s};this.resolver=r,null===e.contentWindow?r.resolve():(Ua.debug(`send(): Sending message to storage domain (${this.storageOrigin}) ${Bi(t,void 0,2)}`),this.timeStart=new Date,null==(n=e.contentWindow)||n.postMessage(t,this.storageOrigin),setTimeout((()=>{try{this.isDone||s(new Error(`Did not receive response within ${za.MESSAGE_EVENT_TIMEOUT_MS}ms`))}catch(e){const t=fe(e);_s.error(t,174)}}),za.MESSAGE_EVENT_TIMEOUT_MS))}catch(r){s(r)}}))}))}reply(e){if(void 0===this.resolver)throw new Error("Cannot reply to message request if the message has no resolver");if(void 0!==this.timeStart){const e=(new Date).getTime()-this.timeStart.getTime();this.timeStart=void 0,Ua.debug(`XO message round-trip time - ${e}ms`)}e.success?this.resolver.resolve():void 0===e.error?this.resolver.reject(new Error("Message request failed, but there is no error data (unexpected)")):this.resolver.reject(e),this.isDone=!0}getExpectedVersion(e){return this.localStorage.read(e).flatMap((e=>Ba.validateStorageDatumString(e))).flatMap((e=>D.ofNullable(e.version)))}}var ja=(e=>(e.UNEXPECTED="UNEXPECTED",e.LOCALSTORAGE_ACCESS="LOCALSTORAGE_ACCESS",e.INVALID_OP="INVALID_OP",e.INVALID_MESSAGE_FORMAT="INVALID_MESSAGE_FORMAT",e.INVALID_MESSAGE_META_FORMAT="INVALID_MESSAGE_META_FORMAT",e.INVALID_DATUM_FORMAT="INVALID_DATUM_FORMAT",e.UNEXPECTED_VERSION="UNEXPECTED_VERSION",e))(ja||{});function Ga(e){return e}class Ba{constructor(e,t,i,s){__publicField(this,"taskManager"),__publicField(this,"localStorage"),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"messageRequests"),__publicField(this,"storageKeys"),__publicField(this,"storageOrigin"),__publicField(this,"cleanupTaskManager"),__publicField(this,"isFeatureMissing"),__publicField(this,"iframeLoadPromise"),__publicField(this,"iframe"),this.localStorage=e,this.taskManager=i,this.environment=t,this.messageRequests={},this.customer=s,this.isFeatureMissing=!1;const n="intellimizeio.com";this.storageOrigin=`https://${s.getId()}.${n}`,this.storageKeys=Jr(s),this.cleanupTaskManager=new Wa(this.localStorage,this.taskManager),this.loadIframe().catch((()=>{this.isFeatureMissing=!0}))}static validateStorageDatumString(e){let t;try{if(t=Qi(e),"object"==typeof t&&null!==t&&("string"==typeof t.version||void 0===t.version)&&"string"==typeof t.data)return D.of(t)}catch(i){Ua.debug(`validateStorageDatumString(): Not a StorageDatum (got ${Bi(t)})`)}return D.empty()}static getNormalizedStorageValue(e){return Ba.validateStorageDatumString(e).map((e=>e.data)).orElse(e)}static get READY_MESSAGE_TIMEOUT_MS(){return 3e3}static get WAIT_FOR_DATA_MS(){return 500}static isMessageReply(e){return"object"==typeof e&&null!==e&&"reply"===e.type}get isCrossOriginEnabled(){return!this.isFeatureMissing&&(this.customer.getCrossOrigin().isEnabled()||this.customer.getOrigins().length>0)}get shouldWaitForData(){if(this.environment.getReferrerUrl().isPresent()){const e=this.environment.getReferrerUrl().get(),t=this.environment.getHostingPageUrl();if(hs(this.customer,e.getOrigin()).orElse(!1)){if(e.getOrigin()!==t.getOrigin())return Ua.debug("shouldWaitForData(): Detected a switch to a different origin."),!0;let i=!1;for(const e of this.storageKeys)if(this.localStorage.read(e).isPresent()){i=!0;break}if(!i)return _s.warn("shouldWaitForData(): Detected an origin with no data.",63),!0;Ua.debug("shouldWaitForData(): not waiting (user didn't cross origins, and there is existing data in LocalStorage)")}else Ua.debug(`shouldWaitForData(): not waiting (referrer origin not allowed - ${e.getOrigin()})`)}else Ua.debug("shouldWaitForData(): not waiting (no referrer - can't determine if user has crossed origins");return!1}initialize(){return __async(this,null,(function*(){if(this.isCrossOriginEnabled){Ua.debug("Cross-Origin storage enabled by customer configuration. Persisting LocalStorage operations to the common origin.");const e=this.syncWithCommonOrigin().catch((e=>{const t=new Ee("Error syncing with common origin",e);_s.error(t,130),this.isFeatureMissing=!0}));this.shouldWaitForData?(Ua.debug("initialize(): Blocking client execution until xd storage is ready (shouldWaitForData is true)"),yield this.waitForData(e)):Ua.debug("initialize(): Not waiting until xd storage is ready (shouldWaitForData is false)")}else Ua.debug("Cross-Origin storage disabled by customer configuration. Using LocalStorage only.");Ua.debug("crossOriginStorage.initialize() has finished")}))}read(e){const t=this.readFromLocalStorage(e);return this.readAsync(e).catch((()=>{this.isFeatureMissing=!0})),t.flatMap((e=>D.ofNullable(e.data)))}write(e,t){this.writeAsync(e,t).catch((()=>{this.isFeatureMissing=!0}))}delete(e){this.deleteAsync(e).catch((()=>{this.isFeatureMissing=!0}))}loadIframe(){return __async(this,null,(function*(){if(void 0===this.iframeLoadPromise){const{document:e}=this.environment.getWindow();let t;this.iframe=e.createElement("iframe"),this.iframeLoadPromise=new Promise(((i,s)=>{let n=!1,r=!1;this.iframe.setAttribute("hidden",""),this.iframe.setAttribute("tabIndex","-1"),this.iframe.setAttribute("width","0"),this.iframe.setAttribute("height","0"),this.iframe.setAttribute("style","display:none");let o=`${this.storageOrigin}/storage.html`;_s.getLevel()<L.LogLevel.OFF&&(o+=`?ideb=${_s.getLevel()}`),this.iframe.setAttribute("src",o),this.iframe.setAttribute("referrerpolicy","strict-origin-when-cross-origin"),this.iframe.onerror=e=>{Ua.debug("XO iframe onerror callback triggered"),n||r||setTimeout((()=>{try{r=!0;const t=new Ee("Iframe load error",e);_s.error(t,66),s()}catch(t){const e=fe(t);_s.error(e,170)}}),0)};const a=()=>{Ua.debug("XO iframe ready resolver triggered"),r||setTimeout((()=>{var e;try{if(Ua.debug("loadIframe(): iframe is ready"),n=!0,void 0===(null==(e=this.iframe.contentWindow)?void 0:e.postMessage))_s.error("postMessage() API not supported",65),s(),this.iframe.remove();else{if(void 0!==t){const e=(new Date).getTime()-t.getTime();Ua.debug(`iframe load + ready message time - ${e}ms`)}i(void 0)}}catch(r){const e=fe(r);_s.error(e,171)}}),0)};this.environment.addListener("message",(e=>{try{this.handleResponse(e,a)}catch(t){const e=new Ee("Exception in XO message response handler",t);_s.error(e,237)}})),t=new Date,e.querySelectorAll("head")[0].insertAdjacentElement("afterbegin",this.iframe),setTimeout((()=>{try{n||(r=!0,_s.error(`iframe did not load & receive "ready" message within ${Ba.READY_MESSAGE_TIMEOUT_MS} ms`,67),s())}catch(e){const t=fe(e);_s.error(t,172)}}),Ba.READY_MESSAGE_TIMEOUT_MS)}))}return this.iframeLoadPromise}))}readFromLocalStorage(e){return this.localStorage.read(e).flatMap((e=>{try{return D.of(Qi(e))}catch(t){return _s.error(`readFromLocalStorage(): Unable to parse as JSON (${e})`,68),D.empty()}}))}writeToLocalStorage(e,t){this.localStorage.write(e,Hi(t)),Ua.debug(`writeToLocalStorage(): Wrote "${e}" to LocalStorage (${Bi(t,void 0,2)})`)}deleteFromLocalStorage(e){this.localStorage.delete(e),Ua.debug(`deleteFromLocalStorage(): Deleted "${e}" from LocalStorage`)}readAsync(e){return __async(this,null,(function*(){if(Ua.debug(`readAsync(): Called with storageKey: "${e}"`),this.isCrossOriginEnabled){const t=new za(this.localStorage,this.storageOrigin,{requestId:"",op:"read",storageKey:e});yield this.sendMessageRequest(t)}}))}writeAsync(e,t){return __async(this,null,(function*(){let i;if(Ua.debug(`writeAsync(): Called with storageKey: "${e}", data ${t}`),this.isCrossOriginEnabled){const s=new za(this.localStorage,this.storageOrigin);i={version:s.getRequestId(),data:t},s.setMessage({requestId:"",op:"write",storageKey:e,storageDatum:i}),this.writeToLocalStorage(e,i),yield this.sendMessageRequest(s)}else this.writeToLocalStorage(e,{data:t})}))}deleteAsync(e){return __async(this,null,(function*(){if(Ua.debug(`delete(): Called with storageKey: "${e}"`),this.isCrossOriginEnabled){const t=new za(this.localStorage,this.storageOrigin,{requestId:"",op:"delete",storageKey:e});this.deleteFromLocalStorage(e),yield this.sendMessageRequest(t)}else this.deleteFromLocalStorage(e)}))}syncWithCommonOrigin(){return __async(this,null,(function*(){const e=[];this.storageKeys.forEach((t=>{this.readFromLocalStorage(t).ifPresent((({data:i,version:s})=>{s?(Ua.debug(`syncWithCommonOrigin(): Existing storageDatum found with a version (storageKey: ${t}). Sending "read" message to the common origin.`),e.push(this.readAsync(t))):(Ua.debug(`syncWithCommonOrigin(): Existing storageDatum found without a version (storageKey: ${t}). Sending "write" message to the common origin.`),e.push(this.writeAsync(t,i)))})).ifAbsent((()=>{Ua.debug(`syncWithCommonOrigin(): No existing storageDatum found (storageKey: ${t}). Sending "read" message to the common origin.`),e.push(this.readAsync(t))}))})),yield Promise.all(e)}))}sendMessageRequest(e){return __async(this,null,(function*(){try{yield this.loadIframe()}catch(i){return void(this.isFeatureMissing=!0)}const t=e.getRequestId();e.setIframe(this.iframe),this.messageRequests[t]=e;try{yield e.send(),delete this.messageRequests[t]}catch(s){if(delete this.messageRequests[t],Ba.isMessageReply(s))this.handleMessageReplyErrors(e,s);else{const e=new Ee("Could not send message request",s);_s.error(e,129),this.isFeatureMissing=!0}}}))}handleResponse(e,t){const{data:i,origin:s}=e;if(s!==this.storageOrigin)return;if(Ua.debug(`handleResponse(): Received message event from storage domain (${this.storageOrigin})`),void 0!==i&&Ua.debug(Bi(i)),"object"!=typeof i||null===i)return void _s.debug("handleResponse(): Refusing to handle message with invalid response format",69);if("ready"===i.type)return Ua.debug('handleResponse(): Received "ready" message'),void t();if("sync"===i.type)return void this.handleSyncResponse(Ga(i));if("reply"!==i.type)return void _s.debug(`handleResponse(): Refusing to handle message with unknown type (${i.type})`,70);const{correlationId:n}=i,r=this.messageRequests[n];void 0!==r?r.reply(i):_s.error("handleResponse(): Could not find matching message in memory",71)}handleSyncResponse({storageKey:e,storageDatum:t}){this.cleanupTaskManager.queueCleanupTask(e,t)}handleMessageReplyErrors(e,t){const{code:i,msg:s}=t.error;if(Ua.debug(s),i===ja.UNEXPECTED_VERSION)this.handleUnexpectedVersion(e,t);else{if(i!==ja.LOCALSTORAGE_ACCESS)throw new Error(s);Ua.debug("LocalStorage is not accessible on the common origin (i.e. browser security setting)")}}handleUnexpectedVersion(e,t){const i=e.getStorageKey(),{storageDatum:s}=t;if(void 0===s){const e=`handleUnexpectedVersion(): Common origin has no data for storageKey: "${i}"`;Ua.debug(e)}else{const e=`handleUnexpectedVersion(): Common origin for storageKey: "${i}"`;Ua.debug(`${e} ${Bi(s,void 0,2)}`)}this.cleanupTaskManager.queueCleanupTask(i,s)}waitForData(e){return __async(this,null,(function*(){return new Promise(((t,i)=>__async(this,null,(function*(){let s=!1;const n=this.environment.getWindow().setTimeout((()=>__async(this,null,(function*(){s=!0;try{t()}catch(e){const t=fe(e);_s.error(t,173)}}))),Ba.WAIT_FOR_DATA_MS),r=Date.now();try{const i=yield e,o=Date.now();Ua.debug(`waitForData(): iframe load + data sync time - ${o-r}ms`);const a=yield this.cleanupTaskManager.run(),l=Date.now();Ua.debug(`waitForData(): Cleanup task time - ${l-o}ms`),s?_s.warn(`waitForData(): Synchronization did not complete within ${Ba.WAIT_FOR_DATA_MS}ms. (Took ${l-r}ms)`,72):(Ua.debug(`waitForData(): Sync completed; finished in under ${Ba.WAIT_FOR_DATA_MS}ms (Took ${l-r}ms)`),this.environment.getWindow().clearTimeout(n),t([i,a]))}catch(o){s||(this.environment.getWindow().clearTimeout(n),i(o))}}))))}))}}class Ha{constructor(){__publicField(this,"storage"),this.storage={}}write(e,t){Xr(e)||_s.error(`Writing an unknown key to MemoryStorage: ${e}`,180),this.storage[e]=t}read(e){return D.ofNullable(this.storage[e])}delete(e){delete this.storage[e]}}class Qa{constructor(e){if(__publicField(this,"environment"),!eo(e,"sessionStorage"))throw new Error("sessionStorage is not available");this.environment=e}write(e,t){Xr(e)||_s.error(`Writing an unknown key to SessionStorage: ${e}`,180),this.environment.writeSessionStorage(e,t)}read(e){return this.environment.readSessionStorage(e)}delete(e){this.environment.deleteSessionStorage(e)}}function qa(e){return void 0!==e.error}function Ka(e,t,i){if(!ds(e,i).orElse(!1)){const s={utcm:"utm_campaign",utcn:"utm_content",utm:"utm_medium",uts:"utm_source",utt:"utm_term"},n=Oa(e,i);t.setInternalAttributes("user",{ts:n}),t.deleteInternalAttributes("user",zi);const r={};zi.forEach((t=>{const i=s[t],n=e.getHostingPageUrl().getQueryParam(i,(()=>!0));n.isPresent()&&(r[t]=n.get())})),Object.keys(r).length>0&&t.setInternalAttributes("user",r)}}function Ya(e,t,i){e.getCss().ifPresent((s=>{try{_s.info(`Injecting customer ${e.getId()} css`),Fs.injectCss(s,`customer-${e.getId()}`,i),t.setCustomer("css",!0)}catch(n){const i=new Ee(`Customer (${e.getId()}) css injection failed`,n);_s.error(i,26),t.setCustomer("css",!1)}})),e.getCode().ifPresent((i=>{try{_s.info(`Running customer ${e.getId()} code`),Fs.eval(i),t.setCustomer("code",!0)}catch(s){const i=new Ee(`Customer (${e.getId()}) code execution failed`,s);_s.error(i,13),t.setCustomer("code",!1)}}))}function Ja(e){return!e.startsWith('{"')}function Xa(e){const t=e.getWindow()[ts(e)];if(void 0===t)return _s.error("Missing customer JSON. Aborting.",145),D.empty();let i;if(_s.time("load json"),Ja(t))try{i=Zi(e,t)}catch(n){const e=new Ee("Could not decrypt CustomerJson",n);return _s.error(e,213),D.empty()}else try{i=Qi(t)}catch(n){const e=new Ee("Could not parse CustomerJson",n);return _s.error(e,210),D.empty()}const s=xs(i);return _s.timeEnd("load json"),D.of(s)}function Za(e){_s.time("Build customer object time");const t=new gi(_s).buildCustomer(e);return _s.timeEnd("Build customer object time"),D.ofNullable(t)}function el(e,t,i){const s=`${Ni}${e.getId()}`;let n="true"===t.read(s).orElse("false");return n||i.getHostingPageUrl().getQueryParam("intellimize_opt_out",Wo("true")).ifPresent((()=>{n=i.getWindow().confirm("Are you sure you want to opt out of Intellimize for this domain?"),n&&(t.write(s,"true"),i.getWindow().alert("You have successfully opted out of Intellimize for this domain."))})),!!n&&(_s.debug("User opt-out; cleanup and exit early"),Jr(e).forEach((e=>{e!==s&&t.delete(e)})),i.getWindow().inrsgew=!0,!0)}function tl(e,t,i,s,n){return __async(this,null,(function*(){const r=n.useStorageType().orElse("CrossOriginStorage");switch(r){case"CrossOriginStorage":{const n=new Ba(e,t,i,s);return yield n.initialize(),n}case"MemoryStorage":return new Ha;case"SessionStorage":return new Qa(t);case"LocalStorage":return e;default:throw new Error(`Unknown storage type: ${r}`)}}))}class il{constructor(){__publicField(this,"variationLists",{}),__publicField(this,"experiences",{}),__publicField(this,"stickyVariations",{}),__publicField(this,"modelVersions",{})}unshift(e){const t=e.getExperience(),i=t.getId();void 0===this.variationLists[i]&&(this.variationLists[i]=[]),this.variationLists[i].unshift(e),this.experiences[i]=t}isEmpty(){return!Object.keys(this.variationLists).some((e=>this.variationLists[e].length>0))}getExperience(e){return this.experiences[e]}getExperiences(){return Object.keys(this.variationLists).map((e=>this.experiences[e]))}setModelVersion(e,t){this.modelVersions[e]=t}getModelVersion(e){return this.modelVersions[e]}sortVariations(e,t){var i;null==(i=this.variationLists[e])||i.sort(t)}prioritizeStickyVariation(e,t){if(_s.group("prioritizeVariation(experience:"+e+", variation:"+t+")"),e in this.variationLists){let i=-1;this.variationLists[e].forEach(((e,s)=>{e.getId()===t&&(i=s)})),_s.debug("found variation index? => "+i),-1!==i&&(this.variationLists[e]=[this.variationLists[e][i]],e in this.stickyVariations||(this.stickyVariations[e]={}),this.stickyVariations[e][t]=!0)}_s.groupEnd()}getVariationIds(e){var t,i;return null!=(i=null==(t=this.variationLists[e])?void 0:t.map((e=>e.getId())))?i:[]}hasNext(e){const t=this.variationLists[e];return void 0!==t&&t.length>0}shift(e){var t;if(!(e in this.variationLists))throw new x("No value present");const i=null==(t=this.variationLists[e])?void 0:t.shift();if(this.removeIfEmpty(e),void 0!==i)return i;throw new x("No value present")}getFirst(e){var t;const i=this.variationLists[e];if(void 0===i)throw new x("No experience present");if(0===i.length)throw new x("No variations present");const s=null==(t=this.variationLists[e])?void 0:t[0];if(void 0!==s)return s;throw new x("No value present")}removeVariation(e,t){t.getId();const i=this.variationLists[e];if(void 0!==i){let s=-1;i.forEach(((e,i)=>{e.getId()===t.getId()&&(s=i)})),-1!==s&&(i.splice(s,1),this.removeIfEmpty(e))}}removeExperience(e){e in this.experiences&&delete this.experiences[e],e in this.variationLists&&delete this.variationLists[e]}isDecidingExperience(e){return e.getId()in this.experiences}isStickyVariation(e){var t;const i=e.getId(),s=e.getExperience().getId();return Boolean(null==(t=this.stickyVariations[s])?void 0:t[i])}toString(){let e="{\n";return Object.keys(this.variationLists).forEach((t=>{e+="  "+t+": ",e+="["+this.variationLists[t].map((e=>e.getId())).join(", ")+"]",e+="\n"})),e+="}\n",e}removeIfEmpty(e){const t=this.variationLists[e];void 0!==t&&0===t.length&&this.removeExperience(e)}}class sl extends kr{constructor(e,t,i,s,n,r,o,a,l,c,u,d,h,g,p,m,v){super(),__publicField(this,"environment"),__publicField(this,"browserStorage"),__publicField(this,"extensionManager"),__publicField(this,"browserEventLogger"),__publicField(this,"customer"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"pageContext"),__publicField(this,"attributeData"),__publicField(this,"statusModel"),__publicField(this,"elementObserver"),__publicField(this,"runtime"),__publicField(this,"hider"),__publicField(this,"decisionContext"),__publicField(this,"getVariationRecordedCallbackTuples"),__publicField(this,"getEligibleCc",!1),__publicField(this,"selectAb",!1),__publicField(this,"selectRbp",!1),__publicField(this,"haveRunCampaignCode",{}),this.environment=S(e),this.browserStorage=S(t),this.extensionManager=S(i),this.browserEventLogger=S(s),this.customer=S(n),this.customerStorage=S(r),this.attributeStorage=S(o),this.activityStorage=S(a),this.user=S(l),this.override=S(c),this.pageContext=S(u),this.attributeData=S(d),this.statusModel=S(h),this.runtime=S(g),this.hider=S(p),this.getVariationRecordedCallbackTuples=S(m),this.elementObserver=S(v),this.decisionContext=new il}toString(){return"SelectVariationsTask()"}inTransaction(){return!1}isUnloading(){return!1}selectAbExperienceVariationsOnce(){this.selectAb||(_s.time("selectAbExperienceVariationsOnce"),_s.group("selectAbExperienceVariationsOnce()"),this.customer.getCampaigns().forEach((e=>{xt.filterExperiences(e.getExperiences()).filter((e=>this.isExperienceEligible(e))).forEach((t=>{let i;if(this.runCampaignCodeOnce(e),this.override.hasVariationIds(t).isPresent()){const e=this.override.hasVariationIds(t).get();i=t.getVariation(e[0])}else{const e=1e3,s=la(oa(t.getId()+this.user.getId(),1),e);i=t.selectVariation(s)}i.ifPresent((e=>{this.isVariationEligible(e)?(this.decisionContext.unshift(e),this.decisionContext.setModelVersion(t.getId(),"ab")):_s.error("Selected A/B variation is not eligible",182,{experienceId:t.getId(),variationId:e.getId()})})).ifAbsent((()=>{_s.error("Failed to select variation for A/B experience",183,{experienceId:t.getId()})}))}))})),_s.groupEnd(),_s.timeEnd("selectAbExperienceVariationsOnce"),this.selectAb=!0)}selectRbpExperienceVariationsOnce(){this.selectRbp||(_s.time("selectRbpExperienceVariationsOnce"),_s.group("selectRbpExperienceVariationsOnce()"),this.customer.getCampaigns().forEach((e=>{kt.filterExperiences(e.getExperiences()).filter((e=>this.isExperienceEligible(e))).forEach((t=>{this.runCampaignCodeOnce(e);for(const e of t.getPrioritizedVariations())if(this.isVariationEligible(e)){this.decisionContext.unshift(e),this.decisionContext.setModelVersion(t.getId(),"rbp");break}void 0===this.decisionContext.getExperience(t.getId())&&_s.info("Failed to select variation for RBP",184,{experienceId:t.getId()})}))})),_s.groupEnd(),_s.timeEnd("selectRbpExperienceVariationsOnce"),this.selectRbp=!0)}getCcEligibleVariationsOnce(){this.getEligibleCc||(_s.time("getCcEligibleVariationsOnce"),_s.group("getCcEligibleVariationsOnce()"),this.customer.getCampaigns().forEach((e=>{At.filterExperiences(e.getExperiences()).filter((e=>this.isExperienceEligible(e))).forEach((t=>{this.runCampaignCodeOnce(e);const i=this.override.isControl().orElseRun((()=>this.customerStorage.updateAndGetControl(e)));if(this.statusModel.setCampaign(e,"control",i),i){const e=t.getControlVariation();this.decisionContext.unshift(e)}else t.getRealVariations().forEach((e=>{this.isVariationEligible(e)&&this.decisionContext.unshift(e)}))}))})),_s.groupEnd(),_s.timeEnd("getCcEligibleVariationsOnce"),this.getEligibleCc=!0)}isExperienceEligible(e){_s.group("isExperienceEligible(experience:"+e.getId()+")"),_s.debug("check experience enabled");let t=" (override)";const i=this.override.isExperienceEnabled(e).orElseRun((()=>(t="",e.isEnabled())));if(_s.info(`Experience ${e.getId()} enabled => ${i}${t}`),this.statusModel.setExperience(e,"enabled",i),!i)return this.customerStorage.deleteExperiencePredictionSelection(e),_s.groupEnd(),!1;let s=!1;_s.debug(`Experience URL match (at least one match), URL: ${this.environment.getHostingPageUrl().getRawUrl()}`);const n=ha(this.pageContext,e.getPages());if(_s.debug("url match => "+(n.length>0)),this.statusModel.setExperience(e,"urlMatch",n.length>0),n.length>0&&(_s.info(`Experience ${e.getId()} URL check, URL:${this.environment.getHostingPageUrl().getRawUrl()} Page:${n[0].getName()} => true`),s=!0),!s){const{experienceIds:t}=this.environment.getWebflowPageMetadata();t.length>0&&(_s.debug("Webflow Page Metadata Experience ID check"),t.includes(e.getId())&&(_s.debug("Webflow experience => true"),s=!0))}if(!s)return _s.groupEnd(),!1;_s.debug("check experience condition");let r=" (override)";const o=this.override.passExperienceCondition().orElseRun((()=>(r="",_s.debug("evaluating experience condition"),e.getCondition().map((t=>{let i=!1;try{i=t.evaluate(this.runtime)}catch(s){const t=new Ee("Experience condition evaluation failed",s);i=!1,_s.error(t,206,{experienceId:e.getId()})}return i})).orElse(!0))));if(_s.info(`Experience ${e.getId()} condition passed => ${o}${r}`),this.statusModel.setExperience(e,"passCondition",o),!o)return _s.groupEnd(),this.customerStorage.deleteExperiencePredictionSelection(e),!1;_s.debug("check experience inclusion");let a=" (override)";const l=this.override.isExperienceIncluded(e).orElseRun((()=>(a="",this.customerStorage.updateAndGetExperienceInclusion(e))));return _s.info(`Experience ${e.getId()} inclusion => ${l}${a}`),this.statusModel.setExperience(e,"inclusion",l),l?(_s.debug("isExperienceEligible => true"),_s.groupEnd(),!0):(_s.groupEnd(),this.customerStorage.deleteExperiencePredictionSelection(e),!1)}isVariationEligible(e){_s.group("isVariationEligible(variation:"+e.getId()+")"),_s.debug("check variation enabled");let t=" (override)";const i=this.override.isVariationEnabled(e).orElseRun((()=>(t="",e.isEnabled())));if(_s.info(`Variation ${e.getExperience().getId()}/${e.getId()} enabled => ${i}${t}`),this.statusModel.setVariation(e,"enabled",i),!i)return _s.groupEnd(),!1;_s.debug("check variation condition");let s=" (override)";const n=this.override.passVariationCondition().orElseRun((()=>(s="",e.getCondition().map((t=>{let i=!1;try{i=t.evaluate(this.runtime)}catch(s){const t=new Ee("Variation condition evaluation failed ",s);i=!1,_s.error(t,207,{experienceId:e.getExperience().getId(),variationId:e.getId()})}return i})).orElse(!0))));return _s.info(`Variation ${e.getExperience().getId()}/${e.getId()} condition passed => ${n}${s}`),this.statusModel.setVariation(e,"passCondition",n),n?(_s.debug("isVariationEligible => true"),_s.groupEnd(),!0):(_s.groupEnd(),!1)}runCampaignCodeOnce(e){const t=e.getId();this.haveRunCampaignCode[t]||(this.haveRunCampaignCode[t]=!0,e.getCss().ifPresent((i=>{try{_s.info(`Injecting campaign ${e.getId()} css`),Fs.injectCss(i,`campaign-${t}`,this.environment.getWindow().document),this.statusModel.setCampaign(e,"css",!0)}catch(s){const t=new Ee(`Campaign (${e.getId()}) css injection failed`,s);_s.error(t,90,{campaignId:e.getId()}),this.statusModel.setCampaign(e,"css",!1)}})),e.getCode().ifPresent((t=>{try{_s.info(`Running campaign ${e.getId()} code`),Fs.eval(t),this.statusModel.setCampaign(e,"code",!0)}catch(i){const t=new Ee(`Campaign (${e.getId()}) code execution failed`,i);_s.error(t,14,{campaignId:e.getId()}),this.statusModel.setCampaign(e,"code",!1)}})))}}class nl extends sl{constructor(){super(...arguments),__publicField(this,"policyCallbackFunctions",[]),__publicField(this,"executeExperiencesTask"),__publicField(this,"policy"),__publicField(this,"sent",!1),__publicField(this,"apiStatus",Tr.WAITING)}static get PREDICTION_ENDPOINT(){return"/prediction"}toString(){return"SelectVariationsTaskV5()"}onPolicyReady(e){void 0===this.policy?this.policyCallbackFunctions.push(e):e(this.policy)}run(){return this.selectAbExperienceVariationsOnce(),this.selectRbpExperienceVariationsOnce(),this.getCcEligibleVariationsOnce(),_s.debug("decisionContext: "+this.decisionContext),void 0===this.executeExperiencesTask&&(this.executeExperiencesTask=new To(this.environment,this.browserStorage,this.extensionManager,this.browserEventLogger,this.attributeStorage,this.activityStorage,this.customerStorage,this.decisionContext,this.pageContext,this.attributeData,this.user,this.override,this.statusModel,this.hider,!0,this.getVariationRecordedCallbackTuples,this.elementObserver)),this.executeExperiencesTask.hideExperiencesOnce(),this.sendOnce(),this.apiStatus===Tr.FAILED?Tr.FAILED:this.apiStatus===Tr.SUCCEEDED?Tr.SUCCEEDED:Tr.TRY_LATER}buildRequest(){const e=this.user.getId(),t=this.customerStorage.updateAndGetSessionId(),i=this.override.isControl().orElseRun((()=>this.customerStorage.setAndGetCustomerControl(this.customer))),s={};At.filterExperiences(this.decisionContext.getExperiences()).forEach((e=>{const t=e.getId(),i=this.customerStorage.getStickyVariation(e).map((e=>e.getId())).orElse("NEVER_MATCH");s[t]=this.decisionContext.getVariationIds(t).map((e=>({variationId:e,isSticky:i===e})))}));const n=Fa.buildBrowserContext(this.environment,this.attributeStorage,this.user,this.pageContext,this.decisionContext);return{userId:e,sessionId:t,isControl:i,candidates:s,context:n}}sendOnce(){if(this.sent)return;_s.debug("SelectVariationsTaskV5.sendOnce()");const e=this.buildRequest();this.environment.fetch(wi,`${nl.PREDICTION_ENDPOINT}/${this.customer.getId()}`,{method:"POST",headers:{"Content-Type":"text/plain;charset=UTF-8"},body:Hi(e)}).then((t=>{if(qa(t)){const e=this.environment.getHostingPageUrl().getOrigin();console.warn(`${e} is not allowed to receive this data. If you‚Äôre expecting data to work here, check the Allowed Domains list at https://app.intellimize.com`)}_s.debug("SelectVariationsTaskV5.sendOnce() => got reply");const i=this.override.isControl().orElseRun((()=>this.customerStorage.setAndGetCustomerControl(this.customer)));this.policy=i?Cs.buildControlPolicy(this.environment):qa(t)?Cs.buildDefaultPolicy(this.environment,e):new Cs(t.policy),this.prioritizeCcVariations(this.policy),this.apiStatus=Tr.SUCCEEDED,this.executePolicyReadyFunctions(this.policy),this.manager.addTask(this.executeExperiencesTask),this.manager.runNow()})).catch((e=>{const t=new Ee("Caught exception in prediction call",e);_s.error(t,148),this.apiStatus=Tr.FAILED})),this.sent=!0}prioritizeCcVariations(e){_s.debug("SelectVariationsTaskV5.prioritizeCcVariations()"),At.filterExperiences(this.decisionContext.getExperiences()).forEach((t=>{const i=t.getId(),s=e.getExperienceVariationId(i);let n;for(;this.decisionContext.hasNext(i);){const e=this.decisionContext.shift(i);e.getId()===s&&(n=e)}void 0===n?_s.error("Prediction API did not select an eligible variation",149):(this.decisionContext.unshift(n),this.customerStorage.getStickyVariation(this.decisionContext.getExperience(i)).ifPresent((e=>{_s.info(`Variation ${i}/${e.getId()} selection was sticky`),this.decisionContext.prioritizeStickyVariation(i,e.getId())})),this.decisionContext.setModelVersion(i,e.getExperienceModelVersion(i))),this.statusModel.setExperienceSortedVariations(this.decisionContext.getExperience(i),this.decisionContext.getVariationIds(i))})),_s.debug(`decisionContext: ${this.decisionContext}`)}executePolicyReadyFunctions(e){_s.debug("SelectVariationsTaskV5.executePolicyReadyFunctions()");for(let t=this.policyCallbackFunctions.shift();void 0!==t;t=this.policyCallbackFunctions.shift())t(e)}}class rl extends kr{constructor(e,t,i,s){super(),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"integrationDataStorage"),__publicField(this,"user"),__publicField(this,"apiStatus",Tr.NOT_STARTED),__publicField(this,"sent",!1),this.environment=e,this.customer=t,this.user=i,this.integrationDataStorage=s}static get ENDPOINT(){return"/context-v2"}toString(){return"ServerContextTask()"}inTransaction(){return!1}isUnloading(){return!1}run(){return this.sendOnce(),this.apiStatus===Tr.SUCCEEDED?Tr.SUCCEEDED:this.apiStatus===Tr.FAILED?Tr.FAILED:(_s.debug("Waiting for server response"),Tr.TRY_LATER)}buildRequestBody(){return this.getCommonRequestBody()}handleResponse(e,t){this.integrationDataStorage.setDataAndMetadata("marketo",t.integrationData.marketo,void 0===e.marketo?void 0:{})}getCommonRequestBody(){const e={clientVersion:mi,userId:this.user.getId()};return mr(this.customer)&&vr(this.environment).ifPresent((t=>{e.marketo={cookie:t}})),e}sendOnce(){if(!this.sent){const e=this.buildRequestBody();this.environment.fetch(wi,`${rl.ENDPOINT}/${this.customer.getId()}`,{method:"POST",headers:{"Content-Type":"text/plain;charset=UTF-8"},body:Hi(e)}).then((t=>{if(qa(t)){const t=this.environment.getHostingPageUrl().getOrigin();console.warn(`${t} is not allowed to receive this data. If you‚Äôre expecting data to work here, check the Allowed Domains list at https://app.intellimize.com`),this.handleResponse(e,{requestId:"00000000-0000-1000-a000-000000000000",clientIp:"0.0.0.0",userAgentDigest:"00000000000000000000000000000000",userAgent:{},location:{},integrationData:{}})}else _s.info("Successfully retrieved ServerContext"),this.handleResponse(e,t);this.apiStatus=Tr.SUCCEEDED,this.manager.runNow()})).catch((e=>{const t=new Ee("Caught exception in server context task",e);_s.error(t,156),this.apiStatus=Tr.FAILED}))}this.sent=!0}}class ol extends rl{constructor(e,t,i,s,n,r){super(e,t,i,s),__publicField(this,"serverContextStorage"),__publicField(this,"isNewSession"),this.serverContextStorage=n,this.isNewSession=r}static get DOMAIN_NOT_AVAILABLE(){return"NA"}static shouldWaitForServerContext(e,t,i,s,n){var r,o,a;let l=!1;Sr(e)&&Ir(t).ifPresent((e=>{const t=i.getMetadata("salesforce").orElse({});void 0!==(null==e?void 0:e.leadIdHash)&&(null==t?void 0:t.leadIdHash)!==e.leadIdHash&&(l=!0),void 0!==(null==e?void 0:e.contactIdHash)&&(null==t?void 0:t.contactIdHash)!==e.contactIdHash&&(l=!0)}));const c=i.getAllMetdata(),u=rr(e)&&void 0===(null==(r=c.firmographic)?void 0:r.domain)||wr(e)&&void 0===(null==(o=c["6sense"])?void 0:o.domain)||nr(e)&&void 0===(null==(a=c.demandbase)?void 0:a.website),d=!s.get().map((e=>Object.keys(null==e?void 0:e.location).length>0&&Object.keys(null==e?void 0:e.userAgent).length>0)).orElse(!1);return l||u||d||n}toString(){return"ServerContextTaskV5()"}buildRequestBody(){const e=this.getCommonRequestBody();if(this.serverContextStorage.get().map((e=>e.clientIp)).ifPresent((t=>{e.clientIp=t})),Sr(this.customer)){const t=this.integrationDataStorage.getMetadata("salesforce").orElse({}),i=Ir(this.environment),s=null==t?void 0:t.leadIdHash,n=i.map((e=>null==e?void 0:e.leadIdHash)).orElse(void 0),r=null!=n?n:s,o=null==t?void 0:t.contactIdHash,a=i.map((e=>null==e?void 0:e.contactIdHash)).orElse(void 0),l=null!=a?a:o;if(void 0!==r||void 0!==l){const t={};void 0!==r&&(t.leadIdHash=r),void 0!==l&&(t.contactIdHash=l),e.salesforce=t}}return this.isNewSession||(this.integrationDataStorage.getMetadata("firmographic").flatMap((e=>D.ofNullable(null==e?void 0:e.domain))).ifPresent((t=>{e.firmographic={domain:t}})),this.integrationDataStorage.getMetadata("6sense").flatMap((e=>D.ofNullable(null==e?void 0:e.domain))).ifPresent((t=>{e["6sense"]={domain:t}})),this.integrationDataStorage.getMetadata("demandbase").flatMap((e=>D.ofNullable(null==e?void 0:e.website))).ifPresent((t=>{e.demandbase={website:t}}))),hr(this.customer)&&gr(this.environment).ifPresent((t=>{e.hubspot={cookie:t}})),e}handleResponse(e,t){var i,s,n,r,o,a,l,c,u,d,h,g,p;const m=t,{integrationData:v}=m,b=__objRest(m,["integrationData"]);this.integrationDataStorage.setDataAndMetadata("marketo",v.marketo,void 0===e.marketo?void 0:{}),this.integrationDataStorage.setDataAndMetadata("salesforce",v.salesforce,null!=(i=e.salesforce)?i:void 0),this.integrationDataStorage.setDataAndMetadata("hubspot",v.hubspot,void 0===e.hubspot?void 0:{}),(null==(s=e.firmographic)?void 0:s.domain)!==(null==(n=v.firmographic)?void 0:n.domain)&&((null==(r=v.firmographic)?void 0:r.domain)===ol.DOMAIN_NOT_AVAILABLE?this.integrationDataStorage.setDataAndMetadata("firmographic",{},{domain:ol.DOMAIN_NOT_AVAILABLE}):this.integrationDataStorage.setDataAndMetadata("firmographic",v.firmographic,{domain:null==(o=v.firmographic)?void 0:o.domain})),(null==(a=e["6sense"])?void 0:a.domain)!==(null==(l=v["6sense"])?void 0:l.domain)&&((null==(c=v["6sense"])?void 0:c.domain)===ol.DOMAIN_NOT_AVAILABLE?this.integrationDataStorage.setDataAndMetadata("6sense",{},{domain:ol.DOMAIN_NOT_AVAILABLE}):this.integrationDataStorage.setDataAndMetadata("6sense",v["6sense"],{domain:null==(u=v["6sense"])?void 0:u.domain})),(null==(d=e.demandbase)?void 0:d.website)!==(null==(h=v.demandbase)?void 0:h.website)&&((null==(g=v.demandbase)?void 0:g.website)===ol.DOMAIN_NOT_AVAILABLE?this.integrationDataStorage.setDataAndMetadata("demandbase",{},{website:ol.DOMAIN_NOT_AVAILABLE}):this.integrationDataStorage.setDataAndMetadata("demandbase",v.demandbase,{website:null==(p=v.demandbase)?void 0:p.website})),this.serverContextStorage.set(b)}}class al{constructor(e,t,i){__publicField(this,"environment"),__publicField(this,"storageKeyPrefix"),__publicField(this,"eventProcessor"),__publicField(this,"isObserving",!1),__publicField(this,"pollTimer"),this.environment=e,this.storageKeyPrefix=t,this.eventProcessor=i}static get POLLING_INTERVAL_MS(){return 1e3}start(){this.isObserving||(_s.debug("StorageQueueConsumer starting to poll"),this.isObserving=!0,this.poll())}stop(){_s.debug("StorageQueueConsumer stopping polling"),this.environment.getWindow().clearTimeout(this.pollTimer),this.isObserving=!1}handlePageUnload(){this.poll(),this.stop()}readSessionStorage(e){try{return this.environment.readSessionStorage(e)}catch(t){const i=new Ee(`StorageQueueConsumer: Storage failed for getItem("${e}")`,t);throw _s.warn(i,227),i}}writeSessionStorage(e,t){try{this.environment.writeSessionStorage(e,t)}catch(i){const t=new Ee(`StorageQueueConsumer: Storage failed for setItem("${e}")`,i);throw _s.warn(t,228),t}}removeSessionStorage(e){try{this.environment.deleteSessionStorage(e)}catch(t){const i=new Ee(`StorageQueueConsumer: Storage failed for removeItem("${e}")`,t);throw _s.warn(i,229),i}}poll(){const e=`${this.storageKeyPrefix}lastWrittenId`,t=`${this.storageKeyPrefix}lastReadId`;let i=D.empty(),s=0;try{i=this.readSessionStorage(e).map((e=>Number.parseInt(e,10))),s=this.readSessionStorage(t).map((e=>Number.parseInt(e,10))).orElse(0)}catch(n){return void this.stop()}if(i.isPresent()&&s<i.get()){const e=s+1,i=`${this.storageKeyPrefix}event-${e}`;let o=D.empty();try{o=this.readSessionStorage(i)}catch(n){return void this.stop()}try{this.writeSessionStorage(t,e.toString()),this.removeSessionStorage(i)}catch(n){return void this.stop()}if(o.isPresent()){let e;try{e=JSON.parse(o.get())}catch(r){const e=new Ee(`StorageQueueConsumer: Event in queue is not valid JSON: "${o.get()}"`,r);_s.error(e,230)}if(void 0!==e)try{_s.debug(`StorageQueueConsumer processing event ${Bi(e)}`),this.eventProcessor(e)}catch(r){const e=new Ee("StorageQueueConsumer: Could not process event",r);_s.error(e,231)}this.poll()}else _s.error(new Error(`StorageQueueConsumer: event-${e} not found in session storage`),232),this.pollAfterDelay()}else this.pollAfterDelay()}pollAfterDelay(){this.environment.getWindow().clearTimeout(this.pollTimer),this.pollTimer=this.environment.getWindow().setTimeout((()=>{this.poll()}),al.POLLING_INTERVAL_MS)}}const ll=3e3,cl=1;class ul extends kr{constructor(e,t,i,s,n,r,o,a,l){super(),__publicField(this,"environment"),__publicField(this,"browserEventLogger"),__publicField(this,"customer"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"user"),__publicField(this,"statusModel"),__publicField(this,"taskManager"),__publicField(this,"taskStartTime"),__publicField(this,"storageQueueConsumer"),this.environment=S(e),this.browserEventLogger=S(t),this.customer=S(i),this.customerStorage=S(s),this.attributeStorage=S(n),this.activityStorage=S(r),this.user=S(o),this.statusModel=S(a),this.taskManager=S(l),w(this.customer.getIntegrationShopify().isPresent())}inTransaction(){return!0}isUnloading(){return!1}getStorageQueueConsumer(){return D.ofNullable(this.storageQueueConsumer)}run(){void 0===this.taskStartTime&&(this.taskStartTime=this.environment.getNowDate(),_s.debug(`ShopifyStorageQueueTask start time: ${this.taskStartTime.getTime()}`));const e=this.environment.getNowDate().getTime()-this.taskStartTime.getTime(),t=this.waitForCurrencyRate(e);return t.isPresent()?(this.storageQueueConsumer=new al(this.environment,`${Oi}${this.customer.getId()}_`,(e=>{Rr(e,t.get(),this.customer,this.environment,this.customerStorage,this.attributeStorage,this.activityStorage,this.user,this.statusModel,this.taskManager,this.browserEventLogger)})),this.storageQueueConsumer.start(),Tr.SUCCEEDED):Tr.TRY_LATER}waitForCurrencyRate(e){const t=this.environment.getWindow();if(void 0===t.Shopify)_s.debug(`window.Shopify not defined after ${e} ms`);else{if(!Us(t.Shopify))return _s.error("window.Shopify is not an object",245),D.of(cl);if(void 0===t.Shopify.currency)_s.debug(`window.Shopify.currency not defined after ${e} ms`);else{if(!Us(t.Shopify.currency))return _s.error("window.Shopify.currency is not an object",246),D.of(cl);if(void 0!==t.Shopify.currency.rate)return r(t.Shopify.currency.rate)?(_s.debug(`window.Shopify.currency defined after ${e} ms (${t.Shopify.currency.rate})`),D.of(Number(t.Shopify.currency.rate))):(_s.error("window.Shopify.currency.rate is not a non-empty string",247),D.of(cl));_s.debug(`window.Shopify.currency.rate not defined after ${e} ms`)}}return e>=ll?(_s.error(`Timed out waiting for window.Shopify.currency (waited ${e}ms)`,248),D.of(cl)):D.empty()}}class dl extends Ds{constructor(){super(...arguments),__publicField(this,"hasRun",!1),__publicField(this,"isRestartingStatus",!1),__publicField(this,"taskManager"),__publicField(this,"environment"),__publicField(this,"override"),__publicField(this,"customer"),__publicField(this,"conditionEvaluationRuntime"),__publicField(this,"elementObserver"),__publicField(this,"pageContext"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"integrationDataStorage"),__publicField(this,"serverContextStorage"),__publicField(this,"intellimizeApi"),__publicField(this,"user"),__publicField(this,"browserStorage"),__publicField(this,"localStorage"),__publicField(this,"statusModel"),__publicField(this,"attributeData"),__publicField(this,"activityStorage"),__publicField(this,"internalApi"),__publicField(this,"hider"),__publicField(this,"browserEventLogger"),__publicField(this,"shopifyStorageQueueTask",D.empty()),__publicField(this,"extensionManager")}run(){return __async(this,null,(function*(){if(_s.info("Starting client"),_s.time("Client run time"),this.hasRun)return void _s.error("Tried to run client again",143);_s.time("new Environment");const e=Uo(window);this.environment=new er(window,e),_s.configureEnvironment(this.environment),_s.timeEnd("new Environment");if(void 0!==this.environment.getWindow().ipgvidtfr)return void _s.error("Intellimize duplicate code detected on page.",144);this.environment.getWindow().ipgvidtfr=this.environment.getPageviewId(),this.extensionManager=ir(),this.hider=new Un(this.environment,this.extensionManager),this.hider.startTimedRegionHider();const t=Xa(this.environment);if(!t.isPresent())return void Un.revealAll(this.environment.getWindow().document);const i=Za(t.get());if(!i.isPresent())return void Un.revealAll(this.environment.getWindow().document);if(this.customer=i.get(),_s.configureCustomer(this.customer),_s.time("load json"),this.override=new jo(this.environment,this.customer),!this.override.shouldRun().orElse(!0))return _s.info("Client not running"),this.environment.getWindow().inrsgew=!0,void Un.revealAll(this.environment.getWindow().document);if(this.override.shouldHide().orElse(!0)||Un.revealAll(this.environment.getWindow().document),this.localStorage=new Jo(this.environment),this.intellimizeApi=new Fo(this.environment),this.intellimizeApi.initialize(),this.taskManager=new ua(this,this.environment),this.override.shouldCheckOptOut().orElse(!0)&&el(this.customer,this.localStorage,this.environment))return void Un.revealAll(this.environment.getWindow().document);_s.time("Setup storage"),this.browserStorage=yield tl(this.localStorage,this.environment,this.taskManager,this.customer,this.override),this.user=new ca(this.browserStorage,this.environment,this.customer),_s.configureUser(this.user),this.statusModel=this.override.showStatusModule().orElse(!1)?new Ho(this.environment,this.customer,this.override,this.browserStorage):new Qo,this.customerStorage=new Ko(this.customer,this.environment,this.browserStorage,this.override);const s=this.customerStorage.getSessionId(),n=this.customerStorage.updateAndGetSessionId(),r=!s.map((e=>e===n)).orElse(!1);this.customer.isCampaignControl()||this.customerStorage.setAndGetCustomerControl(this.customer),this.attributeStorage=new qo(this.customer,this.environment,this.browserStorage,this.user),this.activityStorage=new io(this.customer,this.browserStorage,this.environment,this.override),Ka(this.environment,this.attributeStorage,this.customer),this.integrationDataStorage=new Yo(this.customer,this.browserStorage),cr(this.customer)&&ur(this.environment,this.integrationDataStorage,this.customer),this.serverContextStorage=new Xo(this.customer,this.browserStorage),_s.timeEnd("Setup storage"),this.environment.addUnloadHandler((()=>{try{this.handlePageUnload()}catch(e){const t=new Ee("Exception in ClientV5 unload handler",e);_s.error(t,240)}}));const o=new ol(this.environment,this.customer,this.user,this.integrationDataStorage,this.serverContextStorage,r);ol.shouldWaitForServerContext(this.customer,this.environment,this.integrationDataStorage,this.serverContextStorage,r)?o.onDone((()=>{this.postServerContextWork()})):this.postServerContextWork(),this.taskManager.addTask(o),this.hasRun=!0,_s.timeEnd("Client run time"),this.taskManager.runNow()}))}reRun(e){_s.info("Client.reRun()"),this.isRestartingStatus=!0,this.handlePageUnload(),this.environment.getWindow().setTimeout((()=>{this.taskManager.stop(),this.taskManager.onDone((()=>{this.statusModel.reinitializeExperienceVariations(),this.environment.reinitialize(),this.taskManager.addTask(new Ia(this.elementObserver)),this.customerStorage.updateAndGetSessionId(),Ka(this.environment,this.attributeStorage,this.customer),cr(this.customer)&&ur(this.environment,this.integrationDataStorage,this.customer),this.attributeData.reinitialize(),this.internalApi.reinitialize(),e.forEach((e=>{Fs.executeFunction(e,150)})),this.activityStorage.add(io.buildPageviewActivity(this.customer,this.environment,this.user,this.attributeStorage,this.customerStorage)),this.pageContext.reinitialize(),Ya(this.customer,this.statusModel,this.environment.getWindow().document),this.scheduleTasks(),this.isRestartingStatus=!1}))}),0)}isRestarting(){return _s.debug(`Client.isRestarting() => ${this.isRestartingStatus}`),this.isRestartingStatus}postServerContextWork(){_s.time("postServerContextWork");const e=this.serverContextStorage.get();if(!e.isPresent())return void _s.error("Expected ServerContext is missing",146);const t=e.get();_s.debug(`postServerContextWork() serverContext: ${Bi(t)}`),_s.configureServerContext(t),this.attributeData=new Ss(this.environment,t,this.attributeStorage,this.override,this.customerStorage,this.integrationDataStorage,this.user),this.conditionEvaluationRuntime=new Ms(this.attributeData,this.activityStorage),this.elementObserver=this.override.useElementObserver().orElse(!0)?new Gn:new Rs,this.taskManager.addTask(new Ia(this.elementObserver)),this.pageContext=new Go(this.environment,this.browserStorage,this.extensionManager,this.customer,this.conditionEvaluationRuntime,this.attributeData,this.override,this.taskManager,this.hider,this.elementObserver,this.statusModel),this.browserEventLogger=new Ps(this.customer,this.environment,this.user,this.attributeStorage,this.pageContext,t,this.customerStorage,void 0,this.override);const i=new Do(this.environment,this.extensionManager,this.browserEventLogger,this.taskManager,this.customerStorage,this.attributeStorage,this.activityStorage,this.integrationDataStorage,this.customer,this.user,this.override,this.statusModel,this.intellimizeApi.extractCallQueue(),this.intellimizeApi.extractReadyCallbackQueue(),(e=>{this.addVariationRecordedCallbackTuple(e)}));i.initialize(),this.internalApi=new Mo(this.customer,this.user,this.environment,this.extensionManager,t,this.taskManager,this.browserStorage,this.customerStorage,i,this.attributeData,this.elementObserver),this.internalApi.initialize(),this.activityStorage.add(io.buildPageviewActivity(this.customer,this.environment,this.user,this.attributeStorage,this.customerStorage)),Ya(this.customer,this.statusModel,this.environment.getWindow().document),this.pageContext.reinitialize(),this.scheduleTasks(this.browserEventLogger),this.override.injectVisualEditor().orElse(!1)&&this.environment.injectScript("https://intellimizeditor.com/common.js"),_s.timeEnd("postServerContextWork")}scheduleTasks(e){if(_s.debug("scheduleTasks()"),this.override.shouldRunTasks().orElse(!0)){const t=new nl(this.environment,this.browserStorage,this.extensionManager,this.browserEventLogger,this.customer,this.customerStorage,this.attributeStorage,this.activityStorage,this.user,this.override,this.pageContext,this.attributeData,this.statusModel,this.conditionEvaluationRuntime,this.hider,this.getVariationRecordedCallbackTuples.bind(this),this.elementObserver);t.onPolicyReady((t=>{void 0!==e&&e.setPolicy(t),_s.debug("scheduleTasks() onPolicyReady()"),this.override.sendPageviewBrowserEvents().orElse(!0)&&this.taskManager.addTask(new Aa(this.environment,this.browserEventLogger));const i=new _a(this.environment,this.browserEventLogger,this.customer,this.customerStorage,this.attributeStorage,this.activityStorage,this.user,this.override,this.pageContext,this.statusModel),s=new da(this.environment,this.browserEventLogger,this.integrationDataStorage);if(this.taskManager.addTask(s),this.taskManager.addTask(i),this.customer.getIntegrationShopify().isPresent()){_s.debug("Shopify Pixel enabled for customer");const e=new ul(this.environment,this.browserEventLogger,this.customer,this.customerStorage,this.attributeStorage,this.activityStorage,this.user,this.statusModel,this.taskManager);this.shopifyStorageQueueTask=D.of(e),this.taskManager.addTask(e)}if(mr(this.customer)){if(this.environment.getHostingPageUrl().getQueryParam(ji,r).isPresent()){const e=new Sa(this.environment,this.customer,"/marketo-id-associator",(()=>vr(this.environment)));this.taskManager.addTask(e)}const e=new Ta(this.environment,this.browserEventLogger,this.customer,this.user,this.override,this.activityStorage,this.attributeStorage,this.customerStorage,this.statusModel);this.taskManager.addTask(e)}if(hr(this.customer)){if(this.environment.getHostingPageUrl().getQueryParam(Gi,r).isPresent()){const e=new Sa(this.environment,this.customer,"/hubspot-id-associator",(()=>gr(this.environment)));this.taskManager.addTask(e)}const e=new wa(this.environment,this.browserEventLogger,this.customer,this.user,this.override,this.activityStorage,this.attributeStorage,this.customerStorage,this.statusModel);this.taskManager.addTask(e)}})),this.taskManager.addTask(t)}else this.override.sendPageviewBrowserEvents().orElse(!0)&&this.taskManager.addTask(new Aa(this.environment,this.browserEventLogger))}handlePageUnload(){_s.debug("(Prepare for Shutdown): handlePageUnload() giving the client one more chance to run tasks..."),this.shopifyStorageQueueTask.ifPresent((e=>{e.getStorageQueueConsumer().ifPresent((e=>{e.handlePageUnload()}))}));this.taskManager.findTasks((e=>!e.isDone())).length>0&&(this.taskManager.addTask(new xa),this.taskManager.runNow())}}function hl(e,t){return i=>{_s.time("frameTick",["raf"]);const s=null!=t?t:i;i-s<e&&window.requestAnimationFrame(hl(e,s)),_s.timeEnd("frameTick",["raf"])}}function gl(){new MutationObserver((e=>{Os.time(`mutations: ${e.length}`),e.forEach((e=>{Os.debug(`Doc mutation: ${qi(e)}`)})),Os.timeEnd(`mutations: ${e.length}`)})).observe(document.documentElement,{subtree:!0,childList:!0,attributes:!0,characterData:!0,attributeOldValue:!0,characterDataOldValue:!0})}(()=>{__async(this,null,(function*(){try{_s.time("client startup time"),_s.getLevel()<=L.LogLevel.DEBUG&&(window.requestAnimationFrame(hl(2e3)),gl());const e=new dl;yield e.run(),_s.timeEnd("client startup time")}catch(e){Un.revealAll(document);const t=fe(e);_s.error(t,142)}}))})()}();

